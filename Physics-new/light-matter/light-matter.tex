\documentclass[hyperref, a4paper]{article}

\usepackage{geometry}
\usepackage{titling}
\usepackage{titlesec}
% No longer needed, since we will use enumitem package
% \usepackage{paralist}
\usepackage{enumitem}
\usepackage{footnote}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{mathtools}
\usepackage{bbm}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{soulutf8}
\usepackage{physics}
\usepackage{tensor}
\usepackage{siunitx}
\usepackage[version=4]{mhchem}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{autobreak}
\usepackage[ruled, vlined, linesnumbered]{algorithm2e}
\usepackage{nameref,zref-xr}
\zxrsetup{toltxlabel}
\usepackage[backend=bibtex]{biblatex}
\addbibresource{elasticity.bib}
\usepackage[colorlinks,unicode]{hyperref} % , linkcolor=black, anchorcolor=black, citecolor=black, urlcolor=black, filecolor=black
\usepackage[most]{tcolorbox}
\usepackage{prettyref}

% Page style
\geometry{left=3.18cm,right=3.18cm,top=2.54cm,bottom=2.54cm}
\titlespacing{\paragraph}{0pt}{1pt}{10pt}[20pt]
\setlength{\droptitle}{-5em}

% More compact lists 
\setlist[itemize]{
    itemindent=17pt, 
    leftmargin=1pt,
    listparindent=\parindent,
    parsep=0pt,
}

% Math operators
\DeclareMathOperator{\timeorder}{\mathcal{T}}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\legpoly}{P}
\DeclareMathOperator{\primevalue}{P}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\res}{Res}
\DeclareMathOperator{\sinc}{sinc}
\newcommand*{\ii}{\mathrm{i}}
\newcommand*{\ee}{\mathrm{e}}
\newcommand*{\const}{\mathrm{const}}
\newcommand*{\suchthat}{\quad \text{s.t.} \quad}
\newcommand*{\argmin}{\arg\min}
\newcommand*{\argmax}{\arg\max}
\newcommand*{\normalorder}[1]{: #1 :}
\newcommand*{\pair}[1]{\langle #1 \rangle}
\newcommand*{\fd}[1]{\mathcal{D} #1}
\DeclareMathOperator{\bigO}{\mathcal{O}}

% TikZ setting
\usetikzlibrary{arrows,shapes,positioning}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{decorations.markings}
\usetikzlibrary{calc}
\tikzstyle arrowstyle=[scale=1]
\tikzstyle directed=[postaction={decorate,decoration={markings,
    mark=at position .5 with {\arrow[arrowstyle]{stealth}}}}]
\tikzstyle ray=[directed, thick]
\tikzstyle dot=[anchor=base,fill,circle,inner sep=1pt]

% Algorithm setting
% Julia-style code
\SetKwIF{If}{ElseIf}{Else}{if}{}{elseif}{else}{end}
\SetKwFor{For}{for}{}{end}
\SetKwFor{While}{while}{}{end}
\SetKwProg{Function}{function}{}{end}
\SetArgSty{textnormal}

\newcommand*{\concept}[1]{{\textbf{#1}}}

% Embedded codes
\lstset{basicstyle=\ttfamily,
  showstringspaces=false,
  commentstyle=\color{gray},
  keywordstyle=\color{blue}
}

% Reference formatting
\newcommand*{\citesec}[1]{\S~{#1}}
\newcommand*{\citechap}[1]{chap.~{#1}}
\newcommand*{\citefig}[1]{Fig.~{#1}}
\newcommand*{\citetable}[1]{Table~{#1}}
\newcommand*{\citepage}[1]{pp.~{#1}}
\newrefformat{fig}{Fig.~\ref{#1}}
\newcommand*{\term}[1]{\textit{#1}}

% Color boxes
\tcbuselibrary{skins, breakable, theorems}

\newtcbtheorem{infobox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=blue!5,
    colframe=blue!5,
    coltitle=blue!50,
    borderline west={4pt}{0pt}{blue!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}
\newtcbtheorem[use counter from=infobox]{theorybox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=orange!5, 
    colframe=orange!5, 
    coltitle=orange!50,
    borderline west={4pt}{0pt}{orange!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}
\newtcbtheorem[use counter from=infobox]{learnbox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=green!5,
    colframe=green!5,
    coltitle=green!50,
    borderline west={4pt}{0pt}{green!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}


\newenvironment{shelldisplay}{\begin{lstlisting}}{\end{lstlisting}}

\newcommand*{\kB}{k_{\text{B}}}
\newcommand*{\muB}{\mu_{\text{B}}}
\newcommand*{\efermi}{E_{\text{F}}}
\newcommand*{\pfermi}{p_{\text{F}}}
\newcommand*{\vfermi}{v_{\text{F}}}
\newcommand*{\sA}{\text{A}}
\newcommand*{\sB}{\text{B}}
\newcommand*{\Tc}{T_{\text{c}}}
\newcommand*{\hethree}{$^3$He}
\newcommand*{\hefour}{$^4$He}
\newcommand{\epsr}{\epsilon_{\text{r}}}
\newcommand{\chie}{\chi_{\text{e}}}
\newcommand*{\Gammae}{\Gamma_{\text{e}}}
\newcommand*{\Gammag}{\Gamma_{\text{g}}}
\newcommand*{\omegae}{\omega_{\text{e}}}
\newcommand*{\omegag}{\omega_{\text{g}}}
\newcommand*{\omegaeg}{\omega_{\text{eg}}}
\newcommand*{\ptwfc}[2]{\psi^{(#2)}_{#1}}
\newcommand*{\mueg}{\mu_{\text{eg}}}
\newcommand*{\muge}{\mu_{\text{ge}}}
\newcommand*{\Ezzero}{E_{z0}}
\newcommand*{\kete}{\ket*{\text{e}}}
\newcommand*{\ketg}{\ket*{\text{g}}}
\newcommand*{\coeffe}{c_{\text{e}}}
\newcommand*{\coeffg}{c_{\text{g}}}
\newcommand*{\pope}{p_{\text{e}}}
\newcommand*{\popg}{p_{\text{g}}}
\newcommand*{\ptwo}{P^{(2)}}
\newcommand*{\vp}{v_{\text{p}}}
\newcommand*{\chitwo}{\chi^{(2)}}
\newcommand*{\chithree}{\chi^{(3)}}
\newcommand*{\omegap}{\omega_{\text{p}}}

\title{Light-matter interaction}
\author{Jinyuan Wu}

\begin{document}

\maketitle

TODO:
\begin{itemize}
    \item There are rare cases where the energy velocity 
    (i.e. the velocity that connects $\vb*{s}$ and $u$) 
    is not the same as group velocity;
    for example in metal wave guide?
    \item From the current response of an external field to $\epsr$.
    (That's to say, 
    from TD-aGW to dielectric function.)
    \item Specifically, noise exists when there is damping. 
    Could this be modeled by some sort of non-equilibrium field theory?
    (I think I asked this question before \dots)
\end{itemize}

\section{Coarse-grained description of medium}

A linearly polarized medium can be described by 
\begin{equation}
    \vb*{D} = \epsilon_0 \vb*{E} + \vb*{P}
    = \epsilon_0 \vb*{E} + \epsilon_0 \chi_{\text{e}} \vb*{E} 
    = \epsilon_0 \underbrace{(1 + \chi_\text{e})}_{\eqqcolon \epsilon_{\text{r}}} \vb*{E}.
\end{equation}
Similarly we can deal with magnetization, 
although here the notation, due to historical reasons, needs to be altered slightly.
Now we have 
\begin{equation}
    \vb*{B} = \mu_0 (\vb*{H} + \vb*{M})
    = \mu_0 \underbrace{(1 + \chi_{\text{m}})}_{\mu_{\text{r}}} \vb*{H},
\end{equation}
as if $\vb*{B}$ has the same status of $\vb*{D}$,
although it's $\vb*{H}$ that is the auxiliary field.

From the fourth Maxwell equation we directly find
that time oscillation of polarization stimulates a magnetic field, 
which is correct since $\partial_t \vb*{P}$
can be understood as a current: 
charges have to be rearranged 
so that the orientation of a dipole changes,
which then give us a current.

The Poynting's theorem now reads 
\begin{equation}
    \div{\vb*{S}} + \vb*{H} \cdot \pdv{\vb*{B}}{t} + \vb*{E} \cdot \pdv{\vb*{D}}{t} 
    + \vb*{J}_{\text{free}} \cdot \vb*{E} = 0.
\end{equation}
This is the conservation equation of energy 
only when the material is linear, 
where we can redefine the electromagnetic energy as 
\begin{equation}
    u = \frac{1}{2} (\vb*{E} \cdot \vb*{D} + \vb*{B} \cdot \vb*{H}),
\end{equation} 
which includes the energy stored in the medium.
What we \emph{always} have is 
\begin{equation}
    \div{\vb*{S}} + \pdv{t} \left(
        \frac{\epsilon_0}{2} \vb*{E}^2 
        + \frac{\mu_0}{2} \vb*{H}^2
    \right) + 
    \left(
        \vb*{E} \cdot \pdv{\vb*{P}}{t} 
        + \mu_0 \vb*{H} \cdot \pdv{\vb*{M}}{t}
        + \vb*{J}_{\text{free}} \cdot \vb*{E}
    \right) = 0,
\end{equation} 
which is the conservation equation for the ``pure'' electromagnetic energy, 
e.g. the energy stored in the electromagnetic field.
Of course, the internal degrees of freedom of the medium 
may contain microscopic electromagnetic field modes, 
so by ``the energy stored in the electromagnetic field''
we mean ``the energy stored in the electromagnetic modes we care''.

\section{A more generalized description of linear response}

The $\vb*{D} = \epsilon_0 \epsilon_{\text{r}} \vb*{E}$ case is almost trivial: 
they respond instantaneously and they don't absorb energy.
In this section we still assume that the response is linear,
but don't assume that the response is spontaneous.
Thus 
\begin{equation}
    \vb*{P}(t) = \int_{-\infty}^{\infty} \alpha(t - \tau) \vb*{E}(\tau) \dd{\tau}.
\end{equation}
Thus the polarization field is the convolution 
of the response function and the electric field.
In principle things can be even more complicated: 
$\alpha$ can have momentum dependence in the Fourier space, 
and the consequence is that the response is non-local:
this is important in, say, plasmon, 
where long-range Coulomb interaction requires a non-local description of the response.

The wave equation now is 
\begin{equation}
    \curl{\curl{\vb*{E}}} = - \mu_0 \epsilon_0 \pdv[2]{t}
    \epsr \otimes \vb*{E},
\end{equation}
where $\otimes$ means convolution.
This equation is more clearly illustrated by its form in the frequency space: 
\begin{equation}
    \curl{\curl{\vb*{E}}} = \mu_0 \epsilon_0 \omega^2 \epsr(\omega) \vb*{E}(\omega),
    \label{eq:freq-space-time-retardation-wave-eq}
\end{equation}
where 
\begin{equation}
    \epsr(\omega) = \int_{-\infty}^\infty \epsr(t) \ee^{\ii \omega t} \dd{t},
\end{equation}
and from the fact that $\epsr(t)$ is real, 
\begin{equation}
    \epsr(-\omega) = \epsr(\omega)^*.
\end{equation}
For clarity we may want to use $\tilde{\epsilon}_{\text{r}}$ 
to refer to $\epsr(\omega)$.
The damping behavior of $\epsr(t)$ in the time domain 
is represented by the imaginary part of $\epsr(\omega)$ in the frequency domain.

\eqref{eq:freq-space-time-retardation-wave-eq} tells us an important point:
if the input is time harmonic, 
so is the output.
Indeed we can measure $\epsr(\omega)$ in this way.

The plane wave mode with a frequency-dependent $\epsr(\omega)$ 
has the following dispersive relation:
\begin{equation}
    \left(
        \vb*{k}^2 - \frac{\omega^2}{c^2} \epsr(\omega)
    \right) \vb*{E} = 0 \Rightarrow
    \vb*{k} = \pm \frac{\omega \tilde{n}(\omega)}{c} \vu*{k}, 
\end{equation}
where 
\begin{equation}
    \tilde{n}(\omega) = \sqrt{\epsr(\omega)}.
\end{equation}
From the dispersive relation 
we can define phase velocity and group velocity.

It should be noted that $n$ -- and hence $\vb*{k}$ -- 
is allowed to have an imaginary part,
which tells us absorption in the material. 
Defining 
\begin{equation}
    \tilde{n}(\omega) = n(\omega) + \ii \kappa(\omega),
\end{equation}
we find 
\begin{equation}
    \vb*{E}(\vb*{r}, t) = \ee^{
        - \frac{\omega}{c} \kappa(\omega) \vu*{k} \cdot \vb*{r}
    }
    \ee^{
        \ii \frac{\omega}{c} n(\omega) \vu*{k} \cdot \vb*{r}
        - \ii \omega t
    } E \vu*{e},
\end{equation}
and therefore the decaying coefficient is  
\begin{equation}
    \alpha(\omega) = \frac{\omega}{c} \kappa(\omega),  
\end{equation}
from which we find 
\begin{equation}
    \expval{S(z)} = \frac{1}{2} \abs*{
        \Re \vb*{E}^* \times \vb*{H}
    } \propto \ee^{- 2 \alpha z}.
\end{equation}

We can also evaluate the impact of imaginary part of $\epsr$ 
-- equivalently, of $\chi_{\text{e}}$ -- 
from the perspective of the energy of the electromagnetic field.
Consider a region with no energy flow into or out of it.
We have 
\begin{equation}
    \begin{aligned}
        &\div{\vb*{S}} + \pdv{u}{t} = - \vb*{E} \cdot \vb*{J} \\
        \Rightarrow& \dv{t} \int \expval{u} \dd[d]{\vb*{r}} 
        = - \int \dd[d]{\vb*{r}} \frac{1}{2} \Re \vb*{E}^* \cdot \vb*{J}   
        = - \frac{1}{2} \int \dd[d]{\vb*{r}} \omega \epsilon_0 \Im \chi(\omega) \abs*{\vb*{E}}^2.
    \end{aligned}
\end{equation}
Thus, when $\chi_2$ is positive, 
the field loses energy, 
and when $\chi_2$ is negative, 
the field gets energy.

\section{Microscopic model of dispersive media: the harmonic oscillator model}

The harmonic oscillator is often used as a simplistic model of the atom.
The physical picture seems wrong at the first glance, 
but if we regard the displacement in the harmonic oscillator
as the dipole of the atom, 
then things begin to make sense; 
indeed, the ``classical'' model of harmonic oscillator 
can be shockingly accurate in certain limits.

The EOM is  
\begin{equation}
    m \ddot{\vb*{r}} = - m \Omega^2 \vb*{r} - m \gamma \dot{\vb*{r}}
    + q \vb*{E},
\end{equation}
or in other words 
\begin{equation}
    \ddot{\vb*{p}} + \gamma \dot{\vb*{p}} + \Omega^2 \vb*{p}
    = \frac{q^2}{m} \vb*{E}(t),
\end{equation}
where $\vb*{p} = q \vb*{r}$ is the dipole.
\todo{Whether a more realistic atom model reduces to the above EOM 
requires further investigation.}%
The polarizability can be routinely found as 
\begin{equation}
    \vb*{p}(\omega) = \underbrace{
        \frac{q^2 / m}{\Omega^2 - \omega^2 - \ii \omega \gamma}
    }_{\alpha(\omega)} \vb*{E}(\omega).
\end{equation}
This leads to expected limit cases: 
when $\omega \ll \Omega$, 
$\vb*{E}$ is parallel to $\vb*{p}$,
while when $\omega \gg \Omega$,
$\vb*{E}$ is in the opposite direction to $\vb*{p}$.
\todo{How can this be used for light trapping???}

Now consider an assembly of atoms, 
and we find the total polarization field is now 
\begin{equation}
    \vb*{P} = \left(
        \frac{N}{V}
    \right) \cdot \vb*{p},
\end{equation}
and therefore the behavior of the media, 
in terms of quantities in the theory of electromagnetism, is now 
\begin{equation}
    (\ddot{\vb*{P}} + \gamma \dot{\vb*{P}} + \Omega^2 \vb*{P})
    = \frac{N}{V} \frac{q^2}{m} \vb*{E}.
\end{equation}
Recall that from Maxwell's equations we also have 
\begin{equation}
    \curl \curl \vb*{E} = 
    - \mu_0 \epsilon_0 \pdv[2]{t} \vb*{E}
    - \mu_0 \pdv[2]{t} \vb*{P}.
\end{equation}
The coupled EOMs, in the strong coupling regime, 
are a simple model of \concept{polariton}.
\todo{
    Is it possible to use solely $\epsr$ to capture the 
    behaviors of a polariton?
    Note that with $\epsr$ we still only have one mode 
    but here we actually have two modes, 
    EM field and polarization mode.
    
    Also, how could, say, phonon, be modeled as $\vb*{P}$.
}
\todo{the state of the material is changed after radiation happens 
(and the coupling between matter and the optical field 
also means the state of the material is a mixed state??
This question always puzzles me.)
Specifically, what will Fermi golden rule give us in this exactly solvable case?}

Real materials have more than one internal modes, 
and the relation between the polarizability and the electric field becomes 
\todo{TRK sum rule}

\section{Scattering cross sections}

For a single oscillator, the absorption power is  
\begin{equation}
    \expval{P_{\text{abs}}} = \expval{q \vb*{E} \cdot \dot{\vb*{d}}}
    = \gamma \abs*{\vb*{E}}^2 
    = \sigma_{\text{abs}} \underbrace{
        u_{\text{em}} v_{\text{g}}
    }_{\text{incident intensity}} .
\end{equation}
From this equation we naturally find a 
constant measuring how strong the absorption is 
with area dimension,
which is righteously named as the absorption cross section.
From this linear relation between absorption 
and incident intensity we immediate get Beer's law 
\begin{equation}
    I(z) = I(0) \ee^{- \frac{N}{V} \sigma_{\text{abs}} z},
\end{equation} 
where $N$ is the number of absorption centers.
The equation can be derived straightforwardly by 
using the definition to find 
\[
    \Delta P = - I(z) N \sigma_{\text{abs}}
\]
and noticing that 
\[
    P = I \cdot A.
\]

\section{Local field correction}

The good old ``a hole in a material'' argument.

\section{Kramers-Kronig relations}

It's possible that we have dispersion but no loss 
(as in, say, a wave guide, 
caused by the so-called geometric dispersion); 
in this case K-K relation may fail altogether,
due to some quirky properties of the response function.

\section{Semiclassical field-atom coupling}

In this section we consider the coupling between 
a semiclassical field and a degree of freedom 
that is expected to represent an atom,
be it a two-level system or a quantum oscillator or something else.
The coupling Hamiltonian reads 
\begin{equation}
    H_1 = - \vb*{\mu} \cdot \vb*{E} = - q \vb*{r} \cdot \vb*{E},
\end{equation}
which means we ignore the space dependence of $\vb*{E}$
and just apply a (possibly time-dependent) uniform electric field to 
the atom.
For example, the EOM of a harmonic oscillator is now 
\begin{equation}
    \dot{p} = - m \omega_0^2 x + q E, \quad 
    \dot{x} = \frac{p}{m},
\end{equation}
which means the toy model of driven harmonic oscillator 
is in fact quantitatively correct.
Indeed, the condition of the dipole approximation is 
\begin{equation}
    \frac{\omega}{c} a \ll 1,
\end{equation}
which can be justified either by Taylor expansion 
or by the physical intuition that the atom should not see 
the variance of the electric field.
The dipole approximation is usually correct, 
but caveats are needed for Rydberg atoms
($a$ is too large for ordinary wave length)
and cases with artificially enhanced strong electric variance 
as in, say, a very thin tip near a molecule 
(wave length too small for ordinary $a$).

One thing that can be immediately noticed is that 
the dipole moment expectation is always constant 
when the system is at a stationary state, 
since the $\ee^{- \ii \omega t}$ factors
of the bra and the ket cancel each other.
This means if we treat the light field as a classical field, 
we don't have spontaneous emission,
since radiation requires a time evolving dipole moment.
If 
\begin{equation}
    \ket*{\psi} = c_a \ket*{a} + c_b \ket*{b},
\end{equation}
we get 
\begin{equation}
    \expval{\vb*{\mu}(t)}_{\text{oscillating part}} = 
    c^*_a c_b \ee^{- \ii (\omega_b - \omega_a) t} \mel**{a}{\vb*{\mu}}{b} + \text{c.c.},
\end{equation}
and radiative coupling is possible when the matrix element is non-zero.
When a realistic atomic model is used,
this means that the parity of $a$ and $b$ should be different 
(and thus it's impossible to have transition between 1s and 2s),
and similarly we have selection rules for $m$ and $l$.
Note that we can still have multiple dipole-allowed transitions 
with the help of some intermediate states 
to connect two states that, say, have the same parity;
or we can make use of other transition channels
when the gradient of the electric field is truly large.\todo{Incoherent nonlinear processes}

The time-dependent perturbation usually can't be solved exactly.
Below we review time-dependent perturbation theory.
The Schrodinger equation is 
\begin{equation}
    \ii \hbar \pdv{t} \ket*{\psi(t)} = 
    (H_0 + \lambda H_1(t)) \ket*{\psi(t)},
\end{equation}
and we do the decomposition 
(by including the $\ee^{- \ii \omega_n t}$ factor 
we implicitly come into the interaction picture)
\begin{equation}
    \ket*{\psi(t)} = \sum_{n} \underbrace{  \left(
        \gamma_n^{(0)} + \lambda \gamma_n^{(1)} + \lambda^2 \gamma_n^{(2)} + \cdots
    \right) }_{\gamma_n} \ket*{n} \ee^{- \ii \omega_n t}, 
\end{equation}
and from the 
\begin{equation}
    \dv{\gamma_k}{t} = \frac{1}{\ii \hbar} \lambda \sum_n \mel**{k}{H_1}{n} \gamma_n (t) 
    \ee^{\ii (\omega_k - \omega_n) t}
\end{equation}
we get 
\begin{equation}
    \dv{t} \gamma^{(0)}_k = 0,
\end{equation}
\begin{equation}
    \dv{t} \gamma^{(1)}_k = \frac{1}{\ii \hbar} \sum_n H_{1, kn} 
    \gamma^{(0)}_n \ee^{\ii (\omega_k - \omega_n) t},
\end{equation}
\begin{equation}
    \dv{t} \gamma^{(2)}_k = \frac{1}{\ii \hbar} \sum_n H_{1, kn} 
    \gamma^{(1)}_n \ee^{\ii (\omega_k - \omega_n) t},
\end{equation}
and so on.  

We can organize the perturbed coefficients in the scattering matrix formalism:
\begin{equation}
    \gamma_k(t) = \gamma_k^{(0)} + \sum_n \underbrace{(S_{kn}^{(0)}(t) + S_{kn}^{(1)}(t) + \cdots)}_{S_{kn}} \gamma_n^{(0)},
\end{equation}
and the scattering matrix $S_{kn(t)}$ can be obtained from the 
aforementioned series of equations.

The time evolution caused by dipole coupling 
\begin{equation}
    H = \underbrace{
        - \vb*{\mu} \cdot \vb*{E}_0
    }_{ \eqqcolon W_{kn}} \cos \omega t
\end{equation}
therefore is 
\begin{equation}
    \begin{aligned}
        \dv{\gamma_k^{(1)}}{t} &= \frac{1}{\ii \hbar} 
        \sum_n \gamma^{(0)}_n W_{kn} \ee^{\ii \omega_{kn}} \cos \omega t  \\
        &= \frac{1}{2 \ii \hbar} \sum_n 
        W_{kn} \gamma_n^{(0)} (
            \ee^{\ii (\omega_{kn} + \omega) t} 
            + \ee^{\ii (\omega_{kn} - \omega) t }
        ),
    \end{aligned}
\end{equation}
and the equation can then be solved directly 
since $\gamma_n^{(0)}$ is a constant.
An important approximation is 
\concept{rotating wave approximation (RWA)},
in which we ignore the term $\ee^{\ii (\omega + \omega_{kn}) t}$;
this is a good approximation
when 
\begin{equation}
    \abs*{\omega + \omega_{kn}} \gg \abs*{\omega + \omega_{kn}},
\end{equation}
or in other words when 
the pumping $\vb*{E} = \vb*{E}_0 \cos \omega t$ 
is nearly resonant.
Basically, in RWA we are extracting the \emph{envelope} 
of $\gamma_k^{(1)}$, 
since ignoring the fast oscillating term in a function $f(t)$
is equivalent to replacing $f(t)$ by 
\begin{equation}
    \tilde{f}(t) = \frac{1}{T} \int_{t - T/2}^{t + T/2} f(t') \dd{t'},
\end{equation}
where $T$ is much larger than the period of the fast oscillation.

Now after RWA, we find 
\begin{equation}
    \begin{aligned}
        \gamma^{(1)}_{k}(T) &= \frac{1}{2 \ii \hbar} 
            \sum_n W_{kn} \gamma^{(0)}_n
            \frac{1}{\ii (\omega_{kn} - \omega)}
            \eval{
                \ee^{\ii (\omega_{kn} - \omega) t} 
            }_{0}^T  \\
        &= T \cdot \frac{1}{\ii \hbar} \sum_n 
            W_{kn} \gamma^{(0)}_n \ee^{\ii \Delta \omega T / 2} 
            \sinc(\Delta \omega T / 2),
    \end{aligned} 
\end{equation}
where 
\begin{equation}
    \omega = \omega_k - \omega_n - \omega.
\end{equation}
Therefore we find the probability to s
\begin{equation}
    P_{n \to k}(t) = 
\end{equation}
The final result is the famous Fermi golden rule
\begin{equation}
    P_{n \to k} (t) = t \cdot \frac{2\pi}{\hbar} \abs*{W_{kn}}^2 (\gamma^{(0)}_n)^2 
    \delta_T(\omega_k - \omega_n - \omega).
\end{equation}
We see expectedly that the transition probability reaches its maximum  
when the pumping is resonant.
The fact that we have a sinc function profile of the transition probability 
comes from the finite length of the driving field:
from the mathematical uncertainty relation,
when the pumping pulse has a finite length, 
we don't have a completely well-defined $\omega$,
and the sinc shape comes from the  
Fourier transform of the finite length sine wave.

If we reflect on Fermi golden rule for a while, 
we find something not that physical: 
the spectrum of the final states may be discrete, 
and in this case the $\delta$ function looks suspicious:
for continuous modes the final state spectrum is continuous 
and by saying we sum over final states 
we are actually integrating over the final states, 
so no singular function enters the final result 
of scattering probability;
but for discrete systems this is not true.
This is actually a motivation for quantization of the electromagnetic field
for this provides us with a continuous energy spectrum 
of the composite system of matter and light.

Now we consider radiation from the atom.
This means we should consider the $\omega < 0$ term 
which contributes to the amplitude of states with lower energies.
We do a reverse RWA and ignore the $\ee^{\ii (\omega_{kn} - \omega) t}$ term.

The dipole can also be evaluated from the perturbed wave function.
We have 
\begin{equation}
    \begin{aligned}
        \expval*{\vb*{\mu}}{\psi} &= 
            (\bra*{\psi^{(0)}} + \lambda \bra*{\psi^{(1)}} + \lambda^2 \bra*{\psi^{(2)}} + \cdots)
            \vb*{\mu} (\ket*{\psi^{(0)}} + \lambda \ket*{\psi^{(1)}} + \lambda^2 \ket*{\psi^{(2)}} + \cdots) \\
        &= \underbrace{
            \expval*{\vb*{\mu}}{\psi^{(0)}}
        }_{\expval{\vb*{\mu}}^{(0)}}  + 
        \underbrace{
            \mel*{\psi^{(0)}}{\vb*{\mu}}{\psi^{(1)}} + \text{c.c.}
        }_{\expval*{\vb*{\mu}}^{(1)}} + \cdots,
    \end{aligned}
\end{equation} 
and we can then find the response of the atom dipole to the electric field.
When we are doing this actually we already have to 
slightly deviate from the standard semiclassical coupling theory,
or otherwise when $\omega = \omega_{\text{eg}}$, 
the response is infinite.
The physical answer is spontaneous radiation.

The above procedure can also be seen as a procedure 
to integrate out the atomic degrees of freedom and  
obtain an effective theory of the light field.

\todo{Study dissipation and noise here; todo: spontaneous radiation; 
what's the difference between spontaneous radiation and 
the radiation shown here?}

\section{Elaboration on perturbation schemes}

Suppose we have an \emph{anhamornic} oscillator, 
and the EOM is 
\begin{equation}
    m \ddot{x} + m \omega_0^2 x = - \beta x^2,
\end{equation}
or in other words 
\begin{equation}
    \ddot{x} + \omega_0^2 x = \underbrace{
        - \frac{\beta}{m}
    }_{\eqqcolon \alpha} x^2.
\end{equation}
Of course, when $\alpha = 0$, we go back to the harmonic case.
This equation falls into the scheme 
\begin{equation}
    L x = \lambda N x,
\end{equation}
where $L$ is a linear operator 
and $N$ is the nonlinear, ``interacting'' part.
The perturbation series
\begin{equation}
    x(t) = x_0(t) + \lambda x_1(t) + \cdots 
\end{equation} 
then gives 
\begin{equation}
    \ddot{x}_0 + \omega_0^2 x_0 = 0,
\end{equation}
\begin{equation}
    \ddot{x}_1 + \omega_0^2 x_1 = \alpha x_0^2, 
\end{equation}
\begin{equation}
    \ddot{x}_2 + \omega_0^2 x_2 = \alpha x_0 x_1, 
\end{equation}
and so on. $x_1(t)$ takes the $\cos (2 \omega t)$ form,
or from Feynman diagram it represents SHG from two excitons with frequency $\omega$ 
into one exciton with frequency $2 \omega$.

In the case of a unitary $x^3$ term in the Hamiltonian,
the perturbation theory seems to work fine; 
but now if we treat \emph{damping} in the damped oscillator as a perturbation item,
we get a pathological solution 
which \emph{diverges} and doesn't converge,
although the accuracy in the first several periods is good.
This shows the limit of perturbation theory.

The solution of 
\begin{equation}
    \ddot{a} + \gamma a + \omega_0^2 a = 0 
\end{equation}
is 
\begin{equation}
    a(t) = a_0 \ee^{- \ii \omega_\pm t} ,
\end{equation}
where 
\begin{equation}
    \omega_\pm = \pm \sqrt{
        \omega_0^2 - \left(\frac{\gamma}{2}\right)^2
    } - \ii \frac{\gamma}{2},
\end{equation}
where we observe an envelope 
\begin{equation}
    \expval{a}(t) = a_0 \ee^{- \gamma t / 2}
\end{equation}
under which we see a fast oscillation
with its frequency modified by damping.
When damping is strong compared with $\omega_0$,
it's hard to separate the two, 
but when damping is not that strong, 
separation between damping and oscillation -- 
or more generally, separation between two time scales -- is possible,
and the oscillation shouldn't be too different from $\ee^{- \ii \omega_0 t}$.

With this in mind, assuming that $\gamma / \omega_0 \ll 1$,
and rewriting the equation as 
\begin{equation}
    \ddot{a} + \varepsilon \gamma a + \omega_0^2 a = 0,
    \label{eq:double-time-damping-eq}
\end{equation}
where $\varepsilon$ is a unitless constant 
for bookkeeping purpose,
we write down the ansatz 
\begin{equation}
    a(t) = \bar{a}(
        \underbrace{\varepsilon t}_{\eqqcolon \tau}
    ) \ee^{- \ii \omega_0 t}, 
\end{equation}
which contains a fast variable $\ee^{- \ii \omega_0 t}$
and a slow variable $\bar{a}$;
the argument of $\bar{a}$ is intentionally set to $\varepsilon t$ 
to remind us that $\bar{a}$ is very dull to 
how time passes by.
In the more general case we use $f(t)$ in place of $\ee^{- \ii \omega_0 t}$.
Putting it into \eqref{eq:double-time-damping-eq},
and noticing that 
\begin{equation}
    \dot{a} = - \ii \omega_0 \bar{a} \ee^{- \ii \omega_0 t}
    + \varepsilon \dv{\bar{a}}{\tau} \ee^{- \ii \omega_0 t},
\end{equation}
and 
\begin{equation}
    \ddot{a} \approx (- \ii \omega_0)^2 \bar{a} \ee^{- \ii \omega_0 t} 
    + 2 \varepsilon (- \ii \omega_0) \ee^{- \ii \omega_0 t} \dv{\bar{a}}{\tau},
    \label{eq:ddot-a-approx}
\end{equation}
we have 
\begin{equation}
    2 \varepsilon (- \ii \omega_0) \ee^{- \ii \omega_0 t} \cdot \dot{a} \dv{\bar{a}}{\tau} 
    + \varepsilon (- \ii \omega_0) \ee^{- \ii \omega_0 t} \bar{a} = 0
    \ \Rightarrow \ \dv{\bar{a}}{\tau} + \frac{\gamma}{2} \bar{a} = 0 .
\end{equation}
This is exactly what we expect.
In this example we explicitly write $a(t)$ as the multiplication 
of $\ee^{- \ii \omega_0 t}$ and $\bar{a}(\tau)$; 
if we instead introduce $f(t)$,
we will find the equation it follows 
is just the harmonic oscillator equation.
Finally, we replace $\varepsilon \gamma$ with $\gamma$ 
to go back to the original problem,
and an approximate solution has been found. 

The most formal procedure requires us to keep track of 
every $\varepsilon$ without any ahead-of-time approximations like 
\eqref{eq:ddot-a-approx} or 
inserting the $\gamma = 0$ solution as $f(t)$ into the ansatz for $a$.
In simple calculations however people tend to only keep track of the $\bigO(\varepsilon)$ term,
and the above procedure is perfectly legit.
The idea is the fast part of the solution is usually 
not perturbed at all.
This approximation -- tracking only $\bigO(\varepsilon)$ -- 
is known as \concept{slowly varying envelope approximation}.
\todo{
    Relation with ordinary PT; RG?
}


\section{Rotating wave approximation revisited}

Consider the driven harmonic oscillator
\begin{equation}
    \ddot{a} + \omega_0^2 a = \varepsilon A \cos (\omega t),
\end{equation}
where we have assumed that the driving term is weak enough; 
of course since there is no damping, 
the amplitude will increase infinitely,
but since the driving force is small enough 
it doesn't explode fast.

The ansatz is 
\begin{equation}
    a(t) = \bar{a}(\varepsilon t) \ee^{- \ii \omega_0 t} .
\end{equation}
Substituting this into the EOM, we get 
\begin{equation}
    (- \omega_0^2 \bar{a} 
    - 2 \varepsilon \ii \omega_0 \partial_\tau \bar{a} 
    + \varepsilon^2 \partial_\tau^2 \bar{a}) \ee^{- \ii \omega_0 t}
    + \omega_0^2 \bar{a} \ee^{- \ii \omega_0 t} 
    = \varepsilon A \cos(\omega t).
\end{equation}
The $\bigO(\varepsilon)$ term is 
\begin{equation}
    -2 \ii \varepsilon \omega_0 \partial_\tau \bar{a} = \varepsilon A \cos(\omega t)
    \ \Rightarrow \ 
    \dv{\bar{a}}{t} = \frac{\ii A}{ 2 \omega_0} \cos(\omega t) \ee^{\ii \omega_0 t}.
\end{equation}
Unfortunately $\bar{a}$ still has fast oscillation,
but then we can average over time and get rid of the fast oscillation,
and the eventual result is 
\begin{equation}
    \dv{\expval{\bar{a}}}{t} = \frac{\ii A}{4 \omega_0}.
\end{equation}
To make this approximation make sense, 
we require 
\begin{equation}
    \frac{A}{4 \omega_0} \ll \omega_0   
\end{equation}
so that the increasing of the envelope is not 
of the same order of magnitude of $\omega_0$.

\section{Spontaneous emission}


We can really think of the spontaneous rate as produced 
by an effective photon flux:
the spontaneous emission rate can be rewritten as 
\begin{equation}
    R_{\text{sp}} = \sigma \cdot \frac{c}{\hbar \omega} \cdot \frac{\hbar \omega^3}{\pi c^3}.
\end{equation} 
The spontaneous emission rate can also be obtained  
by replacing the thermal photon occupation in stimulated emission with $1$.
\todo{Relation between cross section and expectation of $\vb*{p}$}

\todo{Rate equation}

\section{Coupling with a quantized EM field}

Consider an atom in a cavity.
We assume that the size of the cavity is very large, almost infinite; 
this means once a photon is emitted it almost never goes back,
and thus
\begin{itemize}
    \item we don't need to consider anything like Poincaré recurrence, 
        and can model the system as a dissipative one, and 
    \item the out state spectrum is continuous 
        and we can use Fermi golden rule.
\end{itemize}
The second point can be seen as a logical consequence of the first one,
since Fermi golden rule is somehow ``dissipative'' in nature.

\section{Interlude: quantization of LC circuit}

As a demonstration of canonical quantization, 
let's consider the quantum version of an LC circuit.
The magnetic energy is 
\begin{equation}
    U_\text{m} = \frac{1}{2} LI^2 = \frac{1}{2}L \dot{Q}^2 ,
\end{equation}
and the electric energy is 
\begin{equation}
    U_{\text{e}} = \frac{1}{2} \frac{Q^2}{C},
\end{equation}
and if we consider the former as the kinetic energy 
and the latter as the potential energy,
the Lagrangian is 
\begin{equation}
    L = \frac{1}{2} L \dot{Q}^2 - \frac{Q^2}{2C},
\end{equation}
and we can easily find that this Lagrangian gives the correct EOM.
Going to the Hamiltonian formalism, 
after a Legendre transform we get 
\begin{equation}
    H = \frac{\Phi^2}{2L} + \frac{1}{2} \frac{Q^2}{C},
\end{equation}
where $\Phi$ is the canonical momentum of $Q$, i.e. 
\begin{equation}
    \Phi \coloneqq \pdv{L}{\dot{Q}} = L \dot{Q}.
\end{equation}
Of course $\Phi$ has its own physical meaning:
the magnetic flux.
Applying canonical commutation relation 
\begin{equation}
    \comm*{Q}{\Phi} = \ii \hbar 
\end{equation}
\todo{Deriving this from QED} we can already quantize the system.
It looks like a quantum harmonic oscillator,
also with different ``mass'' and ``spring constant''.
So the final form of the Hamiltonian,
in occupation number representation, is 
\begin{equation}
    H = \hbar \omega \left(
        a^\dagger a + \frac{1}{2}
    \right),
\end{equation}
where 
\begin{equation}
    \omega = \frac{1}{\sqrt{LC}}
\end{equation}
is the LC frequency. 

It should be noted that to implement the quantum circuit, 
ordinary metals probably won't work, 
since they contain too many other degrees of freedom 
that couple strongly with the electromagnetic degrees of freedom 
and destroy the coherence of the latter 
even when the temperature is low.
Superconducting wires are usually used in place of ordinary wires.

We are describing only one harmonic oscillator here; 
when there are many harmonic oscillators aligned in a certain way in space, 
it's possible to define a \emph{field operator} $\hat{\phi}(\vb*{r}, t)$,
where $\vb*{r}$ is equivalent to the label of harmonic oscillators,
and the time evolution is treated in the same way 
as in ordinary canonical quantization.

Let's consider the electric and magnetic field in the LC circuit.
It can be verified that 
\begin{equation}
    \vb*{E}(\vb*{r}) = \underbrace{
        \bar{\vb*{E}}(\vb*{r})  \sqrt{
        \frac{\hbar}{2 \omega_0}
        }
    }_{\vb*{E}^0(\vb*{r})} (a^\dagger_{\vb*{q}} + a_{\vb*{q}}),
\end{equation}
and 
\begin{equation}
    \vb*{B}(\vb*{r}) = \underbrace{
        \bar{\vb*{B}}(\vb*{r}) \ii \sqrt{
            \frac{\hbar \omega_0}{2} 
        } 
    }_{\vb*{B}^0(\vb*{r})} ( 
        a^\dagger_{\vb*{q}} - a_{\vb*{q}}
    ).
\end{equation}
As a simple demonstration let's assume that 
there is no non-trivial polarization in the circuit:
thus we can treat $\vb*{E}$ and $\vb*{B}$ as scalars 
in \emph{this} case.
Normalization of $\vb*{E}^0$ and $\vb*{B}^0$ 
can be decided by evaluating the total energy:
we expect to get 
\begin{equation}
    \expval{U_\text{e}} + \expval{U_\text{m}} = \frac{1}{2} \hbar \omega_0    
\end{equation}
when we are at the ground state.
We can easily verify that the consequence of this equation is 
\begin{equation}
    \epsilon_0 \int \dd[3]{\vb*{r}} \abs*{\vb*{E}^0(\vb*{r})} = \frac{1}{2} \hbar \omega_0.
\end{equation}
When the shape of our system is not very nontrivial and we can essentially treat it 
as a box with volume $V$ in which $\abs*{\vb*{E}^0(\vb*{r})}$
is completely uniform, this tells us 
\begin{equation}
    E^0(\vb*{r}) = \sqrt{\frac{\hbar \omega_0}{2 \epsilon_0 V}}.
\end{equation}
So the electric field operator for only one mode in a large box is 
\begin{equation}
    \vb*{E}(\vb*{r}) = \vu*{z} \sqrt{\frac{\hbar \omega_0}{2 \epsilon_0 V}} (a^\dagger + a).
    \label{eq:electric-field-one-mode}
\end{equation}

\section{Cavity light field modes and two-level atom}

In principle \eqref{eq:electric-field-one-mode} should be summed over 
to get the full electric field operator.
But in real experimental settings 
the only active degrees of freedom in a system 
are two energy levels of an atom and one EM mode,
and the Hamiltonian becomes 
\begin{equation}
    H = E_\text{g} \dyad{\text{g}} + E_{\text{e}} \dyad{\text{e}} 
    - \vb*{\mu} \cdot \vb*{E} 
    + \hbar \omega_0 (a^\dagger a + 1/2),
\end{equation}
where $\vb*{E}$ is given by \eqref{eq:electric-field-one-mode}.
The wave function is already huge: 
the Hilbert space of the cavity part is countably infinite.
We can analyze possible transitions by calculating 
\begin{equation}
    \mel**{\text{final}}{- \mu E_0 \cos \theta (a + a^\dagger)}{\text{initial}}.
\end{equation} 
The transition between $\ket*{\text{g}, n = 1}$ and $\ket*{\text{e}, n = 0}$,
for example, gives us Rabi oscillation.
\todo{
    When the light field is in a coherent state, 
    we also have Rabi oscillation.
    Explore the situation under which we have Rabi frequency;
    especially if it has anything to do with MBPT.
}
It's impossible to get spontaneous decay in this model, 
because the number of optical modes is not large enough;
we can find spontaneous decay when there are lots of $a_{\vb*{q}}$.

\section{Quantization of field}

Now we consider the complete electric field operator.
We assume it's the sum of something like \eqref{eq:electric-field-one-mode},
where $a$ may be any annihilation operator 
corresponding to an oscillation mode of the system 
treated as a quantum oscillator,
and $\vu*{z}$ needs to be replaced by the true polarization vector $\vu*{f}$, 
which may also contain phase factors like $\ee^{\ii \vb*{k} \cdot \vb*{r}}$,
with the same normalization
\begin{equation}
    \int \dd[3]{\vb*{r}} \abs*{\vu*{f}(\vb*{r})}^2 = V.
\end{equation} 
Note that the equivalence of this quantization 
and the ``real'' canonical quantization 
by imposing commutation relations on $\vb*{A}$ 
is not guaranteed a priori, but is indeed true.
\todo{
    Commutation relation between $\vb*{E}$ and $\vb*{B}$
}
The interaction between light and a two-level atom is then modeled by 
\begin{equation}
    H = H_{\text{atom}} - \vb*{\mu} \cdot \vb*{E} + \hbar  \sum_k \omega_k \left(
        a^\dagger_k a_k + \frac{1}{2}
    \right).
\end{equation}
The basis of the Hilbert space is 
\begin{equation}
    \{
        \ket*{
            \text{atom}, \underbrace{
                n_1, n_2, \ldots, n_k, \ldots
            }_{\text{light}, \{n_i\}} 
        }
    \}.
    \label{eq:complete-light-mattery}
\end{equation}
The dipole interaction term still 
changes one photon occupation number by 1 at once; 
but now an excited state can evolve into many 
one-photon final states, 
and we will see we will get exponential decay 
of the atomic occupation. 

\section{Spontaneous emission in vacuum}

Now we finally can have a quantitative description 
of spontaneous emission.
The complete Hamiltonian is 
\begin{equation}
    H = H_{\text{two level atom}} + \sum_{\vb*{k}} \hbar \omega_{\vb*{k}} \left(
        a^\dagger_{\vb*{k}} a_{\vb*{k}} + \frac{1}{2}
    \right) - \sum_{\vb*{k}} \vb*{\mu} \cdot \vb*{E}_0 \ii (a^\dagger_{\vb*{k}} - a_{\vb*{k}}).
\end{equation}
Consider only the single-photon process, 
we confine \eqref{eq:complete-light-mattery} to 
the subspace where there is at most one photon in the system.
The total transition rate, 
i.e. the probability for an excited atom to emit one photon 
and goes back to the ground state, is the sum of  
the transition rates of all radiation channels. 
So we have 
\begin{equation}
    \begin{aligned}
        P_{\text{e} \to \text{g}} 
        &= \sum_{\vb*{k}} \frac{2\pi}{\hbar^2} \abs*{W_{\text{e} \to \text{g}, \vb*{k}}}^2 
        \delta(\omega_{\vb*{k}} - \omega_{\text{eg}})  \\
        &= \frac{2\pi}{\hbar^2} \abs*{W}^2 D(\omega_{\text{eg}}),
    \end{aligned}
\end{equation}
where we have assumed that the wave vector of the output photon $\vb*{k}$ 
has little influence on the transition amplitude $W_{\text{e} \to \text{g}, \vb*{k}}$
(this assumption of course fails in highly anistropic systems, 
like photonic crystals),
and $D(\omega)$ is the density of states of EM modes. 
When $\vb*{k}$ does have a strong influence on $W$, 
we need to rewrite $W$ into 
\begin{equation}
    W_{\text{e} \to \text{g}, \vb*{k}} = W(\omega_{\vb*{k}}, \vu*{k}),
\end{equation}
and the transition probability becomes 
\begin{equation}
    P_{\text{e} \to \text{g}} = 
    \frac{2\pi}{\hbar^2} 
    \int \frac{\dd{\Omega}}{4\pi} \abs*{W(\omega_{\text{eg}}, \vu*{k})}^2 D(\omega_{\text{eg}}),
\end{equation}
where $\dd{\Omega}$ is the solid angle element of $\vu*{k}$.

In free space, we have 
\begin{equation}
    \abs*{W}^2 = \abs*{\mu_{\text{eg}}}^2 \abs*{E_0}^2 \cos^2 \theta
    = \frac{\hbar \omega}{2 \epsilon_0 V} \abs*{\mu_{\text{eg}}}^2 \cos^2 \theta.
\end{equation}
The DOS of light is 
\begin{equation}
    D(\omega) = \frac{V}{2 \pi^2} \frac{\omega^2}{c^3}.
    \label{eq:dos-free-space}
\end{equation}
We can verify that 
\begin{equation}
    \int \frac{\dd{\Omega}}{4\pi} \cos^2 \theta = \frac{1}{3},
\end{equation}
and we still have double degeneracy of polarization.
The final transition rate is 
\begin{equation}
    \begin{aligned}
        \Gamma_{\text{e} \to \text{g}} &= 
        2 \cdot \frac{2\pi}{\hbar^2} \cdot \frac{\hbar \omega}{2 \epsilon_0 V} \abs*{\mu_{\text{eg}}}^2 \cdot \frac{1}{3} \cdot \frac{V}{2 \pi^2} \frac{\omega^2}{c^3} \\
        &= \frac{
            \omega^3 \abs*{\mu_{\text{eg}}}^2
        }{
            3 \pi \epsilon_0 \hbar c^3
        }.
    \end{aligned}
\end{equation}

It's possible that we also have a continuum of \emph{initial} states:
in this case we need to sum over initial states as well,
resulting in a joint density of states. 

The decay rate also gives an uncertainty of the energy levels.

In the analysis above we consider the optical modes 
to which photons are spontaneously emitted 
as outside the degrees of freedom of interest; 
when we turn to analyze the behavior of the spontaneously emitted photons, 
the following facts are worth noting.
First, the electric field component of the relevant mode 
looks like a noise: its expectation is zero, 
but $\expval{E(t) E(0)}$ is non-zero.
However, details about $\expval{E(t) E(0)}$ 
-- which gives us the power spectrum of spontaneous emission -- 
cannot be retrieved from the imaginary part of the linear polarizability $\chi$: 
the noise related to the damping in linear optics 
are the noise in $D = \epsilon E$, 
i.e. photon modes that are of interest in the analysis above, 
\emph{not} the target photon modes of spontaneous emission; 
and the noise comes from photons radiated by thermally generated dipoles.
Strictly speaking this kind of noise is still spontaneous emission, 
but it is not ``spontaneous emission after driving''.

To further see why spontaneous emission is outside the single-photon effective theory,
note that if we draw a Feynman diagram for $\expval{E(t) E(0)}$ in spontaneous emission,
we have (note that we don't sum over the index of the gray lines: 
we shouldn't, because we need their details)
\begin{equation}
    \sum _{k,k'}\tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,67);\path (168.8000030517578,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da8603488317755186] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (100.5,6.05) .. controls (102.17,7.72) and (102.17,9.38) .. (100.5,11.05) .. controls (98.83,12.72) and (98.83,14.38) .. (100.5,16.05) .. controls (102.17,17.72) and (102.17,19.38) .. (100.5,21.05) .. controls (98.83,22.72) and (98.83,24.38) .. (100.5,26.05) .. controls (102.17,27.72) and (102.17,29.38) .. (100.5,31.05) .. controls (98.83,32.72) and (98.83,34.38) .. (100.5,36.05) .. controls (102.17,37.72) and (102.17,39.38) .. (100.5,41.05) .. controls (98.83,42.72) and (98.83,44.38) .. (100.5,46.05) .. controls (102.17,47.72) and (102.17,49.38) .. (100.5,51.05) -- (100.5,52.8) -- (100.5,52.8) ;
    %Straight Lines [id:da6393318674507893] 
    \draw    (100.5,52.8) -- (145,52.8) ;
    \draw [shift={(125.95,52.8)}, rotate = 180] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da6533530768184097] 
    \draw    (100.5,52.8) -- (59,52.8) ;
    \draw [shift={(84.45,52.8)}, rotate = 180] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da47313052320978777] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (92.5,42.05) -- (92.5,19.8) ;
    \draw [shift={(92.5,16.8)}, rotate = 90] [fill={rgb, 255:red, 155; green, 155; blue, 155 }  ,fill opacity=1 ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da29832989815991584] 
    \draw    (59,52.8) -- (17.5,52.8) ;
    \draw [shift={(42.95,52.8)}, rotate = 180] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da7724964546542064] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (59,6.05) .. controls (60.67,7.72) and (60.67,9.38) .. (59,11.05) .. controls (57.33,12.72) and (57.33,14.38) .. (59,16.05) .. controls (60.67,17.72) and (60.67,19.38) .. (59,21.05) .. controls (57.33,22.72) and (57.33,24.38) .. (59,26.05) .. controls (60.67,27.72) and (60.67,29.38) .. (59,31.05) .. controls (57.33,32.72) and (57.33,34.38) .. (59,36.05) .. controls (60.67,37.72) and (60.67,39.38) .. (59,41.05) .. controls (57.33,42.72) and (57.33,44.38) .. (59,46.05) .. controls (60.67,47.72) and (60.67,49.38) .. (59,51.05) -- (59,52.8) -- (59,52.8) ;
    %Straight Lines [id:da1002469734312903] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (51.5,37.05) -- (51.5,14.8) ;
    \draw [shift={(51.5,40.05)}, rotate = 270] [fill={rgb, 255:red, 74; green, 144; blue, 226 }  ,fill opacity=1 ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    % Text Node
    \draw (15.5,52.8) node [anchor=east] [inner sep=0.75pt]    {$k$};
    % Text Node
    \draw (147,52.8) node [anchor=west] [inner sep=0.75pt]    {$k'$};
    \end{tikzpicture}
    \simeq \tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,156);\path (100,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da23347113107765405] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (25,9) .. controls (26.67,10.67) and (26.67,12.33) .. (25,14) .. controls (23.33,15.67) and (23.33,17.33) .. (25,19) .. controls (26.67,20.67) and (26.67,22.33) .. (25,24) .. controls (23.33,25.67) and (23.33,27.33) .. (25,29) .. controls (26.67,30.67) and (26.67,32.33) .. (25,34) .. controls (23.33,35.67) and (23.33,37.33) .. (25,39) .. controls (26.67,40.67) and (26.67,42.33) .. (25,44) .. controls (23.33,45.67) and (23.33,47.33) .. (25,49) .. controls (26.67,50.67) and (26.67,52.33) .. (25,54) -- (25,55.75) -- (25,55.75) ;
    %Straight Lines [id:da8309528818089311] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (81,9) .. controls (82.67,10.67) and (82.67,12.33) .. (81,14) .. controls (79.33,15.67) and (79.33,17.33) .. (81,19) .. controls (82.67,20.67) and (82.67,22.33) .. (81,24) .. controls (79.33,25.67) and (79.33,27.33) .. (81,29) .. controls (82.67,30.67) and (82.67,32.33) .. (81,34) .. controls (79.33,35.67) and (79.33,37.33) .. (81,39) .. controls (82.67,40.67) and (82.67,42.33) .. (81,44) .. controls (79.33,45.67) and (79.33,47.33) .. (81,49) .. controls (82.67,50.67) and (82.67,52.33) .. (81,54) -- (81,55.75) -- (81,55.75) ;
    %Straight Lines [id:da14496180898607114] 
    \draw    (25,55.75) -- (81,55.75) ;
    \draw [shift={(56.2,55.75)}, rotate = 180] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da16161857218464348] 
    \draw    (81,55.75) -- (81,100.75) ;
    \draw [shift={(81,81.45)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da24549891920992484] 
    \draw    (25,55.75) -- (25,100.75) ;
    \draw [shift={(25,73.55)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da9136670820313375] 
    \draw    (25,100.75) -- (81,100.75) ;
    \draw [shift={(48.3,100.75)}, rotate = 0] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da8410315515696014] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (17,45) -- (17,22.75) ;
    \draw [shift={(17,19.75)}, rotate = 90] [fill={rgb, 255:red, 155; green, 155; blue, 155 }  ,fill opacity=1 ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da6228200950917102] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (90,42) -- (90,19.75) ;
    \draw [shift={(90,45)}, rotate = 270] [fill={rgb, 255:red, 155; green, 155; blue, 155 }  ,fill opacity=1 ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da4243654183226879] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (25,100.75) .. controls (27.3,101.26) and (28.19,102.67) .. (27.68,104.97) .. controls (27.17,107.27) and (28.06,108.68) .. (30.36,109.19) .. controls (32.66,109.7) and (33.55,111.11) .. (33.04,113.41) .. controls (32.53,115.71) and (33.42,117.12) .. (35.72,117.63) .. controls (38.02,118.15) and (38.91,119.56) .. (38.4,121.86) .. controls (37.89,124.16) and (38.78,125.57) .. (41.08,126.08) .. controls (43.38,126.59) and (44.27,128) .. (43.76,130.3) .. controls (43.25,132.6) and (44.14,134.01) .. (46.44,134.52) .. controls (48.74,135.03) and (49.63,136.44) .. (49.12,138.74) .. controls (48.61,141.04) and (49.5,142.45) .. (51.8,142.96) .. controls (54.1,143.47) and (54.99,144.88) .. (54.48,147.18) -- (55,148) -- (55,148) ;
    %Straight Lines [id:da5610378368041893] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (81,100.75) .. controls (81.66,103.02) and (80.86,104.48) .. (78.59,105.13) .. controls (76.32,105.78) and (75.52,107.24) .. (76.18,109.51) .. controls (76.84,111.78) and (76.04,113.24) .. (73.77,113.89) .. controls (71.5,114.54) and (70.7,116) .. (71.36,118.27) .. controls (72.02,120.54) and (71.22,122) .. (68.95,122.65) .. controls (66.68,123.3) and (65.88,124.76) .. (66.54,127.03) .. controls (67.2,129.3) and (66.4,130.76) .. (64.13,131.41) .. controls (61.86,132.06) and (61.06,133.52) .. (61.72,135.79) .. controls (62.38,138.06) and (61.58,139.52) .. (59.31,140.18) .. controls (57.04,140.83) and (56.24,142.29) .. (56.9,144.56) -- (55,148) -- (55,148) ;
    %Straight Lines [id:da2978822808971151] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (55,148) ;
    \draw [shift={(55,148)}, rotate = 45] [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ][line width=0.75]    (-6.15,0) -- (6.15,0)(0,6.15) -- (0,-6.15)   ;
    \end{tikzpicture}
    \label{eq:spontaneous-emission-diagram-1}
\end{equation}
where the RHS should be understood as a lesser Green function,
and the blue lines are in modes we are interested in, 
while the gray liens are in modes of spontaneous emission.
However, if we draw a Feynman diagram for $\expval{E(t) E(0)}$ in a single-photon effective theory, 
we can only get something like this:
\begin{equation}
    \tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,121);\path (100,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da10212137219706907] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (52,109) ;
    \draw [shift={(52,109)}, rotate = 45] [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ][line width=0.75]    (-6.15,0) -- (6.15,0)(0,6.15) -- (0,-6.15)   ;
    %Curve Lines [id:da4125870351131833] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (52,109) .. controls (50.12,110.51) and (48.46,110.33) .. (47.01,108.46) .. controls (45.71,106.51) and (44.07,106.13) .. (42.1,107.31) .. controls (39.9,108.25) and (38.37,107.55) .. (37.5,105.22) .. controls (37.17,102.96) and (35.88,101.94) .. (33.64,102.17) .. controls (31.19,101.94) and (30.11,100.61) .. (30.4,98.19) .. controls (30.97,95.94) and (30.14,94.51) .. (27.93,93.91) .. controls (25.66,93) and (24.96,91.44) .. (25.85,89.23) .. controls (26.87,87.21) and (26.33,85.7) .. (24.23,84.7) .. controls (22.11,83.51) and (21.63,81.91) .. (22.78,79.9) .. controls (23.97,77.88) and (23.54,76.23) .. (21.5,74.95) -- (21.5,74.95) ;
    %Curve Lines [id:da36807391147940915] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (52,109) .. controls (53.46,107.16) and (55.11,106.91) .. (56.95,108.26) .. controls (59.12,109.37) and (60.73,108.79) .. (61.8,106.53) .. controls (62.28,104.32) and (63.65,103.4) .. (65.91,103.76) .. controls (68.31,103.74) and (69.41,102.55) .. (69.21,100.2) .. controls (68.79,97.89) and (69.72,96.45) .. (71.99,95.89) .. controls (74.25,95.16) and (74.97,93.7) .. (74.15,91.51) .. controls (73.26,89.32) and (73.92,87.69) .. (76.11,86.62) .. controls (78.19,85.75) and (78.72,84.19) .. (77.71,81.94) .. controls (76.61,79.87) and (77.1,78.25) .. (79.18,77.06) -- (79.5,75.95) ;
    %Shape: Circle [id:dp6777095204516266] 
    \draw   (3,56.45) .. controls (3,46.23) and (11.28,37.95) .. (21.5,37.95) .. controls (31.72,37.95) and (40,46.23) .. (40,56.45) .. controls (40,66.67) and (31.72,74.95) .. (21.5,74.95) .. controls (11.28,74.95) and (3,66.67) .. (3,56.45) -- cycle ;
    %Shape: Circle [id:dp6570348536300394] 
    \draw   (61,57.45) .. controls (61,47.23) and (69.28,38.95) .. (79.5,38.95) .. controls (89.72,38.95) and (98,47.23) .. (98,57.45) .. controls (98,67.67) and (89.72,75.95) .. (79.5,75.95) .. controls (69.28,75.95) and (61,67.67) .. (61,57.45) -- cycle ;
    %Straight Lines [id:da7649181157539107] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (21.5,5.95) .. controls (23.17,7.62) and (23.17,9.28) .. (21.5,10.95) .. controls (19.83,12.62) and (19.83,14.28) .. (21.5,15.95) .. controls (23.17,17.62) and (23.17,19.28) .. (21.5,20.95) .. controls (19.83,22.62) and (19.83,24.28) .. (21.5,25.95) .. controls (23.17,27.62) and (23.17,29.28) .. (21.5,30.95) .. controls (19.83,32.62) and (19.83,34.28) .. (21.5,35.95) -- (21.5,37.95) -- (21.5,37.95) ;
    %Straight Lines [id:da49373991383628013] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (15,31) -- (15,8.75) ;
    \draw [shift={(15,5.75)}, rotate = 90] [fill={rgb, 255:red, 74; green, 144; blue, 226 }  ,fill opacity=1 ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da5761693455172652] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (87,29) -- (87,6.75) ;
    \draw [shift={(87,32)}, rotate = 270] [fill={rgb, 255:red, 74; green, 144; blue, 226 }  ,fill opacity=1 ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da4663518296724336] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (79.5,6.95) .. controls (81.17,8.62) and (81.17,10.28) .. (79.5,11.95) .. controls (77.83,13.62) and (77.83,15.28) .. (79.5,16.95) .. controls (81.17,18.62) and (81.17,20.28) .. (79.5,21.95) .. controls (77.83,23.62) and (77.83,25.28) .. (79.5,26.95) .. controls (81.17,28.62) and (81.17,30.28) .. (79.5,31.95) .. controls (77.83,33.62) and (77.83,35.28) .. (79.5,36.95) -- (79.5,38.95) -- (79.5,38.95) ;
    %Straight Lines [id:da913237493536206] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (29.5,39.95) .. controls (31.17,41.62) and (31.17,43.28) .. (29.5,44.95) .. controls (27.83,46.62) and (27.83,48.28) .. (29.5,49.95) .. controls (31.17,51.62) and (31.17,53.28) .. (29.5,54.95) .. controls (27.83,56.62) and (27.83,58.28) .. (29.5,59.95) .. controls (31.17,61.62) and (31.17,63.28) .. (29.5,64.95) .. controls (27.83,66.62) and (27.83,68.28) .. (29.5,69.95) -- (29.5,71.95) -- (29.5,71.95) ;
    %Straight Lines [id:da5667062580372724] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (87.5,40.95) .. controls (89.17,42.62) and (89.17,44.28) .. (87.5,45.95) .. controls (85.83,47.62) and (85.83,49.28) .. (87.5,50.95) .. controls (89.17,52.62) and (89.17,54.28) .. (87.5,55.95) .. controls (85.83,57.62) and (85.83,59.28) .. (87.5,60.95) .. controls (89.17,62.62) and (89.17,64.28) .. (87.5,65.95) .. controls (85.83,67.62) and (85.83,69.28) .. (87.5,70.95) -- (87.5,72.95) -- (87.5,72.95) ;
    \end{tikzpicture}
    \label{eq:spontaneous-emission-diagram-2}
\end{equation}
The substantial difference between the two is that in the first diagram \eqref{eq:spontaneous-emission-diagram-1}, 
the in- and out-photon lines are connected by electron lines, 
while in the second diagram they are not.

The question then becomes
``in what effective theory of light in medium can we calculate the spectrum of spontaneous emission 
without knowing details of the medium''.
It definitely could be modeled as the noise generated in \emph{driven matter},
where the mode of the external field is not included in the degrees of freedom of interest:
and indeed that's what is done in the two Feynman diagrams above (where the driving electromagnetic field are treated as external lines),
since the RHS in \eqref{eq:spontaneous-emission-diagram-1}
can be understood as the usual ``photon-radiatively corrected electron-hole-photon'' diagram 
where the radiation correction to the electron comes from an external source.
This is also what is done in Daniel Adam Steck's famous lecture notes, Sec 5.7,
where $\expval{E(0) E(t)}$ from a driven atom is named ``spectrum of resonance fluorescence''; 
note that $S(\omega)$ in the RHS of (5.265) contains $\Omega$ 
(see Sec. 5.7.1), 
and therefore has implicitly considered the influence of the driving electric field.
Also note that in $S(\omega)$ we see $\Gamma$ as well -- 
the atom propagators are still modified by the virtue photon emission and absorption, 
and we indeed get an imaginary part because of spontaneous emission.
If we want to capture radiation of atoms excited by other spontaneously emitted photon,
we just add another term to the RHS of \eqref{eq:spontaneous-emission-diagram-1} 
where the blue external lines 
are replaced by the interactively corrected gray line.
The resulting formalism is a radiation transfer equation (RTE) with external source:
all diagrams with external driving lines 
(including \eqref{eq:spontaneous-emission-diagram-2}, 
but the top two lines should be gray not blue)
are classified as ``source'', 
and diagrams that don't -- like the RHS \eqref{eq:spontaneous-emission-diagram-1}
with the blue external lines replaced by a gray propagator -- 
are corrections to $\epsilon$ appearing in terms like $\grad_{\vb*{q}} \omega_{\vb*{q}}$ in RTE.
Here again driven spontaneous emission is not included as a part of $\epsilon$,
but rather as a renormalization of the source of ``gray'' photons.

It seems we can also build a radiation transfer equation that 
\emph{includes} the photon modes of the external driving,
by doing the following substitution:
\[
    \tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,36);\path (81.33333587646484,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da24073990199033957] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (6,18.75) .. controls (7.67,17.08) and (9.33,17.08) .. (11,18.75) .. controls (12.67,20.42) and (14.33,20.42) .. (16,18.75) .. controls (17.67,17.08) and (19.33,17.08) .. (21,18.75) .. controls (22.67,20.42) and (24.33,20.42) .. (26,18.75) .. controls (27.67,17.08) and (29.33,17.08) .. (31,18.75) .. controls (32.67,20.42) and (34.33,20.42) .. (36,18.75) -- (38.83,18.75) -- (38.83,18.75) ;
    %Straight Lines [id:da9186849425412857] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (38.83,18.75) ;
    \draw [shift={(38.83,18.75)}, rotate = 45] [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ][line width=0.75]    (-6.15,0) -- (6.15,0)(0,6.15) -- (0,-6.15)   ;
    %Straight Lines [id:da7293116761570373] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (38.83,18.75) .. controls (40.5,17.08) and (42.16,17.08) .. (43.83,18.75) .. controls (45.5,20.42) and (47.16,20.42) .. (48.83,18.75) .. controls (50.5,17.08) and (52.16,17.08) .. (53.83,18.75) .. controls (55.5,20.42) and (57.16,20.42) .. (58.83,18.75) .. controls (60.5,17.08) and (62.16,17.08) .. (63.83,18.75) .. controls (65.5,20.42) and (67.16,20.42) .. (68.83,18.75) -- (71.67,18.75) -- (71.67,18.75) ;
    \end{tikzpicture}
    \longrightarrow \tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,36);\path (72.66667175292969,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da6692646917839522] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (6,18.75) .. controls (7.67,17.08) and (9.33,17.08) .. (11,18.75) .. controls (12.67,20.42) and (14.33,20.42) .. (16,18.75) .. controls (17.67,17.08) and (19.33,17.08) .. (21,18.75) .. controls (22.67,20.42) and (24.33,20.42) .. (26,18.75) .. controls (27.67,17.08) and (29.33,17.08) .. (31,18.75) .. controls (32.67,20.42) and (34.33,20.42) .. (36,18.75) .. controls (37.67,17.08) and (39.33,17.08) .. (41,18.75) .. controls (42.67,20.42) and (44.33,20.42) .. (46,18.75) .. controls (47.67,17.08) and (49.33,17.08) .. (51,18.75) .. controls (52.67,20.42) and (54.33,20.42) .. (56,18.75) .. controls (57.67,17.08) and (59.33,17.08) .. (61,18.75) -- (62.22,18.75) -- (62.22,18.75) ;
    \end{tikzpicture}
\]
where the photon propagator in the RHS is again a lesser Green function.
We can see that in the two aforementioned formalisms, 
spontaneous emission no longer looks like a dissipation channel or some mixed state thing,
and that's expected since we are not throwing away any degree of freedom.
Also, the resulting formalisms are about two-point $G^<$ only, 
but still we are not dealing with a single-photon effective theory:
a single-photon effective theory gives EOM of $E$, not $\expval{E E}$.
The following diagram appears both in a single-photon effective theory 
and in a RTE theory that is able to describe spontaneous emission:
\[
    \tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,69);\path (169.6666717529297,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da28107982086961436] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (5.33,39.33) .. controls (7,37.66) and (8.66,37.66) .. (10.33,39.33) .. controls (12,41) and (13.66,41) .. (15.33,39.33) .. controls (17,37.66) and (18.66,37.66) .. (20.33,39.33) .. controls (22,41) and (23.66,41) .. (25.33,39.33) .. controls (27,37.66) and (28.66,37.66) .. (30.33,39.33) .. controls (32,41) and (33.66,41) .. (35.33,39.33) .. controls (37,37.66) and (38.66,37.66) .. (40.33,39.33) -- (44.83,39.33) -- (44.83,39.33) ;
    %Shape: Ellipse [id:dp4604124855148244] 
    \draw   (44.83,39.33) .. controls (44.83,28.29) and (60.95,19.33) .. (80.83,19.33) .. controls (100.72,19.33) and (116.83,28.29) .. (116.83,39.33) .. controls (116.83,50.38) and (100.72,59.33) .. (80.83,59.33) .. controls (60.95,59.33) and (44.83,50.38) .. (44.83,39.33) -- cycle ;
    %Straight Lines [id:da46495326541650495] 
    \draw [color={rgb, 255:red, 155; green, 155; blue, 155 }  ,draw opacity=1 ]   (116.83,39.33) .. controls (118.5,37.66) and (120.16,37.66) .. (121.83,39.33) .. controls (123.5,41) and (125.16,41) .. (126.83,39.33) .. controls (128.5,37.66) and (130.16,37.66) .. (131.83,39.33) .. controls (133.5,41) and (135.16,41) .. (136.83,39.33) .. controls (138.5,37.66) and (140.16,37.66) .. (141.83,39.33) .. controls (143.5,41) and (145.16,41) .. (146.83,39.33) .. controls (148.5,37.66) and (150.16,37.66) .. (151.83,39.33) -- (156.33,39.33) -- (156.33,39.33) ;
    %Curve Lines [id:da5318959295167696] 
    \draw [color={rgb, 255:red, 74; green, 144; blue, 226 }  ,draw opacity=1 ]   (56.83,24.48) .. controls (55.42,22.31) and (55.73,20.65) .. (57.76,19.5) .. controls (59.91,18.75) and (60.71,17.29) .. (60.14,15.11) .. controls (60.07,12.68) and (61.26,11.53) .. (63.69,11.66) .. controls (65.92,12.2) and (67.4,11.36) .. (68.13,9.15) .. controls (69.28,6.95) and (70.85,6.44) .. (72.86,7.63) .. controls (74.66,8.99) and (76.35,8.75) .. (77.92,6.91) .. controls (79.55,5.2) and (81.15,5.22) .. (82.74,6.97) .. controls (84.08,8.8) and (85.77,9.08) .. (87.81,7.79) .. controls (89.84,6.64) and (91.42,7.17) .. (92.54,9.39) .. controls (93.09,11.52) and (94.48,12.31) .. (96.73,11.76) .. controls (99.15,11.6) and (100.35,12.73) .. (100.33,15.14) .. controls (99.9,17.47) and (100.76,18.99) .. (102.9,19.68) .. controls (104.99,21.02) and (105.3,22.62) .. (103.83,24.48) -- (103.83,24.48) ;
    \end{tikzpicture}
\]
but in the former case, 
the blue propagator appearing in the self-energy 
is the equilibrium Green function (although renormalized),
while in the latter case, 
the blue propagator is a non-equilibrium Green function.
This is similar to the fact that time-dependent adiabatic $GW$,
despite using the single-electron $GW$ diagram as its self-energy, 
captures even more physics than BSE does 
(BSE is its linear limit).

\section{Emission into a cavity}

There is no dissipation in the EM field in vacuum,
but there may be dissipation in a cavity.
A cavity always have coupling with a continuum of degrees of freedom,
which produces what is known as dissipation 
if we keep our eyes on the cavity itself.
If we go to the example of the LC circuit,
this time connected to a semi-infinite transmission line,
which plays the role of resistance,
we will observe the same phenomenon.
In a leaky cavity we no longer have perfectly well defined frequencies, 
and when the atom is coupled to the cavity,
we need to replace the old DOS by an effective DOS 
with finite lindwidths; \todo{Derivation}
note that for each mode in the cavity (leaky or not), we always have 
\begin{equation}
    \int \dd{\omega} \text{DOS}(\omega) = 1.
\end{equation}

Now suppose we have an atom in a leaky cavity.
It has to spontaneous emission targets:
the free space (whose DOS is \eqref{eq:dos-free-space})
and the cavity modes.
Assuming that only the \emph{one} cavity mode nearby is relevant,
we have 
\begin{equation}
    D_{\text{leaky cavity}}(\omega) = \frac{1}{2\pi} \frac{
        \Delta \omega
    }{
        (\omega - \omega_0)^2 + (\Delta \omega / 2)^2
    },
\end{equation}
where $\omega_0$ is the frequency of that mode 
if there were no dissipation, 
and $\Delta \omega$ is the line width.
Defining 
\begin{equation}
    \Delta \omega \eqqcolon \frac{\omega_0}{Q},
\end{equation}
we find 
\begin{equation}
    \eta_{\text{Purcell}} \coloneqq \frac{\Gamma_{\text{cavity}}}{\Gamma_{\text{free space}}}
    \propto \frac{Q}{V} \cdot \text{something about $\omega$}.
\end{equation}
So unexpectedly, if we increase $Q$ and decrease $V$, 
we can make the atom selectively emits a photon 
whose behavior we know.
This is known as \concept{Purcell enhancement};
a Purcell device can be used as a single photon source.
Note that $Q$ shouldn't be too strong if we want to use it as a single photon source, 
or otherwise what we get is just Rabi oscillation.

\section{Population dynamics and laser}

In Beer's law we get decreasing intensity; 
if we are able to cause population inversion 
(i.e. more excited atoms than ground state atoms),
which is a highly non-equilibrium state
and always comes with pumping, 
we have \emph{gain} instead of \emph{dissipation}.
The spatial distribution now is determined by 
\begin{equation}
    \dv{I}{z} = N (\pope \sigma_{\text{e}} - \popg \sigma_{\text{g}}) I.
\end{equation}
When the scattering cross section of the excited state and the ground state is the same, 
we need $N_{\text{e}} > N_{\text{g}}$ for positive optical gain. 

Now the problem is how to cause population inversion.
A possible way is to use a four level system 
where the ``ground state'' in the population inversion subspace 
has rapid decay rate to a lower state $\ket*{\text{l}}$,
from which external light pumping brings atoms to a much higher state $\ket{\text{h}}$;
the decay rate from $\ket{\text{h}}$ to $\ket*{\text{e}}$ is also rapid,
and thus we get population inversion
between $\ket*{\text{g}}$ and $\ket{\text{e}}$.

To maximize gain, usually a laser device has the following structure:
a piece of crystal containing an energy level configuration that allows optical gain 
(like the four-level system mentioned above)
is placed in an optical cavity,
and light goes around the cavity and has gain in the round trip;
of course damping still exists 
(at, for example, the mirrors),
and the condition for laser generation 
is that the gain is larger than the loss.

The rate equation for the excited state population is 
\begin{equation}
    \dv{N_{\text{e}}}{t} = 
    \underbrace{
        - \Gamma_{\text{spontaneous radiation}} N_{\text{e}}
        - \Gamma_{\text{non-radiative}} N_{\text{e}}
    }_{- \Gamma_{\text{t}} N_{\text{e}}}
    + N_{\text{g}} R_{\text{pump}}.
\end{equation}
The pumping coefficient reads 
\begin{equation}
    R = \frac{I \sigma}{\hbar \omega},
\end{equation} 
where $I$ is the pumping intensity.
We still need to consider the rate equations for photons within the cavity.
Since the cavity is always leaky, 
we have a photon lifetime in the cavity and 
\todo{Details}

When $R$ is small, the output is just fluorescence, 
i.e. amplified spontaneous emission;
but after $R$ passes a threshold, 
the output increases $10^6$ times and laser appears.
Note that the total energy of photons in the cavity 
has saturation effect: it doesn't increase unboundedly 
when we increase $R$.

The above formalism doesn't touch the quantum state of 
the state of the output light; 
it's actually in a coherent state,
with behaviors very close to classical electromagnetic field.

\todo{
    Weird cases where the rate equation fails: 
    laser generator that doesn't have one atom inside?
}

\section{Nonlinear optics}

A spring driven hard enough no longer looks like a prototypical spring;
optical nonlinearity naturally arises if there is nonlinearity inside the medium; 
or it can appear when several input photon lines 
successively ``accelerate'' a material degree of freedom
in a Feynman diagram,
even though there is no interaction vertex in the latter.

When a scattering process is due to a linear process 
(i.e. one propagator in, one propagator out),
we have three cases:
elastic scattering, inelastic scattering, and absorption.
Elastic scattering doesn't change the internal state of the material,
and it doesn't change the energy of the photon, 
although $\vb*{k}$ can change; 
inelastic scattering changes the internal state of the material 
and changes the energy of the photon as well;
absorption eliminates the photon altogether.
\todo{
    Relation with inelastic scattering.
}
In nonlinear optics elastic scattering is also known as 
\concept{parametric process}.

\begin{figure}
    \centering
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1]
        %uncomment if require: \path (0,300); %set diagram left start at 0, and has height of 300
        
        %Straight Lines [id:da25983667214809936] 
        \draw    (95,203) -- (189.83,203) ;
        %Straight Lines [id:da9538705859744989] 
        \draw  [dash pattern={on 4.5pt off 4.5pt}]  (95,168) -- (142.42,168) ;
        %Straight Lines [id:da42270211581631045] 
        \draw  [dash pattern={on 4.5pt off 4.5pt}]  (95,133) -- (189.83,133) ;
        %Straight Lines [id:da1776425499381462] 
        \draw    (120,203) -- (120,171) ;
        \draw [shift={(120,168)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
        %Straight Lines [id:da303525394738011] 
        \draw    (120,168) -- (120,136) ;
        \draw [shift={(120,133)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
        %Straight Lines [id:da33468994886374914] 
        \draw    (165.83,200) -- (165.83,134.06) ;
        \draw [shift={(165.83,203)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
        
        % Text Node
        \draw (118,150.5) node [anchor=east] [inner sep=0.75pt]    {$\omega _{1}$};
        % Text Node
        \draw (118,185.5) node [anchor=east] [inner sep=0.75pt]    {$\omega _{1}$};
        % Text Node
        \draw (167.83,168.53) node [anchor=west] [inner sep=0.75pt]    {$\omega _{2}$};
        
        
        \end{tikzpicture}
    \caption{Energy level diagram for SHG}        
    \label{fig:shg}
\end{figure}

For \concept{second harmonic generation (SHG)}, 
the energy level diagram looks like \prettyref{fig:shg}, 
where we have two \emph{virtual} energy levels 
that are not real energy levels in the material,
and the energy conservation condition 
\begin{equation}
    \omega_1 + \omega_1 = \omega_2,
\end{equation}
and the phase matching condition
\begin{equation}
    k(\omega_1) + k(\omega_1) = k(\omega_2).
\end{equation}
The second condition is essentially the momentum conservation condition
but we refrain from using this name,
because the only thing we know about $\vb*{k}$
is that it's the wave vector; 
the true momentum flow in a material with an ongoing beam of light 
is very tricky to deal with.

Suppose we have three Fourier components $E_{1, 2, 3}$.
The electric field is 
\begin{equation}
    E = E_1 + E_2 + E_3 + \text{c.c.},
\end{equation}
and the total polarization is 
\begin{equation}
    P^{(2)} = \epsilon_0 \chi^{(2)} E E ,
\end{equation}
and, for example, the polarization with frequency $\omega_2$ is 
\begin{equation}
    \ptwo_{2} = 2 \epsilon_0 \chitwo E_1 E_3^* + \text{c.c.}
\end{equation}
$E_1$ can be seen as annihilation of one photon at mode 1, 
and $E_3^*$ can be seen as creation 
(if we are only interested in mode 2, then ``loss'') 
of one photon at mode 3; 
or, since the electromagnetic field is real, 
``annihilation of a $- \omega_2$ photon''.
Therefore we have 
\begin{equation}
    \ptwo_{2} =
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,100);\path (126,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Shape: Circle [id:dp3306811404234127] 
    \draw   (39.33,55.47) .. controls (39.33,46.15) and (46.88,38.6) .. (56.2,38.6) .. controls (65.51,38.6) and (73.06,46.15) .. (73.06,55.47) .. controls (73.06,64.78) and (65.51,72.33) .. (56.2,72.33) .. controls (46.88,72.33) and (39.33,64.78) .. (39.33,55.47) -- cycle ;
    %Straight Lines [id:da5296240459642283] 
    \draw    (20.21,20.6) .. controls (22.56,20.59) and (23.75,21.76) .. (23.77,24.11) .. controls (23.79,26.47) and (24.98,27.64) .. (27.34,27.61) .. controls (29.7,27.59) and (30.89,28.76) .. (30.91,31.12) .. controls (30.93,33.47) and (32.12,34.64) .. (34.47,34.62) .. controls (36.83,34.6) and (38.02,35.77) .. (38.04,38.13) .. controls (38.06,40.48) and (39.25,41.65) .. (41.6,41.63) -- (43.21,43.21) -- (43.21,43.21) ;
    %Straight Lines [id:da2928888332475701] 
    \draw    (22.21,83.6) .. controls (22.37,81.25) and (23.63,80.16) .. (25.98,80.32) .. controls (28.33,80.49) and (29.59,79.39) .. (29.75,77.04) .. controls (29.92,74.69) and (31.18,73.59) .. (33.53,73.76) .. controls (35.88,73.93) and (37.14,72.83) .. (37.3,70.48) .. controls (37.46,68.13) and (38.72,67.03) .. (41.07,67.2) -- (42.21,66.21) -- (42.21,66.21) ;
    %Straight Lines [id:da7321119817704607] 
    \draw    (73.06,55.47) .. controls (74.73,53.8) and (76.39,53.8) .. (78.06,55.47) .. controls (79.73,57.14) and (81.39,57.14) .. (83.06,55.47) .. controls (84.73,53.8) and (86.39,53.8) .. (88.06,55.47) .. controls (89.73,57.14) and (91.39,57.14) .. (93.06,55.47) .. controls (94.73,53.8) and (96.39,53.8) .. (98.06,55.47) -- (101.21,55.47) -- (101.21,55.47) ;
    %Straight Lines [id:da7059296554476169] 
    \draw    (31.67,18.33) -- (44.82,31.48) ;
    \draw [shift={(46.94,33.6)}, rotate = 225] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da040632101683849564] 
    \draw    (33.21,64.6) -- (22.59,72.78) ;
    \draw [shift={(20.21,74.6)}, rotate = 322.43] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da7511565889159759] 
    \draw    (80.21,48) -- (96.21,48) ;
    \draw [shift={(99.21,48)}, rotate = 180] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    % Text Node
    \draw (18.21,20.6) node [anchor=east] [inner sep=0.75pt]   [align=left] {1};
    % Text Node
    \draw (20.21,83.6) node [anchor=east] [inner sep=0.75pt]   [align=left] {3};
    % Text Node
    \draw (103.21,55.47) node [anchor=west] [inner sep=0.75pt]   [align=left] {2};
    \end{tikzpicture}
    =\tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,100);\path (122.33333587646484,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da30223211942772465] 
    \draw    (12.17,85.5) -- (107,85.5) ;
    %Straight Lines [id:da2414629403384987] 
    \draw  [dash pattern={on 4.5pt off 4.5pt}]  (65.17,50.5) -- (112.58,50.5) ;
    %Straight Lines [id:da7465700877666686] 
    \draw  [dash pattern={on 4.5pt off 4.5pt}]  (12.17,15.5) -- (107,15.5) ;
    %Straight Lines [id:da994160829255007] 
    \draw    (90.17,82.5) -- (90.17,50.5) ;
    \draw [shift={(90.17,85.5)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da46890571414486626] 
    \draw    (90.17,47.5) -- (90.17,15.5) ;
    \draw [shift={(90.17,50.5)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da23096093426901132] 
    \draw    (23,85.5) -- (23,19.56) ;
    \draw [shift={(23,16.56)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    % Text Node
    \draw (88.17,33) node [anchor=east] [inner sep=0.75pt]    {$\omega _{3}$};
    % Text Node
    \draw (88.17,68) node [anchor=east] [inner sep=0.75pt]    {$\omega _{2}$};
    % Text Node
    \draw (25,51.03) node [anchor=west] [inner sep=0.75pt]    {$\omega _{1}$};
    \end{tikzpicture}.
\end{equation}
It's possible that the final step -- creation of a photon at mode 2 -- doesn't happen:
we reach another stationary state.
In this case we get \emph{non-linear absorption}.
This is what is known as \concept{Raman effect},
and from the perspective of photons, 
it reduces the photon energy,
while from the perspective of the matter, 
it increases population on an excited state.

The next question is when the nonlinear effects are important.
Since the Taylor expansion of $P$ with respect to $E$ 
is essentially the Taylor expansion of $P$ with respect to $E / E_0$,
where $E_0$ is the characteristic field strength
-- usually the ionization field strength,
the order of magnitude of $E / E_0$ is the criterion.

\todo{
    Is there nonlinearity with quantum harmonic oscillator driven by external field?
    In the coupling Hamiltonian, we have $e x E \sim (a + a^\dagger) E$ 
    where $a$ and $a^\dagger$ controls the number of ``oscillation quantum'' of the QHO; 
    this of course is radically different from the usual picture of condensed matter field theory 
    where the matter degree of freedom is like $c_{n}$ and $c^\dagger_{n}$.
}

Miller's rule:
\begin{equation}
    \chitwo(2\omega; \omega, \omega) \propto
    \chi(2 \omega) \chi(\omega) \chi(\omega).
\end{equation}
This can be accurately derived from the anhamornic oscillator;
and it can also be seen from the structure of Feynman diagrams.

SHG is only possible when inversion symmetry is broken; 
so for a condensed matter system to show SHG, 
we need at least two atomic species.

\section{Third order nonlinearity}

Unlike second order nonlinearity,
third order nonlinearity can be found in all materials.
It has important physical consequences,
the most important ones being \concept{self-phase modulation}, 
i.e. the change of the phase according to the local intensity, 
and intensity-dependent frequency shift.
The displacement field now reads 
\begin{equation}
    D = \epsilon_0 E + P = \underbrace{
        \epsilon_0 E + \epsilon_0 \chi^{(1)} E
    }_{\epsilon_0 \epsr E} + 
    \underbrace{
    \epsilon_0 \chi^{(3)} E E E 
    }_{P_{\text{NL}}}.
\end{equation}
Here we only consider \concept{Kerr nonlinearity},
where $P_{\text{NL}}$ contains a $\omega$ component 
and a $3 \omega$ component.
Putting this back to the Maxwell's equations, we find 
\begin{equation}
    \left(
        - \partial_z^2 
        - \left(\frac{\omega}{c}\right)^2 
        (\epsr + \Delta \epsr)
    \right) \tilde{E}(\omega) = 0,
\end{equation}
where 
\begin{equation}
    \Delta \epsr = \epsilon_0 \cdot 3 \chi^{(3)} \abs*{\tilde{E}}^2.
\end{equation}
This means the effective refractive index depends on the intensity:
note that we have 
\begin{equation}
    \abs*{\tilde{E}}^2 = \frac{2 I}{c \epsilon_0 n},
\end{equation}
and therefore 
\begin{equation}
    \Delta \epsr = \frac{6 \chi^{(3)}}{\epsilon_0 c n} I.
\end{equation}

It's possible for $\chi^{(3)}$ to contain an imaginary part,
but let's forget about that at this moment;
this leads to good predictions most of the time:
as long as $3 \omega$ is too small for any 
``bright'' (i.e. has strong coupling with electromagnetic field) excitations 
in the crystal, 
$\chi^{(3)}$ is almost completely real; 
of course, when we tune $\omega$ so that $3 \omega$ 
matches an optical band gap, 
this is no longer true.
When $\chi^{(3)}$ is indeed real,
the dispersion relation now is 
\begin{equation}
    k = \frac{\omega}{c} (n + \Delta n),
\end{equation}
where 
\begin{equation}
    (n + \Delta n)^2 = \epsr + \Delta \epsr.
\end{equation}
Assuming that $\Delta \epsr$ is small, 
we have 
\begin{equation}
    2 n \Delta n = \Delta \epsr \Rightarrow 
    \Delta n = \underbrace{
        \frac{
        3 \chi^{(3)}
        }{\epsilon_0 c n^2}
    }_{\eqqcolon n_2} I.
\end{equation}

Now we consider the physical implication of $n_2$.
In linear medium we have Gaussian beam;
but in a medium with strong $\chi^{(3)}$,
for a beam of laser,
the center of the cross section has a higher refractive index, 
and the refractive profile is similar to that of an optical fiber, 
and the laser guides itself through the medium 
and keeps itself from diverging.
This is known as one kind of \concept{spatial solitons}.

The same nonlinearity also causes \concept{spectral generation}.
Suppose a pulse 
\begin{equation}
    E(t) = A(t) \ee^{\ii \phi(t)}
\end{equation}
is injected into the medium.
Then the Kerr nonlinearity contributes to the phase:
\begin{equation}
    \Delta \phi_{\text{NL}}(t) \propto \Delta n(t) \propto I(t).
\end{equation}
Now we examine how the disruption of the simple harmonic phase  
by Kerr nonlinearity contributes to the spectral distribution of the pulse:
the frequency shift is 
\begin{equation}
    \Delta \omega_{\text{NL}} = - \dot{\phi}_{\text{NL}}
    \propto \dot{I}(t),
\end{equation}
and therefore the frequency distribution is broadened 
by the oscillation of $I$;
specifically, we can indefinitely broaden the spectrum 
by increasing $I$.

The aforementioned analysis considers no dispersion; 
this is correct if we only consider a very slim film of the medium,
but for a generalized case -- like a nonlinear optical fiber -- 
dispersion makes the pulse dissolve, 
and this weakens self-phase modulation. 

We need to note that since $\chithree$ is frequency-dependent, 
so is $n_2$, and thus from Kramers-Kronig relation, 
$n_2$ has an imaginary part. 
We have 
\begin{equation}
    \Im n_2 = \frac{3 \Im \chithree}{\epsilon_0 c n^2} \eqqcolon \beta_2,
\end{equation} 
and $\beta_2$ adds a term to the absorption coefficient:
\begin{equation}
    \Delta \alpha = \beta_2 I.
\end{equation}
This is known as \concept{nonlinear absorption}.

Let's consider the semiclassical theory for nonlinear absorption.
Again, in time-dependent perturbation theory, we have 
\begin{equation}
    \expval{\vb*{\mu}}^{(3)} = \mel*{\psi^{(0)}}{\vb*{\mu}}{\psi^{(3)}}  
    + \mel*{\psi^{(1)}}{\vb*{\mu}}{\psi^{(2)}}  
    + \mel*{\psi^{(2)}}{\vb*{\mu}}{\psi^{(1)}}  
    + \mel*{\psi^{(3)}}{\vb*{\mu}}{\psi^{(0)}}  .
\end{equation}
This is the $\bigO(\lambda^3)$ term, 
and hence is proportional to $\chithree$.
\todo{Floquet state; see Eugene Merzbacher 1999 p. 509}

We can see that $\beta_2$ involves two in-coming ``photons''; 
there is no out-going lines, 
since this is not a parametric process.
Thus we can see that the relation between $\Re \chithree$ 
and $\Im \chithree$ is just the optical theorem applied on a non-linear interaction vertex:
the former comes from a four-legged diagram, 
while the second comes from a two-legged diagram.

\section{Diagrammatic techniques}

It can be seen that 
\begin{equation}
    \chitwo \sim \mel*{g}{\vb*{\mu}}{n} \mel*{n}{ \vb*{\mu}}{m} \mel*{m}{\vb*{\mu}}{g},
\end{equation}
and if we do inversion operation, 
it gains a minus sign -- but it shouldn't when the system has inversion symmetry.
So $\chitwo$ is only non-zero when the inversion symmetry is broken.
From the perspective of quantum states, 
if the system has inversion symmetry, 
then each eigenstate is in one representation of that symmetry, 
and therefore an eigenstate always has a definite parity; 
but then in order to let the first two transitions happen, 
the parities of $\ket*{g}$ and $\ket*{n}$ have to be different 
and so are the parities of $\ket*{n}$ and $\ket*{m}$,
so the parities of $\ket*{g}$ and $\ket*{m}$ have to be the same, 
and the last $\vb*{\mu}$ factor vanishes.
The inversion symmetry breaking can be achieved in a system with inversion symmetry 
if we apply a strong electric field to it:
this technique is known as \concept{EFISH}.

Note that although the usual ``energy-level'' formalism 
used in nonlinear optics textbooks 
seems to be an on-shell scheme, 
it's equivalent to the off-shell scheme of Feynman diagrams.
The equivalence can be seeing by noticing that, 
for example, in the expression of the one-loop Feynman diagram with three external lines, i.e.
\begin{equation}
    \int \frac{\dd{\omega}}{2\pi} \frac{1}{\omega - \omega_g + \ii 0^+ \sgn(\omega_g)} \frac{1}{\omega - \omega_p - \omega_m + \ii 0^+ \sgn(\omega_m)} \frac{1}{\omega - \omega_p - \omega_q - \omega_n + \ii 0^+ \sgn(n)} ,
\end{equation}
by applying the residue theorem around the three poles,
we get exactly the three terms in $\expval{\vb*{\mu}}^{(2)}$.
Note that in the last equation above, 
$g$ is also a variable that needs to be summed over, 
and $\omega_i$ is actually $\omega_i - \mu$; 
here we assume that the chemical potential of the system is between 
the ground state energy and the first excited state, 
and by using the same technique used when deriving the Lindhard response function
i.e. consider whether the three frequencies are positive or not 
and do contour integral (and also pay attention to the fact that there is only one occupied state),
we are able to get results completely identical to 
$\chi^{(2)}$ obtained from time-dependent perturbation theory 
(there might be some swaps between $p$ and $q$ 
but this has no physical consequence: 
we need to symmetrize $\chi^{(2)}$ in the end anyway).
The case here is very similar to the fact that 
off-shell ground state Feynman diagrams can be turned into equivalent 
on-shell Goldstone diagrams:
the similarity between the ground state case and the case here 
is that electron lines form closed bubble diagrams.
\todo{What about a thermal ground state?}

\section{Nonlinear wave propagation: the $\chitwo$ case}

When considering SHG, we usually apply the \concept{stiff pump approximation}: 
the pump is assumed to never damp.
From $\div{\vb*{E}} = 0$ we have 
\begin{equation}
    \left(
        - \laplacian + \frac{1}{\vp^2} \partial_t^2 
    \right) \vb*{E} = - \mu_0 \pdv[2]{\vb*{P}^{\text{NL}}}{t}.
\end{equation}
When assume that indeed $\chitwo$ is important, 
and all the waves involves propagate in the $z$ direction,
and we only consider a major frequency component at $\omega$
(i.e. the pumping beam that is assumed to be a constant along $z$ or $t$).
The total electric field reads 
\begin{equation}
    E = \underbrace{E_1^0}_{= \const.} \ee^{\ii (kz - \omega t)}
    + \underbrace{E_2^0 \ee^{\ii (2 k z - \omega t)}}_{E_2},
\end{equation}
and 

The expression of $E_2(z = L)$ contains a $\sinc$ factor, 
quite similar to the form of the transition rate; 
of course when $\Delta k = 0$, 
we have strong SHG, 
but even when the phase matching condition breaks 
we still have non-vanishing SHG response. 
This is because $k$ is not really the momentum:
it has a definite value, 
but the true momentum sees a (small but non-zero) fluctuation here 
because of the spatial variance of $A_{1, 2}$; 
the variance of momentum is $\sim 1 / L$.

\section{IR-active vibrational resonances}

In molecules we have oscillation modes; 
their generalizations in solids are phonons.
The simplest model for nucleus motion is again the harmonic oscillator:
\begin{equation}
    H_{\text{atom}} = \frac{p^2}{2m} + \frac{1}{2} m \Omega^2 (x - x_0)^2. 
\end{equation}
Here $x$ is some sort of generalized coordinate
from which we get the dipole; 
of course we have assume that if we stretch the atom, 
a dipole will just occur;
this is not the case for molecules like \ce{N2}.
$\Omega$ gives the fingerprint of the molecule.
The full Hamiltonian now reads 
\begin{equation}
    H = \hbar \omega \left(
        a^\dagger a + \frac{1}{2}
    \right) + 
    \hbar \Omega \left(
        b^\dagger b + \frac{1}{2}
    \right) - \vb*{\mu} \cdot \vb*{E}, 
\end{equation}
where 
\begin{equation}
    \vb*{\mu} = e \vb*{x} = e \vu*{x} x_0 (b^\dagger + b), \quad 
    \vb*{E} = \vu*{\epsilon} E_0 (a^\dagger + a).
\end{equation}
A caveat has to be made here: 
the real potential fields in regular molecules 
are usually highly nonlinear, 
and the separations between energy levels are highly non-uniform.
\todo{
    Relation between this and non-linear response.
}
So if we perturb the atoms strongly, 
this model is merely a toy model and has no quantitatively value; 
but in solids, phonon-phonon interaction is usually weak enough, 
and this model works just fine.
\todo{
    For IR-active phonons, the diagram for phonon-photon coupling 
    is just one photon becoming one phonon; 
    but then why this is absorption\dots
    Also, what about Raman scattering? 
    The diagram of Raman scattering seems to be 
    one photon in, one photon and one phonon out, or vice versa.
    This also could happen to acoustic phonons, right?
    Since acoustic phonons cause density waves which change $\epsilon$.
}

\section{Raman effect}

For molecules like \ce{N2} or \ce{O2},
the dipole mainly comes from electrons; 
but of course the polarizability can be controlled 
by the coordinates of the atoms.
Thus the expression of the dipole is 
\begin{equation}
    \vb*{\mu} = \alpha(q) \vb*{E} = 
    \alpha_0 \vb*{E} + \pdv{\alpha}{q} q \vb*{E} + \cdots.
\end{equation} 
Note that $q$ is the field operator of $b$ modes:
we get a vertex with two photon lines and one phonon line.
This means we are able to see two small peaks 
if a light beam with frequency $\omega$ is shed on the system:
the Stokes peak $\omega - \Omega$ 
and the anti-Stokes peak $\omega + \Omega$.

\section{Spontaneous Raman effect}

Let's first consider the Stokes effect in the low-temperature case, 
where if there are phonons in the system, 
there is only one in each mode; 
so the status of the material can be reduced to a two-level system.
In this case there is either only one $\Omega$ phonon, or no phonon at all.
Thus the Hilbert space we are interested in can be reduced to 
a three-level system:
\begin{equation}
    \begin{aligned}
        \ket*{a} &= \ket*{\text{g}} \ket*{0}, \\
        \ket*{b} &= \ket*{\text{e}} \ket*{0}, \\
        \ket*{c} &= \ket*{\text{g}} \ket*{1}.
    \end{aligned}
\end{equation}
Here the first part is about the electron 
and the second part is about atomic positions.
Spontaneous Stokes effect happens when a strong external pump field 
brings the system to somewhere near $\ket*{b}$ 
(note that it's not necessary that the pump field is resonant), 
and then after emission of the Stoke photon, 
the system goes to $\ket*{b}$.
We can also set up a similar three-level subspace for anti-Stokes effect; 
we actually can find an equation like 
\begin{equation}
    \frac{P_{\text{anti-Stokes}}}{P_{\text{Stokes}}} = \ee^{- \hbar \Omega / \kB T}.
\end{equation}

Simulated Stokes effect can be used for amplification:

\section{Parametric amplification}

Consider an LC circuit with a varying $C(t)$.
This is the analogy of a swing in circuits.
Probably this is realized by changing the distance between the plates in the capacitor:
\begin{equation}
    C(t) = \frac{\epsilon_0 A}{d(t)}.
\end{equation}
Of course, we can change $C(t)$ in such a way 
that energy is constantly injected into the system.
The logic is like this:
when most of the energy is concentrated in the electric field, 
we should decrease $C$ so 
\begin{equation}
    E_\text{e} = \frac{Q^2}{2 C} 
\end{equation}
increases the energy (note that the total charge is always conserved);
when most of the energy is concentrated in the magnetic field, 
since the electric field is irrelevant at this stage, 
we pull the capacitor back to the original position.
And then energy flows to the capacitor again.

The changing of $C(t)$ can be done mechanically; 
but of course it can also be done by putting a nonlinear dielectric 
into the capacitor.
The total field in the dielectric is the follows:
\begin{equation}
    E_{\text{total}} = E_{\text{s}} \cos \omega_0 t
    + E_{\text{p}} \cos(2\omega_0 + \phi),
\end{equation}
where s means ``signal field'' (including the electric field in the LC circuit) 
and p means ``pump'' i.e. the beam used to modulate $C(t)$, 
and $\omega_0$ is the LC frequency.
The $\chi^{(2)}$ part of the polarization that oscillates  
with frequency $\omega_0$ is 
\begin{equation}
    P_{\text{NL}} = \epsilon_0 \chi^{(2)} E_{\text{s}} E_{\text{p}},
\end{equation}
and we find that for $E_{\text{s}}$, 
the effective dielectric constant has an additional $\epsilon_0 \chi^{(2)} E_{\text{p}}$ term; 
and this correction term oscillates with frequency $\omega_0$.

\section{Difference-frequency generation (DFG)}

A DFG device accepts a $\omega_{\text{p}}$ pump wave 
and a $\omega_{\text{s}}$ signal wave 
and weakens the former, strengthens the latter, 
and creates a new $\omega_{\text{p}} - \omega_{\text{s}}$ idler wave.

After a long and tedious derivation we will find 
\begin{equation}
    \frac{1}{\omega_{\text{s}}} \dv{z} \abs*{A_\text{s}}^2 = 
    \frac{1}{\omega_{\text{i}}} \dv{z} \abs*{A_\text{i}}^2 . 
\end{equation}
This shouldn't be surprising once the process is considered from the quantum perspective:
the photon fluxes of the signal mode and the idler mode 
have to be the same.
\todo{
    What's the quantum state of the output of spontaneous DFG?
}
Since the scattering matrix between the input modes and output modes 
has the Bogoliubov form, it enables \emph{squeezing}.
Also, we can inject no signal wave at all:
in this case if the pumping is low enough, 
the output state is likely to be a 
single-signal photon, single-idler photon state; 
and if a single photon detector for the signal mode reports 
that a single signal photon is generated, 
we know we have a single idler photon created.
This can be used as a reliable single photon source.

\section{Optical phonons}

Assuming that the electric field is smooth enough in space 
and therefore $\varphi \simeq q x E$, 
we find that for a crystal with two types of atoms in one unit cell, for example,
the interaction Hamiltonian between atoms and 
\begin{equation}
    H_{\text{int}} = - q \sum_n u_n E(x_n) 
    + q \sum_n v_n E(x_n + b),
\end{equation}
where $u_n$ is the displacement field of type-1 atoms, 
and $v_n$ is the displacement field of type-2 atoms,
and $b$ is the relative position of the type-2 atom 
compared with the type-1 atom.
In order to see a large $H_{\text{int}}$, 
$u_n$ and $v_n$ should have opposite directions, 
and this happens in optical phonon modes.
From the form of the Hamiltonian we also find that 
strong interaction between phonon and photon only happens 
when the frequencies and wave vectors of the two modes match -- 
and this is not possible for acoustic phonons.

When the splitting between a phonon mode with strong coupling to light 
and a ``dark'' phonon mode 
is already larger than the damping rate, 
we say that the former has become a \concept{polariton}.
Actually the polariton dispersion relation 
can be captured \emph{without} explicitly including 
the phonon degrees of freedom into our theory:
as long as $\epsr$ is correctly obtained 
(and $\epsilon \vb*{E}^2 / 2$ contains both the vacuum energy of electromagnetic field 
and the energy of phonons), 
diagonalization of the electromagnetic Hamiltonian gives us 
all modes involving light, 
polariton modes or merely ``slightly dressed'' photons.
For example, ignoring the damping in the harmonic oscillation model, we have  
\begin{equation}
    \epsilon = \underbrace{\epsilon_{\infty}}_{\text{background}} +
    \frac{
        \omega_{\text{p}}^2
    }{
        \omega_0^2 - \omega^2
    }
\end{equation}
and the general equation 
\begin{equation}
    k^2 = \left(\frac{\omega}{c}\right)^2 \epsilon(\omega)
\end{equation}
which gives poles of the response of the electromagnetic field to external perturbation,
and defines dispersion relations of the modes,
we are able to find \emph{two} modes at each $k$,
and this splitting means polariton occurs when the damping 
in the material is small. 
Although we didn't explicitly include a phonon field in the above derivation, 
the dispersion relation of all the relevant modes are recovered from $\epsilon$,
and that's correct since the total energy is correct with $\epsilon$.

\section{Wave guide}

In a slab waveguide, which extends infinitely in the $z$ direction 
but is finite in the $xy$ plane, the electric field takes the form of 
\begin{equation}
    \vb*{E} = \bar{\vb*{E}}(\vb*{r}_\bot) \ee^{\ii (k_z z - \omega t)},
\end{equation}
because in the $z$ direction we have continuous translational symmetry.

We can solve the TE modes of the waveguide by putting 
\begin{equation}
    \vb*{E} = \phi(x) \vu*{y} \ee^{\ii (k_z z - \omega t)}
\end{equation}
into Maxwell's equation, and hence we find 
\begin{equation}
    (-\partial_x + k_z^2) \phi = \epsr(x) \left(\frac{\omega}{c}\right)^2 \phi.
\end{equation}
Therefore we find that the TE part is equivalent to 
the 1D quantum mechanical boundary state problem:
\begin{equation}
    - \epsr(x) \left(\frac{\omega}{c}\right)^2 \to V, \quad 
    - k_x^2 \to E.
\end{equation}

The profile of $\epsr(x)$ looks like a bump, 
and not a well: 
we do the decomposition 
\begin{equation}
    \epsr(x) = \epsilon_1 + \Delta \epsilon(x)
    = \epsilon_1 + \Delta \epsilon \cdot \mathrm{rect}(x/a),
\end{equation}
where $\epsilon_1$ is the $\epsr$ in the material surrounding the slab
(the so-called \concept{cladding} medium), 
and $\Delta \epsilon$ is the difference
between the slab and the material surrounding it.
Defining 
\begin{equation}
    k_1^2 \coloneqq \left(\frac{\omega}{c}\right)^2 \cdot \epsilon_1,
\end{equation}
we have 
\begin{equation}
    \left(
        - \left(\frac{c}{\omega}\right)^2 \partial_x^2 - \Delta \epsilon 
    \right) \phi
    = (n_1^2 - n_\text{eff}^2) \phi,
\end{equation}
where 
\begin{equation}
    (n_1^2 - n_\text{eff}^2) \left(\frac{\omega}{c}\right)^2 \coloneqq k_1^2 - k_z^2.
\end{equation}
Now this looks incredibly similar to a 1D well problem, 
where $\omega$ is equivalent to the mass; 
we know in order to have bound states, 
\begin{equation}
    n_1^2 - n_{\text{eff}}^2 < 0 \Leftrightarrow 
    k_z > k_1 = \frac{\omega}{c} \epsilon_1.
\end{equation}
We also have modes where $n_1 > n_{\text{eff}}$, which are leaky modes.
Note that in a 1D system, 
as long as we have a well in the potential energy configuration,
we \emph{always} have at least one bound state.

So now we have three regions in the spectrum:
\begin{itemize}
    \item Region I, the continuous region,
    where $\omega / k > c / \epsilon_1$: here we have leaky modes whose spectrum is continuous.
    \item Region II, the bound state region, 
    where $c / (\epsilon_1 + \Delta \epsilon) < \omega / k < c / \epsilon_1$,
    where we have bound states.
    \item Region III, the forbidden region,
    where $\omega / k < c / (\epsilon_1 + \Delta \epsilon)$. \todo{Why there is such a region? An intuitive expnalation might be that since the light spends some time outside of the slab as well, 
    the effective $\epsilon$ should be somewhere between $\epsilon_1$ and $\epsilon_1 + \Delta \epsilon$. 
    But in the forbidden region, $\epsilon$ has to be larger than the latter.}
\end{itemize}
The above argumentation is based on the assumption that $\Delta \epsilon > 0$,
and this can be expected by the physical picture from total internal inflection in geometrical optics. 


\section{Photonic crystals}

The fact that electromagnetic bound modes exist in a waveguide 
immediately hints at the possibility of \concept{photon crystal}:
if several waveguides are aligned in a periodic way, 
bound modes -- which inevitably still slightly leaks out of the well -- 
are connected to each other, 
and Bloch states are formed.
There are several caveats when we transplant ideas 
from electronic structure theory to electrodynamics.
\begin{itemize}
    \item Polarization. Electron wave function is either treated as a scalar or, in the ``non-collinear'' case, 
    as a two-component ``spinor'' 
    (without the complex algebraic structure in spinors in Dirac equation).
    In electrodynamics we have $\vb*{H}$ and $\vb*{E}$,
    but there is redundancy.
    \item Inner product. 
\end{itemize}
But photon crystals are also more convenient to deal with 
in the fact that usually there is no strong interaction between photons.

With periodic dielectric profile, 
unsurprisingly we find the same degeneracy breaking 
and first Brillouin zone formation, 
and we find $\omega(\vb*{k})$ becomes flat at some positions, 
where the group velocity of light becomes zero 
-- a highly unusual case not frequently seen elsewhere.
Also, since the DOS reaches its peak 
at the bottom or the top of a band
(and the band is known as the \concept{air band} 
and the \concept{dielectric band} respectively), 
dipoles placed in a photonic crystal don't have much spontaneous emission 
when the frequency of photons it is to emit is in a band gap,
but the spontaneous emission is greatly enhanced 
when the frequency of photons to be emitted 
is at a band bottom or top.
Also, the thermal emission spectrum, 
proportional to $D(\omega) n_{\text{Bose}}(\omega)$, 
also shows peaks located at band extrema, 
but no thermal photon can be seen in band gaps.
This property can also be used for radiative cooling:
if we somehow tune the peak of $D(\omega)$ to a value 
within the transparency window of atmosphere, 
the photonic crystal actually directly has heat transfer 
with the outer space, which is much colder than the atmosphere, 
so it cools much faster.

At the boundary photonic crystals have surface states -- 
\concept{evanescent} wave solutions -- as well, 
just like an ordinary crystal; 
for an ideal photonic crystal this looks not so physical 
since they clearly violates the periodic boundary condition; 
but all real photonic crystals are finite, 
and the structures of these boundary states 
decide the reflection behaviors of the photonic crystal.

Now we turn to quantitative aspects of photonic crystals.
Suppose the dielectric function is 
\begin{equation}
    \epsr(z) = \bar{\epsilon} + \frac{\Delta \epsilon}{2} \cos (\frac{2\pi}{a} z),
\end{equation}
and we want to solve 
\begin{equation}
    \curl{\curl{\vb*{E}}} = - \mu_0 \partial_t^2 \vb*{D}, \quad 
    \vb*{D} = \epsilon_0 \epsr \vb*{E}.
\end{equation}
Ignoring any anistropic and frequency-dependent properties of the material, 
and switching to the frequency space, 
the equation becomes 
\begin{equation}
    \curl{\curl{\vb*{E}}} = \left(\frac{\omega}{c}\right)^2 \epsr(z) \vb*{E}.
\end{equation}
An interesting observation is that the most natural way to express the problem 
-- we don't want to write $\epsr^{-1}$  -- 
is not an Hermitian eigenvalue problem, 
but a \emph{generalized} Hermitian eigenvalue problem:
on the RHS there is also an operator ($\epsr(z)$), 
and once we move it to the LHS, 
we find the LHS is \emph{no longer} Hermitian.

We still consider solutions with the following form:
\begin{equation}
    \vb*{E}(\vb*{r}) = \vu*{y} \phi(z) .
\end{equation}
Now we get 
\begin{equation}
    - \partial_z^2 \phi(z) = \left(\frac{\omega}{c}\right)^2 \epsr(z) \phi(z).
\end{equation}
Now we put $\epsr$ into this equation, and assume that $\Delta \epsilon$ is small,
and the equation becomes
\begin{equation}
    \left(- \left(\frac{c^2}{\bar{\epsilon}}\right) \partial_z^2 - \omega^2 \frac{\Delta \epsilon}{\bar{\epsilon}}\right) \phi(z) = \omega^2 \phi(z).
\end{equation}
Now we find the problem looks like a quantum mechanic perturbation problem;
specifically, when the wave vector difference  $\phi_{k}$ and $\phi_{-k}$ 
is an integer multiple of $G = 2\pi / a$, 
Bragg scattering happens, and this fact is reflected by the fact that 
we have a \emph{first-order} correction to the frequencies, 
and this leads to degeneracy breaking.

We can focus on $\vb*{H}$ instead and arrive at 
\begin{equation}
    \curl{\left(\frac{1}{\epsr} \curl{\vb*{H}} \right)} = \frac{\omega^2}{c^2} \vb*{H},
\end{equation}
and this is known as the \concept{master equation}; 
the name has nothing to do with the master equation about probabilistic distributions; 
what is handy is the operator on the LHS actually is a Hermitian operator.

\section{Physics of a beam}

A \concept{dispersion surface} is the set of all wave vectors with the same frequency;
for an isotropic system all dispersion surfaces are spheres.
For highly anisotropic mediums we have very weird dispersion surfaces.

Consider a beam with a Gaussian radius profile $E(z = \const., r)$.
Currently we focus on the isotropic case.
Of course we can do a Fourier transform of $E(z = \const., r)$
and we find that in $E$ we have Fourier components 
whose transverse wave vector components are non-zero.
If the electric field only has one frequency, 
then $k_\parallel$ is decided by $k_\bot$,
and therefore the Fourier components do not propagate in the same pace, 
and hence dispersion happens.

Now consider a \emph{flat} dispersion surface perpendicular 
to the propagation direction of a beam.
In this case $k_\parallel$ is fixed, regardless of $k_\bot$; 
the beam then does not disperse at all!
The flat dispersion surface can be engineered in a two-dimensional photonic crystal:
when $\vb*{k}$ is close to the boundary of the first Brillouin zone, 
in different directions, Bragg interference has different strengths, 
and eventually we get flat dispersion surfaces at some $\vb*{k}$ points.

To make the theory more quantitative, 
we study Helmholtz equation. 
Suppose we have decomposition 
\begin{equation}
    \psi(\vb*{r}) = \sum_{\vb*{k}_\bot} u(\vb*{k}_\bot) 
    \ee^{\ii \vb*{k}_\bot \cdot \vb*{r}_\bot} \ee^{\ii {k}_\parallel (\vb*{k}_\bot) z} .
\end{equation}
For an isotropic medium we make the \concept{paraxial approximation}
\begin{equation}
    k_\parallel = \sqrt{k_0^2 - k_\bot^2} \approx k_0 \left(
        1 - \frac{1}{2} \left(\frac{k_\bot}{k_0}\right)^2
    \right),
\end{equation}
which is equivalent to assuming that the intensity 
is mainly distributed around $\vb*{k} = \vb*{k}_\parallel$.
More generally we can continue the Taylor expansion.
Note that in the most general case we can still have $\dv*{k_\parallel}{k_\bot}$
-- it's just absent in the isotropic case.
The total (scalar) field is then 
\begin{equation}
    \psi(\vb*{r}) = \ee^{\ii k_0 z} \underbrace{
        \int \dd[2]{\vb*{k}_\bot} u(\vb*{k}_\bot) 
        \ee^{
            \ii k_\bot r_\bot - \frac{\ii}{2} \left(\frac{k_\bot}{k_0}\right)^2 z
        },
    }_{\text{envelope $f$}},
\end{equation}
and therefore we have  
\begin{equation}
    f(z = 0) = \psi(z = 0), \quad 
    u(\vb*{k}_\bot) = \int \frac{\dd[2]{\vb*{r}_\bot}}{(2\pi)^2} f(z = 0),
\end{equation}
and eventually 
\begin{equation}
    f(\vb*{r}_\bot, z) = \mathcal{F}^{-1} \left(
        \mathcal{F}_{\vb*{r}_\bot \to \vb*{k}_\bot} f(\vb*{r}_\bot, z = 0) 
        \ee^{- \frac{\ii}{2} \left(\frac{k_\bot}{k_0}\right)^2 z}
    \right).
\end{equation}
Thus we find that at each $z$, the radius profile of the electric field 
can be obtained from $f(z=0)$ by double Fourier transforms.

We can verify that the radius profile expands as we go along $z$.
Near $z = 0$, we have 
\begin{equation}
    \begin{aligned}
        f(\Delta z) &\approx \int u(\vb*{k}_\bot) \ee^{\ii \vb*{k}_\bot \cdot \vb*{r}_\bot}
        \left(
            1 - \frac{\ii k_\bot^2}{2k_0} \Delta z
        \right) \dd[2]{\vb*{k}_\bot} \\
        &= f(z=0) + \frac{\ii \Delta z}{2 k_0} \laplacian f(\vb*{r}_\bot, z = 0).
    \end{aligned}
\end{equation}
So we find 
\begin{equation}
    2 \ii k_0 \partial_z f + \partial_{\bot}^2 f = 0.
    \label{eq:spatial-eq-f}
\end{equation}
This, formally, is similar to the Schrodinger equation.
Note that this equation is a static description of a beam mode, 
not truly a dynamic one.
Also, if we keep track of the phase of the beam, 
we will find it develops a curvature as $z$ goes up, 
and hence the beam diverges:
we have 
\begin{equation}
    f(\vb*{r}_\bot, z + \Delta z) = \ee^{\ii \phi(\vb*{r}_\bot, \Delta z)} f(z), \quad 
    \phi(\vb*{r}_\bot, \Delta z) = \frac{\Delta z}{2 k_0} \frac{\laplacian_\bot f}{f}.
\end{equation}
Now if the dispersion surface is engineered to have a negative curvature at $\vb*{k}$, 
we will find the beam \emph{concentrate} itself.

Finally we consider what Kerr nonlinearity does to the system.
Since the Kerr nonlinearity may cancel the curvature caused by the isotropic dispersion relation,
the beam no longer diverges and the wave fronts are always flat.
This is known as optical solitons.

\section{Evolution of a pulse in dispersive medium}

\eqref{eq:spatial-eq-f} is a spatial equation.
If we are able to write down an equation with similar shape 
but the first-order derivative is $\partial_t$, 
we have a real Schrodinger equation in optics.

We use slowly varying envelope approximation here.
Suppose 
\begin{equation}
    a(x, t) \approx \ee^{\ii (k_0 x - \omega_0 t)} \bar{a}(x, t),
\end{equation}
where the ``envelope'' $\bar{a}(x, t)$ is expected to have slower spatial and temporal variation 
compared with the ``carrier'' $\ee^{\ii (k_0 x - \omega_0 t)}$.
In the Fourier space we have 
\begin{equation}
    a(x, t) = \int \dd{\omega} \ee^{\ii (k(\omega) x - \omega t)} a(\omega), 
    \quad \bar{a}(\underbrace{\omega - \omega_0}_{\Delta \omega}) = a(\omega)
\end{equation}
Here we have already required that $a(x, t)$ is a solution of the EOM, 
and that's why in the Fourier space we simply write $a(\omega)$, not $a(\omega, k)$.
We then find 
\begin{equation}
    \bar{a}(x, t) = \int \frac{\dd{\Delta \omega}}{2\pi} \bar{a}(\Delta \omega)
    \ee^{
        - \ii \Delta \omega t + \ii (k_0' \Delta \omega + k_0'' \Delta \omega^2 / 2 + \cdots) x
    },
    \label{eq:a-bar-explicit}
\end{equation}
where $k_0'$ means $\dv*{k}{\omega}$ at $\omega = \omega_0$, etc.
Let's only keep the $\Delta \omega^2$ term -- 
it can then be shown that $\bar{a}(x , t + x / v_{\text{g}})$ broadens.
It can be observed that 
\begin{equation}
    \text{frequency chirp} = \text{distance} \times \text{group velocity dispersion} \times \text{pulse bandwith},
\end{equation}
where GVD is $\dv*[2]{k}{\omega}$.
This fact can be seen more easily by taking the spatial derivative of \eqref{eq:a-bar-explicit}:
$\partial_x$ moves $k_0' \Delta \omega + k_0'' \Delta \omega^2 / 2$ down from the exponent, 
and then we can replace $\Delta$ by $\ii \partial_t$, and we get 
\begin{equation}
    \partial_x \bar{a} = - \frac{1}{v_{\text{g}}} \partial_t \bar{a} 
    - \frac{\ii}{2} k_0'' \partial_t^2 \bar{a},
    \label{eq:envelope-eom}
\end{equation}
which has Schrodinger equation behaviors (including wave packet broadening), 
although the positions of $x$ and $t$ are swapped.

Now if there is Kerr nonlinearity, we can expect to see optical solitons again,
for the phase shift introduced by the nonlinearity and $k_0''$ may cancel each other.
The main effect of Kerr nonlinearity is to correct $\epsr$,
and it enters the exponent in \eqref{eq:a-bar-explicit},
and after $\partial_x$ it just becomes an additional term in \eqref{eq:envelope-eom}; 
this of course is not always correct: 
we have implicitly made assumptions like that in $\chi^{(3)} \abs*{\vb{E}} \vb{E}$, 
$\abs*{\vb{E}}^2$ shouldn't have strong spatial variance, 
to enable us to treat the nonlinear term in Maxwell equations 
in a way similar to the say we treat other constants. 
The EOM of $\bar{a}$ now reads 
\begin{equation}
    \partial_x \bar{a} = - \frac{1}{v_{\text{g}}} \bar{a} 
    - \frac{\ii}{2} k_0'' \partial_t^2 \bar{a} 
    + \ii \gamma \abs*{\bar{a}}^2 \bar{a}.
\end{equation}
We can again redefine $\partial_x$ or $\partial_t$ and get rid of the first term in the RHS; 
when 
\begin{equation}
    A_0 \tau_0 = \sqrt{k_0'' / \gamma},
\end{equation}
the follows is an exact solution
\begin{equation}
    \bar{a} = A_0 \mathrm{sech} (t / \tau_0) \exp(\ii \gamma \abs*{A_0}^2 x / 2).
\end{equation}
It doesn't have any broadening, and we can then make $\tau_0$ extremely small,
and have an extremely short but stable pulse.
There are other solutions of the equation;
some are semi-stable states.
Solitons may have more complicated dynamics,
like colliding with each other.

\section{Transport}

When electrons are accelerated by an external electric field, 
before they hit disorders they always have a ballistic transport period; 
the usual Ohmic transport is true only when 
the disorders are strong enough to make all electrons
move in the terminal velocity. 

\begin{equation}
    \sigma(\omega) = \frac{\sigma_0}{1 - \ii \omega / \Gamma}.
\end{equation}

Macroscopically, the restoring force comes from charge accumulated at the boundary of the system.
In the case of thin film, the restoring frequency is exactly $\omega_{\text{p}}$.
Other shapes causes different restoring frequencies;
of course, this restoring force coming from nowhere influences $\epsr$, 
and this leads to what is known as \concept{surface plasmon polariton}: 
the fluctuation of the surface charge is called the surface plasmon, 
and they are strongly mixed to electromagnetic modes, 
and hence the resulting bosonic fluctuation is known as a sort of polariton.

\section{Plasmon wave}

Now we turn to the bulk case, and the surface modes don't bother us at this moment.
We have three equations: 
the charge conservation equation 
\begin{equation}
    \pdv{\rho}{t} + \div{\vb*{J}} = 0,
\end{equation}
the Maxwell equations, and also the Newton's equation
\begin{equation}
    m \ddot{\vb*{r}} = q \vb*{E}.
\end{equation}
The Newton's equation is the real thing here: 
the physical meaning is that electrons don't interact with others 
and feel no restoring forces; 
this is only possible when the oscillation frequency is high enough,
where the material looks like plasma.

From the charge conservation equation and the Gauss's law we get 
\begin{equation}
    \div{(\vb*{J} + \epsilon_0 \partial_t \vb*{E})} = 0,
\end{equation} 
and the same equation can also be derived by noticing that $\div{\curl{\vb*{B}}} = 0$.
This essentially means that the charge conservation equation 
is not really necessary once we have Maxwell's equations.
From Maxwell's equations we have 
\begin{equation}
    \curl{\curl{\vb*{E}}} = - \mu_0 \partial_t \vb*{J} - \frac{1}{c^2} \partial_t^2 \vb*{E},
\end{equation}
and from the Newton's equation we find 
\begin{equation}
    \partial_t \vb*{J} = q \frac{N}{V} \ddot{\vb*{r}}
    = \epsilon_0 \underbrace{\frac{N}{V} \frac{q^2}{m \epsilon_0}}_{\omega_{\text{p}}^2} \vb*{E},
\end{equation}
and now the wave equation becomes 
\begin{equation}
    \curl{\curl{\vb*{E}}} = - \frac{1}{c^2} \omega_{\text{p}}^2 \vb*{E} - \frac{1}{c^2} \partial_t^2 \vb*{E}.
\end{equation}
Now by Helmholtz decomposition theorem, we decompose $\vb*{E}$ into 
a longitudinal part and a transverse part.
The LHS becomes $\curl{\curl{\vb*{E}_{\text{t}}}} = - \laplacian \vb*{E}_{\text{t}}$.
The RHS is trivially decomposed.
The wave equation therefore reads 
\begin{equation}
    \left(\laplacian - \frac{\omegap^2}{c^2} - \frac{1}{c^2} \partial_t^2\right) \vb*{E}_{\text{t}}
    = \left( \frac{\omegap^2}{c^2} + \frac{1}{c^2} \partial_t^2 \right) \vb*{E}_{\text{l}}.
\end{equation}
Now if we consider this in Fourier space, 
we realize that the polarization of $\vb*{E}_{\text{t}}$
is always orthogonal to that of $\vb*{E}_{\text{l}}$, 
and therefore the above equation becomes 
\begin{equation}
    \left(\laplacian - \frac{\omegap^2}{c^2} - \frac{1}{c^2} \partial_t^2\right) \vb*{E}_{\text{t}}
    = \left( \frac{\omegap^2}{c^2} + \frac{1}{c^2} \partial_t^2 \right) \vb*{E}_{\text{l}} = 0.
\end{equation}

The longitudinal dispersion relation is 
\begin{equation}
    \omega = \omegap,
\end{equation}
that's to say, there is indeed a longitudinal electromagnetic excitation, 
and its frequency is always $\omegap$.
This mode is just the plasmon oscillation.
We still have transverse modes.
By plane wave trial solutions, we find 
\begin{equation}
    \omega = \sqrt{ k^2 c^2 + \omegap^2 }.
\end{equation}
In the high frequency limit we asymptotically approach free space propagation;
when the frequency is low, 
a transverse mode in the metal is heavily dressed
and doesn't look quite different from a plasmon mode.
Most of the time, the longitudinal plasmon mode isn't coupled to external modes,  
which are usually transverse electromagnetic modes, 
there it's not that important.
The transverse mode does matter however.

But there is one case where the longitudinal mode matters.
Consider we excite a longitudinal plasmon mode propagating in $x$ direction, 
and a surface parallel to the $xy$ plane is also created to a dielectric is also created.
Now in the dielectric side, 
we find that the positive and negative charges in the metal 
excite the electromagnetic field -- in a transverse way because 
the electric field lines are perpendicular to $x$ direction near the surface.
Solving the relevant equations, 
we find we get a surface-confined wave, 
a wave that magically, has both transverse and longitudinal features.
(That's also the case in a wave guide!)
Now we have three branches in the excitation spectrum:
one dressed transverse electromagnetic wave, 
whose frequency is $\omegap$ when $k$ is small and $ck$ when $k$ is large; 
a longitudinal plasmon mode;
a surface plasmon polariton mode whose dispersion relation is linear when $k$ is small 
and converges to $\omega_{\text{sp}}$  when $k$ is large.
Note that the group velocity is very slow when $k$ is large for the surface plasmon polariton, 
and the density of states becomes rather high.

\end{document}