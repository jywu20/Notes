\documentclass[hyperref, a4paper]{article}

\usepackage{geometry}
\usepackage{titling}
\usepackage{titlesec}
% No longer needed, since we will use enumitem package
% \usepackage{paralist}
\usepackage{enumitem}
\usepackage{footnote}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{mathtools}
\usepackage{bbm}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{soulutf8}
\usepackage{physics}
\usepackage{tensor}
\usepackage{siunitx}
\usepackage[version=4]{mhchem}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{autobreak}
\usepackage[ruled, vlined, linesnumbered]{algorithm2e}
\usepackage{nameref,zref-xr}
\zxrsetup{toltxlabel}
\usepackage[backend=bibtex]{biblatex}
\addbibresource{elasticity.bib}
\usepackage[colorlinks,unicode]{hyperref} % , linkcolor=black, anchorcolor=black, citecolor=black, urlcolor=black, filecolor=black
\usepackage[most]{tcolorbox}
\usepackage{prettyref}

% Page style
\geometry{left=3.18cm,right=3.18cm,top=2.54cm,bottom=2.54cm}
\titlespacing{\paragraph}{0pt}{1pt}{10pt}[20pt]
\setlength{\droptitle}{-5em}

% More compact lists 
\setlist[itemize]{
    itemindent=17pt, 
    leftmargin=1pt,
    listparindent=\parindent,
    parsep=0pt,
}

% Math operators
\DeclareMathOperator{\timeorder}{\mathcal{T}}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\legpoly}{P}
\DeclareMathOperator{\primevalue}{P}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\res}{Res}
\DeclareMathOperator{\sinc}{sinc}
\newcommand*{\ii}{\mathrm{i}}
\newcommand*{\ee}{\mathrm{e}}
\newcommand*{\const}{\mathrm{const}}
\newcommand*{\suchthat}{\quad \text{s.t.} \quad}
\newcommand*{\argmin}{\arg\min}
\newcommand*{\argmax}{\arg\max}
\newcommand*{\normalorder}[1]{: #1 :}
\newcommand*{\pair}[1]{\langle #1 \rangle}
\newcommand*{\fd}[1]{\mathcal{D} #1}
\DeclareMathOperator{\bigO}{\mathcal{O}}

% TikZ setting
\usetikzlibrary{arrows,shapes,positioning}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{decorations.markings}
\usetikzlibrary{calc}
\tikzstyle arrowstyle=[scale=1]
\tikzstyle directed=[postaction={decorate,decoration={markings,
    mark=at position .5 with {\arrow[arrowstyle]{stealth}}}}]
\tikzstyle ray=[directed, thick]
\tikzstyle dot=[anchor=base,fill,circle,inner sep=1pt]

% Algorithm setting
% Julia-style code
\SetKwIF{If}{ElseIf}{Else}{if}{}{elseif}{else}{end}
\SetKwFor{For}{for}{}{end}
\SetKwFor{While}{while}{}{end}
\SetKwProg{Function}{function}{}{end}
\SetArgSty{textnormal}

\newcommand*{\concept}[1]{{\textbf{#1}}}

% Embedded codes
\lstset{basicstyle=\ttfamily,
  showstringspaces=false,
  commentstyle=\color{gray},
  keywordstyle=\color{blue}
}

% Reference formatting
\newcommand*{\citesec}[1]{\S~{#1}}
\newcommand*{\citechap}[1]{chap.~{#1}}
\newcommand*{\citefig}[1]{Fig.~{#1}}
\newcommand*{\citetable}[1]{Table~{#1}}
\newcommand*{\citepage}[1]{pp.~{#1}}
\newrefformat{fig}{Fig.~\ref{#1}}
\newcommand*{\term}[1]{\textit{#1}}

% Color boxes
\tcbuselibrary{skins, breakable, theorems}

\newtcbtheorem{infobox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=blue!5,
    colframe=blue!5,
    coltitle=blue!50,
    borderline west={4pt}{0pt}{blue!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}
\newtcbtheorem[use counter from=infobox]{theorybox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=orange!5, 
    colframe=orange!5, 
    coltitle=orange!50,
    borderline west={4pt}{0pt}{orange!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}
\newtcbtheorem[use counter from=infobox]{learnbox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=green!5,
    colframe=green!5,
    coltitle=green!50,
    borderline west={4pt}{0pt}{green!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}


\newenvironment{shelldisplay}{\begin{lstlisting}}{\end{lstlisting}}

\newcommand*{\kB}{k_{\text{B}}}
\newcommand*{\muB}{\mu_{\text{B}}}
\newcommand*{\efermi}{E_{\text{F}}}
\newcommand*{\pfermi}{p_{\text{F}}}
\newcommand*{\vfermi}{v_{\text{F}}}
\newcommand*{\sA}{\text{A}}
\newcommand*{\sB}{\text{B}}
\newcommand*{\Tc}{T_{\text{c}}}
\newcommand*{\hethree}{$^3$He}
\newcommand*{\hefour}{$^4$He}
\newcommand{\epsr}{\epsilon_{\text{r}}}
\newcommand{\chie}{\chi_{\text{e}}}
\newcommand*{\Gammae}{\Gamma_{\text{e}}}
\newcommand*{\Gammag}{\Gamma_{\text{g}}}
\newcommand*{\omegae}{\omega_{\text{e}}}
\newcommand*{\omegag}{\omega_{\text{g}}}
\newcommand*{\omegaeg}{\omega_{\text{eg}}}
\newcommand*{\ptwfc}[2]{\psi^{(#2)}_{#1}}
\newcommand*{\mueg}{\mu_{\text{eg}}}
\newcommand*{\muge}{\mu_{\text{ge}}}
\newcommand*{\Ezzero}{E_{z0}}
\newcommand*{\kete}{\ket*{\text{e}}}
\newcommand*{\ketg}{\ket*{\text{g}}}
\newcommand*{\coeffe}{c_{\text{e}}}
\newcommand*{\coeffg}{c_{\text{g}}}
\newcommand*{\pope}{p_{\text{e}}}
\newcommand*{\popg}{p_{\text{g}}}
\newcommand*{\ptwo}{P^{(2)}}
\newcommand*{\chitwo}{\chi^{(2)}}
\newcommand*{\chithree}{\chi^{(3)}}

\title{Light-matter interaction}
\author{Jinyuan Wu}

\begin{document}

\maketitle

TODO:
\begin{itemize}
    \item There are rare cases where the energy velocity 
    (i.e. the velocity that connects $\vb*{s}$ and $u$) 
    is not the same as group velocity;
    for example in metal wave guide?
    \item From the current response of an external field to $\epsr$.
    (That's to say, 
    from TD-aGW to dielectric function.)
    \item Specifically, noise exists when there is damping. 
    Could this be modeled by some sort of non-equilibrium field theory?
    (I think I asked this question before \dots)
\end{itemize}

\section{Coarse-grained description of medium}

A linearly polarized medium can be described by 
\begin{equation}
    \vb*{D} = \epsilon_0 \vb*{E} + \vb*{P}
    = \epsilon_0 \vb*{E} + \epsilon_0 \chi_{\text{e}} \vb*{E} 
    = \epsilon_0 \underbrace{(1 + \chi_\text{e})}_{\eqqcolon \epsilon_{\text{r}}} \vb*{E}.
\end{equation}
Similarly we can deal with magnetization, 
although here the notation, due to historical reasons, needs to be altered slightly.
Now we have 
\begin{equation}
    \vb*{B} = \mu_0 (\vb*{H} + \vb*{M})
    = \mu_0 \underbrace{(1 + \chi_{\text{m}})}_{\mu_{\text{r}}} \vb*{H},
\end{equation}
as if $\vb*{B}$ has the same status of $\vb*{D}$,
although it's $\vb*{H}$ that is the auxiliary field.

From the fourth Maxwell equation we directly find
that time oscillation of polarization stimulates a magnetic field, 
which is correct since $\partial_t \vb*{P}$
can be understood as a current: 
charges have to be rearranged 
so that the orientation of a dipole changes,
which then give us a current.

The Poynting's theorem now reads 
\begin{equation}
    \div{\vb*{S}} + \vb*{H} \cdot \pdv{\vb*{B}}{t} + \vb*{E} \cdot \pdv{\vb*{D}}{t} 
    + \vb*{J}_{\text{free}} \cdot \vb*{E} = 0.
\end{equation}
This is the conservation equation of energy 
only when the material is linear, 
where we can redefine the electromagnetic energy as 
\begin{equation}
    u = \frac{1}{2} (\vb*{E} \cdot \vb*{D} + \vb*{B} \cdot \vb*{H}),
\end{equation} 
which includes the energy stored in the medium.
What we \emph{always} have is 
\begin{equation}
    \div{\vb*{S}} + \pdv{t} \left(
        \frac{\epsilon_0}{2} \vb*{E}^2 
        + \frac{\mu_0}{2} \vb*{H}^2
    \right) + 
    \left(
        \vb*{E} \cdot \pdv{\vb*{P}}{t} 
        + \mu_0 \vb*{H} \cdot \pdv{\vb*{M}}{t}
        + \vb*{J}_{\text{free}} \cdot \vb*{E}
    \right) = 0,
\end{equation} 
which is the conservation equation for the ``pure'' electromagnetic energy, 
e.g. the energy stored in the electromagnetic field.
Of course, the internal degrees of freedom of the medium 
may contain microscopic electromagnetic field modes, 
so by ``the energy stored in the electromagnetic field''
we mean ``the energy stored in the electromagnetic modes we care''.

\section{A more generalized description of linear response}

The $\vb*{D} = \epsilon_0 \epsilon_{\text{r}} \vb*{E}$ case is almost trivial: 
they respond instantaneously and they don't absorb energy.
In this section we still assume that the response is linear,
but don't assume that the response is spontaneous.
Thus 
\begin{equation}
    \vb*{P}(t) = \int_{-\infty}^{\infty} \alpha(t - \tau) \vb*{E}(\tau) \dd{\tau}.
\end{equation}
Thus the polarization field is the convolution 
of the response function and the electric field.
In principle things can be even more complicated: 
$\alpha$ can have momentum dependence in the Fourier space, 
and the consequence is that the response is non-local:
this is important in, say, plasmon, 
where long-range Coulomb interaction requires a non-local description of the response.

The wave equation now is 
\begin{equation}
    \curl{\curl{\vb*{E}}} = - \mu_0 \epsilon_0 \pdv[2]{t}
    \epsr \otimes \vb*{E},
\end{equation}
where $\otimes$ means convolution.
This equation is more clearly illustrated by its form in the frequency space: 
\begin{equation}
    \curl{\curl{\vb*{E}}} = \mu_0 \epsilon_0 \omega^2 \epsr(\omega) \vb*{E}(\omega),
    \label{eq:freq-space-time-retardation-wave-eq}
\end{equation}
where 
\begin{equation}
    \epsr(\omega) = \int_{-\infty}^\infty \epsr(t) \ee^{\ii \omega t} \dd{t},
\end{equation}
and from the fact that $\epsr(t)$ is real, 
\begin{equation}
    \epsr(-\omega) = \epsr(\omega)^*.
\end{equation}
For clarity we may want to use $\tilde{\epsilon}_{\text{r}}$ 
to refer to $\epsr(\omega)$.
The damping behavior of $\epsr(t)$ in the time domain 
is represented by the imaginary part of $\epsr(\omega)$ in the frequency domain.

\eqref{eq:freq-space-time-retardation-wave-eq} tells us an important point:
if the input is time harmonic, 
so is the output.
Indeed we can measure $\epsr(\omega)$ in this way.

The plane wave mode with a frequency-dependent $\epsr(\omega)$ 
has the following dispersive relation:
\begin{equation}
    \left(
        \vb*{k}^2 - \frac{\omega^2}{c^2} \epsr(\omega)
    \right) \vb*{E} = 0 \Rightarrow
    \vb*{k} = \pm \frac{\omega \tilde{n}(\omega)}{c} \vu*{k}, 
\end{equation}
where 
\begin{equation}
    \tilde{n}(\omega) = \sqrt{\epsr(\omega)}.
\end{equation}
From the dispersive relation 
we can define phase velocity and group velocity.

It should be noted that $n$ -- and hence $\vb*{k}$ -- 
is allowed to have an imaginary part,
which tells us absorption in the material. 
Defining 
\begin{equation}
    \tilde{n}(\omega) = n(\omega) + \ii \kappa(\omega),
\end{equation}
we find 
\begin{equation}
    \vb*{E}(\vb*{r}, t) = \ee^{
        - \frac{\omega}{c} \kappa(\omega) \vu*{k} \cdot \vb*{r}
    }
    \ee^{
        \ii \frac{\omega}{c} n(\omega) \vu*{k} \cdot \vb*{r}
        - \ii \omega t
    } E \vu*{e},
\end{equation}
and therefore the decaying coefficient is  
\begin{equation}
    \alpha(\omega) = \frac{\omega}{c} \kappa(\omega),  
\end{equation}
from which we find 
\begin{equation}
    \expval{S(z)} = \frac{1}{2} \abs*{
        \Re \vb*{E}^* \times \vb*{H}
    } \propto \ee^{- 2 \alpha z}.
\end{equation}

We can also evaluate the impact of imaginary part of $\epsr$ 
-- equivalently, of $\chi_{\text{e}}$ -- 
from the perspective of the energy of the electromagnetic field.
Consider a region with no energy flow into or out of it.
We have 
\begin{equation}
    \begin{aligned}
        &\div{\vb*{S}} + \pdv{u}{t} = - \vb*{E} \cdot \vb*{J} \\
        \Rightarrow& \dv{t} \int \expval{u} \dd[d]{\vb*{r}} 
        = - \int \dd[d]{\vb*{r}} \frac{1}{2} \Re \vb*{E}^* \cdot \vb*{J}   
        = - \frac{1}{2} \int \dd[d]{\vb*{r}} \omega \epsilon_0 \Im \chi(\omega) \abs*{\vb*{E}}^2.
    \end{aligned}
\end{equation}
Thus, when $\chi_2$ is positive, 
the field loses energy, 
and when $\chi_2$ is negative, 
the field gets energy.

\section{Microscopic model of dispersive media: the harmonic oscillator model}

The harmonic oscillator is often used as a simplistic model of the atom.
The physical picture seems wrong at the first glance, 
but if we regard the displacement in the harmonic oscillator
as the dipole of the atom, 
then things begin to make sense; 
indeed, the ``classical'' model of harmonic oscillator 
can be shockingly accurate in certain limits.

The EOM is  
\begin{equation}
    m \ddot{\vb*{r}} = - m \Omega^2 \vb*{r} - m \gamma \dot{\vb*{r}}
    + q \vb*{E},
\end{equation}
or in other words 
\begin{equation}
    \ddot{\vb*{p}} + \gamma \dot{\vb*{p}} + \Omega^2 \vb*{p}
    = \frac{q^2}{m} \vb*{E}(t),
\end{equation}
where $\vb*{p} = q \vb*{r}$ is the dipole.
\todo{Whether a more realistic atom model reduces to the above EOM 
requires further investigation.}%
The polarizability can be routinely found as 
\begin{equation}
    \vb*{p}(\omega) = \underbrace{
        \frac{q^2 / m}{\Omega^2 - \omega^2 - \ii \omega \gamma}
    }_{\alpha(\omega)} \vb*{E}(\omega).
\end{equation}
This leads to expected limit cases: 
when $\omega \ll \Omega$, 
$\vb*{E}$ is parallel to $\vb*{p}$,
while when $\omega \gg \Omega$,
$\vb*{E}$ is in the opposite direction to $\vb*{p}$.
\todo{How can this be used for light trapping???}

Now consider an assembly of atoms, 
and we find the total polarization field is now 
\begin{equation}
    \vb*{P} = \left(
        \frac{N}{V}
    \right) \cdot \vb*{p},
\end{equation}
and therefore the behavior of the media, 
in terms of quantities in the theory of electromagnetism, is now 
\begin{equation}
    (\ddot{\vb*{P}} + \gamma \dot{\vb*{P}} + \Omega^2 \vb*{P})
    = \frac{N}{V} \frac{q^2}{m} \vb*{E}.
\end{equation}
Recall that from Maxwell's equations we also have 
\begin{equation}
    \curl \curl \vb*{E} = 
    - \mu_0 \epsilon_0 \pdv[2]{t} \vb*{E}
    - \mu_0 \pdv[2]{t} \vb*{P}.
\end{equation}
The coupled EOMs, in the strong coupling regime, 
are a simple model of \concept{polariton}.
\todo{
    Is it possible to use solely $\epsr$ to capture the 
    behaviors of a polariton?
    Note that with $\epsr$ we still only have one mode 
    but here we actually have two modes, 
    EM field and polarization mode.
    
    Also, how could, say, phonon, be modeled as $\vb*{P}$.
}
\todo{the state of the material is changed after radiation happens 
(and the coupling between matter and the optical field 
also means the state of the material is a mixed state??
This question always puzzles me.)
Specifically, what will Fermi golden rule give us in this exactly solvable case?}

Real materials have more than one internal modes, 
and the relation between the polarizability and the electric field becomes 
\todo{TRK sum rule}

\section{Scattering cross sections}

For a single oscillator, the absorption power is  
\begin{equation}
    \expval{P_{\text{abs}}} = \expval{q \vb*{E} \cdot \dot{\vb*{d}}}
    = \gamma \abs*{\vb*{E}}^2 
    = \sigma_{\text{abs}} \underbrace{
        u_{\text{em}} v_{\text{g}}
    }_{\text{incident intensity}} .
\end{equation}
From this equation we naturally find a 
constant measuring how strong the absorption is 
with area dimension,
which is righteously named as the absorption cross section.
From this linear relation between absorption 
and incident intensity we immediate get Beer's law 
\begin{equation}
    I(z) = I(0) \ee^{- \frac{N}{V} \sigma_{\text{abs}} z},
\end{equation} 
where $N$ is the number of absorption centers.
The equation can be derived straightforwardly by 
using the definition to find 
\[
    \Delta P = - I(z) N \sigma_{\text{abs}}
\]
and noticing that 
\[
    P = I \cdot A.
\]

\section{Local field correction}

The good old ``a hole in a material'' argument.

\section{Kramers-Kronig relations}

It's possible that we have dispersion but no loss 
(as in, say, a wave guide, 
caused by the so-called geometric dispersion); 
in this case K-K relation may fail altogether,
due to some quirky properties of the response function.

\section{Semiclassical field-atom coupling}

In this section we consider the coupling between 
a semiclassical field and a degree of freedom 
that is expected to represent an atom,
be it a two-level system or a quantum oscillator or something else.
The coupling Hamiltonian reads 
\begin{equation}
    H_1 = - \vb*{\mu} \cdot \vb*{E} = - q \vb*{r} \cdot \vb*{E},
\end{equation}
which means we ignore the space dependence of $\vb*{E}$
and just apply a (possibly time-dependent) uniform electric field to 
the atom.
For example, the EOM of a harmonic oscillator is now 
\begin{equation}
    \dot{p} = - m \omega_0^2 x + q E, \quad 
    \dot{x} = \frac{p}{m},
\end{equation}
which means the toy model of driven harmonic oscillator 
is in fact quantitatively correct.
Indeed, the condition of the dipole approximation is 
\begin{equation}
    \frac{\omega}{c} a \ll 1,
\end{equation}
which can be justified either by Taylor expansion 
or by the physical intuition that the atom should not see 
the variance of the electric field.
The dipole approximation is usually correct, 
but caveats are needed for Rydberg atoms
($a$ is too large for ordinary wave length)
and cases with artificially enhanced strong electric variance 
as in, say, a very thin tip near a molecule 
(wave length too small for ordinary $a$).

One thing that can be immediately noticed is that 
the dipole moment expectation is always constant 
when the system is at a stationary state, 
since the $\ee^{- \ii \omega t}$ factors
of the bra and the ket cancel each other.
This means if we treat the light field as a classical field, 
we don't have spontaneous emission,
since radiation requires a time evolving dipole moment.
If 
\begin{equation}
    \ket*{\psi} = c_a \ket*{a} + c_b \ket*{b},
\end{equation}
we get 
\begin{equation}
    \expval{\vb*{\mu}(t)}_{\text{oscillating part}} = 
    c^*_a c_b \ee^{- \ii (\omega_b - \omega_a) t} \mel**{a}{\vb*{\mu}}{b} + \text{c.c.},
\end{equation}
and radiative coupling is possible when the matrix element is non-zero.
When a realistic atomic model is used,
this means that the parity of $a$ and $b$ should be different 
(and thus it's impossible to have transition between 1s and 2s),
and similarly we have selection rules for $m$ and $l$.
Note that we can still have multiple dipole-allowed transitions 
with the help of some intermediate states 
to connect two states that, say, have the same parity;
or we can make use of other transition channels
when the gradient of the electric field is truly large.\todo{Incoherent nonlinear processes}

The time-dependent perturbation usually can't be solved exactly.
Below we review time-dependent perturbation theory.
The Schrodinger equation is 
\begin{equation}
    \ii \hbar \pdv{t} \ket*{\psi(t)} = 
    (H_0 + \lambda H_1(t)) \ket*{\psi(t)},
\end{equation}
and we do the decomposition 
(by including the $\ee^{- \ii \omega_n t}$ factor 
we implicitly come into the interaction picture)
\begin{equation}
    \ket*{\psi(t)} = \sum_{n} \underbrace{  \left(
        \gamma_n^{(0)} + \lambda \gamma_n^{(1)} + \lambda^2 \gamma_n^{(2)} + \cdots
    \right) }_{\gamma_n} \ket*{n} \ee^{- \ii \omega_n t}, 
\end{equation}
and from the 
\begin{equation}
    \dv{\gamma_k}{t} = \frac{1}{\ii \hbar} \lambda \sum_n \mel**{k}{H_1}{n} \gamma_n (t) 
    \ee^{\ii (\omega_k - \omega_n) t}
\end{equation}
we get 
\begin{equation}
    \dv{t} \gamma^{(0)}_k = 0,
\end{equation}
\begin{equation}
    \dv{t} \gamma^{(1)}_k = \frac{1}{\ii \hbar} \sum_n H_{1, kn} 
    \gamma^{(0)}_n \ee^{\ii (\omega_k - \omega_n) t},
\end{equation}
\begin{equation}
    \dv{t} \gamma^{(2)}_k = \frac{1}{\ii \hbar} \sum_n H_{1, kn} 
    \gamma^{(1)}_n \ee^{\ii (\omega_k - \omega_n) t},
\end{equation}
and so on.  

We can organize the perturbed coefficients in the scattering matrix formalism:
\begin{equation}
    \gamma_k(t) = \gamma_k^{(0)} + \sum_n \underbrace{(S_{kn}^{(0)}(t) + S_{kn}^{(1)}(t) + \cdots)}_{S_{kn}} \gamma_n^{(0)},
\end{equation}
and the scattering matrix $S_{kn(t)}$ can be obtained from the 
aforementioned series of equations.

The time evolution caused by dipole coupling 
\begin{equation}
    H = \underbrace{
        - \vb*{\mu} \cdot \vb*{E}_0
    }_{ \eqqcolon W_{kn}} \cos \omega t
\end{equation}
therefore is 
\begin{equation}
    \begin{aligned}
        \dv{\gamma_k^{(1)}}{t} &= \frac{1}{\ii \hbar} 
        \sum_n \gamma^{(0)}_n W_{kn} \ee^{\ii \omega_{kn}} \cos \omega t  \\
        &= \frac{1}{2 \ii \hbar} \sum_n 
        W_{kn} \gamma_n^{(0)} (
            \ee^{\ii (\omega_{kn} + \omega) t} 
            + \ee^{\ii (\omega_{kn} - \omega) t }
        ),
    \end{aligned}
\end{equation}
and the equation can then be solved directly 
since $\gamma_n^{(0)}$ is a constant.
An important approximation is 
\concept{rotating wave approximation (RWA)},
in which we ignore the term $\ee^{\ii (\omega + \omega_{kn}) t}$;
this is a good approximation
when 
\begin{equation}
    \abs*{\omega + \omega_{kn}} \gg \abs*{\omega + \omega_{kn}},
\end{equation}
or in other words when 
the pumping $\vb*{E} = \vb*{E}_0 \cos \omega t$ 
is nearly resonant.
Basically, in RWA we are extracting the \emph{envelope} 
of $\gamma_k^{(1)}$, 
since ignoring the fast oscillating term in a function $f(t)$
is equivalent to replacing $f(t)$ by 
\begin{equation}
    \tilde{f}(t) = \frac{1}{T} \int_{t - T/2}^{t + T/2} f(t') \dd{t'},
\end{equation}
where $T$ is much larger than the period of the fast oscillation.

Now after RWA, we find 
\begin{equation}
    \begin{aligned}
        \gamma^{(1)}_{k}(T) &= \frac{1}{2 \ii \hbar} 
            \sum_n W_{kn} \gamma^{(0)}_n
            \frac{1}{\ii (\omega_{kn} - \omega)}
            \eval{
                \ee^{\ii (\omega_{kn} - \omega) t} 
            }_{0}^T  \\
        &= T \cdot \frac{1}{\ii \hbar} \sum_n 
            W_{kn} \gamma^{(0)}_n \ee^{\ii \Delta \omega T / 2} 
            \sinc(\Delta \omega T / 2),
    \end{aligned} 
\end{equation}
where 
\begin{equation}
    \omega = \omega_k - \omega_n - \omega.
\end{equation}
Therefore we find the probability to s
\begin{equation}
    P_{n \to k}(t) = 
\end{equation}
The final result is the famous Fermi golden rule
\begin{equation}
    P_{n \to k} (t) = t \cdot \frac{2\pi}{\hbar} \abs*{W_{kn}}^2 (\gamma^{(0)}_n)^2 
    \delta_T(\omega_k - \omega_n - \omega).
\end{equation}
We see expectedly that the transition probability reaches its maximum  
when the pumping is resonant.
The fact that we have a sinc function profile of the transition probability 
comes from the finite length of the driving field:
from the mathematical uncertainty relation,
when the pumping pulse has a finite length, 
we don't have a completely well-defined $\omega$,
and the sinc shape comes from the  
Fourier transform of the finite length sine wave.

If we reflect on Fermi golden rule for a while, 
we find something not that physical: 
the spectrum of the final states may be discrete, 
and in this case the $\delta$ function looks suspicious:
for continuous modes the final state spectrum is continuous 
and by saying we sum over final states 
we are actually integrating over the final states, 
so no singular function enters the final result 
of scattering probability;
but for discrete systems this is not true.
This is actually a motivation for quantization of the electromagnetic field
for this provides us with a continuous energy spectrum 
of the composite system of matter and light.

Now we consider radiation from the atom.
This means we should consider the $\omega < 0$ term 
which contributes to the amplitude of states with lower energies.
We do a reverse RWA and ignore the $\ee^{\ii (\omega_{kn} - \omega) t}$ term.

The dipole can also be evaluated from the perturbed wave function.
We have 
\begin{equation}
    \begin{aligned}
        \expval*{\vb*{\mu}}{\psi} &= 
            (\bra*{\psi^{(0)}} + \lambda \bra*{\psi^{(1)}} + \lambda^2 \bra*{\psi^{(2)}} + \cdots)
            \vb*{\mu} (\ket*{\psi^{(0)}} + \lambda \ket*{\psi^{(1)}} + \lambda^2 \ket*{\psi^{(2)}} + \cdots) \\
        &= \underbrace{
            \expval*{\vb*{\mu}}{\psi^{(0)}}
        }_{\expval{\vb*{\mu}}^{(0)}}  + 
        \underbrace{
            \mel*{\psi^{(0)}}{\vb*{\mu}}{\psi^{(1)}} + \text{c.c.}
        }_{\expval*{\vb*{\mu}}^{(1)}} + \cdots,
    \end{aligned}
\end{equation} 
and we can then find the response of the atom dipole to the electric field.
When we are doing this actually we already have to 
slightly deviate from the standard semiclassical coupling theory,
or otherwise when $\omega = \omega_{\text{eg}}$, 
the response is infinite.
The physical answer is spontaneous radiation.

The above procedure can also be seen as a procedure 
to integrate out the atomic degrees of freedom and  
obtain an effective theory of the light field.

\todo{Study dissipation and noise here; todo: spontaneous radiation; 
what's the difference between spontaneous radiation and 
the radiation shown here?}

\section{Elaboration on perturbation schemes}

Suppose we have an \emph{anhamornic} oscillator, 
and the EOM is 
\begin{equation}
    m \ddot{x} + m \omega_0^2 x = - \beta x^2,
\end{equation}
or in other words 
\begin{equation}
    \ddot{x} + \omega_0^2 x = \underbrace{
        - \frac{\beta}{m}
    }_{\eqqcolon \alpha} x^2.
\end{equation}
Of course, when $\alpha = 0$, we go back to the harmonic case.
This equation falls into the scheme 
\begin{equation}
    L x = \lambda N x,
\end{equation}
where $L$ is a linear operator 
and $N$ is the nonlinear, ``interacting'' part.
The perturbation series
\begin{equation}
    x(t) = x_0(t) + \lambda x_1(t) + \cdots 
\end{equation} 
then gives 
\begin{equation}
    \ddot{x}_0 + \omega_0^2 x_0 = 0,
\end{equation}
\begin{equation}
    \ddot{x}_1 + \omega_0^2 x_1 = \alpha x_0^2, 
\end{equation}
\begin{equation}
    \ddot{x}_2 + \omega_0^2 x_2 = \alpha x_0 x_1, 
\end{equation}
and so on. $x_1(t)$ takes the $\cos (2 \omega t)$ form,
or from Feynman diagram it represents SHG from two excitons with frequency $\omega$ 
into one exciton with frequency $2 \omega$.

In the case of a unitary $x^3$ term in the Hamiltonian,
the perturbation theory seems to work fine; 
but now if we treat \emph{damping} in the damped oscillator as a perturbation item,
we get a pathological solution 
which \emph{diverges} and doesn't converge,
although the accuracy in the first several periods is good.
This shows the limit of perturbation theory.

The solution of 
\begin{equation}
    \ddot{a} + \gamma a + \omega_0^2 a = 0 
\end{equation}
is 
\begin{equation}
    a(t) = a_0 \ee^{- \ii \omega_\pm t} ,
\end{equation}
where 
\begin{equation}
    \omega_\pm = \pm \sqrt{
        \omega_0^2 - \left(\frac{\gamma}{2}\right)^2
    } - \ii \frac{\gamma}{2},
\end{equation}
where we observe an envelope 
\begin{equation}
    \expval{a}(t) = a_0 \ee^{- \gamma t / 2}
\end{equation}
under which we see a fast oscillation
with its frequency modified by damping.
When damping is strong compared with $\omega_0$,
it's hard to separate the two, 
but when damping is not that strong, 
separation between damping and oscillation -- 
or more generally, separation between two time scales -- is possible,
and the oscillation shouldn't be too different from $\ee^{- \ii \omega_0 t}$.

With this in mind, assuming that $\gamma / \omega_0 \ll 1$,
and rewriting the equation as 
\begin{equation}
    \ddot{a} + \varepsilon \gamma a + \omega_0^2 a = 0,
    \label{eq:double-time-damping-eq}
\end{equation}
where $\varepsilon$ is a unitless constant 
for bookkeeping purpose,
we write down the ansatz 
\begin{equation}
    a(t) = \bar{a}(
        \underbrace{\varepsilon t}_{\eqqcolon \tau}
    ) \ee^{- \ii \omega_0 t}, 
\end{equation}
which contains a fast variable $\ee^{- \ii \omega_0 t}$
and a slow variable $\bar{a}$;
the argument of $\bar{a}$ is intentionally set to $\varepsilon t$ 
to remind us that $\bar{a}$ is very dull to 
how time passes by.
In the more general case we use $f(t)$ in place of $\ee^{- \ii \omega_0 t}$.
Putting it into \eqref{eq:double-time-damping-eq},
and noticing that 
\begin{equation}
    \dot{a} = - \ii \omega_0 \bar{a} \ee^{- \ii \omega_0 t}
    + \varepsilon \dv{\bar{a}}{\tau} \ee^{- \ii \omega_0 t},
\end{equation}
and 
\begin{equation}
    \ddot{a} \approx (- \ii \omega_0)^2 \bar{a} \ee^{- \ii \omega_0 t} 
    + 2 \varepsilon (- \ii \omega_0) \ee^{- \ii \omega_0 t} \dv{\bar{a}}{\tau},
    \label{eq:ddot-a-approx}
\end{equation}
we have 
\begin{equation}
    2 \varepsilon (- \ii \omega_0) \ee^{- \ii \omega_0 t} \cdot \dot{a} \dv{\bar{a}}{\tau} 
    + \varepsilon (- \ii \omega_0) \ee^{- \ii \omega_0 t} \bar{a} = 0
    \ \Rightarrow \ \dv{\bar{a}}{\tau} + \frac{\gamma}{2} \bar{a} = 0 .
\end{equation}
This is exactly what we expect.
In this example we explicitly write $a(t)$ as the multiplication 
of $\ee^{- \ii \omega_0 t}$ and $\bar{a}(\tau)$; 
if we instead introduce $f(t)$,
we will find the equation it follows 
is just the harmonic oscillator equation.
Finally, we replace $\varepsilon \gamma$ with $\gamma$ 
to go back to the original problem,
and an approximate solution has been found. 

The most formal procedure requires us to keep track of 
every $\varepsilon$ without any ahead-of-time approximations like 
\eqref{eq:ddot-a-approx} or 
inserting the $\gamma = 0$ solution as $f(t)$ into the ansatz for $a$.
In simple calculations however people tend to only keep track of the $\bigO(\varepsilon)$ term,
and the above procedure is perfectly legit.
The idea is the fast part of the solution is usually 
not perturbed at all.
This approximation -- tracking only $\bigO(\varepsilon)$ -- 
is known as \concept{slowly varying envelope approximation}.
\todo{
    Relation with ordinary PT; RG?
}


\section{Rotating wave approximation revisited}

Consider the driven harmonic oscillator
\begin{equation}
    \ddot{a} + \omega_0^2 a = \varepsilon A \cos (\omega t),
\end{equation}
where we have assumed that the driving term is weak enough; 
of course since there is no damping, 
the amplitude will increase infinitely,
but since the driving force is small enough 
it doesn't explode fast.

The ansatz is 
\begin{equation}
    a(t) = \bar{a}(\varepsilon t) \ee^{- \ii \omega_0 t} .
\end{equation}
Substituting this into the EOM, we get 
\begin{equation}
    (- \omega_0^2 \bar{a} 
    - 2 \varepsilon \ii \omega_0 \partial_\tau \bar{a} 
    + \varepsilon^2 \partial_\tau^2 \bar{a}) \ee^{- \ii \omega_0 t}
    + \omega_0^2 \bar{a} \ee^{- \ii \omega_0 t} 
    = \varepsilon A \cos(\omega t).
\end{equation}
The $\bigO(\varepsilon)$ term is 
\begin{equation}
    -2 \ii \varepsilon \omega_0 \partial_\tau \bar{a} = \varepsilon A \cos(\omega t)
    \ \Rightarrow \ 
    \dv{\bar{a}}{t} = \frac{\ii A}{ 2 \omega_0} \cos(\omega t) \ee^{\ii \omega_0 t}.
\end{equation}
Unfortunately $\bar{a}$ still has fast oscillation,
but then we can average over time and get rid of the fast oscillation,
and the eventual result is 
\begin{equation}
    \dv{\expval{\bar{a}}}{t} = \frac{\ii A}{4 \omega_0}.
\end{equation}
To make this approximation make sense, 
we require 
\begin{equation}
    \frac{A}{4 \omega_0} \ll \omega_0   
\end{equation}
so that the increasing of the envelope is not 
of the same order of magnitude of $\omega_0$.

\section{Spontaneous emission}


We can really think of the spontaneous rate as produced 
by an effective photon flux:
the spontaneous emission rate can be rewritten as 
\begin{equation}
    R_{\text{sp}} = \sigma \cdot \frac{c}{\hbar \omega} \cdot \frac{\hbar \omega^3}{\pi c^3}.
\end{equation} 
The spontaneous emission rate can also be obtained  
by replacing the thermal photon occupation in stimulated emission with $1$.
\todo{Relation between cross section and expectation of $\vb*{p}$}

\todo{Rate equation}

\section{Coupling with a quantized EM field}

Consider an atom in a cavity.
We assume that the size of the cavity is very large, almost infinite; 
this means once a photon is emitted it almost never goes back,
and thus
\begin{itemize}
    \item we don't need to consider anything like Poincaré recurrence, 
        and can model the system as a dissipative one, and 
    \item the out state spectrum is continuous 
        and we can use Fermi golden rule.
\end{itemize}
The second point can be seen as a logical consequence of the first one,
since Fermi golden rule is somehow ``dissipative'' in nature.

\section{Interlude: quantization of LC circuit}

As a demonstration of canonical quantization, 
let's consider the quantum version of an LC circuit.
The magnetic energy is 
\begin{equation}
    U_\text{m} = \frac{1}{2} LI^2 = \frac{1}{2}L \dot{Q}^2 ,
\end{equation}
and the electric energy is 
\begin{equation}
    U_{\text{e}} = \frac{1}{2} \frac{Q^2}{C},
\end{equation}
and if we consider the former as the kinetic energy 
and the latter as the potential energy,
the Lagrangian is 
\begin{equation}
    L = \frac{1}{2} L \dot{Q}^2 - \frac{Q^2}{2C},
\end{equation}
and we can easily find that this Lagrangian gives the correct EOM.
Going to the Hamiltonian formalism, 
after a Legendre transform we get 
\begin{equation}
    H = \frac{\Phi^2}{2L} + \frac{1}{2} \frac{Q^2}{C},
\end{equation}
where $\Phi$ is the canonical momentum of $Q$, i.e. 
\begin{equation}
    \Phi \coloneqq \pdv{L}{\dot{Q}} = L \dot{Q}.
\end{equation}
Of course $\Phi$ has its own physical meaning:
the magnetic flux.
Applying canonical commutation relation 
\begin{equation}
    \comm*{Q}{\Phi} = \ii \hbar 
\end{equation}
\todo{Deriving this from QED} we can already quantize the system.
It looks like a quantum harmonic oscillator,
also with different ``mass'' and ``spring constant''.
So the final form of the Hamiltonian,
in occupation number representation, is 
\begin{equation}
    H = \hbar \omega \left(
        a^\dagger a + \frac{1}{2}
    \right),
\end{equation}
where 
\begin{equation}
    \omega = \frac{1}{\sqrt{LC}}
\end{equation}
is the LC frequency. 

It should be noted that to implement the quantum circuit, 
ordinary metals probably won't work, 
since they contain too many other degrees of freedom 
that couple strongly with the electromagnetic degrees of freedom 
and destroy the coherence of the latter 
even when the temperature is low.
Superconducting wires are usually used in place of ordinary wires.

We are describing only one harmonic oscillator here; 
when there are many harmonic oscillators aligned in a certain way in space, 
it's possible to define a \emph{field operator} $\hat{\phi}(\vb*{r}, t)$,
where $\vb*{r}$ is equivalent to the label of harmonic oscillators,
and the time evolution is treated in the same way 
as in ordinary canonical quantization.

Let's consider the electric and magnetic field in the LC circuit.
It can be verified that 
\begin{equation}
    \vb*{E}(\vb*{r}) = \underbrace{
        \bar{\vb*{E}}(\vb*{r})  \sqrt{
        \frac{\hbar}{2 \omega_0}
        }
    }_{\vb*{E}^0(\vb*{r})} (a^\dagger_{\vb*{q}} + a_{\vb*{q}}),
\end{equation}
and 
\begin{equation}
    \vb*{B}(\vb*{r}) = \underbrace{
        \bar{\vb*{B}}(\vb*{r}) \ii \sqrt{
            \frac{\hbar \omega_0}{2} 
        } 
    }_{\vb*{B}^0(\vb*{r})} ( 
        a^\dagger_{\vb*{q}} - a_{\vb*{q}}
    ).
\end{equation}
As a simple demonstration let's assume that 
there is no non-trivial polarization in the circuit:
thus we can treat $\vb*{E}$ and $\vb*{B}$ as scalars 
in \emph{this} case.
Normalization of $\vb*{E}^0$ and $\vb*{B}^0$ 
can be decided by evaluating the total energy:
we expect to get 
\begin{equation}
    \expval{U_\text{e}} + \expval{U_\text{m}} = \frac{1}{2} \hbar \omega_0    
\end{equation}
when we are at the ground state.
We can easily verify that the consequence of this equation is 
\begin{equation}
    \epsilon_0 \int \dd[3]{\vb*{r}} \abs*{\vb*{E}^0(\vb*{r})} = \frac{1}{2} \hbar \omega_0.
\end{equation}
When the shape of our system is not very nontrivial and we can essentially treat it 
as a box with volume $V$ in which $\abs*{\vb*{E}^0(\vb*{r})}$
is completely uniform, this tells us 
\begin{equation}
    E^0(\vb*{r}) = \sqrt{\frac{\hbar \omega_0}{2 \epsilon_0 V}}.
\end{equation}
So the electric field operator for only one mode in a large box is 
\begin{equation}
    \vb*{E}(\vb*{r}) = \vu*{z} \sqrt{\frac{\hbar \omega_0}{2 \epsilon_0 V}} (a^\dagger + a).
    \label{eq:electric-field-one-mode}
\end{equation}

\section{Cavity light field modes and two-level atom}

In principle \eqref{eq:electric-field-one-mode} should be summed over 
to get the full electric field operator.
But in real experimental settings 
the only active degrees of freedom in a system 
are two energy levels of an atom and one EM mode,
and the Hamiltonian becomes 
\begin{equation}
    H = E_\text{g} \dyad{\text{g}} + E_{\text{e}} \dyad{\text{e}} 
    - \vb*{\mu} \cdot \vb*{E} 
    + \hbar \omega_0 (a^\dagger a + 1/2),
\end{equation}
where $\vb*{E}$ is given by \eqref{eq:electric-field-one-mode}.
The wave function is already huge: 
the Hilbert space of the cavity part is countably infinite.
We can analyze possible transitions by calculating 
\begin{equation}
    \mel**{\text{final}}{- \mu E_0 \cos \theta (a + a^\dagger)}{\text{initial}}.
\end{equation} 
The transition between $\ket*{\text{g}, n = 1}$ and $\ket*{\text{e}, n = 0}$,
for example, gives us Rabi oscillation.
\todo{
    When the light field is in a coherent state, 
    we also have Rabi oscillation.
    Explore the situation under which we have Rabi frequency;
    especially if it has anything to do with MBPT.
}
It's impossible to get spontaneous decay in this model, 
because the number of optical modes is not large enough;
we can find spontaneous decay when there are lots of $a_{\vb*{q}}$.

\section{Quantization of field}

Now we consider the complete electric field operator.
We assume it's the sum of something like \eqref{eq:electric-field-one-mode},
where $a$ may be any annihilation operator 
corresponding to an oscillation mode of the system 
treated as a quantum oscillator,
and $\vu*{z}$ needs to be replaced by the true polarization vector $\vu*{f}$, 
which may also contain phase factors like $\ee^{\ii \vb*{k} \cdot \vb*{r}}$,
with the same normalization
\begin{equation}
    \int \dd[3]{\vb*{r}} \abs*{\vu*{f}(\vb*{r})}^2 = V.
\end{equation} 
Note that the equivalence of this quantization 
and the ``real'' canonical quantization 
by imposing commutation relations on $\vb*{A}$ 
is not guaranteed a priori, but is indeed true.
\todo{
    Commutation relation between $\vb*{E}$ and $\vb*{B}$
}
The interaction between light and a two-level atom is then modeled by 
\begin{equation}
    H = H_{\text{atom}} - \vb*{\mu} \cdot \vb*{E} + \hbar  \sum_k \omega_k \left(
        a^\dagger_k a_k + \frac{1}{2}
    \right).
\end{equation}
The basis of the Hilbert space is 
\begin{equation}
    \{
        \ket*{
            \text{atom}, \underbrace{
                n_1, n_2, \ldots, n_k, \ldots
            }_{\text{light}, \{n_i\}} 
        }
    \}.
    \label{eq:complete-light-mattery}
\end{equation}
The dipole interaction term still 
changes one photon occupation number by 1 at once; 
but now an excited state can evolve into many 
one-photon final states, 
and we will see we will get exponential decay 
of the atomic occupation. 

\section{Spontaneous emission in vacuum}

Now we finally can have a quantitative description 
of spontaneous emission.
The complete Hamiltonian is 
\begin{equation}
    H = H_{\text{two level atom}} + \sum_{\vb*{k}} \hbar \omega_{\vb*{k}} \left(
        a^\dagger_{\vb*{k}} a_{\vb*{k}} + \frac{1}{2}
    \right) - \sum_{\vb*{k}} \vb*{\mu} \cdot \vb*{E}_0 \ii (a^\dagger_{\vb*{k}} - a_{\vb*{k}}).
\end{equation}
Consider only the single-photon process, 
we confine \eqref{eq:complete-light-mattery} to 
the subspace where there is at most one photon in the system.
The total transition rate, 
i.e. the probability for an excited atom to emit one photon 
and goes back to the ground state, is the sum of  
the transition rates of all radiation channels. 
So we have 
\begin{equation}
    \begin{aligned}
        P_{\text{e} \to \text{g}} 
        &= \sum_{\vb*{k}} \frac{2\pi}{\hbar^2} \abs*{W_{\text{e} \to \text{g}, \vb*{k}}}^2 
        \delta(\omega_{\vb*{k}} - \omega_{\text{eg}})  \\
        &= \frac{2\pi}{\hbar^2} \abs*{W}^2 D(\omega_{\text{eg}}),
    \end{aligned}
\end{equation}
where we have assumed that the wave vector of the output photon $\vb*{k}$ 
has little influence on the transition amplitude $W_{\text{e} \to \text{g}, \vb*{k}}$
(this assumption of course fails in highly anistropic systems, 
like photonic crystals),
and $D(\omega)$ is the density of states of EM modes. 
When $\vb*{k}$ does have a strong influence on $W$, 
we need to rewrite $W$ into 
\begin{equation}
    W_{\text{e} \to \text{g}, \vb*{k}} = W(\omega_{\vb*{k}}, \vu*{k}),
\end{equation}
and the transition probability becomes 
\begin{equation}
    P_{\text{e} \to \text{g}} = 
    \frac{2\pi}{\hbar^2} 
    \int \frac{\dd{\Omega}}{4\pi} \abs*{W(\omega_{\text{eg}}, \vu*{k})}^2 D(\omega_{\text{eg}}),
\end{equation}
where $\dd{\Omega}$ is the solid angle element of $\vu*{k}$.

In free space, we have 
\begin{equation}
    \abs*{W}^2 = \abs*{\mu_{\text{eg}}}^2 \abs*{E_0}^2 \cos^2 \theta
    = \frac{\hbar \omega}{2 \epsilon_0 V} \abs*{\mu_{\text{eg}}}^2 \cos^2 \theta.
\end{equation}
The DOS of light is 
\begin{equation}
    D(\omega) = \frac{V}{2 \pi^2} \frac{\omega^2}{c^3}.
    \label{eq:dos-free-space}
\end{equation}
We can verify that 
\begin{equation}
    \int \frac{\dd{\Omega}}{4\pi} \cos^2 \theta = \frac{1}{3},
\end{equation}
and we still have double degeneracy of polarization.
The final transition rate is 
\begin{equation}
    \begin{aligned}
        \Gamma_{\text{e} \to \text{g}} &= 
        2 \cdot \frac{2\pi}{\hbar^2} \cdot \frac{\hbar \omega}{2 \epsilon_0 V} \abs*{\mu_{\text{eg}}}^2 \cdot \frac{1}{3} \cdot \frac{V}{2 \pi^2} \frac{\omega^2}{c^3} \\
        &= \frac{
            \omega^3 \abs*{\mu_{\text{eg}}}^2
        }{
            3 \pi \epsilon_0 \hbar c^3
        }.
    \end{aligned}
\end{equation}

It's possible that we also have a continuum of \emph{initial} states:
in this case we need to sum over initial states as well,
resulting in a joint density of states. 

The decay rate also gives an uncertainty of the energy levels.

\section{Emission into a cavity}

There is no dissipation in the EM field in vacuum,
but there may be dissipation in a cavity.
A cavity always have coupling with a continuum of degrees of freedom,
which produces what is known as dissipation 
if we keep our eyes on the cavity itself.
If we go to the example of the LC circuit,
this time connected to a semi-infinite transmission line,
which plays the role of resistance,
we will observe the same phenomenon.
In a leaky cavity we no longer have perfectly well defined frequencies, 
and when the atom is coupled to the cavity,
we need to replace the old DOS by an effective DOS 
with finite lindwidths; \todo{Derivation}
note that for each mode in the cavity (leaky or not), we always have 
\begin{equation}
    \int \dd{\omega} \text{DOS}(\omega) = 1.
\end{equation}

Now suppose we have an atom in a leaky cavity.
It has to spontaneous emission targets:
the free space (whose DOS is \eqref{eq:dos-free-space})
and the cavity modes.
Assuming that only the \emph{one} cavity mode nearby is relevant,
we have 
\begin{equation}
    D_{\text{leaky cavity}}(\omega) = \frac{1}{2\pi} \frac{
        \Delta \omega
    }{
        (\omega - \omega_0)^2 + (\Delta \omega / 2)^2
    },
\end{equation}
where $\omega_0$ is the frequency of that mode 
if there were no dissipation, 
and $\Delta \omega$ is the line width.
Defining 
\begin{equation}
    \Delta \omega \eqqcolon \frac{\omega_0}{Q},
\end{equation}
we find 
\begin{equation}
    \eta_{\text{Purcell}} \coloneqq \frac{\Gamma_{\text{cavity}}}{\Gamma_{\text{free space}}}
    \propto \frac{Q}{V} \cdot \text{something about $\omega$}.
\end{equation}
So unexpectedly, if we increase $Q$ and decrease $V$, 
we can make the atom selectively emits a photon 
whose behavior we know.
This is known as \concept{Purcell enhancement};
a Purcell device can be used as a single photon source.
Note that $Q$ shouldn't be too strong if we want to use it as a single photon source, 
or otherwise what we get is just Rabi oscillation.

\section{Population dynamics and laser}

In Beer's law we get decreasing intensity; 
if we are able to cause population inversion 
(i.e. more excited atoms than ground state atoms),
which is a highly non-equilibrium state
and always comes with pumping, 
we have \emph{gain} instead of \emph{dissipation}.
The spatial distribution now is determined by 
\begin{equation}
    \dv{I}{z} = N (\pope \sigma_{\text{e}} - \popg \sigma_{\text{g}}) I.
\end{equation}
When the scattering cross section of the excited state and the ground state is the same, 
we need $N_{\text{e}} > N_{\text{g}}$ for positive optical gain. 

Now the problem is how to cause population inversion.
A possible way is to use a four level system 
where the ``ground state'' in the population inversion subspace 
has rapid decay rate to a lower state $\ket*{\text{l}}$,
from which external light pumping brings atoms to a much higher state $\ket{\text{h}}$;
the decay rate from $\ket{\text{h}}$ to $\ket*{\text{e}}$ is also rapid,
and thus we get population inversion
between $\ket*{\text{g}}$ and $\ket{\text{e}}$.

To maximize gain, usually a laser device has the following structure:
a piece of crystal containing an energy level configuration that allows optical gain 
(like the four-level system mentioned above)
is placed in an optical cavity,
and light goes around the cavity and has gain in the round trip;
of course damping still exists 
(at, for example, the mirrors),
and the condition for laser generation 
is that the gain is larger than the loss.

The rate equation for the excited state population is 
\begin{equation}
    \dv{N_{\text{e}}}{t} = 
    \underbrace{
        - \Gamma_{\text{spontaneous radiation}} N_{\text{e}}
        - \Gamma_{\text{non-radiative}} N_{\text{e}}
    }_{- \Gamma_{\text{t}} N_{\text{e}}}
    + N_{\text{g}} R_{\text{pump}}.
\end{equation}
The pumping coefficient reads 
\begin{equation}
    R = \frac{I \sigma}{\hbar \omega},
\end{equation} 
where $I$ is the pumping intensity.
We still need to consider the rate equations for photons within the cavity.
Since the cavity is always leaky, 
we have a photon lifetime in the cavity and 
\todo{Details}

When $R$ is small, the output is just fluorescence, 
i.e. amplified spontaneous emission;
but after $R$ passes a threshold, 
the output increases $10^6$ times and laser appears.
Note that the total energy of photons in the cavity 
has saturation effect: it doesn't increase unboundedly 
when we increase $R$.

The above formalism doesn't touch the quantum state of 
the state of the output light; 
it's actually in a coherent state,
with behaviors very close to classical electromagnetic field.

\todo{
    Weird cases where the rate equation fails: 
    laser generator that doesn't have one atom inside?
}

\section{Nonlinear optics}

A spring driven hard enough no longer looks like a prototypical spring;
optical nonlinearity naturally arises if there is nonlinearity inside the medium; 
or it can appear when several input photon lines 
successively ``accelerate'' a material degree of freedom
in a Feynman diagram,
even though there is no interaction vertex in the latter.

When a scattering process is due to a linear process 
(i.e. one propagator in, one propagator out),
we have three cases:
elastic scattering, inelastic scattering, and absorption.
Elastic scattering doesn't change the internal state of the material,
and it doesn't change the energy of the photon, 
although $\vb*{k}$ can change; 
inelastic scattering changes the internal state of the material 
and changes the energy of the photon as well;
absorption eliminates the photon altogether.
\todo{
    Relation with inelastic scattering.
}
In nonlinear optics elastic scattering is also known as 
\concept{parametric process}.

\begin{figure}
    \centering
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1]
        %uncomment if require: \path (0,300); %set diagram left start at 0, and has height of 300
        
        %Straight Lines [id:da25983667214809936] 
        \draw    (95,203) -- (189.83,203) ;
        %Straight Lines [id:da9538705859744989] 
        \draw  [dash pattern={on 4.5pt off 4.5pt}]  (95,168) -- (142.42,168) ;
        %Straight Lines [id:da42270211581631045] 
        \draw  [dash pattern={on 4.5pt off 4.5pt}]  (95,133) -- (189.83,133) ;
        %Straight Lines [id:da1776425499381462] 
        \draw    (120,203) -- (120,171) ;
        \draw [shift={(120,168)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
        %Straight Lines [id:da303525394738011] 
        \draw    (120,168) -- (120,136) ;
        \draw [shift={(120,133)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
        %Straight Lines [id:da33468994886374914] 
        \draw    (165.83,200) -- (165.83,134.06) ;
        \draw [shift={(165.83,203)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
        
        % Text Node
        \draw (118,150.5) node [anchor=east] [inner sep=0.75pt]    {$\omega _{1}$};
        % Text Node
        \draw (118,185.5) node [anchor=east] [inner sep=0.75pt]    {$\omega _{1}$};
        % Text Node
        \draw (167.83,168.53) node [anchor=west] [inner sep=0.75pt]    {$\omega _{2}$};
        
        
        \end{tikzpicture}
    \caption{Energy level diagram for SHG}        
    \label{fig:shg}
\end{figure}

For \concept{second harmonic generation (SHG)}, 
the energy level diagram looks like \prettyref{fig:shg}, 
where we have two \emph{virtual} energy levels 
that are not real energy levels in the material,
and the energy conservation condition 
\begin{equation}
    \omega_1 + \omega_1 = \omega_2,
\end{equation}
and the phase matching condition
\begin{equation}
    k(\omega_1) + k(\omega_1) = k(\omega_2).
\end{equation}
The second condition is essentially the momentum conservation condition
but we refrain from using this name,
because the only thing we know about $\vb*{k}$
is that it's the wave vector; 
the true momentum flow in a material with an ongoing beam of light 
is very tricky to deal with.

Suppose we have three Fourier components $E_{1, 2, 3}$.
The electric field is 
\begin{equation}
    E = E_1 + E_2 + E_3 + \text{c.c.},
\end{equation}
and the total polarization is 
\begin{equation}
    P^{(2)} = \epsilon_0 \chi^{(2)} E E ,
\end{equation}
and, for example, the polarization with frequency $\omega_2$ is 
\begin{equation}
    \ptwo_{2} = 2 \epsilon_0 \chitwo E_1 E_3^* + \text{c.c.}
\end{equation}
$E_1$ can be seen as annihilation of one photon at mode 1, 
and $E_3^*$ can be seen as creation 
(if we are only interested in mode 2, then ``loss'') 
of one photon at mode 3; 
or, since the electromagnetic field is real, 
``annihilation of a $- \omega_2$ photon''.
Therefore we have 
\begin{equation}
    \ptwo_{2} =
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,100);\path (126,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Shape: Circle [id:dp3306811404234127] 
    \draw   (39.33,55.47) .. controls (39.33,46.15) and (46.88,38.6) .. (56.2,38.6) .. controls (65.51,38.6) and (73.06,46.15) .. (73.06,55.47) .. controls (73.06,64.78) and (65.51,72.33) .. (56.2,72.33) .. controls (46.88,72.33) and (39.33,64.78) .. (39.33,55.47) -- cycle ;
    %Straight Lines [id:da5296240459642283] 
    \draw    (20.21,20.6) .. controls (22.56,20.59) and (23.75,21.76) .. (23.77,24.11) .. controls (23.79,26.47) and (24.98,27.64) .. (27.34,27.61) .. controls (29.7,27.59) and (30.89,28.76) .. (30.91,31.12) .. controls (30.93,33.47) and (32.12,34.64) .. (34.47,34.62) .. controls (36.83,34.6) and (38.02,35.77) .. (38.04,38.13) .. controls (38.06,40.48) and (39.25,41.65) .. (41.6,41.63) -- (43.21,43.21) -- (43.21,43.21) ;
    %Straight Lines [id:da2928888332475701] 
    \draw    (22.21,83.6) .. controls (22.37,81.25) and (23.63,80.16) .. (25.98,80.32) .. controls (28.33,80.49) and (29.59,79.39) .. (29.75,77.04) .. controls (29.92,74.69) and (31.18,73.59) .. (33.53,73.76) .. controls (35.88,73.93) and (37.14,72.83) .. (37.3,70.48) .. controls (37.46,68.13) and (38.72,67.03) .. (41.07,67.2) -- (42.21,66.21) -- (42.21,66.21) ;
    %Straight Lines [id:da7321119817704607] 
    \draw    (73.06,55.47) .. controls (74.73,53.8) and (76.39,53.8) .. (78.06,55.47) .. controls (79.73,57.14) and (81.39,57.14) .. (83.06,55.47) .. controls (84.73,53.8) and (86.39,53.8) .. (88.06,55.47) .. controls (89.73,57.14) and (91.39,57.14) .. (93.06,55.47) .. controls (94.73,53.8) and (96.39,53.8) .. (98.06,55.47) -- (101.21,55.47) -- (101.21,55.47) ;
    %Straight Lines [id:da7059296554476169] 
    \draw    (31.67,18.33) -- (44.82,31.48) ;
    \draw [shift={(46.94,33.6)}, rotate = 225] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da040632101683849564] 
    \draw    (33.21,64.6) -- (22.59,72.78) ;
    \draw [shift={(20.21,74.6)}, rotate = 322.43] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    %Straight Lines [id:da7511565889159759] 
    \draw    (80.21,48) -- (96.21,48) ;
    \draw [shift={(99.21,48)}, rotate = 180] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (7.14,-3.43) -- (0,0) -- (7.14,3.43) -- (4.74,0) -- cycle    ;
    % Text Node
    \draw (18.21,20.6) node [anchor=east] [inner sep=0.75pt]   [align=left] {1};
    % Text Node
    \draw (20.21,83.6) node [anchor=east] [inner sep=0.75pt]   [align=left] {3};
    % Text Node
    \draw (103.21,55.47) node [anchor=west] [inner sep=0.75pt]   [align=left] {2};
    \end{tikzpicture}
    =\tikzset{every picture/.style={line width=0.75pt}} %set default line width to 0.75pt        
    \begin{tikzpicture}[x=0.75pt,y=0.75pt,yscale=-1,xscale=1, baseline=(XXXX.south) ]
    \path (0,100);\path (122.33333587646484,0);\draw    ($(current bounding box.center)+(0,0.3em)$) node [anchor=south] (XXXX) {};
    %Straight Lines [id:da30223211942772465] 
    \draw    (12.17,85.5) -- (107,85.5) ;
    %Straight Lines [id:da2414629403384987] 
    \draw  [dash pattern={on 4.5pt off 4.5pt}]  (65.17,50.5) -- (112.58,50.5) ;
    %Straight Lines [id:da7465700877666686] 
    \draw  [dash pattern={on 4.5pt off 4.5pt}]  (12.17,15.5) -- (107,15.5) ;
    %Straight Lines [id:da994160829255007] 
    \draw    (90.17,82.5) -- (90.17,50.5) ;
    \draw [shift={(90.17,85.5)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da46890571414486626] 
    \draw    (90.17,47.5) -- (90.17,15.5) ;
    \draw [shift={(90.17,50.5)}, rotate = 270] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    %Straight Lines [id:da23096093426901132] 
    \draw    (23,85.5) -- (23,19.56) ;
    \draw [shift={(23,16.56)}, rotate = 90] [fill={rgb, 255:red, 0; green, 0; blue, 0 }  ][line width=0.08]  [draw opacity=0] (8.04,-3.86) -- (0,0) -- (8.04,3.86) -- (5.34,0) -- cycle    ;
    % Text Node
    \draw (88.17,33) node [anchor=east] [inner sep=0.75pt]    {$\omega _{3}$};
    % Text Node
    \draw (88.17,68) node [anchor=east] [inner sep=0.75pt]    {$\omega _{2}$};
    % Text Node
    \draw (25,51.03) node [anchor=west] [inner sep=0.75pt]    {$\omega _{1}$};
    \end{tikzpicture}.
\end{equation}
It's possible that the final step -- creation of a photon at mode 2 -- doesn't happen:
we reach another stationary state.
In this case we get \emph{non-linear absorption}.
This is what is known as \concept{Raman effect},
and from the perspective of photons, 
it reduces the photon energy,
while from the perspective of the matter, 
it increases population on an excited state.

The next question is when the nonlinear effects are important.
Since the Taylor expansion of $P$ with respect to $E$ 
is essentially the Taylor expansion of $P$ with respect to $E / E_0$,
where $E_0$ is the characteristic field strength
-- usually the ionization field strength,
the order of magnitude of $E / E_0$ is the criterion.

\todo{
    Is there nonlinearity with quantum harmonic oscillator driven by external field?
    In the coupling Hamiltonian, we have $e x E \sim (a + a^\dagger) E$ 
    where $a$ and $a^\dagger$ controls the number of ``oscillation quantum'' of the QHO; 
    this of course is radically different from the usual picture of condensed matter field theory 
    where the matter degree of freedom is like $c_{n}$ and $c^\dagger_{n}$.
}

Miller's rule:
\begin{equation}
    \chitwo(2\omega; \omega, \omega) \propto
    \chi(2 \omega) \chi(\omega) \chi(\omega).
\end{equation}
This can be accurately derived from the anhamornic oscillator;
and it can also be seen from the structure of Feynman diagrams.

SHG is only possible when inversion symmetry is broken; 
so for a condensed matter system to show SHG, 
we need at least two atomic species.

\section{Third order nonlinearity}

Unlike second order nonlinearity,
third order nonlinearity can be found in all materials.
It has important physical consequences,
the most important ones being \concept{self-phase modulation}, 
i.e. the change of the phase according to the local intensity, 
and intensity-dependent frequency shift.
The displacement field now reads 
\begin{equation}
    D = \epsilon_0 E + P = \underbrace{
        \epsilon_0 E + \epsilon_0 \chi^{(1)} E
    }_{\epsilon_0 \epsr E} + 
    \underbrace{
    \epsilon_0 \chi^{(3)} E E E 
    }_{P_{\text{NL}}}.
\end{equation}
Here we only consider \concept{Kerr nonlinearity},
where $P_{\text{NL}}$ contains a $\omega$ component 
and a $3 \omega$ component.
Putting this back to the Maxwell's equations, we find 
\begin{equation}
    \left(
        - \partial_z^2 
        - \left(\frac{\omega}{c}\right)^2 
        (\epsr + \Delta \epsr)
    \right) \tilde{E}(\omega) = 0,
\end{equation}
where 
\begin{equation}
    \Delta \epsr = \epsilon_0 \cdot 3 \chi^{(3)} \abs*{\tilde{E}}^2.
\end{equation}
This means the effective refractive index depends on the intensity:
note that we have 
\begin{equation}
    \abs*{\tilde{E}}^2 = \frac{2 I}{c \epsilon_0 n},
\end{equation}
and therefore 
\begin{equation}
    \Delta \epsr = \frac{6 \chi^{(3)}}{\epsilon_0 c n} I.
\end{equation}

It's possible for $\chi^{(3)}$ to contain an imaginary part,
but let's forget about that at this moment;
this leads to good predictions most of the time:
as long as $3 \omega$ is too small for any 
``bright'' (i.e. has strong coupling with electromagnetic field) excitations 
in the crystal, 
$\chi^{(3)}$ is almost completely real; 
of course, when we tune $\omega$ so that $3 \omega$ 
matches an optical band gap, 
this is no longer true.
When $\chi^{(3)}$ is indeed real,
the dispersion relation now is 
\begin{equation}
    k = \frac{\omega}{c} (n + \Delta n),
\end{equation}
where 
\begin{equation}
    (n + \Delta n)^2 = \epsr + \Delta \epsr.
\end{equation}
Assuming that $\Delta \epsr$ is small, 
we have 
\begin{equation}
    2 n \Delta n = \Delta \epsr \Rightarrow 
    \Delta n = \underbrace{
        \frac{
        3 \chi^{(3)}
        }{\epsilon_0 c n^2}
    }_{\eqqcolon n_2} I.
\end{equation}

Now we consider the physical implication of $n_2$.
In linear medium we have Gaussian beam;
but in a medium with strong $\chi^{(3)}$,
for a beam of laser,
the center of the cross section has a higher refractive index, 
and the refractive profile is similar to that of an optical fiber, 
and the laser guides itself through the medium 
and keeps itself from diverging.
This is known as one kind of \concept{spatial solitons}.

The same nonlinearity also causes \concept{spectral generation}.
Suppose a pulse 
\begin{equation}
    E(t) = A(t) \ee^{\ii \phi(t)}
\end{equation}
is injected into the medium.
Then the Kerr nonlinearity contributes to the phase:
\begin{equation}
    \Delta \phi_{\text{NL}}(t) \propto \Delta n(t) \propto I(t).
\end{equation}
Now we examine how the disruption of the simple harmonic phase  
by Kerr nonlinearity contributes to the spectral distribution of the pulse:
the frequency shift is 
\begin{equation}
    \Delta \omega_{\text{NL}} = - \dot{\phi}_{\text{NL}}
    \propto \dot{I}(t),
\end{equation}
and therefore the frequency distribution is broadened 
by the oscillation of $I$;
specifically, we can indefinitely broaden the spectrum 
by increasing $I$.

The aforementioned analysis considers no dispersion; 
this is correct if we only consider a very slim film of the medium,
but for a generalized case -- like a nonlinear optical fiber -- 
dispersion makes the pulse dissolve, 
and this weakens self-phase modulation. 

We need to note that since $\chithree$ is frequency-dependent, 
so is $n_2$, and thus from Kramers-Kronig relation, 
$n_2$ has an imaginary part. 
We have 
\begin{equation}
    \Im n_2 = \frac{3 \Im \chithree}{\epsilon_0 c n^2} \eqqcolon \beta_2,
\end{equation} 
and $\beta_2$ adds a term to the absorption coefficient:
\begin{equation}
    \Delta \alpha = \beta_2 I.
\end{equation}
This is known as \concept{nonlinear absorption}.

Let's consider the semiclassical theory for nonlinear absorption.
Again, in time-dependent perturbation theory, we have 
\begin{equation}
    \expval{\vb*{\mu}}^{(3)} = \mel*{\psi^{(0)}}{\vb*{\mu}}{\psi^{(3)}}  
    + \mel*{\psi^{(1)}}{\vb*{\mu}}{\psi^{(2)}}  
    + \mel*{\psi^{(2)}}{\vb*{\mu}}{\psi^{(1)}}  
    + \mel*{\psi^{(3)}}{\vb*{\mu}}{\psi^{(0)}}  .
\end{equation}
This is the $\bigO(\lambda^3)$ term, 
and hence is proportional to $\chithree$.
\todo{Floquet state; see Eugene Merzbacher 1999 p. 509}

We can see that $\beta_2$ involves two in-coming ``photons''; 
there is no out-going lines, 
since this is not a parametric process.
Thus we can see that the relation between $\Re \chithree$ 
and $\Im \chithree$ is just the optical theorem applied on a non-linear interaction vertex:
the former comes from a four-legged diagram, 
while the second comes from a two-legged diagram.

\end{document}