\documentclass[hyperref, a4paper]{article}

\usepackage{geometry}
\usepackage{float}
\usepackage{titling}
\usepackage{titlesec}
% No longer needed, since we will use enumitem package
% \usepackage{paralist}
\usepackage{enumitem}
\usepackage{footnote}
\usepackage{soulutf8}
\usepackage{enumerate}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{mathtools}
\usepackage{bbm}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{physics}
\usepackage{tensor}
\usepackage{siunitx}
\usepackage{booktabs}
\usepackage[version=4]{mhchem}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{autobreak}
\usepackage[ruled, vlined, linesnumbered]{algorithm2e}
\usepackage[backend=bibtex,doi=false,isbn=false,url=false]{biblatex}
\addbibresource{gw.bib}
\usepackage[colorlinks,unicode]{hyperref} % , linkcolor=black, anchorcolor=black, citecolor=black, urlcolor=black, filecolor=black
\usepackage[most]{tcolorbox}
\usepackage{prettyref}

% Page style
\geometry{left=3.18cm,right=3.18cm,top=2.54cm,bottom=2.54cm}
\titlespacing{\paragraph}{0pt}{1pt}{10pt}[20pt]
\setlength{\droptitle}{-5em}

% More compact lists 
% \setlist[itemize]{itemindent=17pt, leftmargin=1pt}

% Math operators
\DeclareMathOperator{\timeorder}{T}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\legpoly}{P}
\DeclareMathOperator{\primevalue}{P}
\DeclareMathOperator{\sgn}{sgn}
\newcommand*{\ii}{\mathrm{i}}
\newcommand*{\ee}{\mathrm{e}}
\newcommand*{\const}{\mathrm{const}}
\newcommand*{\suchthat}{\quad \text{s.t.} \quad}
\newcommand*{\argmin}{\arg\min}
\newcommand*{\argmax}{\arg\max}
\newcommand*{\normalorder}[1]{: #1 :}
\newcommand*{\pair}[1]{\langle #1 \rangle}
\newcommand*{\fd}[1]{\mathcal{D} #1}
\DeclareMathOperator{\bigO}{\mathcal{O}}
\DeclareMathOperator{\id}{id}

% TikZ setting
\usetikzlibrary{decorations.text}
\usetikzlibrary{arrows,shapes,positioning}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{decorations.markings}
\tikzstyle arrowstyle=[scale=1]
\tikzstyle directed=[postaction={decorate,decoration={markings,
    mark=at position .5 with {\arrow[arrowstyle]{stealth}}}}]
\tikzstyle ray=[directed, thick]
\tikzstyle dot=[anchor=base,fill,circle,inner sep=1pt]

% Algorithm setting
% Julia-style code
\SetKwIF{If}{ElseIf}{Else}{if}{}{elseif}{else}{end}
\SetKwFor{For}{for}{}{end}
\SetKwFor{While}{while}{}{end}
\SetKwProg{Function}{function}{}{end}
\SetArgSty{textnormal}

\newcommand*{\concept}[1]{{\textbf{#1}}}

\DeclareMathOperator{\im}{im}

% Embedded codes
\lstset{basicstyle=\ttfamily,
  showstringspaces=false,
  commentstyle=\color{gray},
  keywordstyle=\color{blue}
}

\newcommand{\soliddoc}{\href{../solid/solid.pdf}{this note}}
\newcommand{\lastlec}{\href{./2022-3-15.pdf}{the last lecture}}

% Reference formatter
\newrefformat{fig}{Fig.~\ref{#1}}

% Color boxes
\tcbuselibrary{skins, breakable, theorems}

\newtcbtheorem[number within=chapter]{infobox}{Box}{
    enhanced,
    boxrule=0pt,
    colback=blue!5,
    colframe=blue!5,
    coltitle=blue!50,
    borderline west={4pt}{0pt}{blue!65},
    sharp corners,
    fonttitle=\bfseries, 
    breakable,
    before upper={\parindent15pt\noindent}}{box}

% Disable unsupported commands in bookmark titles 
\pdfstringdefDisableCommands{%
  \def\\{}%
  \def\texttt#1{<#1>}%
  \def\mathbb#1{#1}%
}
\pdfstringdefDisableCommands{\def\eqref#1{(\ref{#1})}}

\makeatletter
\pdfstringdefDisableCommands{\let\HyPsd@CatcodeWarning\@gobble}
\makeatother

\title{Photon transferring}
\author{Jinyuan Wu}

\begin{document}

\maketitle

\section{Heuristic derivation of the light transportation equation}

In this section we derive the light transportation equation 
in a way inspired by the quantum Boltzmann equation (QBE).
We know in an isotropic medium, the dispersion relation of light is always 
in the form of 
\begin{equation}
    \omega = c k,  
\end{equation}
where $c$ is the effective speed of light in the medium, 
and therefore 
\begin{equation}
    \grad_{\vb*{k}} = c \vu*{k} \eqqcolon c \vu*{s},
\end{equation}
where $\vu*{s}$ is the direction of the photon momentum, 
i.e. the direction of light propagation.
Thus, for photons in an \ul{isotropic and uniform medium}, 
Suppose $f(\vb*{r}, \vb*{k}, t)$ is the distribution function of photons.
In the LHS of QBE, we have 
\begin{equation}
    \begin{aligned}
        \text{LHS} &= \pdv{f}{t} + \pdv{\omega}{\vb*{k}} \cdot \pdv{f}{\vb*{r}}
        - \pdv{\omega}{\vb*{r}} \cdot \pdv{f}{\vb*{k}} \\
        &= \pdv{f}{t} + c \vu*{s} \cdot \pdv{f}{\vb*{r}}.
    \end{aligned}
\end{equation}
\ul{Ignoring non-linear processes}, due to conservation of energy, 
the magnitude of the $\vb*{k}$ vector is conserved, 
and therefore we may confine ourselves to 
a small segment of $f(\vb*{r}, \vb*{k}, t)$
where $\abs*{\vb*{k}}$ is a given constant.
Since we are only working with single-photon processes, 
and all scattering events can be thought of as 
scattering with some kind of ``disorders'' in the medium, 
the collision integral in QBE, obtained from Fermi golden rule, 
is linear with respect to $f$: 
it always takes the form of 
\begin{equation}
    \text{RHS} = - 2\pi \sum_{\vb*{k'}} \abs*{M(\vb*{k} \to \vb*{k}')}^2 (f(\vb*{r}, \vb*{k} , t) - f(\vb*{r}, \vb*{k}', t) )
    \delta(\omega_{\vb*{k}} - \omega_{\vb*{k}'}),
\end{equation}
where the quantum corrections to the incoming and the outgoing terms 
cancel each other. 

Since the QBE with an isotropic and uniform diffusion term 
and a disorder-induced collision integral outlined above 
is linear, we can multiply an arbitrary factor to $f$ 
without modifying the form of the equation.
In a macroscopic theory we want to work with quantities that 
have direct macroscopic meanings; 
for radiation this means we want to work with energy, 
i.e. $(n + 1/2) \hbar \omega \approx n \hbar \omega$.
Since $\abs*{\vb*{k}}$ is conserved, 
we can decompose the $\vb*{k}$ degree of freedom 
into the degree of freedom of frequency (i.e. color)
and the degree of freedom of wave vector orientation, 
referred to as $\vu*{s}$, 
the solid angle element of which is $\dd{\Omega}$. 
We define \concept{radiance} as a function $L(\vb*{r}, \vu*{s}, t)$ such that
\begin{equation}
    L(\vb*{r}, \vu*{s}, t) \vu*{s} \dd{\omega} \dd{\Omega} 
    = \underbrace{f(\vb*{r}, \vb*{k}, t) \cdot k^2 \dd{k} \dd{\Omega} }_{\text{photon number}}
    \cdot \underbrace{\hbar \omega}_{\text{single photon energy}} \cdot
    \underbrace{c \vu*{s}}_{\text{velocity}} , \quad 
    \omega = c k,
\end{equation}
and thus the energy flux (also known as the \concept{flux}) 
on the spectrum range between $\omega$ and $\omega + \dd{\omega}$
going through an area element $\dd{\vb*{A}}$ is 
\begin{equation}
    \dd{\Phi} = L(\vb*{r}, \vu*{s}, t) \vu*{s} \cdot \dd{\vb*{A}} \dd{\omega} \dd{\Omega},
\end{equation}
The unit of $L$ is \unit{W/(m^2 \cdot Hz)}: 
when $L \dd{\omega}$ is understood as an energy current, 
the unit has clear physical meaning, 
and we can also understand $L$'s unit as \unit{W/m^3 \cdot m/s},
which means a part in $L \dd{\omega}$ can be seen 
as energy density times $c$.
Both understandings are correct,
as is illustrated in \eqref{eq:diffusion-radiance}.

We also want to parameterize the collision integral of QBE.
The RHS of QBE of $L$ is now rewritten as 
\begin{equation}
    \begin{aligned}
        \text{RHS} &= c \mu_{\text{s}} \int \dd{\Omega'} (L(\vb*{r}, \vu*{s}', t) - L(\vb*{r}, \vu*{s}, t)) P(\vu*{s}, \vu*{s}') \\
        &= c \mu_{\text{s}} \int \dd{\Omega'} L(\vb*{r}, \vu*{s}', t)  P(\vu*{s}, \vu*{s}')
        - c \mu_{\text{s}} L(\vb*{r}, \vu*{s}, t) ,
    \end{aligned}
\end{equation}
where we have decomposed the scattering matrix 
into an overall strength $c \mu_{\text{s}}$ 
(the $c$ factor will cancel with the $c$ factor in the second term of LHS), 
and a function $P(\vu*{s}, \vu*{s}')$ -- for some reason called the \concept{phase function} -- 
measuring how anisotropic the scattering process is, 
and the normalization condition is 
\begin{equation}
    \int \dd{\Omega'} P(\vu*{s}, \vu*{s}') = 1,
\end{equation}
and when the scattering process is also completely isotropic, we have 
\begin{equation}
    P(\vu*{s}, \vu*{s}') = \frac{1}{4 \pi}.
\end{equation}
The QBE of photons therefore becomes the following 
\concept{radiation transfer equation (RTE)}: 
\begin{equation}
    \frac{1}{c} \pdv{L}{t} + \vu*{s} \cdot \grad_{\vb*{r}} L = 
    - \mu_{\text{s}} L + \mu_{\text{s}} \int \dd{\Omega'} 
    L(\vb*{r}, \vu*{s}', t) P(\vu*{s}, \vu*{s}').
    \label{eq:rad-transfer-1}
\end{equation}
The conditions of the validity of the above equation 
includes the aforementioned assumptions that 
\ul{the medium is uniform and isotropic, 
and there is no nonlinear process in the system,} 
and also the fundamental validity condition of QBE: 
\ul{the validity of gradient expansion of the effective density matrix 
in the Wigner representation}.
Physically speaking, this means the system should allow 
the formation of defined wave packets, 
which has well-defined positions 
but also looks like a plane wave when we zoom in on it.
Specifically, this means diffraction shouldn't be an important factor here;
but if a structure with strong diffraction can be modeled as a scattering process, 
diffraction in this case can still be captured by the collision integral.

The next step is to find the true meaning of $\mu_{\text{s}}$. 
Assuming a clean background and a stationary configuration, 
the second term in the RHS of \eqref{eq:rad-transfer-1} vanishes, 
we have 
\[
    \dv{L}{z} = - \mu_{\text{s}} L, 
\]
where $z$ is the propagation length. 
So we find $1 / \mu_{\text{s}}$ is roughly 
the mean path $l_{\text{s}}$ between two scattering incidents, 
and \eqref{eq:rad-transfer-1} can also be alternatively written as 
\begin{equation}
    \frac{1}{c} \pdv{L}{t} + \vu*{s} \cdot \grad_{\vb*{r}} L = 
    \frac{1}{l_{\text{s}}} \int \dd{\Omega'} 
    (L(\vb*{r}, \vu*{s}', t) - L(\vb*{r}, \vu*{s}, t)) P(\vu*{s}, \vu*{s}'),
    \label{eq:rad-transfer-2}
\end{equation}
from which we have 
\begin{equation}
    \dv{L}{z} + \frac{1}{l_{\text{s}}} L = 0 
\end{equation}
when the system reaches the stationary state. 

Some scattering processes turn the photons into other degrees of freedom, 
and in the foreseeable future they will not come back; 
these processes are just absorption processes, 
and we can just add them to \eqref{eq:rad-transfer-1} 
using the relaxation time approximation, and get 
\begin{equation}
    \begin{aligned}
        \frac{1}{c} \pdv{L}{t} + \vu*{s} \cdot \grad_{\vb*{r}} L &= 
        - \mu_{\text{a}} L +
        \underbrace{\frac{1}{l_{\text{s}}}}_{\mu_{\text{s}}} \int \dd{\Omega'} 
        (L(\vb*{r}, \vu*{s}', t) - L(\vb*{r}, \vu*{s}, t)) P(\vu*{s}, \vu*{s}') \\
        &= - \underbrace{(\mu_{\text{a}} + \mu_{\text{s}})}_{\mu_{\text{t}}} L 
        + \mu_{\text{s}} \int \dd{\Omega'} 
        L(\vb*{r}, \vu*{s}', t) P(\vu*{s}, \vu*{s}') ,
    \end{aligned}
    \label{eq:rte-final}
\end{equation}
where $\mu_{\text{t}}$ is known as the extinction coefficient. 

Until now, we have only discussed about ``scalar light'':
$L$ contains no discrete index.
This works when all photons in the system 
are polarized in one direction; 
this however is not a realistic assumption in actual optical systems.
Thus, in \eqref{eq:rte-final}, 
we need to replace $L$ and $P$ by $2 \times 2$ matrices;
$L_{\alpha \beta}$ can be seen as the single-photon reduced density matrix 
when the spatial indices are fixed:
the full single-photon reduced density matrix is 
$L_{\alpha \vb*{k}, \beta \vb*{k}'}$,
and $\vb*{k}$ and $\vb*{k}'$ are recast into $\vb*{k}$ and $\vb*{r}$ 
when we derive the Boltzmann equation.
Now \eqref{eq:rte-final} is 
\begin{equation}
    \frac{1}{c} \pdv{L_{\alpha \beta}}{t} + \vu*{s} \cdot \grad_{\vb*{r}} L_{\alpha \beta}
    = - \underbrace{(\mu_{\text{a}} + \mu_{\text{s}})_{\alpha \gamma}}_{\mu_{\text{t}}} L_{\gamma \beta} 
    + \mu_{\text{s}} \int \dd{\Omega'} 
    P_{\alpha \gamma}(\vu*{s}, \vu*{s}') L_{\gamma \beta}(\vb*{r}, \vu*{s}', t)  .
\end{equation} 
Usual detectors that only count photon number detect $\trace L$.
It's however possible that $P_{\alpha \gamma}$ randomly 
turns one polarization to another, 
and if this polarization relaxation process is fast enough 
that long before $L$ reaches equilibrium, 
$L_{\alpha \beta}$ is almost unpolarized,
\eqref{eq:rte-final} can still be taken literally, 
since 
\begin{equation}
    L_{\alpha \beta} = \delta_{\alpha \beta} L / 2.
\end{equation}

A final correction to RTE is the spatial non-uniformity of optical properties, 
including scattering and change of light speed. 
This means both $\mu_{\text{a/s}}$ and $P(\vu*{s}, \vu*{s}')$ 
may have spatial variance, 
and so does $c$; 
of course, this variance shouldn't break the validity of QBE. 
In this case even though the correct generalization of RTE contains, say, 
$\grad_{\vb*{r}} (c L)$, 
due to the slow spatial variance of $c$, 
we can still rewritten it as $c \grad_{\vb*{r}} L$, 
and get back to \eqref{eq:rte-final}.

\section{From RTE to the diffusion equation}

Under the following assumptions, RTE is reduced to the diffusion equation: 
\begin{itemize}
    \item \ul{The radiance is nearly isotropic 
    -- and therefore if we do spherical harmonic expansion to it, 
    only the $l = 0, 1$ components need to be kept.} 
    This happens when scattering is strong enough 
    so that the direction of light propagation 
    is randomized; 
    to be exact, this means \ul{scattering is much stronger than absorption}:
    $1 / c \mu_{\text{a}}$ is the time scale of 
    how long radiation lasts in the system before being dampened by absorption, 
    and scattering should randomized the directions of light propagation 
    within this period of time. 
    Note that this also means that if the radiance starts with a highly 
    anisotropic configuration, 
    then there is already a (although short) period of time in the beginning 
    during which the diffusion equation is not a good description 
    of the dynamics of the system. 
    \item \ul{The change of current density is much slower 
    than the speed photons pass the mean free path.}
    \item \ul{The scattering property has rotational symmetry (although not completely isotropic)}:
        thus $P(\vu*{s}, \vu*{s}') = P(\vu*{s} \cdot \vu*{s}')$.
        This can be seen as included in the second approximation, 
        since otherwise it's not likely that the radiance finally converges to 
        an isotropic solution.
\end{itemize}

In this section we ignore polarization;
that's to say, we assume that scattering events 
relax polarization quickly enough.

If we only keep the first two spherical harmonic components of $L$
(here the first approximation is used), 
i.e. the $\vu*{s}$ dependence of $L$ 
is either trivial 
or is proportional to something dot $\vu*{s}$, 
then we have
\begin{equation}
    L(\vb*{r}, \vu*{s}, t) = \frac{1}{4 \pi} \Phi(\vb*{r}, t) 
    + \frac{3}{4 \pi} \vb*{J} \cdot \vu*{s},
    \label{eq:diffusion-radiance}
\end{equation}
where 
\begin{equation}
    \Phi(\vb*{r}, t) = \int \dd{\Omega} L(\vb*{r}, \vu*{s}, t)
\end{equation}
is $c$ times the energy density at $\vb*{r}$, and 
\begin{equation}
    \vb*{J}(\vb*{r}, t) = \int \dd{\Omega} \vu*{s} L(\vb*{r}, \vu*{s}, t)
\end{equation}
is recognized as the current density; 
this seems intuitive from the microscopic meaning of $L$,
and we are also going to explicitly show that $\vb*{J}$
appears in its expected position in the diffusion equation.
We can explicitly verify that the normalization conditions are correct: 
for example, we have 
\begin{equation}
    \int \dd{\Omega} \frac{3}{4 \pi} \vb*{J} \cdot \vu*{s} \cdot \underbrace{\cos \theta}_{\hat{s}_z} = 
    J_z, 
\end{equation} 
where the $J_{x, y}$ terms, since they contain a $\sin \varphi$ or $\cos \varphi$ factor, 
vanish under the integral over $\dd \Omega$. 

Now, by applying $\int \dd{\Omega}$ to \eqref{eq:rte-final}, the LHS becomes 
\begin{equation}
    \text{LHS} = \frac{1}{c} \pdv{\Phi}{t} 
    + \int \dd{\Omega} \vu*{s} \cdot \grad_{\vb*{r}} L(\vb*{r}, \vu*{s}, t)
    = \frac{1}{c} \pdv{\Phi}{t} 
    + \div \underbrace{
        \int \dd{\Omega} \vu*{s}  L(\vb*{r}, \vu*{s}, t) 
    }_{\vb*{J}}, 
\end{equation}
where we have used the condition 
\begin{equation}
    \div(\vu*{s} L) = \vu*{s} \cdot \grad L
    \label{eq:move-grad-1}
\end{equation} 
since $\vu*{s}$ has no spatial dependence, 
while the RHS becomes 
\begin{equation}
    \begin{aligned}
        \text{RHS} &= - \mu_{t} \Phi 
        + \mu_{\text{s}} \int \dd{\Omega'} L(\vb*{r}, \vu*{s}', t) \int \dd{\Omega} P(\vu*{s}, \vu*{s}') \\
        &= - \mu_{t} \Phi 
        + \mu_{\text{s}} \int \dd{\Omega'} L(\vb*{r}, \vu*{s}', t) \\
        &= - \mu_{t} \Phi 
        + \mu_{\text{s}} \Phi = - \mu_{\text{a}} \Phi ,
    \end{aligned}
\end{equation}
and thus we have 
\begin{equation}
    \frac{1}{c} \pdv{\Phi}{t} + \div{\vb*{J}} + \mu_{\text{a}} \Phi = 0.
\end{equation}
Now we see $\vb*{J}$ indeed is the current density.

Then, we apply $\int \dd{\Omega} \vu*{s}$ to \eqref{eq:rte-final}.
This time the calculation will be slightly more non-trivial.
The LHS now is 
\begin{equation}
    \text{LHS} = \frac{1}{c} \pdv{\vb*{J}}{t} + 
    \div \int \dd{\Omega} \vu*{s} \vu*{s} L, 
\end{equation}
where we again use the condition \eqref{eq:move-grad-1}. 
A direct evaluation tells us 
\begin{equation}
    \frac{1}{4\pi} \int \dd{\Omega} \vu*{s} \vu*{s} \Phi = \frac{1}{3} \Phi,
\end{equation}
and the contribution from the $\vb*{J}$ part is zero. 
The $(z, z)$ component of $\int \dd{\Omega} \vu*{s} \vu*{s}$, for example, is 
\[
    \int \dd{\Omega} \cos^2 \theta = 
    \int_{0}^{\pi} \sin \theta \dd{\theta} \cos^2 \theta \cdot 2 \pi 
    = \frac{2}{3} \cdot 2 \pi,
\]
and hence the $1/3$ factor. 
On the other hand, the $(x, z)$ or $(y, z)$ components suffer from 
the existence of a vanishing $\int \dd{\varphi} \sin\varphi$ or $\cos \varphi$ factor, 
and for the $(x, y)$ component, $\int \dd{\varphi} \sin \varphi \cos \varphi$ is still zero. 
So now we find the full expression of the LHS: 
\begin{equation}
    \text{LHS} = \frac{1}{c} \pdv{\vb*{J}}{t} + \frac{1}{3} \grad{\Phi}.
\end{equation}
As for the RHS, we have 
\begin{equation}
    \text{RHS} = - \mu_{\text{t}} \vb*{J} + \mu_{\text{s}} \int \dd{\Omega'} 
    L(\vb*{r}, \vu*{s}', t) \int \dd{\Omega} \vu*{s} P(\vu*{s} \cdot \vu*{s}').
\end{equation}
We use $\vu*{s}'$ as the $z$ axis, and then $P(\vu*{s} \cdot \vu*{s}') = P(\cos \theta)$, 
and therefore $\int \dd{\Omega} \vu*{s} P(\vu*{s} \cdot \vu*{s}')$ 
is always parallel to $\vu*{s}'$, 
since the $x$ and $y$ components contain 
$\int \dd{\varphi} \sin \varphi$ and $\int \dd{\varphi} \cos \varphi$
and therefore vanish.
We therefore write 
\begin{equation}
    \int \dd{\Omega} \vu*{s} P(\vu*{s} \cdot \vu*{s}') = g \vu*{s}',
\end{equation}
where $g$ is an unknown factor.
The RHS therefore becomes 
\begin{equation}
    \text{RHS} = - \mu_{\text{t}} \vb*{J} 
    + \mu_{\text{s}} g \int \dd{\Omega'} \vu*{s}' L(\vb*{r}, \vu*{s}', t) 
    = - \mu_{\text{t}} \vb*{J} 
    + \mu_{\text{s}} g \vb*{J}.
\end{equation}
So we have 
\begin{equation}
    \frac{1}{c} \pdv{\vb*{J}}{t} + \frac{1}{3} \grad{\Phi}
    = - \mu_{\text{t}} \vb*{J} 
    + \mu_{\text{s}} g \vb*{J}
    = - (\mu_{\text{a}} + \mu_{\text{s}}') \vb*{J}, 
    \quad \mu_{\text{s}}' = (1 - g) \mu_{\text{s}}.
\end{equation}
Now we invoke the condition that the change of the current is slow 
compared with $c \mu_{\text{t}}$, 
and we approximately, we have 
\begin{equation}
    \frac{1}{3} \grad{\Phi}
    = - \mu_{\text{t}} \vb*{J} 
    + \mu_{\text{s}} g \vb*{J}
    = - (\mu_{\text{a}} + \mu_{\text{s}}') \vb*{J}, 
    \quad \mu_{\text{s}}' = (1 - g) \mu_{\text{s}}.
\end{equation}
This gives the constitutive relation between the current density 
and the gradient of radiance. 

Thus, we find with the three -- or two -- assumptions listed at the start of this section, 
we have 
\begin{equation}
    \frac{1}{c} \pdv{\Phi}{t} + \div{\vb*{J}} + \mu_{\text{a}} \Phi = 0, \quad 
    \vb*{J} = - D \grad{\Phi},
    \label{eq:diffusion}
\end{equation}
where 
\begin{equation}
    D = \frac{1}{3 (\mu_{\text{a}} + \mu_{\text{s}}')}, \quad 
    \mu_{\text{s}}' = (1 - g) \mu_{\text{s}}, 
    \label{eq:diffusion-property}
\end{equation}
and 
\begin{equation}
    \int \dd{\Omega} \vu*{s} P(\vu*{s} \cdot \vu*{s}') = g \vu*{s}'
    \Rightarrow 2 \pi \int_{0}^{\pi} \sin \theta \dd{\theta} \cdot \cos \theta P(\cos \theta)
    = g .
\end{equation}
Now we find RTE has been completely reduced to a diffusion equation.

\section{Volume rendering}

In most everyday cases, the time evolution of $L$ can be ignored: 
the system reaches equilibrium as soon as ``the light is turned on'', 
since the speed of light is very fast. 
It's also frequently assumed that $c$ is 
\ul{one hundred percent uniform in space
and not just very slow in its spatial change}. 
In these cases, we get 
\begin{equation}
    \begin{aligned}
        \vu*{s} \cdot \grad_{\vb*{r}} L &= 
        - \mu_{\text{a}} L +
        \underbrace{\frac{1}{l_{\text{s}}}}_{\mu_{\text{s}}} \int \dd{\Omega'} 
        (L(\vb*{r}, \vu*{s}', t) - L(\vb*{r}, \vu*{s}, t)) P(\vu*{s}, \vu*{s}') \\
        &= - \underbrace{(\mu_{\text{a}} + \mu_{\text{s}})}_{\mu_{\text{t}}} L 
        + \mu_{\text{s}} \int \dd{\Omega'} 
        L(\vb*{r}, \vu*{s}', t) P(\vu*{s}, \vu*{s}') .
    \end{aligned}
    \label{eq:se-final}
\end{equation}
The time evolution term is thrown away. 
This equation is sometimes known as the \concept{scattering equation}
or \concept{volume rendering equation}.
Again, for polarized light, $L P$ should be replaced by $P_{\alpha \gamma} L_{\gamma \beta}$.

\begin{figure}
    \centering
    \input{optical-path/surface-scattering-1.tex}
    \caption{The boundary modeled as a region (the green rectangle) where scattering events are frequent}
    \label{fig:boundary-scattering}
\end{figure}

\section{Surface boundary condition: reflection}

If we are not modeling things like clouds, 
and are interested in, say, the image of a cup or an apple, 
the bulk part of the scattering equation is easy, 
since \ul{everything is assumed to be isotropic and uniform in the bulk};
the main problem then becomes how to treat the boundaries appropriately.

We can think the boundary of an object as a region where 
scattering is particularly strong, 
as in \prettyref{fig:boundary-scattering}.
On one side of the region, 
the radiance takes its value at the edge of the bulk, 
and on the other side of the region, 
the radiance decreases to zero. 
Suppose the thickness of the region is $l$.

Now we extend the $\vu*{s}$ line shown in \prettyref{fig:boundary-scattering}
opposite its direction, until we reach the $L=0$ side of the scattering region.
We call this path $C$,
and the length of this path is $l / \cos \theta$.
We integrate the scattering equation \eqref{eq:se-final} along this path, 
and get 
\begin{equation}
    L(\vb*{r}, \vu*{s}) = - \mu_{\text{t}} \int_C \dd{l} L(\vb*{r}', \vu*{s})
    + \mu_{\text{s}} \int \dd{\Omega'} P(\vu*{s}, \vu*{s}') \int_C \dd{l} L(\vb*{r}', \vu*{s}') .
    \label{eq:re-1}
\end{equation}
$L(\vb*{r}', \vu*{s})$ is a linear functional of 
the radiance distribution around the surface. 
(It has to be linear, since the scattering equation is a linear equation.)
In the simplest case, the reflected light on one point ($L(\vb*{r}, \vu*{s})$)
mainly comes from incoming light at the same point; 
thus $L(\vb*{r}', \vu*{s})$ and $L(\vb*{r}', \vu*{s}')$ on path $C$ 
can be rewritten as some kind of damping function of $\abs*{\vb*{r} - \vb*{r}'}$ 
times $L(\vb*{r}, \vu*{s})$ and $L(\vb*{r}, \vu*{s}')$, 
and we have 
\[
    \mu_{\text{s}} \int_C \dd{l} L(\vb*{r}', \vu*{s}') 
    = g(\vu*{s}, \vu*{s}') \frac{\mu_{\text{s}} l}{\cos \theta} L(\vb*{r}, \vu*{s}),
\]
where $g(\vu*{s}, \vu*{s}')$ comes from 
the properties of the scattering layer, 
and from time reversal symmetry we can assume that it's symmetric, 
since the phase function is symmetric. 
This means 
\begin{equation}
    \begin{aligned}
        \mu_{\text{s}} \int \dd{\Omega'} P(\vu*{s}, \vu*{s}') \int_C \dd{l} L(\vb*{r}', \vu*{s}')
        &= \mu_{\text{s}} l \int \dd{\Omega'} P(\vu*{s}, \vu*{s}') 
        g(\vu*{s}, \vu*{s}') \frac{1}{\cos \theta} L(\vb*{r}, \vu*{s}) \\
        &= \mu_{\text{s}} l \int \cos \theta' \dd{\Omega'} 
        \underbrace{
            P(\vu*{s}, \vu*{s}') 
            g(\vu*{s}, \vu*{s}') \frac{1}{\cos \theta \cos \theta'}
        }_{\text{symmetric}} L(\vb*{r}, \vu*{s})  .
    \end{aligned}
\end{equation}
Similarly, we have 
\begin{equation}
    \begin{aligned}
        \mu_{\text{t}} \int_C \dd{l} L(\vb*{r}', \vu*{s})
        &= \mu_{\text{t}} g(\vu*{s}, \vu*{s}) \frac{l}{\cos \theta} L(\vb*{r}, \vu*{s}) \\
        &= \mu_{\text{t}} l \int \cos \theta' \dd{\Omega'} 
        \underbrace{
            \delta(\vu*{s}, \vu*{s}') \frac{1}{\cos \theta \cos \theta'}
        }_{\text{symmetric}} L(\vb*{r}, \vu*{s}'),
    \end{aligned}
\end{equation}
where 
\begin{equation}
    \delta(\vu*{s}, \vu*{s}') = \frac{1}{\sin \theta} \delta(\theta - \theta') \delta(\varphi - \varphi'). 
\end{equation}
So finally, from \eqref{eq:re-1} we get 
\begin{equation}
    L(\vb*{r}, \vu*{s}) = \int f(\vu*{s}, \vu*{s}') L(\vb*{r}, \vu*{s}') \cos \theta' \dd{\Omega'}, 
    \quad f(\vu*{s}, \vu*{s}') = f(\vu*{s}', \vu*{s}).
    \label{eq:re-2}
\end{equation}
We find the exact theory (under the aforementioned premises) of light propagation 
in this case turns out to be \eqref{eq:re-2},
which is known as the \concept{rendering equation}. 
In the rendering equation we have the symmetric function $f(\vu*{s}, \vu*{s}')$,
called the \concept{bidirectional reflectance distribution function (BRDF)}. 
We can always readjust the BRDF so that it is only non-zero 
when $\vu*{s} \cdot \vu*{n}$ and $\vu*{s}' \cdot \vu*{n}$
have different signs. 
This can be seen by noticing that an outgoing (i.e. $\vu*{s} \cdot \vu*{n} > 0$) radiance 
always comes from an ingoing radiance, 
and therefore its effect can be alternatively attributed to the latter. 
This means we can rewrite \eqref{eq:re-2} to
\begin{equation}
    L(\vb*{r}, \vu*{s}) = \int_{\vu*{s}' \cdot \vu*{n} < 0} 
    f(\vu*{s}, \vu*{s}') L(\vb*{r}, \vu*{s}') \cos \theta' \dd{\Omega'}, \quad 
    \vu*{s} \cdot \vu*{n} > 0,
    \label{eq:re-final}
\end{equation}
with the BRDF defined appropriately.
The photon number conservation condition (essentially the energy conservation condition, 
since we don't have any frequency changing mechanism) is 
\begin{equation}
    \int f(\vu*{s}, \vu*{s}') \cos \theta' \dd{\Omega'}  \leq 1.
\end{equation}
This is an inequality, because absorption is also included in the BRDF.

\eqref{eq:re-final} can be derived in a more straightforward way 
from energy conservation, 
where we define 
\begin{equation}
    \underbrace{\dd{L(\vb*{r}, \vu*{s})}}_{\text{outgoing radiance}} 
    = \underbrace{L(\vb*{r}, \vu*{s}') \cos \theta' \dd{\Omega'}}_{\text{incoming radiance}} 
    \cdot \underbrace{f(\vu*{s}, \vu*{s}')}_{\text{response}} ,
\end{equation}
where the $\cos \theta'$ factor can be obtained intuitively 
by considering the fact that if a beam of light 
is incident on the material with an angle $\theta'$, 
the effective cross section of the beam is reduced by a factor of $\cos \theta'$.

\section{More about surface}


One thing that is hard to place this into the framework 
of scattering of photons in a 3D space
is transmission, 
since now we have two bulk areas with different optical properties,
and the Boltzmann transportation approach needs to be corrected 
to capture this scenario.
We still consider TODO: Fabry–Pérot interferometer??? We know a crystal ball also has internal electromagnetic modes, which can only be derived with full wave optics; 
also multiple reflection/transmission, 
without polarization relaxation,
can also create phenomenon that can't be captured by scalar \eqref{eq:rte-final}??

A even more complicated case is when there indeed is 
a very thing intermediate layer between the two bulk spaces; 
in this case we need \concept{bidirectional scattering-surface reflectance distribution function (BSSRDF)}
and \concept{bidirectional scattering-surface transmittance distribution function (BSSTDF)},
which includes the possibility that light comes into the surface in one position 
but goes out in another.

There is a major notation difference between the notation above that is more familiar to physicists
and the standard notation in computer graphics:
in CG, the direction unit vector is usually represented as $\omega$, 
and $\dd{\Omega}$ is often written as $\dd{\Omega}$;
also, the position is referred to as $\vb*{p}$, 
which may be confused with the momentum.
Thus the rendering equation now reads 
\begin{equation}
    L(\vb*{p}, \omega_{\text{o}}) 
    = \int f(\vb*{p}, \omega_{\text{o}}, \omega_{\text{i}}) 
    L(\vb*{p}, \omega_{\text{i}}) \abs{\cos \theta_{\text{i}}} \dd{\omega_{\text{i}}},
\end{equation}
where $f(\omega_{\text{o}}, \omega_{\text{i}})$ 
is the sum of BRDF and BTDF; 
of course polarization may still be important above, 
and it's also possible that we have BSSTDF and BSSTDF 
so another integral in the position variable is needed.

\section{Example of BDSF: boundary between two dielectrics}

In this section we derive the 

\begin{equation}
    f_{\text{r}} = F_{\text{r}} \frac{\delta(\vu*{s}_\text{i}, \vu*{s}_{\text{r}})}{\abs*{\cos \theta_{\text{r}}}}
\end{equation}

For reflected light, we have 
\begin{equation}
    \begin{aligned}
        \abs*{\vb*{E}_{\text{t}}}^2 = \abs*{t}^2 \abs*{\vb*{E}_{\text{i}}}^2 
        &\Rightarrow \epsilon_{\text{t}} \abs*{\vb*{E}_{\text{t}}}^2 
        = \frac{\epsilon_{\text{t}}}{\epsilon_{\text{i}}} \abs*{t}^2 \epsilon_{\text{i}} \abs*{\vb*{E}_{\text{i}}}^2 \\
        &\Rightarrow L_{\text{t}}(\vb*{r}, \vu*{s}_{\text{t}}) 
        = \frac{n_{\text{t}}^2}{n_{\text{i}}^2} \abs*{t}^2 L_{\text{i}}(\vb*{r}, \vu*{s}_{\text{i}}).
    \end{aligned}
\end{equation}

\section{Several trivial cases of volume rendering}

The last piece needed to render a system with trivial bulk properties 
where all interesting things happen at the boundaries 
is how to link $L(\vb*{r}, \vu*{s})$ at the boundaries 
with $L(\vb*{r}, \vu*{s})$ in the space. 

Let's start with the example of the point source.
Intuitively, when there is no scattering or absorption in the space,
and we have the inverse-square law,
and therefore the radiance around a point source assumes the form of 
\begin{equation}
    L(\vb*{r}, \vu*{s}) = \frac{C}{r^2} \delta(\vu*{r}, \vu*{s}),
\end{equation} 
where $C$ is a constant, which is likely to be 
sometimes times the angular frequency spectral flux,
as is implied by dimensional analysis.
We can verify this solution explicitly: 
when there is no scattering and absorption, 
the volume rendering equation reads 
\begin{equation}
    \vu*{s} \cdot \grad_{\vb*{r}} L = 0,
    \label{eq:trivial-bulk-re}
\end{equation}
and indeed we have  
\begin{equation}
    \begin{aligned}
        \vu*{s} \cdot \grad_{\vb*{r}} \left(\frac{1}{r^2} \delta(\vu*{r}, \vu*{s})\right) &= 
        \grad_{\vb*{r}} \cdot \left(
            \frac{1}{r^2} \delta(\vu*{r}, \vu*{s}) \vu*{s}
        \right) 
        = \grad_{\vb*{r}} \cdot \left(
            \frac{1}{r^2} \delta(\vu*{r}, \vu*{s}) \vu*{r}
        \right) \\
        &= \frac{1}{r^2} \pdv{r} \left(
            r^2 \cdot \frac{1}{r^2} \delta(\vu*{r}, \vu*{s})
        \right) = 0.
    \end{aligned}
    \label{eq:inverse-square-is-solution}
\end{equation}
Here the second line makes use of the fact 
that $\delta(\vu*{r}, \vu*{s})$ involves no radial dependence.

\begin{infobox*}{Another way to derive \eqref{eq:inverse-square-is-solution}}
    We can also do \eqref{eq:inverse-square-is-solution} in a more straightforward way.
    We use $(\theta_0, \varphi_0)$ to refer to the spherical coordinates of $\vu*{s}$,
    and use $(r, \theta, \varphi)$ to refer to the spherical coordinates of $\vb*{r}$.
    Thus 
    \begin{equation}
        \grad_{\vb*{r}} = \vu*{r} \pdv{r} + \vu*{\theta} \frac{1}{r} \pdv{\theta} 
        + \vu*{\varphi} \frac{1}{r \sin \theta} \pdv{\varphi},
    \end{equation}
    \begin{equation}
        \frac{1}{r^2} \delta(\vu*{r}, \vu*{s}) = \frac{1}{r^2}
        \frac{1}{\sin \theta} \delta(\theta - \theta_0) \delta(\varphi - \varphi_0)
        = \frac{1}{r^2} \frac{1}{\sin \theta_0} \delta(\theta - \theta_0) \delta(\varphi - \varphi_0),
    \end{equation}
    and 
    \begin{equation}
        \begin{aligned}
            \vu*{s} \cdot \vu*{\theta} &= \sin \theta_0 \cos \varphi_0 \cos \theta \cos \varphi
            + \sin \theta_0 \sin \varphi_0 \cos \theta \sin \varphi 
            - \cos \theta_0 \sin \theta, \\ 
            \vu*{s} \cdot \vu*{\varphi} &= - \sin \theta_0 \cos \varphi_0 \sin \varphi 
            + \sin \theta_0 \sin \varphi_0 \cos \varphi.
        \end{aligned}
    \end{equation}
    Using the fact that 
    \begin{equation}
        \delta'(x) f(x) = \delta'(x) f(0) - \delta(x) f'(0),
    \end{equation}
    we are able to show that all $\delta'(\theta - \theta_0)$ and $\delta'(\varphi - \varphi_0)$
    terms vanish, and indeed we have \eqref{eq:inverse-square-is-solution}.
\end{infobox*}

Then we proceed to decide the constant $C$.
We have 
\begin{equation}
    \begin{aligned}
        \text{outgoing power per $\dd{\omega}$} &=
        \int_{\abs*{\vb*{r}}^2 = \const.} \int \dd{\Omega} L(\vb*{r}, \vu*{s}) \\
        &= \int_{\abs*{\vb*{r}}^2 = \const.} \frac{C}{r^2} = 4 \pi r^2 \cdot \frac{C}{r^2},
    \end{aligned}
    \label{eq:flux-around-point-source}
\end{equation}
and thus we get 
\begin{equation}
    L(\vb*{r}, \vu*{s}) = \frac{\Phi}{4 \pi r^2} \delta(\vu*{s}, \vu*{r}),
    \label{eq:ideal-inverse-square}
\end{equation}
where $\Phi$ is the angular frequency spectral flux. 

It's instructive to compare this solution with 
the expression of $L$ obtained from Maxwell equations.
TODO: absence of diffraction

When we do have absorption and/or scattering in the system, 
intuitively we have 
\begin{equation}
    L(\vb*{r}, \vu*{s}) = \Phi \frac{\ee^{- \mu_{\text{t}} r}}{r^2},
    \label{eq:dampened-inverse-square-law}
\end{equation}
which goes back to \eqref{eq:ideal-inverse-square}
when $\mu_{\text{t}} = 0$.
Again this can be verified, under the assumption that 
we can ignore scattered light that comes back:
now the volume rendering equation becomes 
\begin{equation}
    \vu*{s} \cdot \grad_{\vb*{r}} L = - \mu_{\text{t}} L,
\end{equation}
and the LHS evaluates into 
\begin{equation}
    \begin{aligned}
        \vu*{s} \cdot \grad_{\vb*{r}} \left(
            \frac{\ee^{- \mu_{\text{t}} r}}{r^2}
        \right) &= 
        \grad_{\vb*{r}} \left(
            \frac{\ee^{- \mu_{\text{t}} r}}{r^2} 
            \delta(\vu*{r}, \vu*{s}) \vu*{r}
        \right)  \\
        &= \delta(\vu*{r}, \vu*{s}) \cdot \frac{1}{r^2} \pdv{r} \left(
            r^2 \cdot \frac{\ee^{- \mu_{\text{t}} r}}{r^2} 
        \right) \\
        &= \delta(\vu*{r}, \vu*{s}) \cdot \frac{1}{r^2} 
        (- \mu_{\text{r}}) \ee^{- \mu_{\text{t}} r} = \text{RHS}.
    \end{aligned}
\end{equation}
Interestingly, although the $\ee^{- \mu_{\text{t}} r}$ factor 
looks diffusional, 
it's different with the diffusion coefficient given in 
\eqref{eq:diffusion} and \eqref{eq:diffusion-property},
and this can be expected: for a point source, 
the structure of the radiance is rather different with 
the assumption in \eqref{eq:diffusion-radiance}.
The $\Phi$ constant in \eqref{eq:dampened-inverse-square-law}
is now the total angular momentum spectral flux 
in the $r \to 0$ limit.

\eqref{eq:ideal-inverse-square} and \eqref{eq:dampened-inverse-square-law}
work as well for finite, spherical sources,
of which the wave vector of radiation at the boundary 
is parallel to the normal vector.
We want to extend the $1/r^2$ law to a more generalized boundary.

The integral form of \eqref{eq:trivial-bulk-re} is 
\begin{equation}
    L(\vb*{r}, \vu*{s}) = L(\vb*{r} + \vu*{s} t , \vu*{s}),
\end{equation}
where $t$ is a parameter; the equation 
\begin{equation}
    \vb*{x} = \vb*{r} + \vu*{s} t 
\end{equation}
has a clear physical meaning: it's the equation of the ray 
in the direction $\vu*{s}$ that passes $\vb*{r}$.
Thus, we find that along a ray, 
the radiance in the direction of the ray doesn't change. 
TODO: conflict with inverse square law: 
it seems the problem with the inverse square law is that 
first doing $\vu*{s} \cdot \grad_{\vb*{r}}$ 
and then applying it to $L$ 
is somehow different with first doing $\grad_{\vb*{r}} L$
and then multiply $\vu*{s}$ to it. 

\section{Path sampling, ray tracing, and the like}

\end{document}