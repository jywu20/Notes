\chapter{非线性极化}

极化矢量和电场之间的关系当然不完全是线性的。我们

\section{非线性光学过程的经典模型}\label{sec:classical-models}

\subsection{非线性谐振子模型}\label{sec:classical-oscillator}

本节将材料当成一系列谐振子的组合，并且暂时不考虑谐振子之间的相互作用。
这是相对合理的，因为能够长距离传输光的介质一般不是金属，从而电子是相对定域的。
然而，这并不意味着我们的理论是自由的。
我们知道一个标准的经典谐振子可以用
\begin{equation}
    m \dv[2]{x}{t} + m \gamma \dv{x}{t} + m \omega_0^2 x = q E
\end{equation}
来描述，而如果我们加上诸如$x^3$这样的项，即让谐振子的回复力为非线性的，就可以造成谐振子模式发生自相互作用。
我们讨论的问题的能量都并不高，谐振子运动不会特别快，因此可以认为谐振子只产生电场，并且其方式为“电偶极子产生库伦场”。
用作用量表示，就是% TODO:有误，这里的关键在于qxE可以给出电场对电荷的作用，但是是否能够给出电荷对电场的作用？？或者说，电场和电荷的相互作用拉氏量或是哈密顿量要怎么写？？
\[
    S = \int \dd{t} \left( \frac{1}{2} m \dot{x}^2 - \frac{1}{2} k x^2 + \text{higher order $x^n$} + qxE \right).
\]
现在积掉谐振子，就能够得到非线性的光子-光子过程，即多个光子和一或是一个光子分裂为多个光子。

\subsubsection{二阶非线性极化}

我们现在在谐振子能量中加入一个三次项，即在运动方程中加入一个二次回复力：
\begin{equation}
    m \dv[2]{x}{t} + m \gamma \dv{x}{t} + m \omega_0^2 x + m a x^2 = q E.
    \label{eq:x3-eq}
\end{equation}
这相当于在能量中加入了一个$\frac{1}{3} m a x^3$项。这个项破坏了系统的中心反演对称性。
我们实际上是要从电场计算$x$（从$x$计算响应电场的公式是显然的，就是大量偶极子加总为$\vb*{P}$然后从$\vb*{P}$出发算电场）。

对这个问题的标准的处理是微扰求解微分方程，但是实际上可以使用费曼图分析这个问题。由于只考虑经典情况，无需计算圈图。
“经典情况”到底指的是什么需要进一步说明：在经典情况下我们没有二次量子化，粒子图景的经典理论和场的图景的经典理论还不一样。
粒子图景下运动方程是关于各个粒子的位置和动量的，入射和出射外线没有任何限制。
场的图景下，我们求解系统的基本自由度（在这里是电场和谐振子坐标）的运动方程，得到场变量随时间的变化情况，即实际上在求解$\expval*{\phi}$，因此只能有一条出射外线，入射外线应当被当成外源。
在经典极限下这两种图景不会造成太大差别：同一张图的外线数目是固定的，在场的图景下，出射外线多了外源就少，由于我们要求场强满足$\phi / \hbar \ll 1$（但与此同时能标又没有高到多顶角图非常重要，从而圈图修正有必要计算），外源较少的过程是非常不重要的。

我们采用后一种图景，因为我们实际上就是在微扰求解\eqref{eq:x3-eq}。
将电磁场和带有$x^3$形势能的非线性振子耦合，则费曼图中应该有\autoref{fig:x3-vertex}和\autoref{fig:light-osci-couple}两种基本元件。
应当注意这里的短直线代表的是$x$的某个频率的分量，如果做量子化，就是一个谐振子模式。
这里的传播子并不代表谐振子的状态本身。这也就是\autoref{fig:light-osci-couple}顶角中只有一条短直线而不是两条的原因：它代表一个入射光子激发出一个谐振子模式，而不是谐振子整体吸收一个光子之后变成另一个状态。
由于电场和谐振子的耦合是完全线性的（并且由于谐振子是一个没有空间分布的点，实际上耦合项就是电偶极子能量），且我们关心的是“非线性介质中有哪些光学过程”，可以将电场暂时当成背景场，于是\autoref{fig:light-osci-couple}应该被\autoref{fig:external-field}取代。
例如，我们只需要分析一阶过程\autoref{fig:first-order-x3-external}就能知道\autoref{fig:first-order-x3-photon}的来源——如果$E$让$x$产生非线性响应，那就有光子分裂和合并的过程。

费曼规则可以很容易地写出：（我们认为频率为$\omega$的成分携带$\ee^{- \ii \omega t}$因子）
\begin{itemize}
    \item 传播子为
    \[
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (0, 0);
                \vertex (b) at (1, 0);
                \propag [plain, mom={$\omega$}] (a) to (b); 
            \end{feynhand}
        \end{tikzpicture} = \frac{\ii}{m (\omega^2 + \ii \gamma \omega - \omega_0^2)}.
    \]
    \item 顶角为
    \[
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (-1,-1); \vertex (b) at (1,-1); \vertex (c) at (0,1);
                \vertex (o) at (0,0); 
                \propag [plain] (a) to (o);
                \propag [plain] (b) to (o); 
                \propag [plain] (c) to (o);    
            \end{feynhand}
        \end{tikzpicture} = - \ii 2 m a \cdot 2\pi \delta(\sum \omega).
    \]
    注意正常情况下$x^3$相互作用要配一个$1/3!$的因子但是这里只有$1/3$，因此顶角实际上是$2ma$而不是$ma$。
    \item 外源为
    \[
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex [crossdot] (a) at (0, 0){};
                \vertex (b) at (1, 0);
                \propag [plain, mom={$\omega$}] (a) to (b); 
            \end{feynhand}
        \end{tikzpicture} = \ii q E(\omega).
    \]
    请注意这里没有负号，而$x^3$是负号的，这是因为均匀电场会倾向于把谐振子拉向无穷远处而回复力则会将谐振子拉回来。
    本节采取的傅里叶变换约定为
    \[
        E(t) = \int \dd{\omega} E(\omega) \ee^{- \ii \omega t},
    \]
    没有加入$2\pi$是因为很多时候入射光并不是连续谱，而是离散的几个频域分量加起来。
\end{itemize}

\begin{figure}
    \centering
    \subfigure[$x^3$自相互作用顶角]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (-1,-1); \vertex (b) at (1,-1); \vertex (c) at (0,1);
                \vertex [dot] (o) at (0,0) {}; 
                \propag [plain] (a) to (o);
                \propag [plain] (b) to (o); 
                \propag [plain] (c) to (o);    
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:x3-vertex}
    }
    \subfigure[光子激发出一个谐振子模式]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (-1, 1.5);
                \vertex (b) at (0, 1.5);
                \vertex (c) at (1, 1.5);
                \propag [photon] (a) to (b);
                \propag [plain] (b) to (c);
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:light-osci-couple}
    }
    \subfigure[外源驱动谐振子，即\autoref{fig:light-osci-couple}中的光子被当成无动力学的外场后得到的图形]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex [crossdot] (a) at (0, 0) {};
                \vertex (b) at (1, 0);
                \propag [plain] (a) to (b);
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:external-field}
    }
    \caption{加入$\frac{1}{3} m a x^3$势能之后的费曼图元件}
\end{figure}

\begin{figure}
    \centering
    \subfigure[外场导致的响应的一阶近似]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex [crossdot] (a) at (-1,-1) {};
                \vertex [crossdot] (b) at (1,-1) {}; 
                \vertex (c) at (0,1);
                \vertex (o) at (0,0) ; 
                \propag [plain, mom={$\omega_1$}] (a) to (o);
                \propag [plain, mom={$\omega_2$}] (b) to (o); 
                \propag [plain, mom={$\omega_1 + \omega_2$}] (o) to (c);
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:first-order-x3-external}
    }
    \subfigure[\autoref{fig:first-order-x3-external}导致的非线性光学过程]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a0) at (-1.5, -1.5);
                \vertex (a) at (-0.5,-0.5);
                \vertex (b0) at (1.5, -1.5);
                \vertex (b) at (0.5,-0.5); 
                \vertex (c) at (0,0.5);
                \vertex (c0) at (0, 1.5);
                \vertex (o) at (0,0) ; 
                \propag [photon, mom={$\omega_1$}] (a0) to (a);
                \propag [plain] (a) to (o);
                \propag [photon, mom={$\omega_2$}] (b0) to (b);
                \propag [plain] (b) to (o); 
                \propag [plain] (o) to (c);
                \propag [photon, mom={$\omega_1 + \omega_2$}] (c) to (c0);
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:first-order-x3-photon}
    }
    \caption{一阶过程}
    \label{fig:x3-first-order}
\end{figure}

据此，线性响应（零阶，没有发生任何非线性效应）为
\begin{equation}
    x_1(\omega) = \ii q E(\omega) \frac{\ii}{m (\omega^2 + \ii \gamma \omega - \omega_0^2)} = \frac{q / m}{\omega_0^2 - \omega^2 - \ii \gamma \omega} E(\omega).
\end{equation}
一阶过程（即\autoref{fig:first-order-x3-external}）给出如下修正：
\begin{equation}
    \begin{aligned}
        x_2(\omega) &= \frac{1}{2} \int \dd{\omega_1} \int \dd{\omega_2} (\ii q E(\omega_1)) (\ii q E(\omega_2)) \frac{\ii}{m(\omega_1^2 + \ii \gamma \omega_1 - \omega_0^2)} \frac{\ii}{m(\omega_2^2 + \ii \gamma \omega_2 - \omega_0^2)} \\ 
        &\quad \quad \times (-\ii 2 m a) \frac{\ii}{(m(\omega_1 + \omega_2)^2 + \ii \gamma (\omega_1 + \omega_2) - \omega_0^2)} 2\pi \delta(\omega_1 + \omega_2 - \omega) \\
        &= \int \dd{\omega_1} \int \dd{\omega_2} \frac{a (q / m)^2}{(\omega_1^2 + \ii \gamma \omega_1 - \omega_0^2) (\omega_2^2 + \ii \gamma \omega_2 - \omega_0^2) (\omega^2 + \ii \gamma \omega - \omega_0^2)}  \\
        &\quad \quad \times 2\pi \delta(\omega_1 + \omega_2 - \omega) \times E(\omega_1) E(\omega_2).
    \end{aligned} 
    \label{eq:continuous-x3-first-order}
\end{equation}
这里需要注意一点：\autoref{fig:first-order-x3-external}中外场出现了两次，而
\[
    E(t)^2 = \int \dd{\omega_1} \int \dd{\omega_2} E(\omega_1) E(\omega_2) \ee^{-\ii (\omega_1 + \omega_2) t},
\]
如果$\omega_1 \neq \omega_2$那么$E(\omega_1) E(\omega_2)$项实际上会被求和两次；同样，此时\eqref{eq:continuous-x3-first-order}中的$E(\omega_1) E(\omega_2)$项也会被求和两次。
直观地看，外场是给定的而不能随意交换，所以\autoref{fig:first-order-x3-external}中的两个外场从左到右为$\omega_1$和$\omega_2$的图和从左到右为$\omega_2$和$\omega_1$的图虽然给出一样的结果，但是是两张图，不能看成一张图，它们加起来会导致因子$2$出现。
如果我们令$E(t)$实际上只有两个频率分量，这一点会显得尤其明显。
$\omega_1 = \omega_2$的情况中没有因子$2$，我们常将这样的过程称为\emph{简并的}。

现在我们采取更加常规的，微扰求解微分方程的做法。费曼图计算已经告诉我们主要的光学过程来自\autoref{fig:first-order-x3-external}。
因此，我们将输入的$E$设置为
\begin{equation}
    E = E_1 (\ee^{\ii \omega_1 t} + \ee^{-\ii \omega_1 t}) + E_2 (\ee^{\ii \omega_2 t} + \ee^{-\ii \omega_2 t}), 
    \label{eq:input-two-freq-e}
\end{equation}
做展开
\begin{equation}
    x = x_1 + x_2 + \ldots, \quad x_n \sim E^{n },
\end{equation}
并记
\begin{equation}
    x_i = \sum_n x_i(\omega_n) + \text{c.c.}.
\end{equation}
线性项$x_1$由
\[
    m \ddot{x}_1 + m \gamma \dot{x_1} +  m \omega_0^2 x_1 = q E
\]
给出，为
\begin{equation}
    x_1(\omega_1) = \frac{(q/m) E_i}{\omega_0^2 } \ee^{-\ii \omega_n t},
\end{equation}
二阶项由
% TODO:懒得写了
这些项分别称为：
\begin{itemize}
    \item \concept{和频（SFG, sum frequency generation）}，
    \item \concept{差频（DFG, difference frequency generation）}，
    \item \concept{倍频（SHG, second harmonic generation）}，
    \item \concept{光学整流（OR, optic rectification）}（因为输入交流波而得到直流波，那当然是整流了）。
\end{itemize}
倍频是和频的特殊情况，光学整流是差频的特殊情况。当然，直接将\eqref{eq:input-two-freq-e}代入\eqref{eq:continuous-x3-first-order}也能够得到这些过程。

乍一看，费曼图方法不仅能够得到两个光子合并为一个光子的过程，也能够得到一个光子分裂成两个光子的过程（所谓的\concept{SPDC过程（Spontaneous parametric down-conversion）}，也称为\concept{OPG过程（Optical parametric generation）}），但是我们后面将看到，微分方程方法似乎只能给出两个光子合并为一个光子的过程——如果我们在$E$中放入只有一个频率$\omega_0$的波，那么非线性效应似乎只会给出$\omega=0$和$\omega=2\omega_0$两种波。
但是其实这里并没有矛盾：SPDC过程需要两条出射外线；如前所述，我们采用场的图景，由于我们采用微分方程的写法，即从$E$求解$x$（其实是$\expval*{x}$），然后用“谐振子位置的偏离导致极化电场产生”计算总电场的变化，对$x$也要采用场的图景，所以的确只应该考虑只有一条外线的费曼图。
这暗示着SPDC过程实际上是非常弱的（本该如此，和频过程的振幅正比于$E^2$而SPDC过程的振幅正比于$E$），因此在经典图景下这个过程根本就不会出现。%
\footnote{
    从这里也可以看出光学中量子理论的重要性，即使我们讨论的能标自始至终都没有高到让只有QED才有的过程（如四光子等效相互作用）出现。
    经典理论对电磁波的描述是非常粗糙的：如果我们要描述一个物理状态中有两种不同频率的光子，应该怎么做？
    在经典理论中只有一种方法：设
    \[
        \vb*{E} = \vb*{E}_1 \ee^{\ii \omega_1 t} + \vb*{E}_2 \ee^{\ii \omega_2 t} + \text{c.c.}.
    \]
    现在如果要将从一个单频波到以上状态的过程画成费曼图，由于只能画一条外线的图，势必只能画出$\omega_0 \to \omega_1$和$\omega_0 \to \omega_2$两个图，然后能量就不守恒了。
}%

这并不是说SPDC过程——或者说OPG过程——在适用经典近似的体系中完全看不到，因为我们可以在OPG过程后面再放一个DFG过程。
DFG过程也可以称为\concept{OPA过程（Optical parametric amplification）}，因为它让入射的两束光的一束变弱而另一束变强。
例如，设我们希望将一束频率为$\omega_1$的光分裂成两束光，频率分别是$\omega_2$和$\omega_3$。
我们可以将一个有二阶非线性极化的光学晶体放在一个内壁对频率为$\omega_2$和$\omega_3$的反射率很高的谐振腔中。
按照后面会提到的\eqref{eq:sfg-intensity}，如果有相位匹配条件成立，那么$\omega_1 \to \omega_2 + \omega_3$的OPG过程转化效率很高（在那里是SFG过程效率很高，这里就是OPG过程转化效率很高），于是产生足够强的$\omega_2$光束和$\omega_3$光束，这些光束被谐振腔反射回来，回到非线性晶体内部，于是发生很强的OPA过程。
因此，我们仅仅通过一束单频入射光就得到了两束不同频率的出射光。
% TODO：怎么定量算？
在经典理论中OPA过程是允许的，因此时间反演对称性并没有丧失：的的确确可以有光子的分裂。
但是，经典理论中所有电磁波模式上的光子都是足够多的，因此从“完全没有光子”到“有一个光子”的过程在经典理论中无法被描述。这就是OPG过程看不到的原因。
换而言之，经典理论中的光子分裂，即OPA，不仅需要入射的泵浦光，还需要一个（直观上看，引导泵浦光分裂成哪些频率的光的）\concept{种子光}。
一旦种子光入射了，随着光的传播它会增强。

\begin{figure}
    \centering
    \subfigure[外场导致的响应的二阶近似]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex [crossdot] (a) at (-1,-1) {};
                \vertex [crossdot] (b) at (1,-1) {}; 
                \vertex (c) at (0,1);
                \vertex (o) at (0,0) ;
                \vertex [crossdot] (e) at (1, 2) {};
                \vertex  (f) at (-1, 2) ; 
                \propag [plain, mom={$\omega_1$}] (a) to (o);
                \propag [plain, mom={$\omega_2$}] (b) to (o); 
                \propag [plain, mom={$\omega_1 + \omega_2$}] (o) to (c);
                \propag [plain, mom={$\omega_3$}] (e) to (c);
                \propag [plain, mom={$\omega_1 + \omega_2 + \omega_3$}] (c) to (f);
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:second-order-x3-external}
    }
    \subfigure[\autoref{fig:second-order-x3-external}导致的非线性光学过程]{
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a0) at (-1.5, -1.5);
                \vertex (a) at (-0.5,-0.5);
                \vertex (b0) at (1.5, -1.5);
                \vertex (b) at (0.5,-0.5); 
                \vertex (c) at (0,0.5);
                \vertex (o) at (0,0) ; 
                \vertex (d) at (0.5, 1);
                \vertex (e) at (-0.5, 1);
                \vertex (d0) at (1.5, 2);
                \vertex (e0) at (-1.5, 2);
                \propag [photon, mom={$\omega_1$}] (a0) to (a);
                \propag [plain] (a) to (o);
                \propag [photon, mom={$\omega_2$}] (b0) to (b);
                \propag [plain] (b) to (o); 
                \propag [plain] (o) to (c);
                \propag [plain] (c) to (e);
                \propag [plain] (c) to (d);
                \propag [photon, mom={$\omega_3$}] (d0) to (d);
                \propag [photon, mom={$\omega_1 + \omega_2 + \omega_3$}] (e) to (e0);
            \end{feynhand}
        \end{tikzpicture}
        \label{fig:second-order-x3-photon}
    }
    \caption{二阶过程}
    \label{fig:x3-second-order}
\end{figure}

还可以进一步往上计算微扰。例如，二阶微扰将给出\autoref{fig:x3-second-order}。
这里给出的四光子相互作用和\autoref{fig:first-order-x3-photon}产生的等效四光子相互作用不同，后者需要两个光子先合并，产生的光子传播一会，然后再和另一个光子合并。
\autoref{fig:second-order-x3-photon}给出的四光子相互作用是直截了当的。

我们来对各阶微扰的量级做一个估计。如果$\omega$和$\omega_0$比较接近，那么微扰论根本就不适用：此时共振发生，$x$是非常大的，可能高阶修正比低阶修正还大。
此时需要从头做光和物质耦合的计算而不能使用加入微弱非线性因素的振子模型。
如果$\omega$远大于$\omega_0$，我们将得到等离子体，此时彼此无关的、振幅不大的振子的图像更加失效了，可能晶格都已经被破坏了，电子的运动状况主要受电场控制。
在这两种情况下本节给出的非线性振子模型都不适用。（等离子体情况下有另一个非线性来源，即协变导数的输运项；见后文）
对$\omega \ll \omega_0$的情况，线性响应的振幅的量级为
\[
    x_1 \sim \frac{(q/m) E}{\omega_0^2},
\]
而
\[
    x_2 \sim \frac{a (q/m)^2 E^2}{\omega_0^6},
\]
因此
\begin{equation}
    \frac{x_2}{x_1} \sim \frac{a q E}{m \omega_0^4}.
\end{equation}
设原子对电子的束缚电场的量级为$E_\text{atom}$，则总位移$x$的振幅可以估计为
\[
    q E_\text{atom} \sim m \omega_0^2 x .
\]
$x$的量级具体有多大是不确定的，它包括没有外加电场时由$q E_\text{atom}$做回复力的内禀振荡，线性响应$x_1$和非线性响应$x_2$。
我们不妨采取一个非常极端的假设，认为线性回复力和非线性回复力已经一样大了（如果非线性回复力很小，那么当然只需要计算一阶图），此时
\[
    m \omega_0^2 x \sim m a x^2,
\]
于是
\[
    q E_\text{atom} \sim m \omega_0^2 \frac{\omega_0^2}{a},
\]
最后
\begin{equation}
    \frac{x_2}{x_1} \sim \frac{E}{E_\text{atom}}.
\end{equation}
通常原子内部电场的数量级为\SI{3e8}{V/m}，因此即使认为非线性回复力和线性回复力一样大，一般来说$x_2$也远小于$x_1$，即此时非线性极化相对于线性极化来说还是不大的。
介质的光学性能由极化给出，和回复力没有直接关系，因此非线性极化一般来说总是比非线性极化小得多的。
类似地实际上可以证明
\begin{equation}
    \frac{x_{n+1}}{x_n} \sim \frac{E}{E_\text{atom}}.
\end{equation}

\subsubsection{三阶非线性极化}

\subsection{自由电子气的输运项}

本节将自由电子气视为带电荷的连续介质。非线性效应来自$(\vb*{v} \cdot \grad) \vb*{v}$。
我们写下电荷的运动方程：
\begin{equation}
    \pdv{\vb*{v}}{t} + (\vb*{v} \cdot \grad) \vb*{v} = - e (\vb*{E} + \vb*{v} \times \vb*{B}),
\end{equation}
这里会导致非线性效应的包括输运项$(\vb*{v} \cdot \grad) \vb*{v}$和洛伦兹力项。

我们现在加载单频周期性外场。设频率为$\omega$的电场分量为
\begin{equation}
    \vb*{E}(\omega) = A \ee^{- \ii \omega t} + A^* \ee^{\ii \omega t},
\end{equation}
在忽略所有微扰的情况下显然
\begin{equation}
    \vb*{v}_1 = \frac{e \vb*{E}}{\ii m \omega}.
\end{equation}
于是
\[
    \pdv{\vb*{v}_2}{t} + (\vb*{v}_1 \cdot \grad) \vb*{v}_1 = - e \vb*{v}_1 \times \vb*{B},
\]
最终计算得到
\begin{equation}
    \vb*{j}(2\omega) = \rho_1 \vb*{v}_1 + \rho_0 \vb*{v}_2 = \frac{\epsilon_0 e}{\ii m \omega} (\div{\vb*{E}(\omega)}) \vb*{E}(\omega) + \rho_0 \frac{\ii}{4\omega} \div(\vb*{E}(\omega) \cdot \vb*{E}(\omega)).
    \label{eq:double-freq-current}
\end{equation}

\subsection{金属表面效应}

金属表面也能够产生二次谐波。将金属中的电子视为上一节讨论的带负电荷的连续介质。
金属表面发生了一个突变：内侧是带负电荷的连续介质而外侧则什么也没有。
由于金属外侧没有任何电荷分布，以下提到电流密度等时都是在金属内部讨论。

在金属表面附近，平行于表面的电流密度分量只有\eqref{eq:double-freq-current}的第一项，于是
\begin{equation}
    \vb*{j}_\parallel(2\omega) = \frac{\epsilon_0 e}{\ii m \omega} \pdv{E_\bot(\omega)}{z} \vb*{E}_\parallel(\omega) , 
\end{equation}
对它求积分，得到
\[
    \int_{0^-}^{0^+} \dd{z} \vb*{j}_\parallel(2\omega) = \frac{\epsilon_0 e}{\ii m \omega} \vb*{E}_{\parallel} (\omega) E_\bot(\omega) (1 - \epsilon),
\]
而垂直分量则是
\begin{equation}
    \vb*{j}_\bot(2\omega) = \frac{\epsilon_0 e}{\ii m \omega} \pdv{E_z}{z} E_z + \rho \frac{\ii}{4\omega} \left(\frac{e}{m\omega}\right)^2 \pdv{z} (E_z^2),
\end{equation}

\section{非线性极化的量子理论}

\subsection{单电子系统与经典光场耦合}

绝缘体中，电子-电子库伦散射一般来说是不重要的（除了在一些比较特殊的点由于库仑相互作用打开能隙等）。
从而，对透明晶体——一般来说不导电——以及普通的不导电的气体，的光学性能的计算通常可以使用束缚态单电子模型，即电子的本征态由能级编号标记，然后可以分析光如何让电子在能级之间跃迁。
\autoref{sec:classical-oscillator}中我们以光子和经典谐振子的振动模式为基本自由度，通过为谐振子引入一个非二次型的势来得到非线性效应。
这种做法在量子理论中当然也是成立的，并且此时谐振子的振动模式真的就像一个个粒子一样。
然而，应当注意，这种“光子和谐振子振动模式相互作用，谐振子的振动模式通过非简谐的势能相互作用”的理论并不是最方便的，因为无论为振子——在这里实际上就是原子中的电子——引入怎样的非线性势，由于是束缚态，电子自身的能谱都可以被一系列能级完整描述，并且这些能级是比较容易算出来的。
光子与电子碰撞会让电子从一个能级跳到另一个能级，并且能量守恒条件——其中电子的能量由已经经过非二次型势能修正的能级给出——必须成立。
这意味着，首先考虑非简谐的势能的作用，计算出电子能级，然后考虑光子让电子在这些能级之间跃迁，是更加方便的。
这个图景在经典理论中无法使用，因为此时的光子吸收相互作用顶角有一条入射线，两条出射线，从而一个有光子出射的过程一定有多条出射线（至少一条光子线，以及一条雷打不动的电子出射线），从而无法在经典理论中表达。

在基于电子能级的图景中，非线性光学效应来自高阶微扰论，因为相互作用顶角上连接了两条电子线和一条光子线，从而，一张费曼图中可以有数量任意的入射和出射光子线，另一方面，电子线除了和光子相互作用以外，没有别的相互作用。
这和基于非线性振子的图景非常不同，在后者中一个光子只能连接到一条代表振子振动模式（而不是电子本身）的内线上，即光子到振子振动模式的转换始终是线性的，但是振子振动模式之间可以碰撞，从而有非线性过程。
遮去电子线，将电子的非线性响应表示为宏观的“极化”，以上两种图景统一变成了\autoref{sec:non-linear-maxwell}中的图景。
电子与光场通过电偶极跃迁耦合，在耦合哈密顿量中电场是线性的，从而，电子电偶极矩的$n$次方就对应一个$n$光子顶角。

\subsubsection{电子状态的含时微扰论}

本节考虑一个受到经典电磁场扰动的单电子系统。设系统一开始位于某个态$\ket*{g}$上，电磁场扰动会让它在各个瞬时的状态变得不确定起来。
我们用$m, n$等标记电子能级，用$p, q$等标记光子模式，并做傅里叶分解
\begin{equation}
    \vb*{E}(t) = \sum_p \vb*{E}(\omega_p) \ee^{- \ii \omega_p t}.
\end{equation}

我们首先计算电场扰动下的电子波函数$\ket*{\psi}$。单光子吸收过程$\braket*{m}{\psi^{(1)}}$为
\begin{equation}
    \begin{aligned}
        \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex (a) at (-1.3, 0) {$g$};
                    \vertex (o) at (0, 0);
                    \vertex (b) at (1.3, 0) {$m$};
                    \vertex (c) at (-0.5, 0.87) ;
                    
                    \propag[fermion] (a) to (o);
                    \propag[fermion] (o) to (b);
                    \propag[photon, mom={$p$}] (c) to (o);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} &= \frac{1}{\hbar} \sum_p \frac{1}{\omega_g + \omega_p - \omega_m} \mel{m}{- \vb*{d} \cdot \vb*{E}(\omega_p)}{g} \ee^{- \ii (\omega_g + \omega_p - \omega_m) t} \\
        &= \frac{1}{\hbar} \sum_p \frac{\vb*{d}_{mg} \cdot \vb*{E}(\omega_p)}{\omega_{mg} - \omega_p} \ee^{\ii (\omega_{mg} - \omega_p) t},
    \end{aligned}
\end{equation}
双光子吸收过程$\braket*{n}{\psi^{(2)}}$为%
\footnote{
    这里使用的实际上是time ordered perturbation theory, 但是它的各阶微扰和covariant perturbation theory基本上是一样的。
    有两种方式看出这一点。我们可以将开头的$\ket{\text{g}}$也看成一个外线，从而第一个传播子中的$\omega_g + \omega_p$可以看成通过能量守恒定律计算出的能量，而$\omega_m$可以看成从能谱中读出的$m$模式的能量，整个传播子和$\omega - \vb*{p}^2 / 2m$是差不多的。
    这样末端的$l$线可以看成“有外场存在时的自发极化”，然后从此出发即可计算出$\chi$。
    我们也可以在covariant perturbation theory中积分掉各种中间变量来得到推导出此处的分母。
}%
\begin{equation}
    \begin{aligned}
        \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex (a) at (-1.3, 0) {$g$};
                    \vertex (o1) at (0, 0);
                    \vertex (o2) at (1.7, 0);
                    \vertex (b) at (3.0, 0) {$n$};
                    \vertex (c) at (-0.5, 0.87) ;
                    \vertex (d) at (1.2, 0.87);
                    
                    \propag[fermion] (a) to (o1);
                    \propag[fermion] (o1) to[edge label={$m$}] (o2);
                    \propag[fermion] (o2) to (b);
                    \propag[photon, mom={$p$}] (c) to (o1);
                    \propag[photon, mom={$q$}] (d) to (o2);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} &= \frac{1}{\hbar^2} \sum_{p, q} \sum_m \frac{1}{\omega_g + \omega_p + \omega_q - \omega_n} \mel{n}{- \vb*{d} \cdot \vb*{E}(\omega_p)}{m} \\ 
        &\quad \quad \times \frac{1}{\omega_g + \omega_p - \omega_m} \mel{m}{- \vb*{d} \cdot \vb*{E}(\omega_p)}{g} \ee^{- \ii (\omega_g + \omega_p + \omega_q - \omega_n) t} \\
        &= \frac{1}{\hbar^2} \sum_{p, q} \sum_m \frac{(\vb*{d}_{nm} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng} - \omega_q - \omega_p) (\omega_{mg} - \omega_p)} \ee^{\ii (\omega_{ng} - \omega_p - \omega_q) t},
    \end{aligned}
\end{equation}
同理还能够得到三光子吸收过程$\braket*{l}{\psi}$为
\begin{equation}
    \begin{aligned}
        &\quad \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex (a) at (-1.3, 0) {$g$};
                    \vertex (o1) at (0, 0);
                    \vertex (o2) at (1.7, 0);
                    \vertex (o3) at (3.4, 0);
                    \vertex (b) at (4.7, 0) {$l$};
                    \vertex (c) at (-0.5, 0.87) ;
                    \vertex (d) at (1.2, 0.87);
                    \vertex (e) at (2.9, 0.87);
                    
                    \propag[fermion] (a) to (o1);
                    \propag[fermion] (o1) to[edge label={$m$}] (o2);
                    \propag[fermion] (o2) to[edge label={$n$}] (o3);
                    \propag[fermion] (o3) to (b);
                    \propag[photon, mom={$p$}] (c) to (o1);
                    \propag[photon, mom={$q$}] (d) to (o2);
                    \propag[photon, mom={$r$}] (e) to (o3);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} \\
        &= \frac{1}{\hbar^3} \sum_{p, q, r} \sum_{m, n} \frac{(\vb*{d}_{ln} \cdot \vb*{E}(\omega_r)) (\vb*{d}_{nm} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{lg} - \omega_p - \omega_q - \omega_r) (\omega_{ng} - \omega_q - \omega_p) (\omega_{mg} - \omega_p)} \ee^{\ii (\omega_{lg} - \omega_p - \omega_q - \omega_r) t}.
    \end{aligned}
\end{equation}

以上三个过程都是严格按照电偶极辐射哈密顿量计算出来的；实际的系统中除了电偶极辐射以外，还有各种各样的噪声扰动。
我们假定噪声的主要效果是让系统倾向于自动地弛豫到基态，于是唯象地向传播子中加入有限大小的虚部$\ii \gamma_{mn}$以产生某种阻尼，为了简化书写，令
\begin{equation}
    \omega_{mn} = \omega_{m} - \omega_{n} - \ii \gamma_{mn},
\end{equation}
从而以上三个过程的表达式仍然是正确的，但是此时$\omega_{mn}$具有虚部，其复共轭不等于它本身。
这在计算期望值$\mel*{\psi}{\cdot}{\psi}$时非常重要。
我们还假定
\begin{equation}
    \gamma_{mn} = \gamma_{nm},
\end{equation}
这个假设的合理性需要在\autoref{sec:electron-density-matrix}中看到。

我们在这里用电子波函数描述电子，而用经典的电磁波描述光，一方面没有做光场量子化就能够得到非线性响应，一方面确保了非线性响应的量子本质能够被体现出来。
在经典理论中是画不出以上三个过程的，原因是显然的：在经典理论中光和电子的耦合方式就是\autoref{fig:light-osci-couple}，只有这个顶角的话，在经典的费曼图（严格区分“先发生”和“后发生”的过程，从而禁止相当一大类圈图）是画不出来电子吸收多个光子的过程的。
我们此处用实线表示的实际上是\emph{电子场}而不是\emph{电子坐标}，或者说不是（像\autoref{fig:light-osci-couple}那样的）电子的振动模式。
二次量子化之后电场和电子的耦合实际上形如$A_\mu \bar{\psi} \psi$，因此的确有两条电子线。
虽然电场和电子的耦合中电场是线性的，电子线却有两条，因此仅仅用电子-光子相互作用顶角就能够构造出多光子的图。

\subsubsection{双侧费曼图方法}\label{sec:pure-double-sided-feynman}

耦合项$- \vb*{d} \cdot \vb*{E}$会导致电子受到电场影响，自然也会导致电场被电子激发出来。
本节讨论经典电磁场，从而不能真的用光子入射散射等概念计算等效光子-光子顶角。
经典电磁场中介质极化是新的波源，而极化矢量为
\begin{equation}
    \vb*{P} = N \expval*{\vb*{d}} = N \mel*{\psi}{\vb*{d}}{\psi},
\end{equation}
将$\vb*{P}$代入介质中的麦克斯韦方程，即可得到介质中光的行为。
我们这里直接计算$\vb*{d}$的期望值，以得到极化矢量，这个做法的合理性在于我们本质上还是在积掉电子，即在配分函数中保留电磁场不动，积掉电子场，计算（两边是基态的）关联函数。

这样，极化矢量对电场的一阶响应为
\begin{equation}
   \begin{aligned}
    &\quad \mel*{\psi^{(0)}}{\vb*{d}}{\psi^{(1)}} + \mel*{\psi^{(1)}}{\vb*{d}}{\psi^{(0)}} \\
    &= \sum_m \ee^{- \ii \omega_m t} \vb*{d}_{gm} \ee^{\ii \omega_g t} \frac{1}{\hbar} \sum_p \frac{\vb*{d}_{mg} \cdot \vb*{E}(\omega_p)}{\omega_{mg} - \omega_p} \ee^{\ii (\omega_{mg} - \omega_p) t} + \text{h.c.} \\
    &= \frac{1}{\hbar} \sum_{m, p} \left( \frac{ \vb*{d}_{gm} (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{\omega_{mg} - \omega_p} \ee^{- \ii \omega_p t} + \frac{(\vb*{d}_{gm} \cdot \vb*{E}(\omega_p) )^* \vb*{d}_{mg}}{\omega_{mg}^* - \omega_p} \ee^{\ii \omega_p t} \right) \\
    &= \frac{1}{\hbar} \sum_{m, p} \left( \frac{ \vb*{d}_{gm} (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{\omega_{mg} - \omega_p} \ee^{- \ii \omega_p t} + \frac{(\vb*{d}_{gm} \cdot \vb*{E}(\omega_p) ) \vb*{d}_{mg}}{\omega_{mg}^* + \omega_p} \ee^{- \ii \omega_p t} \right), 
   \end{aligned} 
   \label{eq:dipole-first-perturbation}
\end{equation}
其中第三个等号将第二项中的$\omega_p$换成了$-\omega_p$。更高阶的响应也可以用类似的方式获得。
在计算更高阶的响应时，直接展开计算是非常繁琐的，例如，$\vb*{d}$的期望值中电场的二次项为
\begin{equation}
    \begin{aligned}
        &\quad \mel*{\psi^{(0)}}{\vb*{d}}{\psi^{(2)}} + \mel*{\psi^{(2)}}{\vb*{d}}{\psi^{(0)}} + \mel*{\psi^{(1)}}{\vb*{d}}{\psi^{(1)}} \\
        &= \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{\vb*{d}_{gn} (\vb*{d}_{nm} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng} - \omega_p - \omega_q) (\omega_{mg} - \omega_p)} \ee^{-\ii (\omega_p + \omega_q) t} \\
        &\quad + \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{(\vb*{d}_{ng} \cdot \vb*{E}(\omega_q))^* \vb*{d}_{nm} (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng}^* - \omega_q) (\omega_{mg} - \omega_p)} \ee^{-\ii (\omega_p - \omega_q) t} \\
        &\quad + \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{ (\vb*{d}_{ng} \cdot \vb*{E}(\omega_q))^* (\vb*{d}_{mn} \cdot \vb*{E}(\omega_p))^* \vb*{d}_{mg} }{(\omega_{ng}^* - \omega_q) (\omega_{mg}^* - \omega_p - \omega_q)} \ee^{\ii (\omega_p + \omega_q) t},
    \end{aligned}
\end{equation}
或者，通过调整求和变量让$\ee$指数完全成为$\ee^{- \ii (\omega_p + \omega_q) t}$，上式就是
\begin{equation}
    \begin{aligned}
        &\quad \mel*{\psi^{(0)}}{\vb*{d}}{\psi^{(2)}} + \mel*{\psi^{(2)}}{\vb*{d}}{\psi^{(0)}} + \mel*{\psi^{(1)}}{\vb*{d}}{\psi^{(1)}} \\
        &= \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{\vb*{d}_{gn} (\vb*{d}_{nm} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng} - \omega_p - \omega_q) (\omega_{mg} - \omega_p)} \ee^{-\ii (\omega_p + \omega_q) t} \\
        &\quad + \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{(\vb*{d}_{gn} \cdot \vb*{E}(\omega_q)) \vb*{d}_{nm} (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng}^* + \omega_q) (\omega_{mg} - \omega_p)} \ee^{-\ii (\omega_p + \omega_q) t} \\
        &\quad + \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{ (\vb*{d}_{gn} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{nm} \cdot \vb*{E}(\omega_p)) \vb*{d}_{mg} }{(\omega_{ng}^* + \omega_q) (\omega_{mg}^* + \omega_p + \omega_q)} \ee^{- \ii (\omega_p + \omega_q) t},
    \end{aligned}
\end{equation}
而三阶项就更加繁琐了。实际上，我们可以将这些计算总结为一套费曼图，其规则如下：
\begin{itemize}
    \item 电子线包括从下而上的左侧线和从上而下的右侧线，即所谓\emph{双边费曼图（double sided Feynman diagram）}；
    \item 在左侧线最顶端放置$\vb*{d}$算符，使用一根波浪线代表它产生电磁场；
    \item 由于顶角总是有两条电子线，传播子和顶角可以合并成一个组件。在左侧线上，从下到上第$i$个顶角给出
    \begin{equation}
        \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex (g) at (0, 0);
                    \vertex (t) at (0, 2);
                    \vertex (l) at (-1, 0.5) {$\omega_i$};
                    \vertex (v) at (0, 1);
                    
                    \propag[plain] (g) to[edge label={$m$}] (v) ;
                    \propag[plain] (v) to[edge label={$n$}] (t);
                    \propag[extphoton] (l) to (v);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} = \frac{\vb*{d}_{nm} \cdot \vb*{E}(\omega_p) }{\omega_{ng} - \sum_{j=1}^i \omega_j},
        \label{eq:feynman-diagram-left}
    \end{equation}
    其中$\omega_k$表示左侧线从下到上第$j$个光子线的频率。
    而在右侧线上，从下到上第$i$个顶角给出
    \begin{equation}
        \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex (g) at (0, 0);
                    \vertex (t) at (0, 2);
                    \vertex (l) at (1, 0.5) {$\omega_i$};
                    \vertex (v) at (0, 1);
                    
                    \propag[plain] (g) to[edge label={$m$}] (v) ;
                    \propag[plain] (v) to[edge label={$n$}] (t);
                    \propag[extphoton] (l) to (v);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} = \frac{\vb*{d}_{mn} \cdot \vb*{E}(\omega_p) }{\omega_{ng}^* + \sum_{j=1}^i \omega_j}.
        \label{eq:feynman-diagram-right}
    \end{equation}
    其中$\omega_k$表示右侧线从下到上第$j$个光子线的频率。为了区分外场和$\mel*{\psi}{\vb*{d}}{\psi}$，我们用直线表示前者而用波浪线代表后者，虽然在凝聚态场论中我们通常用带有$\otimes$的波浪线代表前者。
\end{itemize}
例如，\eqref{eq:dipole-first-perturbation}可以用费曼图表示如下：
\begin{equation}
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$g$};
                \vertex (g2) at (0.25, 0) {$g$};
                \vertex (t1) at (-0.25, 2.5);
                \vertex (t2) at (0.25, 2.5);
                \propag[plain] (t1) to[out=90, in=90] (t2);

                \vertex (v1) at (-0.25, 1) ;
                \vertex (l1) at (-1.55, 0.5) {$\omega_p$};
                \propag[extphoton] (l1) to (v1);
                \propag[plain] (g1) to (v1) ;

                \vertex (o) at (-0.25, 2);
                \vertex (e) at (-1.55, 2.5) {$\omega_p$};
                \propag[outphoton] (o) to (e);
                \propag[plain] (v1) to[edge label={$m$}] (o);

                \propag[plain] (o) to (t1);

                \propag[plain] (t2) to (g2);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} = \frac{1}{\hbar} \sum_{m, p} \frac{ \vb*{d}_{gm} (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{\omega_{mg} - \omega_p} \ee^{- \ii \omega_p t} ,
    \label{eq:left-in-one-order-perturbation}
\end{equation}
以及
\begin{equation}
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$g$};
                \vertex (g2) at (0.25, 0) {$g$};
                \vertex (t1) at (-0.25, 2.5);
                \vertex (t2) at (0.25, 2.5);
                \propag[plain] (t1) to[out=90, in=90] (t2);

                \vertex (v1) at (0.25, 1) ;
                \vertex (l1) at (1.55, 0.5) {$\omega_p$};
                \propag[extphoton] (l1) to (v1);
                \propag[plain] (g2) to (v1) ;

                \propag[plain] (v1) to[edge label'={$m$}] (t2);
                \propag[plain] (t1) to (o);

                \vertex (o) at (-0.25, 2);
                \vertex (e) at (-1.55, 2.5) {$\omega_p$};
                \propag[outphoton] (o) to (e);

                \propag[plain] (o) to (g1);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} = \frac{1}{\hbar} \sum_{m, p} \frac{ \vb*{d}_{mg} (\vb*{d}_{gm} \cdot \vb*{E}(\omega_p) )}{\omega_{mg}^* + \omega_p} \ee^{- \ii \omega_p t}.
    \label{eq:right-in-one-order-perturbation}
\end{equation}
更高阶的响应也可以用类似的方式用费曼图计算，如二阶响应对应如下三个图：
\begin{equation}
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$g$};
                \vertex (g2) at (0.25, 0) {$g$};
                \vertex (t1) at (-0.25, 3.5);
                \vertex (t2) at (0.25, 3.5);
                \propag[plain] (t1) to[out=90, in=90] (t2);

                \vertex (v1) at (-0.25, 1) ;
                \vertex (l1) at (-1.55, 0.5) {$\omega_p$};
                \propag[extphoton] (l1) to (v1);

                \vertex (v2) at (-0.25, 2);
                \vertex (l2) at (-1.55, 1.5) {$\omega_q$};
                \propag[extphoton] (l2) to (v2);

                \propag[plain] (g1) to (v1) ;
                \propag[plain] (v1) to[edge label={$m$}] (v2);

                \vertex (o) at (-0.25, 3);
                \vertex (e) at (-1.55, 3.5) {$\omega_p + \omega_q$};
                \propag[outphoton] (o) to (e);
                \propag[plain] (v2) to[edge label={$n$}] (o);

                \propag[plain] (o) to (t1);

                \propag[plain] (t2) to (g2);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} = \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{\vb*{d}_{gn} (\vb*{d}_{nm} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng} - \omega_p - \omega_q) (\omega_{mg} - \omega_p)} \ee^{-\ii (\omega_p + \omega_q) t},
    \label{eq:second-response-1}
\end{equation}
\begin{equation}
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$g$};
                \vertex (g2) at (0.25, 0) {$g$};
                \vertex (t1) at (-0.25, 3.5);
                \vertex (t2) at (0.25, 3.5);
                \propag[plain] (t1) to[out=90, in=90] (t2);

                \vertex (v1) at (0.25, 1) ;
                \vertex (l1) at (1.55, 0.5) {$\omega_q$};
                \propag[extphoton] (l1) to (v1);
                \propag[plain] (g2) to (v1) ;

                \propag[plain] (v1) to[edge label'={$n$}] (t2);
                \propag[plain] (t1) to (o);

                \vertex (o) at (-0.25, 3);
                \vertex (e) at (-1.55, 3.5) {$\omega_p + \omega_q$};
                \propag[outphoton] (o) to (e);

                \propag[plain] (g1) to (v2);
                \vertex (v2) at (-0.25, 2);
                \vertex (l2) at (-1.55, 1.5) {$\omega_p$};
                \propag[extphoton] (l2) to (v2);
                \propag[plain] (v2) to[edge label={$m$}] (o);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} = \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{(\vb*{d}_{gn} \cdot \vb*{E}(\omega_q)) \vb*{d}_{nm} (\vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{(\omega_{ng}^* + \omega_q) (\omega_{mg} - \omega_p)} \ee^{-\ii (\omega_p + \omega_q) t} ,
\end{equation}
以及
\begin{equation}
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$g$};
                \vertex (g2) at (0.25, 0) {$g$};
                \vertex (t1) at (-0.25, 3.5);
                \vertex (t2) at (0.25, 3.5);
                \propag[plain] (t1) to[out=90, in=90] (t2);

                \vertex (v1) at (0.25, 1) ;
                \vertex (l1) at (1.55, 0.5) {$\omega_q$};
                \propag[extphoton] (l1) to (v1);
                \propag[plain] (g2) to (v1) ;

                \vertex (v2) at (0.25, 2);
                \vertex (l2) at (1.55, 1.5) {$\omega_p$};
                \propag[extphoton] (l2) to (v2);
                \propag[plain] (v2) to[edge label={$n$}] (v1);

                \propag[plain] (v2) to[edge label'={$m$}] (t2);
                \propag[plain] (t1) to (o);

                \vertex (o) at (-0.25, 3);
                \vertex (e) at (-1.55, 3.5) {$\omega_p + \omega_q$};
                \propag[outphoton] (o) to (e);

                \propag[plain] (o) to (g1);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} = \frac{1}{\hbar^2} \sum_{p, q} \sum_{m, n} \frac{ (\vb*{d}_{gn} \cdot \vb*{E}(\omega_q)) (\vb*{d}_{nm} \cdot \vb*{E}(\omega_p)) \vb*{d}_{mg} }{(\omega_{ng}^* + \omega_q) (\omega_{mg}^* + \omega_p + \omega_q)} \ee^{- \ii (\omega_p + \omega_q) t}.
\end{equation}

\subsubsection{极化矢量和极化率}

现在我们获得了$\vb*{d}$，于是可以计算出$\vb*{P}$，于是进一步可以计算出$\chi^{(1)}$, $\chi^{(2)}$等等。
在假定介质稀薄，或者说假定光只会被散射单次，并且介质中所有电子吸收入射光的概率均相同时，我们有
\[
    \vb*{P} = N \expval*{\vb*{d}} = \epsilon_0 \chi^{(1)}_{ij} E^j + \epsilon_0 \chi^{(2)}_{ij} E^i E^j + \cdots,
\]
即可得到
\begin{equation}
    \chi^{(1)}_{ij}(\omega_p) = \frac{N}{\epsilon_0 \hbar} \sum_{m} \left( \frac{ d_{gm}^i {d}_{mg}^j}{\omega_{mg} - \omega_p} + \frac{{d}_{mg}^i d_{gm}^j}{\omega_{mg}^* + \omega_p} \right)  ,
    \label{eq:linear-chi-pure}
\end{equation}
以及
\begin{equation}
    \begin{aligned}
        \chi^{(2)}_{ijk}(\omega_p + \omega_q, \omega_p, \omega_q) &= \frac{N}{\epsilon_0 \hbar^2} \mathcal{P}_\text{I} \sum_{m, n} \Bigg( \frac{d_{gn}^i d_{nm}^j d_{mg}^k }{(\omega_{ng} - \omega_p - \omega_q) (\omega_{mg} - \omega_p)} \\
        &\quad + \frac{d_{gn}^j d_{nm}^i d_{mg}^k }{(\omega_{ng}^* + \omega_q) (\omega_{mg} - \omega_p)} \\
        &\quad + \frac{ d_{gn}^j d_{nm}^k d_{mg}^i }{(\omega_{ng}^* + \omega_q) (\omega_{mg}^* + \omega_p + \omega_q)} \Bigg) .
    \end{aligned}
    \label{eq:second-chi-pure}
\end{equation}
等式坐标括号内的第一个频率是转换产生的光的频率，后面的频率是输入光的频率。
这里元算符$\mathcal{P}_\text{I}$将其后的表达式中的$\omega_p$和$\omega_q$交换，将$j$与$k$交换，并且求和所有可能的交换情况。
它的出现是因为以上所有求和式中$\sum_{p, q}$均未固定各个频率出现的顺序，从而，例如，如果输入光有两个频率分量$\omega_1, \omega_2$，那么$\omega_p = \omega_1, \omega_q = \omega_2$和$\omega_p = \omega_2, \omega_q = \omega_1$这两种情况都必须考虑进去；由于指标$j$和$\vb*{E}(\omega_q)$缩并，指标$k$和$\vb*{E}(\omega_p)$缩并，交换$\omega_p$和$\omega_q$也要求交换$j$和$k$。
因此，\eqref{eq:second-chi-pure}在去掉$\mathcal{P}_\text{I}$之后其实有六项。

从\eqref{eq:linear-chi-pure}和\eqref{eq:second-chi-pure}出发可以证明关于极化率的一些性质。
首先是熟知的二阶非线性极化对应空间反演对称性破缺。
在空间反演下，正比于$\vb*{r}$的电偶极矩$\vb*{d}$变号，此时$\chi^{(1)}$不变而$\chi^{(2)}$变号。
对具有空间反演不变性的系统，空间反演下张量不应该有变动，因此对具有空间反演不变性的系统，二阶非线性极化为零。
类似的其它从晶体的对称性在宏观层面分析得到的非线性极化率的性质也可以通过观察这些对称性对$\vb*{d}$的矩阵元的约束而获得。

在远离共振的频段，阻尼不会造成特别大的影响，从而\eqref{eq:second-chi-pure}中所有的$\omega_{mn}$都是实数。
此时\eqref{eq:second-chi-pure}可以进一步化简。
设
\begin{equation}
    \omega_s = \omega_p + \omega_q,
\end{equation}
我们会发现，如果我们定义元算符$\mathcal{P}_\text{F}$为将其后的表达式中的$(\omega_q, j)$，$(\omega_p, k)$和$(- \omega_s, i)$做所有可能的置换并求和，则可以验证
\begin{equation}
    \chi^{(2)}_{ijk}(\omega_s, \omega_p, \omega_q) = \frac{N}{\epsilon_0 \hbar^2} \mathcal{P}_\text{F} \sum_{m, n} \frac{d_{gn}^i d_{nm}^j d_{mg}^k }{(\omega_{ng} - \omega_s) (\omega_{mg} - \omega_p)}.
\end{equation}
这个表达式说明了另一个性质：在无阻尼的情况下，二阶非线性极化率中的$\omega_p, \omega_q, -\omega_s$是等价的：把它们连通$i, j, k$一起轮换不改变$\chi^{(2)}_{ijk}(\omega_s, \omega_p, \omega_q)$的值。
这是因为在没有阻尼时，二阶非线性极化可以通过在哈密顿量中加入一个等效相互作用
\begin{equation}
    {H}_\text{int} = \int \dd[3]{\vb*{r}} \frac{1}{3} \epsilon_0 \chi^{(2)} : \vb*{E} \vb*{E} \vb*{E}
\end{equation}
得到，从而$\chi^{(2)}$的$i, j, k$指标是等价的，切换到频域下后，三个电场分别用$\omega_p, \omega_q, \omega_s$标记，则$\omega_p, \omega_q, \omega_s$也应该是等价的。
轮换三个电场相当于同时轮换$i, j, k$和$\omega_p, \omega_q, \omega_s$，这对系统的行为不造成任何改变，这就解释了前述的$\chi^{(2)}$的性质。
$\omega_s$在轮换时带有负号可以用下图理解：
\begin{equation}
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (o) at (0, 0);
                \vertex (a) at (1.5, 0);
                \vertex (b) at (-0.75, 1.3);
                \vertex (c) at (-0.75, -1.3);
                
                \propag[photon, mom={$\omega_s$}] (o) to (a);
                \propag[photon, mom={$\omega_p$}] (b) to (o);
                \propag[photon, mom={$\omega_q$}] (c) to (o);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} = \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (o) at (0, 0);
                \vertex (a) at (1.5, 0);
                \vertex (b) at (-0.75, 1.3);
                \vertex (c) at (-0.75, -1.3);
                
                \propag[photon, mom={$- \omega_s$}] (a) to (o);
                \propag[photon, mom={$\omega_p$}] (b) to (o);
                \propag[photon, mom={$\omega_q$}] (c) to (o);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered}
\end{equation}
需注意我们这里实际上还是在处理经典电磁场，从而需要严格区分一个顶角上的入射线和出射线，因此出射的$\omega_s$和入射的$\omega_q$和$\omega_p$在推导$\chi^{(2)}$时的地位看起来不同，但是在最终结果中一定有$\omega_p, \omega_q, -\omega_s$以及附带的$i, j, k$的轮换对称性成立。
下面给出这种轮换性的一些显式表达式，这里我们为了强调“转化”，将$\chi^{(2)}(\omega_s, \omega_q, \omega_p)$写成$\chi^{(2)}(\omega_s = \omega_q + \omega_p)$：
\begin{equation}
    \chi^{(2)}_{ijk}(\omega_s = \omega_q + \omega_p) = \chi^{(2)}_{jik}(- \omega_q = - \omega_s + \omega_p) = \chi^{(2)}_{jik}(\omega_q = \omega_s - \omega_p)^*, 
\end{equation}
\begin{equation}
    \chi^{(2)}_{ijk}(\omega_s = \omega_q + \omega_p) = \chi^{(2)}_{ikj}(\omega_s = \omega_p + \omega_q).
\end{equation}
容易看出更一般的轮换关系对任意阶的远离共振（从而阻尼可以忽略）的非线性极化率都成立，且当$\chi^{(n)}(\omega_s = \sum_i \omega_i)$括号内等式两边的频率从一侧移到另一侧时需要加复共轭。
例如对线性极化就有熟知的
\begin{equation}
    \chi^{(1)}_{ij}(\omega) = \chi^{(1)}_{ji}(-\omega) = \chi^{(1)}_{ji}(\omega)^* = \chi^{(1)}_{ij}(-\omega).
\end{equation}

总之，在量子力学的框架下，产生非线性极化并不需要介质内有非线性势或者类似的非线性相互作用。
在量子力学的框架下电子和光子的相互作用方式——一个电子吸收或者放出一个光子——自然地允许出现\eqref{eq:second-response-1}这样的过程；而另一方面，经典理论禁止多条外线的出现，从而也无法在介质内部没有非线性相互作用的情况下得到非线性响应。

我们此处做的计算积掉了电子自由度。电子在电磁波的作用下没有处在某个明确的能级上，虽然费曼图中我们说电子可能处在$m$或$n$号能级，但这都是离壳的。
光学上，我们说此时电子处在“虚能级”上。后文中当光和介质中实实在在的模式（如声子）耦合时，将会涉及“实能级”，因为声子的发射和吸收让系统从一个明确的能级跃迁到另一个明确的能级上。

实际上，虽然本节在一开始似乎假定了系统处在束缚态，但以上推导完全没有用到不同能级之间有有限的能隙这个条件。（这和诸如拓扑序的波函数重整化之类的东西是不同的，在那些话题中，能隙是至关重要的，因为要保证小的激发不会让系统跑到激发态上去的概率变得很大；本节所述的过程都是求和了所有可能的跃迁，所以有没有能隙不重要）
因此，对那些电子可以长距离运动的系统，如果能够适用能带理论，即单电子近似仍然成立，我们以上的推导在考虑了诸如电子的激发在费米面附近等费米统计带来的特殊效应后仍然是适用的。
一旦通过各种方法——比如DFT计算——得到系统能谱，就能够计算出非线性极化率。

最后我们需要指出，我们目前做的所有计算都依赖两个假设：一个是电子之间的库仑相互作用可以忽略，即我们无需真的去分析一个多体系统；另一个假设是介质充分稀薄。
这第二个假设不成立时我们就有局域场修正，即介质外部的电磁场进入到介质分子或原子附近时会因为邻近的原子的响应而受到“修饰”或者说“增强”。

\subsubsection{与凝聚态场论方法的一致性}

双边费曼图的规则看起来非常奇特，但是实际上可以将它理解为凝聚态场论中的图。
它和一般的凝聚态场论的不同之处在于，本节讨论的带有弛豫的模型是非幺正的，时间反演不变性破缺，从而传播子的书写有一些需要注意的地方。
大体上说我们是要计算
\[
    \expval*{{c}^\dagger_m(t) \vb*{d}_{mn} c_n(t) }, \quad \ket*{\Omega} = c^\dagger_g(-\infty) \ket*{0}.
\]
我们有两种做法，其中之一是直接计算$\mel*{0}{c_g(-\infty) {c}^\dagger_m(t) \vb*{d}_{mn} c_n(t) c^\dagger_g(-\infty)}{0}$，对应的费曼图形如
\begin{equation}
    \sum_{m, n} \vb*{d}_{mn} \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex [grayblob] (o) at (0, 0) {};
                \vertex (a) at (-1, 1) {$g, -\infty$};
                \vertex (b) at (-1, -1) {$g, -\infty$};
                \vertex (c) at (1, 1) {$m, t$};
                \vertex (d) at (1, -1) {$n, t$};
    
                \propag[fermion] (a) to (o);
                \propag[fermion] (o) to (b);
                \propag[fermion] (o) to (c);
                \propag[fermion] (d) to (o);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered},
    \label{eq:double-sided-feynman-diagram-in-condensed}
\end{equation}
其中$m, n$两端均可以不在壳，即有对应的传播子。这是可以理解的，因为如果电磁场也是量子化的，上图实际上就是
\[
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex [grayblob] (o) at (0, 0) {};
                \vertex (a) at (-1, 1) {$g, -\infty$};
                \vertex (b) at (-1, -1) {$g, -\infty$};
                \vertex (e) at (1.75, 0);
                \vertex (f) at (2.75, 0);
    
                \propag[fermion] (a) to (o);
                \propag[fermion] (o) to (b);
                \propag[fermion] (o) to[out=45, in=135] (e);
                \propag[fermion] (e) to[in=315, out=225] (o);
                \propag[photon] (e) to (f);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered}.
\]
在本节中我们无需计算上图最右边的产生光子的顶角，光子产生是在非线性麦克斯韦方程中通过极化矢量引入的。

\eqref{eq:double-sided-feynman-diagram-in-condensed}中的$g$外线实际上是系统基态的一部分，因此我们不能将两个$g$外线连接起来，否则得到的实际上是真空气泡图。因此，我们只需要考虑下图
\begin{equation}
    \sum_{m, n} \vb*{d}_{mn} \ee^{- \ii (\omega_m - \omega_n) t} \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (-2, 1) {$g, -\infty$};
                \vertex (b) at (-2, 0) {$g, -\infty$};
                \vertex (c) at (2, 1) {$m, t$};
                \vertex (d) at (2, 0) {$n, t$};
                \vertex[grayblob] (o1) at (0, 1) {};
                \vertex[grayblob] (o2) at (0, 0) {};
                
                \propag[fermion] (a) to (o1);
                \propag[fermion] (o1) to (c);
                \propag[fermion] (o2) to (b);
                \propag[fermion] (d) to (o2);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered}
    \label{eq:general-form-condensed}
\end{equation}
即可，其中圆圈内是一个或多个光子吸收或发射过程。由于本节的系统时间反演对称性破缺，因为存在弛豫项，图
\[
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (-2, 1) {$g, -\infty$};
                \vertex (c) at (2, 1) {$m, t$};
                \vertex[grayblob] (o1) at (0, 1) {};
                
                \propag[fermion] (a) to (o1);
                \propag[fermion] (o1) to (c);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered}
\]
中的频域电子传播子是
\[
    \int \ee^{\ii \omega t} \dd{t} T\expval*{\psi_m(t) \bar{\psi}_g} = \frac{\ii}{\omega - \omega_m + \ii \gamma},
\]
而
\[
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (a) at (-2, 1) {$g, -\infty$};
                \vertex (c) at (2, 1) {$m, t$};
                \vertex[grayblob] (o1) at (0, 1) {};
                
                \propag[fermion] (o1) to (a);
                \propag[fermion] (c) to (o1);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered}
\]
中的频域电子传播子是
\[
    \int \ee^{\ii \omega t} \dd{t} T\expval*{{\psi}_g \bar{\psi}_m(t)} = \frac{\ii}{\omega - \omega_m - \ii \gamma}.
\]
$\mel{\psi}{\vb*{d}}{\psi}$中有一系列从$-\infty$演化到我们要计算的时间点的粒子线，也有一系列从我们要计算的时间点演化回$-\infty$的粒子线，它们的电子传播子是不同的：在时间反演变换下$\gamma$需要加上一个负号。
从\eqref{eq:dipole-first-perturbation}出发，我们也可以将$\gamma$的负号理解为是$\bra{\psi}$相比于$\ket*{\psi}$取了复共轭而产生的。
对$\gamma$的负号的两种理解是一致的，因为时间反演和复共轭紧密相关。
\eqref{eq:general-form-condensed}中的$-\infty$演化到我们要计算的时间点的一系列电子线实际上就是双边费曼图的左侧电子线，而\eqref{eq:general-form-condensed}中从我们要计算的时间点演化到$-\infty$的一系列电子线实际上就是双边费曼图中的右侧电子线。
右边的传播子中的$\gamma$要多一个负号。

基于以上考虑，把这些费曼图当成凝聚态场论的图理解，可以写出
\begin{equation}
    \begin{aligned}
        &\quad \sum_{m, n} \vb*{d}_{mn} \ee^{-\ii (\omega_m - \omega_n) t} \times \left( \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex[crossdot] (l) at (0, 2) {};
                    \vertex (a) at (-2, 1) {$g, -\infty$};
                    \vertex (b) at (-2, 0) {$g, -\infty$};
                    \vertex (c) at (2, 1) {$m, t$};
                    \vertex (d) at (2, 0) {$n, t$};
                    \vertex (v) at (0, 1);

                    \propag[photon, mom={$\omega_p$}] (l) to (v);
                    \propag[fermion] (a) to (v);
                    \propag[fermion] (v) to (c);
                    \propag[fermion] (d) to (b);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} \right) \\
        &= \sum_p \vb*{d}_{gm} \ee^{-\ii \omega_p t} \sum_{m} \frac{\ii}{\omega_p + \omega_g - \omega_m + \ii \gamma_{mg}} \frac{(\ii \vb*{d}_{mg} \cdot \vb*{E}(\omega_p))}{\hbar},
    \end{aligned}
\end{equation}
计算结果和\eqref{eq:left-in-one-order-perturbation}是一致的。同样我们使用凝聚态场论的理解方式计算入射光子在右侧电子线的图，有
\begin{equation}
    \begin{aligned}
        &\quad \sum_{m, n} \vb*{d}_{mn} \ee^{-\ii (\omega_m - \omega_n) t} \times \left( \begin{gathered}
            \begin{tikzpicture}
                \begin{feynhand}
                    \vertex[crossdot] (l) at (0, -1) {};
                    \vertex (a) at (-2, 1) {$g, -\infty$};
                    \vertex (b) at (-2, 0) {$g, -\infty$};
                    \vertex (c) at (2, 1) {$m, t$};
                    \vertex (d) at (2, 0) {$n, t$};
                    \vertex (v) at (0, 0);

                    \propag[photon, mom={$\omega_p$}] (l) to (v);
                    \propag[fermion] (a) to (c);
                    \propag[fermion] (d) to (v);
                    \propag[fermion] (v) to (b);
                \end{feynhand}
            \end{tikzpicture}
        \end{gathered} \right) \\
        &= \sum_p \vb*{d}_{mg} \ee^{- \ii \omega_p t} \sum_m \frac{\ii \vb*{d}_{gm} \cdot \vb*{E}(\omega_p)}{\hbar} \frac{\ii}{\omega_g - \omega_p - \omega_m + \ii \gamma_{mg}} ,
    \end{aligned}
\end{equation}
和\eqref{eq:right-in-one-order-perturbation}一致。
类似的可以验证，\eqref{eq:feynman-diagram-left}和\eqref{eq:feynman-diagram-right}两个费曼规则也是可以通过凝聚态场论导出的，其中诸如$\sum \omega_i$这样奇怪的表达式实际上是能量守恒条件的结果。

\subsubsection{密度矩阵表述}\label{sec:electron-density-matrix}

以上所有的计算中的非幺正效应都是手动添加在传播子中的，并且我们到最后实际上又忽略了它们。
本节给出对电子弛豫到基态这件事的稍微严格一些的处理。
我们使用密度矩阵描述电子状态。实际系统中总是存在各种各样的过程让处于激发态的电子回到基态，如自发辐射、碰撞等。唯象地引入参数$\gamma_{mn}$，写出密度矩阵的时间演化方程
\begin{equation}
    \dot{\rho}_{mn} = - \frac{\ii}{\hbar} \comm*{H}{\rho}_{mn} - \gamma_{mn} (\rho_{mn} - \rho^\text{eq}_{mn}),
    \label{eq:electron-density-matrix-evolve}
\end{equation}
通常可以假定电子处在热态，而由于$\{\ket*{m}\}$是能量本征态，有
\begin{equation}
    \rho^\text{eq}_{mn} = \rho^\text{eq}_{mm} \delta_{mn},
\end{equation}
其中$\rho^\text{eq}_{mn}$给出热平衡态分布。

方程\eqref{eq:electron-density-matrix-evolve}

实际上，\eqref{eq:electron-density-matrix-evolve}的解也可以画成双边费曼图，在每个时间点，有\emph{两个}状态，分别对应密度矩阵的左矢和右矢，因此电子线包括左右两部分。
但此时的双边费曼图和\autoref{sec:pure-double-sided-feynman}中有所差别，主要体现在传播子的表达式不同，以及会多出来几个图。
例如，密度矩阵的双边费曼图同时包括下面的两张图：
\[
    \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$\ket*{g}$};
                \vertex (g2) at (0.25, 0) {$\bra*{g}$};
                \vertex (t1) at (-0.25, 4) {$\ket*{n}$};
                \vertex (t2) at (0.25, 4) {$\bra*{n}$};

                \vertex (v1) at (0.25, 1) ;
                \vertex (l1) at (1.55, 0.5) {$\omega_q$};
                \propag[extphoton] (l1) to (v1);
                \propag[plain] (g2) to (v1) ;
                
                \propag[plain] (v1) to (t2);

                \vertex (v2) at (-0.25, 2);
                \vertex (l2) at (-1.55, 1.5) {$\omega_p$};
                \propag[extphoton] (l2) to (v2);
                \propag[plain] (g1) to (v2);

                \vertex (o) at (-0.25, 3);
                \vertex (e) at (-1.55, 3.5) {$\omega_p + \omega_q$};
                \propag[outphoton] (o) to (e);
                \propag[plain] (v2) to[edge label={$\ket*{m}$}] (o);
                \propag[plain] (o) to (t1);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} , \quad \begin{gathered}
        \begin{tikzpicture}
            \begin{feynhand}
                \vertex (g1) at (-0.25, 0) {$\ket*{g}$};
                \vertex (g2) at (0.25, 0) {$\bra*{g}$};
                \vertex (t1) at (-0.25, 4) {$\ket*{n}$};
                \vertex (t2) at (0.25, 4) {$\bra*{n}$};

                \vertex (v1) at (0.25, 2) ;
                \vertex (l1) at (1.55, 1.5) {$\omega_q$};
                \propag[extphoton] (l1) to (v1);
                \propag[plain] (g2) to (v1) ;
                
                \propag[plain] (v1) to (t2);

                \vertex (v2) at (-0.25, 1);
                \vertex (l2) at (-1.55, 0.5) {$\omega_p$};
                \propag[extphoton] (l2) to (v2);
                \propag[plain] (g1) to (v2);

                \vertex (o) at (-0.25, 3);
                \vertex (e) at (-1.55, 3.5) {$\omega_p + \omega_q$};
                \propag[outphoton] (o) to (e);
                \propag[plain] (v2) to[edge label={$\ket*{m}$}] (o);
                \propag[plain] (o) to (t1);
            \end{feynhand}
        \end{tikzpicture}
    \end{gathered} ,
\]
第一张图中电子状态的演化路径是
\[
    \dyad{g} \longrightarrow \dyad*{g}{n} \longrightarrow \dyad*{m}{n} \longrightarrow \dyad*{n}{n},
\]
第二张图中电子状态的演化路径为
\[
    \dyad*{g} \longrightarrow \dyad*{m}{g} \longrightarrow \dyad*{m}{n} \longrightarrow \dyad*{n}{n},
\]
两者不同。因此的确，左右两边的入射光子线如果上下位置不同，则产生不同的图。
实际上，此处的密度矩阵的双边费曼图实际上是Keldysh场论的一个特例（见\cite{Hansen_2012}）。
最终可以证明，在远离共振的情况下两者是一致的。

\subsection{空间相位}

TODO：多个分子之间的间距如果恰到好处地让它们的辐射相位正好差了$\pi$，有可能在远处观察不到辐射

