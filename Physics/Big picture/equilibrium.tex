\documentclass[hyperref, UTF8, a4paper]{ctexart}

\usepackage{geometry}
\usepackage{titling}
\usepackage{titlesec}
\usepackage{paralist}
\usepackage{footnote}
\usepackage{enumerate}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{cite}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{physics}
\usepackage{ulem}
\usepackage{tikz}
\usepackage[colorlinks, linkcolor=black, anchorcolor=black, citecolor=black]{hyperref}
\usepackage{prettyref}

\geometry{left=3.18cm,right=3.18cm,top=2.54cm,bottom=2.54cm}
\titlespacing{\paragraph}{0pt}{1pt}{10pt}[20pt]
\setlength{\droptitle}{-5em}
\preauthor{\vspace{-10pt}\begin{center}}
\postauthor{\par\end{center}}

\DeclareMathOperator{\timeorder}{T}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\res}{Res}
\DeclareMathOperator{\primevalue}{P}
\newcommand*{\ii}{\mathrm{i}}
\newcommand*{\ee}{\mathrm{e}}
\newcommand*{\const}{\mathrm{const}}
\newcommand*{\comment}{\paragraph{注记}}
\newcommand*{\fd}[1]{\mathcal{D}{#1}}
\newcommand*{\cexpval}[1]{\langle \langle #1 \rangle \rangle}

\newrefformat{sec}{第\ref{#1}节}
\newrefformat{note}{注\ref{#1}}
\renewcommand{\autoref}{\prettyref}

\newenvironment{bigcase}{\left\{\quad\begin{aligned}}{\end{aligned}\right.}

\title{统计物理}
\author{吴晋渊}

\begin{document}

\maketitle

以下涉及场论的地方，如无特殊说明均以$D$为空间维数。
% TODO:怎样预测一个过程是不是可逆的？例如，压强一样的同种气体混合应该是可逆的，压强不一样就会产生输运，这是怎么判断出来的呢

\section{关于混合态的量子理论}

我们将讨论量子系统的统计力学。本文中我们将采用标准的关于“测量”的理论而不分析其背后的原理。
使用$\{\ket{n}\}$表示系统态空间的一组完备正交基。
有物理意义的哈密顿量都有基态，因此我们可以通过移动能量零点的方法，让哈密顿量的各个本征值都大于零。

使用$\expval*{\hat{A}}$或者$\bar{A}$来表示可观察量$\hat{A}$的期望值。
使用$T$表示编时算符，$\Theta(t)$表示阶跃函数。

\subsection{混合态和密度算符}

\subsubsection{引入密度算符}\label{sec:introduction-of-density-operator}

很多量子系统——即使简单如一个单粒子——的态空间都可以分解成一些态空间的直积。
一些时候我们只是关心整个系统的一部分。因此，接下来称我们关心的这部分为\textbf{系统}，称我们不关心的部分为\textbf{环境}。
我们设环境完全被算符$\hat{B}$描述而$\hat{A}$是关于系统的一个算符，则系统-环境对的态可以写成这样：
\begin{equation}
    \ket{\text{sys-env}} = \sum_i c_i \ket{\psi_i} \ket{B_i}.
    \label{eq:sys-env-state}
\end{equation}
也就是说我们把系统-环境对的态中含有的所有项都整理成以上形式。
我们还假定系统的演化独立于环境，
这或者是因为环境对系统的作用并不强以至于可以忽略，或者是因为环境对系统的作用如此之强以至于其结果可以很容易地知道而不需要考虑环境的内部状态（例如，考虑原子核对电子的作用）。
然而，虽然系统和环境之间没有耦合，但在制备系统的时候\eqref{eq:sys-env-state}中的$\ket{\psi_i}$和$\ket{B_i}$之间有某种关系，
例如，如果通过裂变的方式制备具有某种自旋的粒子束，那么我们需要的粒子和我们丢弃的粒子放在一起的态就是%
\footnote{可以看到，产生纠缠态还是需要系统和环境发生相互作用。如果系统和环境在$t=-\infty$时就没有发生相互作用，并且它们的动力学彼此不相关，那么它们的态就永远不会有纠缠。但纠缠态产生之后，就算系统和环境不再发生相互作用，纠缠还是会一直存在。\label{note:entangled-states}}
\[
    \ket{\text{all}} = \frac{1}{\sqrt{2}} \ket{\uparrow} \ket{\uparrow} + \frac{1}{\sqrt{2}} \ket{\downarrow} \ket{\downarrow},
\]
两个粒子一旦被制备就不再有相互作用，但是显然不可能使用$\ket{\uparrow}$和$\ket{\downarrow}$的叠加写出其中任何一个粒子的态——不能够写出
\[
    \ket{\text{all}} = \left( a_1 \ket{\uparrow} + b_1 \ket{\downarrow} \right) \otimes \left( a_2 \ket{\uparrow} + b_2 \ket{\downarrow} \right)
\]
这样的表达式。
把第一个粒子看成系统而第二个粒子看成环境的一部分我们就得到了\eqref{eq:sys-env-state}形式的态。这种“总系统的态不能够写成各个部分的态的直积”情况称为\textbf{量子纠缠}。
这意味着，系统的观察结果不可能完全由诸$\ket{\psi_i}$确定，而必须考虑环境；但是通常环境是什么样的我们并不知道。
因此不能够简单地通过“求解系统-环境对的运动方程”来计算我们关心的结果，而必须通过某种手段把环境“积掉”。
具体怎么做，接下来很快会看到。

可以制备大量的这种系统-环境对，这些系统-环境对之间并没有相互作用，它们的集合称为\textbf{系综}。
系综很自然地导致一个使用古典概型的\textbf{概率}。
通过系综计算出来的概率和真的动手做变量控制得足够好的实验时的概率是一致的：动手做实验时实验结果依赖于某些环境参数$\theta$，
只要环境是足够杂乱，以至于$\theta$的分布完全随机（环境通常足够大，因此总是这样），
那么重复做实验就是采集了大量$\theta$样本，每个$\theta$确定了一个系统，从而建立了一个系综。%
\footnote{当然，系综中系统-环境对的数目总是很大的，而真实的实验做不了那么多次。这里只是原理性地说明系综这一概念的合理性。}%
另一种会自然地要求我们讨论系综的情景是，系统的初态依赖某些参数，而我们并不知道这些参数是什么，于是不得不列出所有可能的参数然后平行地让这些可能的态往前演化，看看具有不同性质的态各占多少。
很容易看出这和“多次做实验”根本就是一回事。%
\footnote{可能出现的另一个问题是，为什么我们能够合理地将各种可能的系统放在一起构造一个系综；最直截了当的做法是假定有一个宇宙波函数，测量、实验等过程使得其结果和宇宙中其它部分的状态纠缠在一起，从而宇宙波函数可以写成一系列直积态的叠加，这些直积态单独拿出来就组成一个系综，这些直积态的权重的模平方构成系综中各个系统的权重。

“这些直积态单独拿出来组成一个系综”是朗道的量子力学书上的讲法，但我们可能仍然要问，诸如“系统-环境对”这样的说法是依赖于基底的，而量子力学是基底无关的，为什么偏偏要将宇宙波函数在系统-环境对基底下展开，然后将其系数的模平方当作经典概率。
这里的奥妙在于我们的宇宙的物理规律是相当局域的，特别的，观察者本人、他在操作的实验仪器、被观察的对象都是非常局域的：系统-环境对这组基底被偏好的原因也就在这里。
实际上我们可以写下一个量子主方程来描述观察者的心理状态以及被观察的对象的状态，由于无处不在的退相干，这个量子主方程和一个经典概率演化方程几乎毫无区别，从而无论用多次实验测得的频率或是观察者内心的不确定性定义概率，都会和密度算符这一套定义出的概率相一致。
}

现在我们从这个系综当中随机取出一个系统-环境对，然后对它做一次测量，会得到什么样的结果？
算符$\hat{A}$在系统的态空间和环境的态空间的直积上显然是简并的（无论$\hat{A}$在系统的态空间上是不是简并的）。
测量态\eqref{eq:sys-env-state}的$\hat{A}$值。设$\hat{A}$的本征值$A_i$对应着系统的本征态$\ket{A_i^{(j)}}$，$j=1, 2, \ldots$。
测量结果为$A_i$的概率是
\[
    \begin{aligned}
        P(A_i) &= \sum_{j,k} \abs{\bra{A_i^{(j)}} \bra{B_k} \ket{\text{sys-env}}}^2 \\
        &= \sum_{j, k} \abs{ \bra{A_i^{(j)}} \sum_l c_l \ket{\psi_l} \braket{B_k}{B_l} }^2 \\
        &= \sum_{j, k} \abs{c_k}^2 \abs{\braket{A_i^{(j)}}{{\psi_k}}}^2 \\
        &= \sum_j \ev{ \sum_k \abs{c_k}^2 \dyad{\psi_k} }{A_i^{(j)}}
    \end{aligned}
\]
从系综中随机抽取一个系统-环境对，用$\hat{A}$做测量，得到结果为$A_i$的概率是：
\[
    \begin{aligned}
        P(A_i) &= \sum_j P(\ket{\text{sys-env}_j}) P(\text{$\ket{\text{sys-env}_j}$ gives $A_i$}) \\
        &= \sum_l P(\ket{\text{sys-env}_l}) \sum_j \ev{ \sum_k \abs{c_{l, k}}^2 \dyad{\psi_{l, k}} }{A_i^{(j)}} \\
        &= \sum_j \ev{ \sum_{l, k} P(\ket{\text{sys-env}_l}) \abs{c_{l, k}}^2 \dyad{\psi_{l, k}} }{A_i^{(j)}},
    \end{aligned}
\]
其中下标$l, k$指的是系综中第$l$个系统的第$k$个$\ket{\psi}$（见\eqref{eq:sys-env-state}）。
我们定义\textbf{密度算符}
\begin{equation}
    \hat{\rho} = \sum_{l, k} P(\ket{\text{sys-env}_l}) \abs{c_{l, k}}^2 \dyad{\psi_{l, k}},
    \label{eq:density-operator-def}
\end{equation}
就有
\begin{equation}
    P(A_i) = \sum_j \ev{\hat{\rho}}{A_i^{(j)}}.
    \label{eq:prop-of-quantity}
\end{equation}
相应的，期望值为
\[
    \expval*{\hat{A}} = \sum_{i, j} A_i \ev{\hat{\rho}}{A_i^{(j)}}.
\]
注意到
\[
    \sum_{i, j} \ev{\hat{\rho} A_i }{A_i^{(j)}} = \sum_{i, j} \ev{\hat{\rho} \hat{A} }{A_i^{(j)}} = \trace \left(\hat{\rho} \hat{A}\right),
\]
我们得到
\begin{equation}
    \expval*{\hat{A}} = \sum_{i, j} A_i \ev{\hat{\rho}}{A_i^{(j)}} = \trace \left(\hat{\rho} \hat{A}\right).
    \label{eq:expectation}
\end{equation}

在\eqref{eq:density-operator-def}中$\abs{c_{l, k}}^2$相当于是$P(\ket{\psi_{l, k}}|\ket{\text{sys-env}_l})$（归一化性质是显然的），
于是\eqref{eq:density-operator-def}写成%
\footnote{由于量子态的平方才是概率，如果我们认为量子态本身是某种概率性理论中的对象，我们就必须要区分经典概率和量子概率：前者是从一个系综中取出一个系统，这个系统具有某些性质的可能性，后者则是这个系统的可观察量取不同值的概率。
但正如此处我们看到的那样，实际上两者可以以统一的方式处理，我们完全可以良定义一个$P(\ket{\psi_i})$。
如果回顾测量的意义，我们会发现所谓测量无非就是系统与环境相互作用，导致系统和环境出现纠缠，而具体得到什么结果和我们未知——因此只能够使用一个概率分布来模拟的——环境变量有关，可见量子态本身和概率毫无关系，量子力学中的概率的概念完全是因为做测量时对环境的无知导致的，而使用概率分布来穷举所有可能的环境变量的方式和我们穷举所有可能出现的系统状态构造一个系综（从而引入所谓“经典概率”）的方式完全一样。
因此，根本就没有所谓经典概率和量子概率的区分：量子力学中的概率和构造统计系综时引入的概率具有同样的起源。
只有一种概率，就是系统演化过程中由于与环境的相互作用导致系统状态不能确定，因此必须使用混合态描述系统而导致的概率。
这同一种概率起源如果出现在观测时，就导致观测结果的涨落，即所谓“量子测量的不确定性”，如果出现在观测前，就导致系统从纯态变得不纯，即所谓“退相干”。
退相干也可以理解成环境在不停地测量系统。
}%
\begin{equation}
    \hat{\rho} = \sum_{i} P(\ket{\psi_i}) \dyad{\psi_i},
    \label{eq:density-operator}
\end{equation}
其中$P(\ket{\psi_i})$指的是从系综中随机取出一个态，经过测量发现它处于$\ket{\psi_i}$的概率。%
\footnote{更准确地说，这是“经过测量之后发现它在各个$\ket{\psi}$态之中处于$\ket{\psi_i}$”的概率。
测量永远是针对一个算符的而不是针对一个单独的态的，对系统做一次测量，观察它会落到诸$\ket{\psi}$中的哪一个的方法是，构造算符
\[
    \hat{A} = \sum_i A_i \dyad{\psi_i},
\]
其中不同的$i$对应不同的$A_i$，然后使用这个算符对系统做测量，若测量结果是某个$A_i$，那么系统就落在了态$\ket{\psi_i}$上。单独把态$\ket{\psi_i}$拿出来讨论“它出现的概率”是和量子力学的框架相矛盾的。不过，为了说明方便，在各个$\ket{\psi}$态给定的情况下，我们常用“系统取$\ket{\psi_i}$的概率这样的说法”。}%
需要注意的是，即使诸$\ket{\psi_i}$相互并不正交，\eqref{eq:density-operator}也是成立的。
\eqref{eq:density-operator}中的每一项的系数都是正的，因此$\hat{\rho}$是正定的。
而又由于\eqref{eq:density-operator}中每一项的系数都小于等于$1$，数学上可以证明，$\hat{\rho}$的本征值全部在$0$和$1$之间，可以取到$1$。
当然，如果\eqref{eq:density-operator}中的某一个$P(\ket{\psi_i})$真的取到了$1$，那么按照概率的性质，此时其余的$P(\ket{\psi_j})$都是零，从而
\[
    \hat{\rho} = \dyad{\psi_i},
\]
因此系统处于纯态。类似地也可以说明，$\hat{\rho}$的本征值取到$1$，当且仅当系统处于纯态；此时$\hat{\rho}$的本征态就是系统的态矢量。

如果可能的$\psi_i$只有一个，那么称此时的系综是\textbf{纯}的，或者说系统处于纯态，因为此时根本不需要引入系综的概念：直接对这个仅有的$\ket{\psi}$解运动方程就可以得到想要的一切信息。
否则，称此时的系综为\textbf{混合}的，或者说系统处于混合态。
需要注意的是即使是纯态也会引入随机性，因为测量所用的算符的本征态未必和$\ket{\psi_i}$一致。
但混合态引入了另一种随机性：我们甚至不知道系统（从系综中随便选取的某一个）具体处于什么态！
这种随机性是由于我们缺乏某些信息而产生的：我们或者不知道和我们关心的系统纠缠的态是什么样的，或者不知道我们关心的系统到底在什么态上面。

通常，对一个系综我们只关心特定的物理量取某些值的概率，以及物理量的期望，后者又可以从前者推出来。
从\eqref{eq:prop-of-quantity}和\eqref{eq:expectation}可以看出，密度算符给出了所有这些信息。
因此我们认为密度算符完整描述了系综。
除了这两项信息以外的信息则不能从密度算符中提取。例如，请注意从\eqref{eq:density-operator}中不能读取出$\ket{\psi_i}$分别都是什么，因为可以找到多组$\ket{\psi_i}$，使用不同的$P$，而得到同样的$\hat{\rho}$，也就是说不同构造的系综可以有同样的密度算符。
通常称诸$\ket{\psi_i}$，也就是有非零系数的态，为\textbf{参与态}。显然密度算符提供不了参与态具体是什么的信息，不过一般我们也不需要这些信息。
实际上，\eqref{eq:density-operator}本身就体现了这一点：我们并不关心混合态是因为系统和环境的纠缠还是因为别的什么引起的，因此使用统一的\eqref{eq:density-operator}处理两种情况。

一般来说，对实际的、通常规模很大的系统，我们不可能知道它的所有信息。或者我们不知道它的某些参数，或者我们不知道它是不是和环境纠缠在一起。无论哪种情况，描述系统都需要使用混合态。
因此接下来在不至于引起混淆时我们不严格区分“系统”和“系综”，因为我们根本就不知道“实际上的系统”是什么样子的，而只能讨论系综。于是称纯的系综处于\textbf{纯态}，混合系综处于\textbf{混合态}。
相应的，凡是不能够从密度算符中读取得到的信息，我们一概不讨论，因为这些信息不能从系综中读出来。

\subsubsection{时间演化}

下面我们分析密度算符的时间演化。我们将只讨论不显含时间的物理量。为了一般性，首先在相互作用绘景下分析问题。此时
\[
    \ii \hbar \dv{t} \ket{\psi^I} = \hat{H}_i^I \ket{\psi^I},
\]
由于系统和环境的演化可认为是彼此独立的，于是系统-环境的时间演化算符是系统的时间演化算符和环境的时间演化算符的直积，两者均为幺正算符，从而随着时间演化，$c_i$不会变化。
另一方面，如果两个态在某一个时刻不同，那么它们不会在某一个连续的时间区间内处处相同；
既然$P(\ket{\text{sys-env}_l})$是通过系综中相同的态的个数除以总个数算出来的，显然我们有
\[
    P_{t_1} (\ket{\text{sys-env}_l (t_1)}) = P_{t_2} (\ket{\text{sys-env}_l (t_2)}).
\]
于是以下我们略去$P$的时间下标以及其括号内的时间标记，因为这个参数对$P$而言没有意义。
因此$P(\ket{\psi_i})$恒定不变。
这样可以推导出
\begin{equation}
    \dv{\hat{\rho}^I}{t} = \frac{1}{\ii \hbar} \comm*{\hat{H}_i^I}{\hat{\rho}^I}.
\end{equation}
请注意这个方程的对易子和算符运动方程的对易子是反的。
由此，我们顺带得出了薛定谔绘景中的密度算符演化方程
\begin{equation}
    \dv{\hat{\rho}^S}{t} = \frac{1}{\ii \hbar} \comm*{\hat{H}^S}{\hat{\rho}^S},
    \label{eq:quantum-liouville}
\end{equation}
以及海森堡绘景中的密度算符演化方程
\begin{equation}
    \hat{\rho}^H = \const.
\end{equation}
请注意这些方程在$\hbar \to 0$时退化为经典统计力学中的刘维尔方程，因此称其为\textbf{量子刘维尔方程}。

为方便起见，我们将薛定谔绘景和相互作用绘景之间的关系罗列如下：
做哈密顿量的分解
\begin{equation}
    \hat{H}^S = \hat{H}_0 + \hat{H}_i^S,
\end{equation}
则
\begin{equation}
    \ket{\psi^I(t)} = \hat{U}_0^\dagger(t,t_0) \ket{\psi^S(t)},
\end{equation}
从而密度算符的切换关系为
\begin{equation}
    \hat{\rho}^I = \hat{U}_0^\dagger(t,t_0) \hat{\rho}^S \hat{U}_0(t,t_0),
\end{equation}
可观察量的切换关系为
\begin{equation}
    \hat{A}^I = \hat{U}_0^\dagger(t,t_0) \hat{A}^S \hat{U}_0(t,t_0),
\end{equation}
其中
\begin{equation}
    \hat{U}_0 = T \exp \left( - \frac{\ii}{\hbar} \int_{t_0}^t \dd{t} \hat{H}_0 \right),
\end{equation}
当$\hat{H}_0$不含时时就是简单的
\begin{equation}
    \hat{U}_0 = \ee^{-\frac{\ii}{\hbar} (t-t_0) \hat{H}_0}.
\end{equation}

系综达到平衡，也就是说，各个物理量出现的概率都不再发生任何变化的时候，意味着密度算符不变，这又等价于
\begin{equation}
    [\hat{\rho}, \hat{H}] = 0.
    \label{eq:equilibrium-case}
\end{equation}
这个方程的成立不依赖于绘景。如果$\hat{H}$不显含时间（系统能够达到平衡通常意味着这一点），那么平衡时的$\hat{\rho}$就和绘景选取无关。

迹运算和很多其它的运算不依赖于具体的基矢量，因此它们在绘景变换下不变。

\subsubsection{密度算符的性质}

现在来分析密度算符的性质。为方便起见以下记
\[
    P(\ket{\psi_i}) = p_i.
\]
首先，
\[
    \trace \hat{\rho} = \sum_n \mel{n}{\hat{\rho}}{n} = \sum_n \mel{n}{\sum_i p_i \dyad{\psi_i}}{n} = \sum_{n, i} p_i \braket{n}{\psi_i} \braket{\psi_i}{n},
\]
于是
\begin{equation}
    \trace \hat{\rho} = 1.
    \label{eq:trace-of-density-operator}
\end{equation}
容易看出导出\eqref{eq:trace-of-density-operator}的论证也可以反过来用。在已知\eqref{eq:trace-of-density-operator}的情况下，可以推知，若$\hat{\rho}$可以被展开为一系列归一化态的叠加
\[
    \hat{\rho} = \sum_i \rho_i \dyad{\psi_i},
\]
则
\[
    \sum_i \rho_i = 1,
\]
无论诸$\ket{\psi_i}$是否正交。通常称$\rho_i$为\textbf{分布函数}。

\eqref{eq:trace-of-density-operator}无论是对纯态还是混合态都是成立的。
然而，$\hat{\rho}^2$的迹却并非如此。对纯态而言
\[
    \hat{\rho}^2 = \dyad{\psi} \dyad{\psi} = \dyad{\psi} = \hat{\rho},
\]
而对混合态，
\[
    \hat{\rho}^2 = \sum_{i, j} p_i p_j \braket{\psi_i}{\psi_j} \dyad{\psi_i}{\psi_j},
\]
从而
\[
    \begin{aligned}
        \trace \hat{\rho}^2 &= \sum_n \mel{n}{\sum_{i, j} p_i p_j \braket{\psi_i}{\psi_j} \dyad{\psi_i}{\psi_j}}{n} \\
        &= \sum_{n, i, j} p_i p_j \braket{\psi_i}{\psi_j} \braket{\psi_j}{n} \braket{n}{\psi_i} \\
        &= \sum_{i, j} p_i p_j \braket{\psi_i}{\psi_j} \braket{\psi_j}{\psi_i} \\
        &=  \sum_{i, j} p_i p_j \abs{\braket{\psi_i}{\psi_j}}^2 \\
        &< \sum_{i, j} p_i p_j = 1 = \trace \hat{\rho}.
    \end{aligned}
\]
上式中我们取小于号而不是小于等于号是因为混合态中诸态不可能全部相互平行。
总之，$\hat{\rho}$幂等的充要条件是它描述了一个纯态，且
\begin{equation}
    \trace \hat{\rho}^2 \begin{cases}
        = 1, \quad & \text{for pure states}, \\
        < 1, \quad & \text{for mixed states}.
    \end{cases}
    \label{eq:inequality-of-mixed-state}
\end{equation}
也就是说密度算符能够提供“纯态还是混合态”的信息。于是可以定义一个密度算符的\textbf{纯度}为
\begin{equation}
    \varsigma = \trace \hat{\rho}^2,
\end{equation}
它越接近$1$说明系统越接近纯态。

此外很容易看出密度算符是厄米的。如果各个参与态相互正交，那么密度算符的本征值就是对应的本征态出现的概率。
当然，各个参与态完全可以不正交，但因为我们从密度算符中并不能判断出哪些是参与态，因此总是可以将密度算符使用它自身的本征态展开，不失一般性地假定各个参与态就是密度算符的本征态。
在各个参与态正交时，可以具体地写出任何一个物理量的期望的公式。我们有
\[
    \begin{aligned}
        \hat{\rho} &= \sum_n P(\ket{n}) \dyad{n}, \\
        \expval*{\hat{A}} &= \trace \hat{\rho} \hat{A} \\
        &= \sum_m \mel{m}{\left(\sum_n P(\ket{n}) \dyad{n} \hat{A} \right)}{m} \\
        &= \sum_{m, n} P(\ket{n}) \braket{m}{n} \mel{n}{\hat{A}}{m}, 
    \end{aligned}
\]
从而
\begin{equation}
    \expval*{\hat{A}} = \sum_n P(\ket{n}) \mel{n}{\hat{A}}{n}.
\end{equation}

如果密度算符能够被对角化，那么实际上可以使用经典概率的观点看待体系：体系出现某个态的概率为多少，出现另一个态的概率为多少。
密度算符的非对角元则对应着量子纠缠等非经典的结果。
% TODO：详细说明

\subsubsection{复合系统}\label{sec:combining-systems}

本节将讨论，如果我们已有一个总系统的密度算符，而实际上我们只想讨论其中的一部分的行为，那么要如何写出这个部分的密度算符。
将系统分成两部分，其中一部分称为系统1，另一部分称为系统2。
设$\hat{A}$是只和系统1有关的一个算符。记描述系统2的一组基态为$\ket{\chi_i}$；$\ket{\phi_i}$是系统1的一组态，但它们未必满足正交归一化条件。
则系统的任何一个态均形如
\[
    \ket{\psi} = \sum_{i, j} c_{ij} \ket{\phi_i} \ket{\chi_j},
\]
也就是说我们使用系统2的基矢量展开整个系统的态。
从而整个系统的密度算符形如
\[
    \hat{\rho} = \sum_k p_k \sum_{i,j} \abs{c_{k,ij}}^2 \ket{\phi_i} \ket{\chi_j} \bra{\phi_i} \bra{\chi_j}
\]
请注意所谓的“两个系统”并不一定意味着这是空间上隔离的两个系统——我们只不过是把两个态空间直积而成的态空间中关于两个态空间的信息分别称为系统1和系统2。

现在使用$\hat{A}$对系统1做一次测量，得到$A_i$的概率为
\[
    \begin{aligned}
        P(A_i) &= \sum_{j, k} \bra*{A^{(j)}_i} \bra{\chi_k} \hat{\rho} \ket*{A^{(j)}_i} \ket{\chi_k} \\
        &= \sum_{j, k, l, m, n} p_l \abs{c_{l, mn}}^2 \braket*{A_i^{(j)}}{\phi_m} \braket*{\phi_m}{A_i^{(j)}} \braket{\chi_k}{\chi_n} \braket{\chi_n}{\chi_k} \\
        &= \sum_j \mel*{A_i^{(j)}}{\sum_m \left(\sum_{l, n} p_l \abs{c_{l, mn}}^2 \right) \dyad{\phi_m}}{A_i^{(j)}} 
    \end{aligned}.
\]
记
\[
    \hat{\rho}_1 = \sum_m \left(\sum_{l, n} p_l \abs{c_{l, mn}}^2 \right) \dyad{\phi_m}.
\]
每一项的系数看起来有些复杂，不过请注意
\[
    \abs{c_{l, mn}}^2 = P(\ket{\phi_m} \ket{\chi_n} | \ket{\psi_l}),
\]
有
\[
    \sum_{l, n} p_l \abs{c_{l, mn}}^2 = \sum_{l, n} P(\ket{\psi_l}) P(\ket{\phi_m} \ket{\chi_n} | \ket{\psi_l}) = P(\ket{\phi_m}),
\]
也就是说这个系数就是“从系综中随便取一个态做测量结果发现系统1正好就在$\ket{\phi_m}$上”的概率。
从而我们导出
\[
    \hat{\rho}_1 = \sum_m P(\ket{\phi_m}) \dyad{\phi_m}.
\]
这个表达式的形式和\eqref{eq:density-operator}一模一样。
而系统1经过测量得到$A_i$的概率则是
\[
    P(A_i) = \sum_j \mel{A^{(j)}_i}{\hat{\rho}_1}{A^{(j)}_i},
\]
相应的$\hat{A}$的期望值就是
\[
    \begin{aligned}
        \sum_i A_i P(A_i) &= \sum_{i, j} \mel{A^{(j)}_i}{\hat{\rho}_1 A_i}{A^{(j)}_i} \\
        &= \sum_{i, j} \mel{A^{(j)}_i}{\hat{\rho}_1 \hat{A}}{A^{(j)}_i} = \trace_1 \left(\hat{\rho}\hat{A}\right),
    \end{aligned}
\]
其中$\trace$的下标1表示我们是在系统1的希尔伯特空间上做迹运算。
所有这些结果都和\eqref{eq:prop-of-quantity}和\eqref{eq:expectation}完全一致。
因此我们称$\hat{\rho}_1$为\textbf{约化密度算符}。
容易验证，它可以由
\begin{equation}
    \hat{\rho}_1 = \trace_2 \hat{\rho}
\end{equation}
得到。我们说这是把系统2从密度算符中\textbf{迹掉了}，因为上式仅仅对系统2求迹，而保留了关于系统1的信息。

很容易就可以看出，以上推导和\autoref{sec:introduction-of-density-operator}中从纠缠态导出（通常描述了混合态的）密度算符的方式完全一样。
这是当然的，因为系统1可以和系统2有纠缠，因此人为把系统1孤立出来必然导致\autoref{sec:introduction-of-density-operator}节中的操作。

我们将看到，将系统2迹掉会让密度算符变得更加远离纯态。设我们对系统1和系统2分别有正交归一化基$\{\ket{m^{(1)}}\}$和$\{\ket{n^{(2)}}\}$，将$\hat{\rho}$展开就得到
\[
    \hat{\rho} = \sum_{m,n} \rho_{mn} \ket{m^{(1)}} \ket{n^{(2)}},
\]
其中的$\rho_{mn}$都是实数，因为密度算符是厄米的。从而
\[
    \hat{\rho}^2 = \sum_{m,n} \rho_{mn} \ket{m^{(1)}} \ket{n^{(2)}},
\]
\[
    \trace \hat{\rho}^2 = \sum_{m,n} \rho_{mn}^2.
\]
另一方面我们有
\[
    \hat{\rho}_1 = \trace_2 \hat{\rho} = \sum_m \left(\sum_n \rho_{mn}\right) \ket{m^{(1)}},
\]
同样可以计算出
\[
    \trace \hat{\rho}_1^2 = \sum_m \left(\sum_n \rho_{mn}\right)^2,
\]
使用不等式
\[
    \left(\sum_n \rho_{mn}\right)^2 \leq \sum_n \rho_{mn}^2,
\]
我们发现$\hat{\rho}_1$的纯度小于等于$\hat{\rho}$的纯度。
不等式取到等号的条件是可以把$\rho_{mn}$分解成一个仅仅关于$m$的数和一个仅仅关于$n$的实数的乘积，也即，
\[
    \rho_{mn} = \rho^{(1)}_m \rho^{(2)}_n,
\]
从而容易看出
\[
    \hat{\rho} = \hat{\rho}_1 \otimes \hat{\rho}_2.
\]
这意味着什么，我们马上可以看到。

设我们有两个相互独立的系统，称为系统1和系统2。
所谓相互独立指的是对其中一个系统做某些操作（或者说，让其中一个系统和另一些东西产生相互作用）不影响另一个系统的状态。例如，对其中一个系统做测量不会影响另一个系统的状态。这等价于说两个系统没有量子纠缠。
设两个系统的密度算符分别为
\[
    \hat{\rho}_1 = \sum_i P(\ket*{\psi_i^{(1)}}) \dyad*{\psi_i^{(1)}}, \quad \hat{\rho}_2 = \sum_i P(\ket*{\psi_i^{(2)}}) \dyad*{\psi_i^{(2)}}.
\]
现在把系统1和系统2看成同一个系统。实际上，我们是把描述系统1的系综和描述系统2的系综拼成了一个大系综。这个大系综中的态可以写成$\ket*{\psi_i^{(1)}} \otimes \ket*{\psi_j^{(2)}}$的形式。
现在使用这一组态对总系统做一次测量，由于系统1和系统2无关，有
\[
    P(\ket*{\psi_i^{(1)}} \otimes \ket*{\psi_j^{(2)}}) = P(\ket*{\psi_i^{(1)}}) P(\ket*{\psi_j^{(2)}}),
\]
从而，总系统的密度算符就是
\begin{equation}
    \hat{\rho} = \hat{\rho}_1 \otimes \hat{\rho}_2.
    \label{eq:independent-systems-combinition}
\end{equation}
反之也容易验证，如果\eqref{eq:independent-systems-combinition}成立，那么设$\hat{H}_1$仅仅作用在系统1上，则
\[
    \begin{aligned}
        \dv{t} \hat{\rho}_1 \otimes \hat{\rho}_2 &= \frac{1}{\ii \hbar} \comm*{\hat{H}_1}{\hat{\rho}_1 \otimes \hat{\rho}_2} \\
        &= \frac{1}{\ii \hbar} \comm*{\hat{H}_1}{\hat{\rho}_1} \otimes \hat{\rho}_2,
    \end{aligned}
\]
因此对系统1做的操作不影响系统2，反之亦然。
因此，两个系统独立，当且仅当\eqref{eq:independent-systems-combinition}成立。
这又等价于，
\begin{equation}
    (\trace_2 \hat{\rho}) \otimes (\trace_1 \hat{\rho}) = \hat{\rho}.
\end{equation}

总之，将总系统的一部分单独抽取出来分析，抽取出来的这部分的密度算符不会比总系统的密度算符更纯；它们的纯度一致，当且仅当被抽取出来的这部分系统和剩余部分彼此独立。

以上讨论导致一个显然的推论。如果一个纯态系统的某些自由度与其它自由度从来不发生相互作用（从而也不可能让这些自由度与其它自由度纠缠起来——见\autoref{note:entangled-states}），那么将这些自由度从密度算符中迹掉之后得到的密度算符还是纯态。
从希尔伯特空间的角度也可以得到这个结论，因为如果一个纯态系统的某些自由度与其它自由度从来不发生相互作用，那么系统实际上采取的态矢量一定可以写成前面这些自由度确定的一个态矢量和其余自由度确定的一个态矢量的直积。因此两部分自由度可以被分开处理。

\subsubsection{未归一化的密度算符}\label{sec:relative-density-operator}

以上讨论的密度算符在定义时保证了其系数真的就是对应的态出现的概率。有时我们能够比较容易地计算出某个态出现的概率正比于某个值，即只知道
\begin{equation}
    P(\ket{\psi_i}) \propto f(\psi_i),
\end{equation}
而不容易将它归一化。此时可以定义未归一化的密度算符或者说相对密度算符为
\begin{equation}
    \hat{\rho} = \sum_i f(\psi_i) \dyad{\psi_i},
\end{equation}
定义\textbf{配分函数}
\begin{equation}
    Z = \sum_i f(\psi_i) = \trace \hat{\rho},
\end{equation}
则$\hat{\rho} / Z$就是归一化的密度算符。使用这个关系，我们得到期望值公式为
\begin{equation}
    \expval*{\hat{A}} = \frac{1}{Z} \trace \left(\hat{\rho} \hat{A}\right) = \frac{\trace \left(\hat{\rho} \hat{A}\right)}{\trace \hat{\rho}},
\end{equation}
在参与态为正交归一化基时这就是
\begin{equation}
    \expval*{\hat{A}} = \frac{1}{Z} \sum_n P(\ket{n}) \mel{n}{\hat{A}}{n}.
\end{equation}
纯度公式为
\begin{equation}
    \varsigma = \frac{\trace \hat{\rho}^2}{\trace \hat{\rho}},
\end{equation}
越接近1说明态越纯。

\subsection{带有环境的过程：熵、信息和主方程}

\subsubsection{冯诺依曼熵}

宏观上能够观察的量可以分成两类。一类在微观层面具有良定义，其宏观形式就是它的统计平均。这一类量的例子有能量等，它们的计算已经在\eqref{eq:expectation}中给出了。
还有一类量在微观层面并无明确定义，它们是大量粒子的集体行为涌现出现的结果。这一类物理量也可以通过密度算符得到，但具体方法并没有一定之规。
本节将讨论一个典型的这种涌现出来的物理量。

设$\hat{\rho}$是归一化的密度算符。首先定义%
\footnote{关于下式中的$\ln \hat{\rho}$：设算符$\hat{A}$可被谱展开为
\[
    \hat{A} = \sum_i A_i \dyad{i},
\]
则可以验证，一个解析函数作用在$\hat{A}$上的结果为
\[
    f(\hat{A}) = \sum_i f(A_i) \dyad{i}.
\]
因此即使函数$f$的性质不那么好，我们也规定上式成立。显然如果$\hat{A}$是厄米的，且$f$是实函数，那么$f(\hat{A})$也是厄米的。
}%
\begin{equation}
    S = - \trace (\hat{\rho} \ln \hat{\rho}) = - \expval*{\ln \hat{\rho}}.
    \label{eq:von-neumann-entropy}
\end{equation}
为\textbf{熵}，或称为\textbf{冯诺依曼熵}来和我们将要看到的另一种熵区分。设密度算符被谱展开为
\[
    \hat{\rho} = \sum_n \rho_n \dyad{n},
\]
我们只取其中非零的项。那么熵就可以写成分布函数的函数：
\begin{equation}
    S = - \sum_n \rho_n \ln \rho_n.
\end{equation}
这意味着如果把诸$\ket{n}$一起相同的幺正变换，$S$不变。这就是说，$S$在密度算符做幺正变换时不变，也即
\begin{equation}
    S(\hat{\rho}) = S(\hat{U} \hat{\rho} \hat{U}^{-1}).
\end{equation}
如前所述，$0 < \rho_n \leq 1$，从而$S \geq 0$。

如果系统处于纯态，那么总是有一个态$\ket{\psi}$使密度算符可以写成
\[
    \hat{\rho} = \dyad{\psi},
\]
此时$\rho_n$只有一个，且它的值为$1$，从而$S=0$。反之，如果$S=0$，那么所有的$\rho_n$都是1，因此只有一个$\rho_n$且它是1，因此系统处于纯态。
这意味着熵为$0$是系统处于纯态的充要条件。因此熵可以看成系统偏离纯态的量度，或者说看成“我们对系统有多无知”的量度。

我们已经发现了熵取最小值意味着什么。顺带而来的问题：熵取极大值又意味着什么？我们会看到，这意味着系统达到了平衡态。

设有两个彼此独立的系统，它们各自的密度算符被谱展开为
\[
    \hat{\rho}_1 = \sum_i \rho_i^{(1)} \dyad*{i^{(1)}}, \quad \hat{\rho}_2 = \sum_j \rho_j^{(2)} \dyad*{j^{(2)}},
\]
从而
\[
    \hat{\rho} = \sum_{i,j} \rho_i^{(1)} \rho_j^{(2)} \dyad*{i^{(1)}, j^{(2)}}.
\]
组成的总系统的熵为
\[
    \begin{aligned}
        S(\hat{\rho}) &= - \sum_{i, j} \rho_i^{(1)} \rho_j^{(2)} \ln (\rho_i^{(1)} \rho_j^{(2)}) \\
        &= - \sum_{i, j} \rho_i^{(1)} \rho_j^{(2)} \ln \rho_i^{(1)} - \sum_{i, j} \rho_i^{(1)} \rho_j^{(2)} \ln \rho_j^{(2)} \\
        &= - \sum_i \rho_i^{(1)} \ln \rho_i^{(1)} - \sum_j \rho_j^{(2)} \ln \rho_j^{(2)} \\
        &= S(\hat{\rho}_1) + S(\hat{\rho}_2).
    \end{aligned}
\]
也就是说，彼此独立的系统组成的总系统的熵就是组成它的各个系统的熵之和。
我们只能够得到这个程度的结论：一个系统的熵未必是它的各个子系统的熵之和。
熵对任何系统的可加性只有在更加特定的情况下才能够成立。

需要注意的是随着各种物理过程的发生，冯诺依曼熵并非在所有情况下都会增长。

\subsubsection{涉及环境的时间演化}

能够通过涉及环境的时间演化实现的从一个密度算符到另一个密度算符的线性变换称为\textbf{量子操作}。
普通的时间演化是一种量子操作，因为显然时间演化算符$\hat{U}$对应以下量子操作：
\[
    \hat{\rho} \longrightarrow \hat{U} \hat{\rho} \hat{U}^\dagger,
\]
即我们没有对环境做任何事情。这又意味着，一个一般的量子操作未必能写成以上形式。

首先考虑一个比较简单的情况。我们假定环境一开始处于纯态$\ket{e_0}$，且系统一开始和环境没有量子纠缠，则
\[
    \hat{\rho} = \trace_\text{env} (\hat{U}(\hat{\rho} \otimes \dyad*{e_0}{e_0}) \hat{U}^\dagger),    
\]
于是计算得到
\begin{equation}
    \hat{\rho}' = \sum_k \hat{E}_k \hat{\rho} \hat{E}_k^\dagger,
\end{equation}
其中
\begin{equation}
    \hat{E}_k = \mel*{e_k}{\hat{U}}{e_0}, \sum_k \hat{E}_k^\dagger \hat{E}_k = I,
\end{equation}
$\ket{e_k}$是环境的一组基底。

实际上，任何一个量子操作都可以写成这样的形式，这个结论称为Kraus定理。

我们知道，标准的量子测量不是幺正过程，但是它确实是一个量子操作；实际上可以看出任何一个量子操作都对应某种测量，这当然是正确的，因为迹掉环境就相当于做了测量。

量子操作是保迹、完备的。

\subsection{退化到经典情况}\label{sec:back-to-classical}

% 一些不成熟的想法：很多时候我们使用纯量子的动力学方程来计算诸如跃迁速率之类的东西，而另一方面又把系统状态或者系统出现在某一状态的概率当成纯粹经典的对象来考虑，或许可以将这种看似矛盾的操作当成是在处理一个开放系统：它时不时会被环境测量，从而很少出现叠加态或者纠缠，因此它的每一个时刻的状态都可以认为是经典的；另一方面，测量的频率没有快到出现量子芝诺效应，因此两次测量之间的系统演化却又满足纯粹的薛定谔方程

在我们讨论的问题的尺度（能量变化、空间大小，等等）远大于$\hbar$时——或者等价地说，$\hbar\to 0$时——量子统计就退化为了经典统计。
此时所有可观察量都近似是对易的，从而系统的态可以使用正则坐标
\[
    (x_1, x_2, \ldots, x_n, p_1, p_2, \ldots, p_n)
\]
表示。

对纯态，在半经典情况下可以证明这样一个表达式：设$x,p$是一对共轭变量，则
\begin{equation}
    \frac{1}{2\pi} \oint p \dd{x} = \hbar \left(n + \frac{1}{2}\right), \quad n = 0, 1, 2, \ldots.
\end{equation}
这里$n$是量子态的标记，不同$n$对应不同量子态。在系统规模很大时$n$也很大，从而
\begin{equation}
    \oint p \dd{x} \sim 2 \pi \hbar n.
    \label{eq:phase-cell}
\end{equation}
由于等式左边是分析力学中的角变量，是相平面上的闭路积分，这个公式意味着在系统规模很大时，可以这样分析其动力学：使用经典哈密顿力学，但是计算类似于\eqref{eq:phase-cell}这样的积分时应该假定相平面被分成了许多大小为$2\pi \hbar$的格子（所谓\textbf{相格}）。
在系统有$s$对坐标-动量%
\footnote{很多时候也说系统有$s$个自由度。自由度这一概念可以有多种意思，它可以表示系统的CSCO的数目，在采取这个定义时$s$对坐标-动量意味着$s$个自由度。见\autoref{note:degree-of-freedom-counting}。}%
时，单个相格大小为$(2\pi \hbar)^s$。
由于一个相格对应一个$n$，在$\Delta x \Delta p$的范围内共有
\begin{equation}
    \Omega = \frac{\Delta x \Delta p}{(2\pi \hbar)^s}
\end{equation}
个彼此独立的量子态。

相格以一种直观的方式展示了量子力学的不确定性原理：实际上我们并不能同时精确地讨论坐标和动量。实际上，在纯态问题中量子力学的不确定性原理的合适的经典图像是相格而不是概率：将相空间分成相格之后系统演化仍然是决定论的，没有任何随机因素，但就是不能同时确定动量和坐标。
动量越确定，每个相格在动量维上就越窄，相应的在坐标维上就越宽，坐标就越不确定。
相格的图像不能展示量子力学允许的叠加态——实际上也没有什么经典图像能够很好地展示叠加态。

对混合态，可以将一个系综中的各个系统的纯态（称为\textbf{代表点}，因为它们代表了系统可能的状态；代表点可能有重复）单独地画在相空间当中，并记这些点的密度为$\rho(x, p, t)$，称为\textbf{密度函数}。
则由经典分析力学的刘维尔定理，有
\begin{equation}
    \pdv{\rho}{t} = [H, \rho].
\end{equation}
方程右边的方括号指的是经典的泊松括号而不是对易子，因为经典情况下哈密顿量是数。
可见，密度算符$\hat{\rho}$在量子统计力学中的地位就是经典统计力学中的密度函数。但要注意：$\hbar\to 0$时$\hat{\rho}$和$\rho$之间有线性关系，但是$\hat{\rho}$并不直接退化为$\rho$。
记$\Gamma$为相空间，则经典统计力学中的物理量期望值就是
\begin{equation}
    \expval{A} = \int \dd{\Gamma} \rho A(x, p).
\end{equation}

\section{热力学}

本节给出的所有假设都是平衡态统计力学的推论。然而，只使用这些假设就能够推导出所有热力学涉及的结论。
因此，热力学可以被构造为一个独立于任何具体的统计物理理论的公理系统。只要其公理在某个统计物理理论（未必是平衡态）下正确，整个热力学在这个公理系统下就是正确的。
虽然本节会频繁用到“功”、“热量”等看起来非常经典物理的概念，但这些概念在量子情况下也是有良好定义的。

在热力学中我们也还是讨论系统，系统可以是平衡态的也可以是非平衡态的。
从系统状态到实数的连续函数称为\textbf{状态函数}。由于热力学不分析系统的内部结构（这些要留给统计物理），实际上我们做的正好相反：我们使用状态函数来标记一个系统的\textbf{宏观状态}，这些被选出来的状态函数称为\textbf{热力学坐标}。%
\footnote{所谓“宏观状态”指的是“尺度足够大以至于可以使用经典力学描述的状态”，如体积、粒子数等。}%
对应的，称密度算符中的参与态为微观态，同一个宏观态对应着许多的微观态。
状态函数可以是某个良定义的可观察量的期望值及其函数，比如能量，也可以是某个涌现出来的量，比如说熵或者温度。
通常我们要求使用一个平衡态系统的全部热力学坐标足以确定该系统的密度算符。
显然可能的非平衡态系统远远多于可能的平衡态系统，因此一个非平衡态系统需要热力学坐标以外的一些参数来描述。

要注意在热力学的框架下我们不能严格定义“平衡”，因为这涉及系统内部的结构，因而需要使用某个统计理论来定义。
但可以确定的是，“平衡”意味着诸宏观量不发生变化，从而，系统的热力学坐标不发生变化。
平衡态的系统仍然可能出现微观层面的变化，正如我们在统计力学中看到的那样，它可以遍历所有被允许的态、出现在不同的能级上，等等。

系统可能会发生演化，从一个确定的状态演化到另一个确定的状态就是一个\textbf{热力学过程}。
一个过程中的每一时刻，系统可以是平衡的也可以是不平衡的，如果一个过程的每一时刻系统几乎都是平衡的，那么这个过程就是热力学坐标空间中的一条曲线。
否则，仅仅通过热力学坐标空间不足以描述该过程。

\subsection{温度、能量、功、热量}

\subsubsection{热力学第零定律与温度}

我们称两个系统热平衡，当且仅当，它们接触之后形成的总系统立即达到平衡，也就是说两个系统接触之后其状态函数不发生变化。
引入\textbf{热力学第零定律}：所有系统都能够达到热平衡，且设有已经达到平衡的三个系统$A,B,C$，若系统$A$和系统$B$热平衡，系统$B$和系统$C$热平衡，那么系统$A$和系统$C$接触之后也能够立即达成平衡。
这个基本假设实际上意味着我们可以引入\textbf{热力学温度}。
由于平衡系统可以使用状态函数完全描写，两个系统是否热平衡完全取决于这两个系统的热力学坐标。
于是，记$A_1, A_2, \ldots$为系统$A$的热力学坐标，记$B_1, B_2, \ldots$为系统$B$的热力学坐标，记$C_1, C_2, \ldots$为系统$C$的热力学坐标，那么可以找到三个函数$f_{AB}, f_{BC}, f_{AC}$，使得$A$与$B$热平衡、$B$与$C$热平衡、$A$与$C$热平衡的充要条件分别是
\[
    f_{AB} (A_1, A_2, \ldots, B_1, B_2, \ldots) = 0,
\]
\[
    f_{BC} (B_1, B_2, \ldots, C_1, C_2, \ldots) = 0,
\]
以及
\[
    f_{AC} (A_1, A_2, \ldots, C_1, C_2, \ldots) = 0. 
\]
显然，$A$和$C$热平衡的充要条件又可以写成
\[
    C_1 = F_{AC} (A_1, A_2, \ldots, C_2, \ldots),
\]
$B$和$C$热平衡的充要条件也可以写成
\[
    C_1 = F_{BC} (B_1, B_2, \ldots, C_2, \ldots).
\]
这样一来，$A$和$C$热平衡且$B$和$C$热平衡的充要条件就是
\begin{equation}
    F_{AC} (A_1, A_2, \ldots, C_2, \ldots) = F_{BC} (B_1, B_2, \ldots, C_2, \ldots).
    \label{eq:ac-and-bc-equilibrium}
\end{equation}
这个方程的解集似乎可以含有$C_2, C_2, \ldots$。然而，请注意$A$和$C$热平衡且$B$和$C$热平衡意味着$A$和$B$热平衡，也就是
\begin{equation}
    f_{AB} (A_1, A_2, \ldots, B_1, B_2, \ldots) = 0,
    \label{eq:ab-equilibrium}
\end{equation}
这个方程的解集却不显含$C_2, C_3, \ldots$。\eqref{eq:ac-and-bc-equilibrium}能够推导出\eqref{eq:ab-equilibrium}，因此\eqref{eq:ac-and-bc-equilibrium}的解集只应该是\eqref{eq:ab-equilibrium}的解集的子集。
既然\eqref{eq:ab-equilibrium}的解集不显含任何关于系统$C$的信息，\eqref{eq:ac-and-bc-equilibrium}的解集当然也不应该显含任何关于系统$C$的信息。
因此实际上\eqref{eq:ac-and-bc-equilibrium}不显含$C_2, C_3, \ldots$。这样\eqref{eq:ac-and-bc-equilibrium}实际上就是
\[
    F_{AC} (A_1, A_2, \ldots) = F_{BC} (B_1, B_2, \ldots).
\]
既然$F_{AC}$和$F_{BC}$实际上和系统$C$无关，我们可以重命名它们，得到
\begin{equation}
    \Theta_A (A_1, A_2, \ldots) = \Theta_B (B_1, B_2, \ldots).
    \label{eq:thermodynamics-temperature}
\end{equation}
\eqref{eq:thermodynamics-temperature}等价于\eqref{eq:ac-and-bc-equilibrium}，它成立的充要条件是存在某个已平衡的系统$C$，使得$A$和$C$热平衡且$B$和$C$热平衡。
因此，\eqref{eq:thermodynamics-temperature}是“$A$和$B$热平衡”的充分条件，从而也是\eqref{eq:ab-equilibrium}的充分条件。
另一方面，\eqref{eq:thermodynamics-temperature}是一个仅含有$A$的状态函数和$B$的状态函数的单个方程，而\eqref{eq:ab-equilibrium}也是这样的单个方程，它们在热力学坐标空间中画出来的轨迹或者仅有可数个交点，或者完全重叠。
\eqref{eq:thermodynamics-temperature}是\eqref{eq:ab-equilibrium}的充分条件这件事意味着实际情况不可能是前者，因此我们得到最终的结论：
\eqref{eq:thermodynamics-temperature}是系统$A$和$B$热平衡的充要条件。

如果一个系统可以看成若干个子系统接触之后的产物，那么当这个系统平衡后，其子系统的温度就是这个系统的温度。
这是因为记该系统（称为系统$A$）温度为$\Theta$，现在使用另一个温度为$\Theta$的系统（称为系统$B$）与之接触，显然，系统$B$一定会和系统$A$的某个子系统接触，而既然系统$A$和系统$B$温度一致，如前所述，它们接触后立即达到热平衡，相应的，系统$B$和与之接触的$A$的子系统接触后立即达到热平衡，因此能够和$B$发生接触的所有$A$的子系统必定具有温度$\Theta$；$A$的子系统相互接触，因此它的所有子系统都有温度$\Theta$。
需注意以上论证建立在$A$的几个子系统确实相互接触的前提之上。例如，真空中被红外光反射镜隔开的两个物体可以具有不同的温度，而与此同时它们组成的总系统又确实达到了热平衡，因为这两个物体不能发生有效的相互作用。

\eqref{eq:thermodynamics-temperature}中的$\Theta$是系统的一些状态函数的函数，因此它也是一个状态函数。我们称其为\textbf{温度}。实际上，\eqref{eq:thermodynamics-temperature}对具体的计算毫无作用——有无数种满足它的状态函数$\Theta$。\eqref{eq:thermodynamics-temperature}——从而热力学第零定律——的作用是提供一个存在性。
我们称能够用于计算的温度定义为\textbf{温标}。

通常为了和日常生活中的“冷热”概念保持一致，我们对温度添加一个额外的要求：如果系统$A$和系统$B$接触之后能量从系统$A$流向系统$B$，那么就认为系统$A$的温度高于系统$B$。
这里我们使用了“流动”的概念，也即认为一个系统的能量变化$\Delta E$，则与之直接接触的系统的能量变化$-\Delta E$。实际上这用到了热力学第一定律。另一方面，既然温度是一个实数，以上要求实际上还假定了能量流动的方向具有传递性，因此它也涉及热力学第二定律。
的确，将温标完全确定下来只使用热力学第零定律是不够的。

\subsubsection{热力学第一定律}

% TODO:统计力学中认定平衡时能量不流动
% TODO：功转化为热量
现在我们讨论系统的能量变化。按照先前在平衡态统计物理当中的论述，能量变化意味着有相互作用，有相互作用就有相互作用能，但通常哈密顿量中的相互作用项可以略去，从而我们仍有能量可加性。

\textbf{热力学第一定律}指出：系统能量变化可以分成两部分。一部分称为\textbf{功}，它的大小可以写成若干个形如$X_i \dd{Y_i}$的项的和；另一部分称为\textbf{热量}，它没有特殊的表达式；功和热量都具有可加性%
\footnote{
    物理量$A$具有可加性实际上意味着我们可以写出这样的表达式：
    \[
        \pdv{\text{density}}{t} + \div{\text{flow}} = \text{generation},
    \]
    换而言之，我们可以说$A$在系统内部被产生，在不同的系统之间流动。
}
，这意味着如果没有外界做功或传热或者功-热转换，则一个系统被做功$W$等价于与之接触的系统被做负功$-W$，一个系统吸热$Q$等价于与之接触的系统放热$Q$。

这样，对单个系统，记$W$和$Q$分别是它得到的功和热量，则存在一个称为\textbf{内能}的状态函数，使得
\begin{equation}
    \dd{U} = \delta{Q} + \sum_i X_i \dd{Y_i} = \var{Q} + \var{W}.
    \label{eq:thermodynamics-first-law}
\end{equation}
对每个$i$，称$X_i$和$Y_i$组成一对\textbf{共轭变量}。
我们使用$\delta$表示热量和功的微元是因为一般来说热量微元不是一个恰当微分形式%
\footnote{一些物理量可以最终写成密度算符的函数，如总能量、熵等，它们完全由系统的状态确定，称为状态函数或状态量；另一些物理量是在一个过程中得到定义的，如功、冲量，其通式为
\[
    X(S_1 \longrightarrow S_2) = \int_{S_1}^{S_2} \sum_i Y_i \dd{Z_i},
\]
或者写成微分形式
\[
    \var{X} = \sum_i Y_i \dd{Z_i},
\]
其中$B_i$和$C_i$为状态量。有一些过程量实际上是状态量的变化，例如“能量的变化”
\[
    \Delta E (S_1 \longrightarrow S_2) = \int_{S_1}^{S_2} \dv{E}{t} \dd{t},
\]
但并非所有过程量都对应状态量的变化。一个过程量是某个状态量的变化量当且仅当该过程量的微元是一个恰当微分形式。}%
，从而一个过程中的热量通常并不是某个状态函数的变化量。

我们这里还隐含地引入了一个假设，就是内能$U$和系统是如何和外界连接的无关，换而言之，就是系统之间的相互作用能可以略去。
我们将看到这个假设是能量、功、热量的可加性的前提。

热力学第一定律区分了热量和做功两种传递能量的方式。这两种方式在改变内能这件事上是等价的。如果在一个过程中，体系初末内能一致，那么我们就有
\[
    \int \var{Q} + \int \var{W} = 0,
\]
也即，体系吸热等于体系对外做功（外界对体系做功的相反数）。我们称这是将热量转化为了功；类似的也可以说，功可以转化为热量。
然而，这样的转化并不是毫无限制的。我们马上会看到这样的转化过程受到什么样的限制。

\subsection{热力学第二定律和熵}

\subsubsection{热力学第二定律的两种表述}

本节讨论关于熵的话题。我们将首先引入一个看起来相当唯象的假设，然后证明它有多种等价形式，然后得到一个温标和热力学熵，从而导出使用熵表述的热力学第二定律。
最后，通过证明统计力学中的温度和熵实际上就是这个温标和热力学熵，我们就证明了热力学第二定律可以建立在统计力学之上。

我们有这样一个定律，称为\textbf{热力学第二定律的开尔文表述}：不可能有一个等温过程能够将单一热源的热量完全转化为功而不产生其它变化。

这个定律的另一个等价形式，称为\textbf{热力学第二定律的克劳修斯表述}，是：热量不能从低温系统流向高温系统而不产生其它影响。

我们来论证这两个说法的等价性。首先假设有这样一个过程，能够将单一热源的热量完全转化为功而不产生其它变化。我们知道有很多装置都可以把功完全转化成热，比如说摩擦生热。
把这两个过程连起来，也就是：
\begin{enumerate}
    \item 首先从某个温度为$\Theta_1$的热源吸取热量$Q$；
    \item 然后将这部分热量变成功$W=Q$；
    \item 然后把这部分功通过摩擦生热之类的的方式完全变成热量而传递给一个温度为$\Theta_2$的系统。
\end{enumerate}
我们这样就获得了一个装置，可以随意地将一部分热量从任意一个系统转移到另一个系统，而且没有产生其它变化。因此我们可以随意地将热量从低温系统转移到高温系统而不产生其它变化。
因此如果开尔文表述不成立，那么克劳修斯表述也不成立。

再考虑另一种情况。假定克劳修斯表述不成立，也就是我们能够找到一个过程，让热量从一个低温系统流向高温系统。那么，我们可以把这个过程和一个普通的\textbf{热机}——也就是吸收一定热量、对外做功，然后再释放一定热量，如此不断循环的设备——连接起来，形成这样的一个过程：
\begin{enumerate}
    \item 低温热源将热量$Q$传递给高温热源；
    \item 热机从高温热源吸收热量$Q$（总是可以做到，只需要让热机的温度低于高温热源温度即可）；
    \item 热机对外做功$W$；
    \item 热机向低温热源排放热量$Q-W$（是这个数值是因为热力学第一定律；能够排放热量是因为可以让热机的温度介于高温热源和低温热源之间）。
\end{enumerate}
在这样的过程中，高温热源总的来说没有吸收也没有释放热量；低温热源损失了$Q-(Q-W)=W$的热量；对外做功为$W$。
这个过程从单一热源，也就是低温热源，吸收了热量$W$，使之全部变成了对外做的功，因此违背了开尔文表述。
因此如果克劳修斯表述不成立，那么开尔文表述也不成立。

总之，克劳修斯表述和开尔文表述是同一条定律——也就是\textbf{热力学第二定律}——的不同说法，这条定律禁止某些“太神奇了而不大可能是真的”的物理过程，比如说让海水温度略微下降从而产生足够全人类用上一段时间的功。

热力学第二定律还有很多推论。例如，达到热平衡的系统不应该自发地产生温度差，否则就可以使用这个温度差做功，从而从单一热源将热量转化为功。

\subsubsection{热机效率、过程可逆性和热力学温度}

我们还将看到，热力学第二定律对热机的效率产生了一个很自然的限制。

我们设一台热机在它的循环往复的运作过程中从一些与之接触的系统吸收了热量$Q_1$，又向一些与之接触的系统释放了热量$Q_2$（称为\textbf{废热}，因为这一部分热量没有转化为功）。由热力学第一定律，我们有
\begin{equation}
    W = Q_1 - Q_2,
\end{equation}
$W$是热机对外做的功。定义热机的效率为
\begin{equation}
    \eta = \frac{W}{Q_1} = 1 - \frac{Q_2}{Q_1}.
    \label{eq:heat-efficienty}
\end{equation}
$Q_2$不可能是零，否则在热机的一个循环中，若我们将热机从中吸热的系统看成一个总系统，那么热机就从一个单一系统中吸收热量$Q_1$，然后把它全部转化为了功。
这表明$Q_2>0$，于是任何一个热机的效率都不可能达到1。
现在的问题是，热机的效率是否有一个上限？

我们首先考虑一类特殊的热机，称为\textbf{可逆热机}，也就是循环过程是可逆过程的热机。
所谓可逆过程，指的是一种颠倒过来也完全可以发生的过程。
实际上，一个过程是可逆的，当且仅当，该过程中的每一段从初态运行到末态之后，都有另一个过程可以将此末态转移到初态而抵消这一段过程对外界的所有影响。
这两个说法的等价性论证如下：如果一个过程颠倒过来可以发生，那其中的任何一段也可以颠倒过来发生，于是该过程中的任何一段从初态运行到末态之后只需要执行这一段过程颠倒后所得的过程，就从末态转移到了初态，而两个彼此颠倒的过程对外界的影响相互抵消了；
反之，如果一个过程中的每一段从初态运行到末态之后，都有另一个过程可以将此末态转移到初态而抵消这一段过程对外界的所有影响，那么我们取一个过程微元，能够找到另一个过程微元，使得先作用前者再作用后者之后系统状态恢复而环境状态也恢复；但由微元的性质，后者和前者相差的是一个高阶小量，从而后者实际上就是前者颠倒过来的结果，因此该过程中的每一个微元都是可以颠倒的，从而整个过程也是可以颠倒的。

直觉上，可逆过程一般意味着比较少的能量转化为了不得不排放到外界的废热$Q_2$。例如，废热的一个重要产生途径为摩擦生热，而摩擦不是一个可逆的过程（摩擦将功转化为了热，而由热力学第二定律热不能转化为功而不对外界产生影响）。因此不慎严格地说，可逆过程意味着摩擦等非理想因素被完全排除。
但我们现在在讨论热力学，我们并不细致地去分析什么样的过程会导致不可逆性；同样我们也将使用完全基于热力学而不基于任何具体的物理理论的论证来表明可逆热机的特殊性质。

我们有结论：同样条件下（例如，同样温度的热源、同样的输入热量），没有一台热机能够具有比一台可逆热机更好的效率。
这是热力学第二定律的推论。设可逆热机$A$从热源1吸收热量$Q$之后可以做功$W$，然后向热源2排放热量$Q-W$。%
\footnote{热源1和热源2可能分别是由几个温度不等的小热源组成的，而未必是完全均匀的。}%
假设有一台效率比$A$还要好的热机$B$，则它从热源1吸收热量$Q$之后可以做功$W'$，$W'>W$。由于$A$是可逆的，它也可以从另一个热源吸收热量$W-Q$，接受外界做功$W$，然后向热源1排放热量$Q$。
那么我们可以构造下面的过程：
\begin{enumerate}
    \item 热机$B$从热源1吸热$Q$，向热源2排热$Q-W'$，同时做功$W'$；
    \item 功$W'$中，$W'-W$的部分被用于向外做功，$W$被输入热机A；
    \item 热机$A$接受$B$做的功$W$，从热源2吸热$W-Q$，向热源1排热$Q$。
\end{enumerate}
整个过程向外做功$W'-W$，热源1无净热量得失，热源2损失热量$W'-W$。也即，这个过程从单一热源吸热而将其全部转化为了功，因而违背了热力学第二定律。
因此不存在这样的热机$B$，也就是说没有效率比$A$还要高的热机。

现在有两台可逆热机$A$和$B$。同样条件下$A$的效率不可能高于$B$，$B$的效率也不可能高于$A$，因此两者的效率是一样的。也即，所有可逆热机在同样的条件下都具有同样的效率。
于是我们得出结论：任何可逆热机在同样的条件下都具有同样的效率，且这个效率是该条件下一切热机能够达到的最大效率。

这个结论其实让人感到惊奇，因为我们没有用到任何关于热机的具体原理的知识。例如，我们从来不需要讨论什么是摩擦、什么是不可逆过程，我们只需要使用抽象的“可逆”概念就可以了。

以上结论实际上还可以进一步加强：热机是可逆的是热机效率最大化的充要条件（而不仅仅是充分条件）。理由也很简单。设有一台不可逆热机也能够达到可逆热机的效率，那么可以构造这样的过程：
\begin{enumerate}
    \item 不可逆热机吸热$Q$，做功$W$，放热$Q'$；
    \item 功$W$用于驱动可逆热机反向工作，即可逆热机受不可逆热机做功$W$，吸热$Q'$，放热$Q$。
\end{enumerate}
这个过程意味着我们找到了一个过程，可以将一个不可逆过程对外界的影响完全抵消，这和不可逆性的定义矛盾。

虽然我们在做以上推导时，都是对可逆热机和不可逆热机输入了同样的热量，比较它们做的功，但实际上可逆热机的效率和输入热量是无关的。要看出为什么，设一台可逆热机从某热源吸热$Q$而做功$W$。如果效率和输入热量有关，就有
\[
    W = \eta(Q) Q.
\]
我们也可以使用两台一样的这种可逆热机，进行下面的操作：
\begin{enumerate}
    \item 从热源吸热$Q$；
    \item 将热量$Q$分成两份$Q_1$和$Q_2$；
    \item 将$Q_1$提供给其中一台可逆热机，由它对外做功$W_1$；
    \item 将$Q_2$提供给另一台可逆热机，由它对外做功$W_2$。
\end{enumerate}
这样一来，对外做的总功为
\[
    W' = \eta(Q_1) Q_1 + \eta(Q_2) Q_2, \quad Q_1 + Q_2 = Q.
\]
由于将热量分成两束、将两台可逆热机的功合并在一起都是可逆的，以上过程也是可逆的。由于任何可逆热机在相同条件下都应该具有一样的效率，我们有
\[
    W = W'.
\]
从而，对任意满足$Q_1 + Q_2 = Q$的$Q_1, Q_2$，都有
\[
    \eta(Q) Q = \eta(Q_1) Q_1 + \eta(Q_2) Q_2.
\]
唯一的可能就是，$\eta$实际上并不显含$Q$。因此可逆热机的效率和输入热量无关。从而，可逆热机输出的功、排出的废热和输入热量成正比关系。

现在我们考虑只涉及两个温度确定的热源的可逆热机，称为\textbf{卡诺热机}。通过考虑这种类型的热机，我们实际上可以获得一个温标，同时获得热力学第二定律的一个显式表达式。
卡诺热机的效率和热机具体的构造无关（正如我们刚刚证明的那样），因此其效率只和两个热源的温度$\Theta_1$和$\Theta_2$有关。因此，在热源温度已知的情况下，只需要知道可逆热机吸收了多少热量，我们就知道它会对外做多少功、会对外排放多少热量。
现在考虑一个固定的温度$\Theta_s$，设可逆热机的两个热源分别为$\Theta_s$和$\Theta$，热机从温度为$\Theta_s$的热源吸热$Q_s$，则会向温度为$\Theta$的热源放热$Q$。%
\footnote{由于热机可逆，$\Theta_s$小于$\Theta$是没有关系的，此时只需要外界对热机做功就可以完成整个过程——这实际上就是制冷机。}%
我们已经证明过，$Q$和$Q_s$有正比关系，因此有
\begin{equation}
    Q = Q_s f(\Theta).
    \label{eq:q-s-and-theta}
\end{equation}
$f$实际上是递增的。设$\Theta_1<\Theta_2$，且对温度为$\Theta_1$和$\Theta_2$的热源热机分别放热$Q_1$和$Q_2$，由于热机的可逆性，我们可以构造如下过程：
\begin{enumerate}
    \item 从温度为$\Theta_1$的热源吸热$Q_1$，向温度为$\Theta_s$的热源放热$Q_s$；
    \item 从温度为$\Theta_s$的热源吸热$Q_s$，向温度为$\Theta_2$的热源放热$Q_2$。
\end{enumerate}
这是一个可逆过程，因此由可逆热机效率的唯一性，任何一台卡诺热机从温度为$\Theta_1$的热源吸热$Q_1$必然伴随着向温度为$\Theta_2$的热源放热$Q_2$。
这是一个热量从低温系统流向高温系统的过程，则外界必定对热机做功，因为如果外界不对热机做功，那这就违背了热力学第二定律；而如果热机对外界做功，我们显然可以把这部分功通过摩擦生热等方式转化为热量传递给温度为$\Theta_2$的热源，导致一个热量从低温系统流向高温系统而不产生其它影响的过程，同样违反热力学第二定律。
因此
\[
    Q_2 = Q_1 + \text{work done to the machine},
\]
从而
\[
    Q_2 > Q_1,
\]
也即
\[
    Q_2(\Theta_2) > Q_1(\Theta_1), \quad \text{for } \Theta_2 > \Theta_1.
\]
由于没有指定特定的温标，我们只能获得\eqref{eq:q-s-and-theta}，而不能获得更进一步的结论。
但由于温标的任意性，我们完全可以要求
\[
    f(T) \propto \Theta,
\]
从而
\[
    Q \propto Q_s \Theta,
\]
我们称满足这个条件的温标为\textbf{热力学温标}。显然，所有可能的热力学温标相互之间差一个常数因子。在热力学温标下，
这等价于
\begin{equation}
    \frac{Q_1}{T_1} = \frac{Q_2}{T_2}.
\end{equation}
一旦得到了这个关系式，我们就得到了可逆热机的效率，因为如前所述，任何一台卡诺热机从温度为$\Theta_1$的热源吸热$Q_1$必然伴随着向温度为$\Theta_2$的热源放热$Q_2$。
设$T_1>T_2$，从而$Q_1>Q_2$，可逆热机对外做功。考虑\eqref{eq:heat-efficienty}，对卡诺热机有
\begin{equation}
    \eta = 1 - \frac{T_2}{T_1}.
\end{equation}
因此对任何二热源热机，均有
\begin{equation}
    \eta \leq 1 - \frac{T_2}{T_1},
    \label{eq:efficiency-inequality}
\end{equation}
如果热机可逆则取等号。热机不可逆时是否能够取等号？结论是不行，因为如果一部不可逆的二热源热机（称为$A$）的效率和可逆热机（称为$B$）完全一致，那么可以构造这样的过程：
\begin{enumerate}
    \item $A$从高温热源吸热$Q$，向低温热源排放热量$Q'$，对$B$做功$W$；
    \item $B$倒过来运转（此时它实际上是制冷机），接受$A$做的总量为$W$的功，从低温热源吸热$Q'$，向高温热源排热$Q$。
\end{enumerate}
这样我们就让$A$在运转了一段时间之后回到了原来的状况，且高温热源和低温热源无净热量流动，$A$和$B$组成的大系统也没有对外界做功。
这和$A$是不可逆热机矛盾。因此\eqref{eq:efficiency-inequality}中的等号在且仅在热机可逆时取得。

现在我们可以讨论一个一般的热机了。设这个热机的一个循环中经历了一系列过程，每个过程中热机从温度为$T$的热源吸热$\dd{Q}$（若热机在这个步骤实际上向热源放热，则$\dd{Q}$取负值），对外做功$\dd{W}$（若反而是外界向热机做功则取负值）。
我们记这台热机为热机$A$。
现在想象我们有一个温度为$T_0$的很大的热源，这意味着其温度对有限的过程而言保持恒定，然后构造一个多步骤的循环过程，其中每一步为：
\begin{enumerate}
    \item 让一部卡诺热机从温度为$T_0$的热源吸热$\dd{Q}_0$，这部分热量正好导致卡诺热机输出热量$\dd{Q}$（若卡诺热机向$T_0$热源放热也是可以的，只需要让$\dd{Q}_0$取负值即可）；
    \item 卡诺热机输出的能量被全部传递给了热机$A$；
    \item 热机$A$输入热量$\dd{Q}$，对外做功$\dd{W}$。
\end{enumerate}
如此进行一个循环。整个循环中，每一步的$\dd{Q}$，$\dd{W}$和$T$是给定的，$\dd{Q}_0$则是根据\eqref{eq:heat-efficienty}计算出来的。
显然这个循环在任何条件下都是可以进行的，于是我们可以将$T_0$取得比较低（从而需要外界对卡诺热机做比较多的功来保持其运转，不过我们并不需要考虑这一点）。
一个循环过后必定有
\[
    \oint \var{Q}_0 \leq 0,
\]
否则能量自发地从低温热源流向高温热源，违反热力学第二定律。考虑到\eqref{eq:heat-efficienty}，我们有
\[
    \frac{\var{Q}_0}{T_0} = \frac{\var{Q}}{T},
\]
考虑到$T_0$恒定不变，我们有
\begin{equation}
    \oint \frac{\var{Q}}{T} \leq 0.
    \label{eq:clausius-inequality}
\end{equation}
虽然\eqref{eq:clausius-inequality}的导出建立在“与热机$A$接触的热源由一部卡诺热机的废热供热”的假设上，但由于热机$A$的行为完全由每一步的$\dd{Q}$和$T$决定，热机“不知道”自己是不是由一部卡诺热机供热。
那么，既然\eqref{eq:clausius-inequality}对由卡诺热机供热的热机成立，它对任何一个热机循环过程都是成立的。不等式\eqref{eq:clausius-inequality}称为\textbf{克劳修斯不等式}。

在热机可逆时，我们可以把热机的运转完全颠倒过来，做变换
\[
    \var{Q} \longrightarrow -\var{Q},
\]
而不违反任何物理定律。这就意味着
\[
    \oint \frac{-\var{Q}}{T} \leq 0,
\]
从而
\[
    \oint \frac{\var{Q}}{T} = 0.
\]
因此对可逆热机，克劳修斯不等式\eqref{eq:clausius-inequality}取等号。
不可逆热机\eqref{eq:clausius-inequality}不能取等号，否则可以使用这个不可逆热机对外做的功驱动一部可逆制冷机，从而一个循环后不可逆热机对环境的影响完全被消除而一切都恢复到了初始状态，和不可逆性矛盾。

% TODO：证明可逆过程一定是准静态的；大致的思路是，只有准静态过程才能让$\int A \dd{B}$完全扫过状态方程$A=f(B)$曲线之下的面积；
% 但仍有一些事情要做：需要论证状态方程的存在性，以及只需要使用热力学第一定律中的$A,B$等量就足以描述平衡态系统。热力学坐标到底是什么？？

最后，由于任何一个系统的循环过程实际上都是在吸热、放热、做功，任何一个在发生循环过程的系统实际上都是一台热机。于是克劳修斯不等式对任何一个循环过程都成立；取等条件为循环过程可逆。

我们使用热力学第二定律导出了克劳修斯不等式。如果热力学第二定律不成立，那么可以构造这样一个循环过程，它从低温热源$T_1$吸热$Q$而向高温热源放热$Q$，且没有接受外界做功也没有对外界做功，此时
\[
    \oint \frac{\var{Q}}{T} = \frac{Q}{T_1} - \frac{Q}{T_2} > 0,
\]
于是克劳修斯不等式就不成立了。
因此克劳修斯不等式实际上等价于热力学第二定律，或者说它是热力学第二定律的一种不等式表述。

\subsubsection{热力学熵}

% TODO：热力学中熵的可加性
既然对可逆热机，克劳修斯不等式\eqref{eq:clausius-inequality}取等号，而可逆过程一定是准静态的，从而涉及的$\var{Q}$和$T$可以写成诸热力学坐标的函数，在热力学坐标空间中我们有%
\footnote{即使对不可逆系统照样有该式成立。克劳修斯不等时中的积分是关于实际的过程的，也即
\[
    \int_\text{circle process} \frac{\var{Q}(t)}{T(t)} = \int_\text{circle process} \frac{1}{T} \frac{\var{Q}(t)}{\dd{t}} \dd{t} < 0,
\]
这和
\[
    \oint_\text{state space} \frac{\dd{U}-\var{W}}{T} = 0
\]
并无矛盾。}
\begin{equation}
    \oint \frac{\dd{U}-\var{W}}{T} = 0.
\end{equation}
因此我们可以定义一个新的状态函数$S$，称为\textbf{热力学熵}，它满足
\begin{equation}
    \dd{S} = \frac{\dd{U}-\var{W}}{T}.
    \label{eq:entropy-dd}
\end{equation}
光靠\eqref{eq:entropy-dd}是确定不下来熵的具体值的；满足这个表达式的$S$彼此差一个常数。
这样，对可逆系统而言就有
\begin{equation}
    \dd{U} = \var{S} + \var{W} = T\dd{S} + \var{W}.
\end{equation}
可逆系统和不可逆系统的热力学第一定律表达式唯一的差别就是$\var{Q}$的形式，于是系统可逆等价于
\begin{equation}
    \left(\pdv{U}{S}\right)_{Y} = T, \quad \left(\pdv{S}{U}\right)_Y = \frac{1}{T}.
    \label{eq:pdv-of-u-and-s}
\end{equation}
这里使用标准的记号，以偏导数的下标表示被认为是不变的量。

在引入热力学熵的概念之后，就可以从\eqref{eq:clausius-inequality}导出熵增原理。设有一个过程$P$，初态为$A$，末态为$B$，我们可以构造一个从$B$到$A$的可逆过程，从而形成一个循环。对这个循环应用\eqref{eq:clausius-inequality}，就得到
\[
    \int_P \frac{\var{Q}}{T} + \int_{B}^A \frac{\var{Q}}{T} \leq 0,
\]
也即
\[
    \int_P \frac{\var{Q}}{T} \leq - \int_{B}^A \frac{\var{Q}}{T} = \int_A^B \frac{\var{Q}}{T},
\]
于是就得到
\begin{equation}
    S_B - S_A \geq \int_P \frac{\var{Q}}{T}.
    \label{eq:increasing-entropy}
\end{equation}
或者等价的
\begin{equation}
    \dd{S} \geq \frac{\var{Q}}{T}.
\end{equation}
从以上推导可以看出\eqref{eq:increasing-entropy}的取等条件就是\eqref{eq:clausius-inequality}的取等条件，也就是过程$P$连同从$B$到$A$的过程可逆，也即过程$P$可逆。
因此\eqref{eq:increasing-entropy}在过程$P$可逆时取等号。
我们使用克劳修斯不等式推导出了\eqref{eq:increasing-entropy}，而容易看出\eqref{eq:increasing-entropy}也能够反过来推导出克劳修斯不等式，这只需要让过程$P$是一个循环过程就可以，此时$S_A$和$S_B$相等，自然得到\eqref{eq:clausius-inequality}。
这里有一个微妙的细节：在导出\eqref{eq:increasing-entropy}时我们用到了\textbf{热力学熵}，而热力学熵是良定义的状态函数这件事是使用\eqref{eq:clausius-inequality}推导出来的。
因此更加准确地说，与\eqref{eq:clausius-inequality}等价的是“存在某个状态函数$S$使得不等式\eqref{eq:increasing-entropy}成立，且取等条件为过程可逆”。

在过程中无热量交换，也即，发生过程的系统与外界绝热的情况下，\eqref{eq:increasing-entropy}就是
\begin{equation}
    \Delta S \geq 0,
\end{equation}
取等条件为过程可逆。这就是所谓的\textbf{熵增原理}：绝热系统的熵永远不会减小。
实际上，虽然我们使用\eqref{eq:increasing-entropy}推导出了熵增原理，但熵增原理结合熵和热量的性质也可以推导出\eqref{eq:increasing-entropy}。设有过程$P$，初态为$A$末态为$B$，我们将它的热量交换端和一台可逆热机连接，组成一个绝热的总系统，对这个总系统应用熵增原理，有
\[
    S_\text{system, $B$} + S_\text{reversible, $B$} \geq S_\text{system, $A$} + S_\text{reversible, $A$}.
\]
对可逆过程有
\[
    \frac{\var{Q}_\text{reversible}}{T} = \dd{S},
\]
于是
\[
    \begin{aligned}
        S_\text{system, $B$} - S_\text{system, $A$} &\geq S_\text{reversible, $A$} - S_\text{reversible, $B$} \\
        &= - \int_A^B \frac{\var{Q}_\text{reversible}}{T} \\
        &= \int_A^B \frac{\var{Q}_\text{system}}{T}.
    \end{aligned}
\]
取等条件为总系统发生的过程可逆，也即过程$P$可逆。这正是\eqref{eq:increasing-entropy}。
因为发生过程$P$的系统并不知道它在和什么东西做热交换，如果以上不等式对和一台可逆热机连接的系统上发生的过程成立，那它就对一切过程均成立。

总之，以下三个结论彼此等价，且它们都是热力学第二定律的表述：
\begin{itemize}
    \item 有一个称为熵，记作$S$的状态函数，绝热系统的熵总是增加的，且对可逆过程有$\var{Q}=T\dd{S}$，或等价的\eqref{eq:pdv-of-u-and-s}；
    \item 有一个称为熵，记作$S$的状态函数，它让\eqref{eq:increasing-entropy}恒成立；
    \item 克劳修斯不等式\eqref{eq:clausius-inequality}。
\end{itemize}

一个自然的推论是，
\[
    \var{W} \geq \dd{U} - T \dd{S},
\]
由于体系对外界做的功满足% TODO:为什么？
\[
    \var{W}_\text{output} \leq - \var{W},
\]
就有% TODO
\begin{equation}
    \var{W}_\text{output} \leq \text{something},
\end{equation}
因此一个初末态确定的过程能够做的功有一个上限。以上不等式取等号的充要条件是过程可逆，或者说这是准静态过程，因此我们得出结论：同样的初末条件，准静态过程做功最多。

\subsection{热力学第三定律和熵的零点}

热力学第三定律是说：任何系统在零温附近，熵都是一个常数，也即，当$T\to 0$时，$\Delta S \to 0$，或者说
\[
    \pdv{S}{\text{anything}} \to 0 \quad \text{as $T \to 0$}.
\]
这是一个非常强的论断，因为直觉上$S$的行为会和很多参数有关。然而，对很多物质的实验测定确实可以得到这样一个结论。
在前面所有的论述中，有意义的都只有熵的变化，而不包括熵的绝对大小，因此指定了一个系统在零温处的熵值我们就完全确定了它的熵和其它热力学坐标的关系。
显然，认定任何系统在零温附近熵都为零是可以的。

热力学第三定律有一个等价的表述：从有限温度不能够经过有限的过程到达绝对零度。设想一个从有效温度$T=T_0$到$T=0$的过程。
温度下降了，这意味着内能下降了。如果在此过程中总的来说热量流向系统，那么热力学第二定律就被违反了——我们可以构造下面的过程：
\begin{enumerate}
    \item 将一个热库和系统连接；
    \item 系统吸热$Q$，向外做功$W$，温度下降；
    \item 然后热库向系统补充热量，并向环境补充热量。
\end{enumerate}
在此过程中单一热源（热库）的热量被完全转化为了功。换而言之，物体冷却时必定向外放出热量。
热力学第三定律是正确的等价于在$T=0$附近$\dd{S}=0$，也即
\[
    \var{Q} = T \dd{S} = 0,
\]
这等价于物体不再能够向外放出热量，从而无法进一步冷却，即物体不能冷却到$T=0$。
这就证明了两种说法的等价性。

\subsection{平衡条件}

\section{平衡态统计物理}\label{sec:equilibrium-system}

本节讨论由大量粒子组成的平衡态系统的密度算符以及各种性质。大部分物理系统的平衡态几乎都可以使用这一套框架来描述，因为量子场论自然地导致多粒子态（可以使用单粒子量子力学描述的系统实际上就是使用薛定谔场描述的系统%
\footnote{在两种意义上，单粒子量子力学是量子场论的退化情况。就动力学方程而言，单粒子量子力学是0+1维场论；另一方面单粒子量子力学对应一个无粒子间相互作用的场论。
第一种对应下，单粒子量子力学中的“粒子”是指其能级；第二种对应下，单粒子量子力学中的“粒子”和它对应的无粒子间相互作用的场论中的“粒子”是同样的东西（见\autoref{note:second-quantization}）。}
）。
我们假定哈密顿量不显含时间，从而保证平衡态的存在性，而将含时演化留到后面讨论。

\subsection{孤立系统}

\subsubsection{微正则系综与等概率原理}

\textbf{孤立系统}是指很大（从而它不是可积的），并且和外界有小但确实有的相互作用（从而它的演化轨迹会时不时从一条偏移到另外一条上，但每条轨迹又不会有很大偏离）的系统。
称它为孤立系统是因为宏观上看它和外界没有物质能量交换。
平衡态的孤立系统具有\textbf{各态遍历性}：在一段时间内，系统会经过所有可能的态。%
\footnote{这些条件都是必要的：如果系统很简单，比如说，就是理想的二体问题，那么就算系统和环境有纠缠或者持续的小的相互作用也不会各态遍历——可积系统不会热化。总之，任何一个在统计物理上有意义的系统必然在某种意义上是开放的。所谓“孤立”仅仅表示它和外界的相互作用并不大。}%
所谓可能指的是和系统已知的各个参数一致，例如如果系统和外界无能量交换，那么所有可能的态就是指能量和初始能量相等的态。%
\footnote{类似于“系统有硬边界”这样的条件，如“系统装在一个盒子里”，可以看成是系统受到一个外加势的作用，这个外加势在盒子内部为零，在盒子外部为无穷大，从而由系统能量有限可以知道，系统中的粒子绝对不会跑到盒子外部去。}%
系统遍历所有可能的态的时间，也就是\textbf{遍历时间}，通常远远小于我们观察的时间尺度。
显然，这就意味着在我们观察的时间尺度上均匀取样地对系统做观察，得到的结果是随机的，因此需要引入一个系综来处理这个问题。%
\footnote{这是又一个虽然没有实际上的随机性，但信息的缺乏意味着我们必须引入概率测度来分析问题的例子。}%
许多系统如果和外界毫无接触，那么并不会有遍历性；但是几乎我们关心的所有系统都或多或少地和外界有小的相互作用。
这种系统达到平衡，且和外界虽有小的相互作用但相互作用对系统能量影响不大，以至于系统总能量可以看成是给定的的情况称为\textbf{微正则系综}。相应的，系统和外界的小的相互作用以及它带来的能量变化称为\textbf{热涨落}。%
\footnote{物理量涨落的大小定义为其标准差。}%

系统取各个态的概率是多少呢？数学上可以证明，设系统的所有可能的态组成希尔伯特空间，且给定该希尔伯特空间的一组基，则系统取这组基中的任何一个的概率都是一样的。
从而，系统具有某个宏观性质的概率就正比于满足这个性质的正交态的数目。这就是\textbf{等概率原理}，有时也称为\textbf{统计物理基本假设}。
关于“可能的态”需要特殊说明。有些态的不可能性是哈密顿量告诉我们的。例如，如果系统被放置在一个无限深、无限厚的势陷当中，那么系统中的粒子不可能到达势陷外面。还有一些态的不可能性是来自系统的初态。系统的哈密顿量不含时，因此如果系统的初态是一个能量本征态，能量为$E$，那么它无论如何不会演化到一个具有$2E$能量的态上面；同样，如果系统的动力学保证粒子数守恒，那么系统的粒子数也不会发生变化。

守恒量通常都是关于整个系统的，因此通常很大，从而可以和各种尺度的外界扰动（热涨落）有耦合，因此，系统几乎总是处在其所有守恒量的本征态上，于是我们可以毫无顾虑地讨论“系统的守恒量的值”而不用担心叠加态。
我们看到，系统具有的所有守恒量实际上将系统的态空间分成了一个个轨道，每个轨道上的态具有相同的守恒量的值。热涨落让系统可以取同一个轨道上的不同的态，却不能让系统从一个轨道跳跃到另一个轨道。（当然实际上，热涨落还是可以让守恒量发生小的变化的，如可以让能量在一定范围内涨落，也即，轨道是有宽度的，但由于涨落按照定义很小而且相互抵消，因此可以忽略这一点。）
设系统具有的守恒量为$\hat{Q}_1, \hat{Q}_2, \ldots$，记对应轨道上有$\Omega(Q_1, Q_2, \ldots)$个彼此独立的量子态。

当然，这些守恒量当中肯定有一个量，就是系统能量。系统哈密顿量的本征态形如$\ket{E^{(i)}, j}$，其中$\{E^{(i)}\}$指的是一组不同的能量，$j$代表简并。
为方便起见，我们记这些本征态为$\{\ket{n}\}$，并设$E_n$为$\ket{n}$对应的本征态的能量。
请注意$E_n$和$E^{(n)}$是不一样的：后者在$n$不同时没有重复，而前者由于能量简并可以有重复。

在以上讨论的基础上可以直接写出微正则系综的密度算符为
\begin{equation}
    \hat{\rho} = \frac{1}{\Omega(E)} \sum_{E_n = E} \dyad{n},
    \label{eq:microcanonical-ensemble-density-operator}
\end{equation}
其中$\{\ket{n}\}$为系统哈密顿算符的各正交本征态，$\Omega(E)$给出了能量为$E$的哈密顿量的彼此独立的本征态的数目。
我们把具有同一个能量的所有态称为一个\textbf{能级}，那么$\Omega(E)$就是能级$E$的简并度。

\subsubsection{相互接触的系统}\label{sec:contacting-systems}

考虑两个系统，分别称为系统1和系统2。首先记系统1有$\Omega_1 (E)$个彼此独立的能量为$E$的态，系统2有$\Omega_2 (E)$个彼此独立的能量为$E$的态。
如果将两个系统组建成一个总系统，在系统1和系统2无相互作用时，总系统的哈密顿量就是
\[
    \hat{H}_T = \hat{H}_1 + \hat{H}_2,
\]
由于$\hat{H}_1$和$\hat{H}_2$对易，$\hat{H}_T$的本征值就是两者的本征值之和。设总系统有$\Omega_T(E)$个彼此独立的总系统的能量为$E$的态，那么
\[
    \Omega_T (E_T) = \sum_{E_T=E_1^{(m)}+E_2^{(n)}} \Omega_1 (E_1^{(m)}) \Omega_2 (E_2^{(n)}),
\]
或者
\begin{equation}
    \Omega_T (E) = \sum_{n} \Omega_1 (E_1^{(n)}) \Omega_2 (E - E_1^{(n)}),
    \label{eq:total-system-state-number}
\end{equation}
其中$E$为$\hat{H}_T$的某个本征值。
% 由于守恒荷没有交换，可以直接认为守恒荷只提供能量简并；守恒量完备集

现在让两个系统“接触”，也就是让它们产生一个相对于它们各自的哈密顿量来说比较小的相互作用。此时\eqref{eq:total-system-state-number}就不再适用了，因为总系统的哈密顿量还要加上一个相互作用项，由于系统1和系统2的哈密顿量都可能是离散谱，设$E_1^{(n)}$是系统1哈密顿量的本征值，$E-E_1^{(n)}$却未必是系统2的哈密顿量的本征值！
但由于我们考虑的系统的粒子数都非常大，系统2的能谱近似是连续的，也即，$E-E_1^{(n)}$总是非常接近系统2的一个能级。因此我们接受\eqref{eq:total-system-state-number}。

关于\eqref{eq:total-system-state-number}还有一个值得注意的地方。由于系统1和系统2的能级可以是连续的或者几乎是连续的，$\Omega$应该怎么定义实际上需要进一步澄清。
对能谱连续的情况，设$d(E)$为态密度，然后做以下替换：
\[
    \sum_n \longrightarrow \int , \quad \Omega \longrightarrow d(E) \dd{E},
\]
就得到了正确的结果，也就是
\[
    d_T(E) \dd{E} = \int d_1 (E_1) \dd{E_1} d_2 (E - E_1) (\dd{E} - \dd{E_1}),
\]
即
\begin{equation}
    d_T(E) = \int \dd{E_1} d_1 (E_1) d_2 (E - E_1).
    \label{eq:canonical-state-continue}
\end{equation}
因此我们只需要讨论离散谱的情况，就可以推广到连续谱。
实际上我们完全可以反过来，首先讨论连续谱然后再推广到离散谱。在离散谱情况下，定义
\[
    d(E) = \sum_n \Omega(E^{(n)}) \delta(E - E^{(n)}),
\]
这样得到的$d(E)$是一个一个尖峰。我们取$\epsilon$为能量差的分辨率的尺度，定义
\[
    \Omega_\epsilon (E) = \int_{E-\epsilon/2}^{E+\epsilon/2} \dd{E} d(E),
\]
就恢复到了\eqref{eq:total-system-state-number}。需要注意的是并非所有的$\epsilon$都能够让$\Omega_\epsilon$恢复到$\Omega$。
然而，由于$\Omega(E)$、$d(E)$和$\Omega_\epsilon(E)$之间的换算关系是完全均匀的，当离散谱各能级的间距很小时，可以把等概率原理应用到它们任何一个上面，只要它们服从微正则系综。
因此很多时候并不需要让$\Omega_\epsilon(E)$为实际的处在能级$E$上的量子态个数——实际上，实际计算时也不可能真的算出来实际的处在能级$E$上的量子态个数。

\subsubsection{熵和温度}\label{sec:entropy-and-temperature}

微正则系综下冯诺依曼熵的计算特别容易。由于\eqref{eq:microcanonical-ensemble-density-operator}的形式非常简单，可以直接得到
\[
    S = - \sum_\text{eigenstate $\ket{n}$} \frac{1}{\Omega(E)} \ln \frac{1}{\Omega(E)},
\]
由于求和号内的表达式并不显含$n$，而求和一共进行了$\Omega(E)$次，我们就得到
\begin{equation}
    S(E) = \ln \Omega(E).
    \label{eq:entropy-and-state-number}
\end{equation}
我们把微正则系综中的冯诺依曼熵写成关于能量的函数，因为系统的哈密顿量只是描写了系统的结构，或者说可能有多少能量，却并没有说明系统实际上有多少能量。当然一般情况下，系统的态可以不是能量本征态，所以也说不上有什么确定的能量，但由于本节仅讨论微正则系综，不会出现这种情况。

关于$\Omega$需要特殊说明：如果系统是多粒子系统（任何系统都可以写成多粒子系统），那么交换两个粒子之后得到的状态应该看成同一种，因为无论粒子是费米子还是玻色子，粒子交换都只会让态矢量差一个系数，而不会产生和原来的态矢量线性无关的新态矢量。
换而言之，$\Omega$中因为粒子编号、交换等导致的“多个态”应该被看成是同一个。

实际上，微正则系综的冯诺依曼熵\eqref{eq:entropy-and-state-number}是孤立体系的冯诺依曼熵中最大的。
使用拉格朗日乘子法可以导出这一点。考虑最大化问题
\[
    S = - \trace (\hat{\rho} \ln \hat{\rho}) \quad \text{s.t.} \quad \begin{bigcase}
        \hat{\rho} &= \sum_{E_n=E} \rho_n \dyad{n}, \\
        \trace \hat{\rho} &= 1,
    \end{bigcase}
\]
系统的孤立性意味着系统只能出现在能级$E$上，这也就是上式中我们认为密度算符的所有参与态的能量本征值都是$E$的原因。
$\trace \hat{\rho} = 1$等价于
\[
    \sum_{E_n=E} \rho_n = 1,
\]
且我们有
\[
    S = - \sum_{E_n=E} \rho_n \ln \rho_n,
\]
于是取目标函数为
\[
    u = - \sum_{E_n=E} \rho_n \ln \rho_n + \lambda \left(1 - \sum_{E_n=E} \rho_n\right),
\]
对任意一个$\rho_m$优化，得到
\[
    0 = - \ln \rho_m - 1 - \lambda,
\]
可见所有$\{\rho_n\}$都是相等的，从而
\[
    \hat{\rho} \propto \sum_{E_n=E} \dyad{n},
\]
归一化就得到\eqref{eq:entropy-and-state-number}。因此我们得到\textbf{最大熵原理}：孤立系统达到平衡，当且仅当其冯诺依曼熵（在这个系统可及的范围内，即满足保持各个守恒荷不变等等条件）达到最大。
只要孤立系统的冯诺依曼熵达到了最大值，它就一定已经平衡，并且服从微正则系综。

实际上，\eqref{eq:entropy-and-state-number}可以作为另一种熵的定义，称为\textbf{玻尔兹曼熵}。
玻尔兹曼熵对彼此独立（或者相互作用非常弱）的系统也具有可加性%
\footnote{无论是冯诺依曼熵还是玻尔兹曼熵，都只在两个系统几乎独立的时候才具有可加性。这是它们的定义决定的，在物理上也是合理的。例如，两个具有强烈相互作用的气体系统可能发生化学反应，它们组成的总系统不能够良好地拆分成“子系统”，从而，正如我们预期的那样，总系统的熵并非子系统的熵之和。}%
，因为两个彼此无关的系统组成的总系统的状态数为%
\footnote{实际上如果我们只使用状态数来定义熵，并要求独立系统的熵可加，那么仅有的可能就是玻尔兹曼熵或者玻尔兹曼熵乘以一个常数因子。}%
\begin{equation}
    \Omega_T = \Omega_1 \Omega_2.
\end{equation}
不过，由于\eqref{eq:entropy-and-state-number}的成立是有条件的，玻尔兹曼熵和冯诺依曼熵是不同的。
两者只有在平衡态孤立体系上才是一样的，此时我们统称它们为\textbf{熵}。

相互接触的系统自然地导出了温度的概念。两个系统在孤立时，它们达到平衡时的状况可以各自使用微正则系综描述，从而
\[
    S_1(E) = \ln \Omega_1 (E), \quad S_2 (E) = \ln \Omega_2 (E).
\]
当两个系统发生接触之后，它们就不再是系统1和系统2的冯诺依曼熵了，而是这两个系统的玻尔兹曼熵
设两个系统分别在能级$E_1$和$E_2$上。现在让它们接触。平衡时它们接触而成的总系统的熵为
\[
    S_T(E_T) = \ln \Omega_T (E_T) = \ln \sum_{n} \Omega_1 (E_1^{(n)}) \Omega_2 (E_T - E_1^{(n)}),
\]
其中
\[
    E_T = E_1 + E_2.
\]
当然，由于两个系统之间的相互作用，它们接触之后会发生能量交换，并产生纠缠，因此平衡后的系统的熵并不是$S_1$和$S_2$的简单相加。
但我们总是可以使用$S_1$和$S_2$写出$\Omega_1$和$\Omega_2$的表达式，得到
\begin{equation}
    S_T(E_T) = \ln \sum_{n} \exp \left(S_1(E_1^{(n)})+S_2(E_T-E_1^{(n)})\right).
    \label{eq:combined-system-entropy}
\end{equation}
请注意被求和的函数随着自变量的增长而增长得非常快。对比很大的系统，我们有
\[
    \Omega \sim 2^N,
\]
其中$N$表示系统的粒子数（具体底数是多少不重要，因为$N$很大时底数不改变数量级），从而
\[
    S \sim N.
\]
因此随着系统规模的增长，$S$可以不受限制地增长，这样，对比很大的系统，\eqref{eq:combined-system-entropy}的值几乎完全由它右边的求和式中最大的一项决定，也就是%
\footnote{实际上这就是计算积分近似值时常用的鞍点法。}
\[
    \begin{aligned}
        S_T &= \ln \max_{E_1^{(n)}} \left( \exp \left(S_1(E_1^{(n)})+S_2(E_T-E_1^{(n)})\right) \right) \\
        &= \max_{E_1^{(n)}} \left(S_1(E_1^{(n)})+S_2(E_T-E_1^{(n)})\right),
    \end{aligned}
\]
由于系统规模很大，能谱几乎是连续的，可以认为$E_1^{(n)}$近似为连续变量，从而可以对它求导，通过计算
\[
    \pdv{E_*} \left( S_1(E_*) + S_2(E_T-E_*) \right) = 0
\]
我们得到
\begin{equation}
    \eval{\pdv{S_1(E)}{E}}_{E=E_*} = \eval{\pdv{S_2(E)}{E}}_{E=E_T-E_*}.
    \label{eq:equilibrium-condition-original}
\end{equation}
从而，两系统接触之后形成的总系统平衡时的熵就是
\begin{equation}
    S_T = S_1(E_*) + S_2(E_T-E_*),
\end{equation}
其中$E_*$是\eqref{eq:equilibrium-condition-original}的解。
这也是两系统组成的总系统能够达到的最大熵。

我们注意到一个惊人的事实：如果在两系统接触之前，系统1平衡于能级$E_*$上，系统2平衡于能级$E_T-E_*$上，那么系统1和系统2接触之后立刻就达到了平衡，形成了一个能量为$E_T$的总系统。
这是因为两系统接触之前，它们组成的总系统的熵按照熵的叠加性为
\[
    S_1(E_*) + S_2(E_T-E_*),
\]
恰好就是两系统接触之后的熵。由于$S_T$是两系统组成的总系统能够达到的最大熵，两系统接触前后的密度算符是完全一样的。
于是对任意一个达到平衡的系统——它未必是孤立的——我们定义物理量\textbf{温度}$T$为
\begin{equation}
    \frac{1}{T} = \pdv{S}{E} = \pdv{\ln \Omega}{E},
\end{equation}
其中的$S$指的是这个系统的玻尔兹曼熵，也就是这个系统孤立平衡时它的冯诺依曼熵。
如果两个系统孤立时具有相同的温度，那么它们接触之后立刻达到平衡。
由于两系统接触前后密度算符没有发生变化，两系统接触之后各自的温度毫无变化。%
\footnote{需要注意的是系统接触后密度算符没有变化只有在两个系统的粒子数都比很大时才成立。正如我们在关于正则系综的论述中会看到的那样，一个与外界接触的系统有一定的可能出现在远离其平均能量的能级上，因此显然，两系统接触后密度算符实际上会有一定的变化。然而，当粒子数很大时，这种变化是可以略去的。}%
实际上，两系统接触之后形成的总系统的温度也和两系统的温度一样。这是因为\eqref{eq:equilibrium-condition-original}实际上给出了$E_T$和$E_*$的函数关系，从而
\[
    \begin{aligned}
        \pdv{S_T}{E_T} &= \pdv{E_T} \left(S_1(E_*(E_T)) + S_2(E_T-E_*(E_T))\right) \\
        &= \eval{\pdv{S_1}{E}}_{E=E_*} \dv{E_*}{E_T} + \eval{\pdv{S_2}{E}}_{E=E_T-E_*} \left( 1 - \dv{E_*}{E_T} \right) \\
        &= \left( \eval{\pdv{S_1}{E}}_{E=E_*} - \eval{\pdv{S_2}{E}}_{E=E_T-E_*} \right) \dv{E_*}{E_T} + \eval{\pdv{S_2}{E}}_{E=E_T-E_*} \\
        &= \frac{1}{T}.
    \end{aligned}
\]
总之，温度一致的任意两个系统接触之后立刻达到平衡，且接触之后两个系统的温度没有变化，接触之后形成的总系统的温度就是两个系统的温度。
另一方面，设一个孤立系统是两个子系统接触而形成的，当它达到平衡时，我们会发现其子系统的温度就是这个孤立系统的温度。
% TODO：整理一下这里的论证。实际上可以把这里的论证放到热力学那一节里面
综上我们得出结论：温度相同的平衡态系统

\subsection{开放系统}

\subsubsection{正则系综}

接下来我们讨论系统和环境有较多能量交换，但除此以外不交换任何其它守恒荷的情况。设系统和环境中的一部分之间有能量传递，且这一部分远大于系统，称其为\textbf{热库}。%
\footnote{由于环境远大于系统，如果热库不远大于系统，总是可以将环境中的另外一些部分加入热库使之远大于系统。}%
我们分别用1来标记系统，用2来标记热库。较小的系统和热库组成了一个总系统，这个总系统宏观上是封闭的，微观上则可以受到环境中其它部分的微小作用，因此它满足各态遍历假设。我们关心的小系统却未必能够满足这个假设。
我们假定系统和热库的相交部分非常小（通常情况是，系统和热库接触的部分只是一个表面），这样两者的相互作用哈密顿量并不大，从而没有必要考虑相互作用能，系统和热库的总能量为
\begin{equation}
    E_T = E_s + E_r,
    \label{eq:total-energy}
\end{equation}
其中$E_s$指系统能量，$E_r$指热库能量。此外，我们还假定除了能量以外，系统和外界的守恒荷不存在耦合。%
\footnote{设系统和外界的动力学由于对称性，有守恒荷$\hat{N}$。设系统具有守恒荷$\hat{N}_1$，外界具有守恒荷$\hat{N}_2$，那么
\[
    \hat{N} = \hat{N}_1 + \hat{N}_2.
\]
守恒性意味着
\[
    0 = \comm*{\hat{H}}{\hat{N}} = \comm*{\hat{H}_1 + \hat{H}_2 + \hat{H}_\text{int}}{\hat{N}_1 + \hat{N}_2},
\]
由于对称性，$\comm*{\hat{H}_1}{\hat{N}_1}$和$\comm*{\hat{H}_2}{\hat{N}_2}$都是零，而又由于系统的哈密顿量不可能指挥关于外界的物理量的演化，外界的哈密顿量也不可能指挥系统的哈密顿量的演化，$\comm*{\hat{H}_1}{\hat{N}_2}$和$\comm*{\hat{H}_2}{\hat{N}_1}$也都是零。那么就需要且只需要
\[
    \comm*{\hat{N}_1}{\hat{H}_\text{int}} + \comm*{\hat{N}_2}{\hat{H}_\text{int}} = 0.
\]
这个方程要成立意味着，或者$\hat{N}_2$恒定，从而$\hat{N}_1$恒定，或者$\hat{H}_\text{int}$起到了一个泵的作用，让系统和外界能够交换守恒荷。

$\hat{H}_3$能否驱动守恒荷的交换对体系的性质会有质的改变，因为它们会导致总系统的状态数取不同的形式，从而分别导出正则系综和巨正则系综。
\label{note:without-other-decoupling}}%
描述这样的系统的系综就是\textbf{正则系综}。

接下来我们需要根据等概率原理计算出系统出现在不同的能级的概率。
由于等概率原理是针对系统和热库组成的总系统而言的，我们需要讨论总系统的状态和系统的状态之间的关系。可以取系统的态矢量的一组基矢量为哈密顿量的本征态，标记它们为
\[
    \ket{E, k},
\]
其中$E$表示能量，$k$表示导致能量简并的一些因素，比如说如果自旋不影响能量，那么$k$就可以是自旋。

记总系统的能量为$E_T$。这个能量会有热涨落，但是大体上可以看成恒定。
在其中系统具有能量$E_1$的总系统状态一共有$\Omega_1 (E_1) \Omega_2 (E_T - E_1)$个，因此
\begin{equation}
    P(E_1) = \frac{\Omega_1(E_1) \Omega_2(E_T-E_1)}{\Omega_T(E_T)},
\end{equation}
具有能量$E_1$的彼此独立的态正好就有$\Omega_1(E_1)$个，其中每一个态出现的概率都是$P(E_1) / \Omega_1 (E_1)$，这样系统的归一化的密度算符就是%
\footnote{这隐含了一个条件：密度算符是对角化的，否则不能够直接用各个态出现的经典概率写出密度算符。
但由于已经达到了稳态，$\hat{\rho}$和$\hat{H}$对易，因此两者可以同时对角化，因此在能量表象$\{\ket{n}\}$下密度算符确实是对角化的。}
\[
    \begin{aligned}
        \hat{\rho} &= \sum_{\text{all states of the system}} \dyad{\text{a state with energy $E_1$}} \frac{P(E_1)}{\Omega_1 (E_1)} \\
        &= \sum_n \dyad{n} \frac{\Omega_2 (E_T - E_{1n})}{\Omega_T(E_T)} \\
        &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \Omega_2 (E_T - E_{1n}).
    \end{aligned}
\]
我们并不知道热库的具体结构，因此也无从分析$\Omega_2(E_T-E_{1n})$的表达式。
然而，注意到热库通常来说都是很大的，因此$E_{1n}$相对$E_T$来说总是很小，因此我们能够通过泰勒展开取第一项来分析问题。
由于$\Omega_2$随着热库规模的增大指数增长，实际上我们不能够直接对$\Omega_2 (E_T - E_{1n})$做展开。要看出为什么，注意到
\[
    \Omega_2 (E_T - E_{1n}) \sim (E_T - E_{1n})^M,
\]
其中$M$与热库规模——例如其粒子数——同阶。这样就有
\[
    \Omega_2 (E_T - E_{1n}) \sim E_T^M \left( 1 - M \frac{E_{1n}}{E_T} + \frac{1}{2} M (M-1) \left(\frac{E_{1n}}{E_T}\right)^2 + \cdots \right),
\]
$M$的巨大数量级意味着取一阶展开有可能并不能达到足够的精度。
为此我们使用一个技巧：展开
\[
    \exp(\ln \Omega_2(E_T-E_{1n})) \sim \exp \left( M \ln (E_T - E_{1n}) \right),
\]
由于$M$不再出现在展开式当中，从$E_{1n}$相比总能量$E_T$很小这个事实就可以直接取一阶展开式了。于是
\[
    \begin{aligned}
        \hat{\rho} &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \Omega_2 (E_T - E_{1n}) \\
        &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \ee^{\ln \Omega_2 (E_T - E_{1n})} \\
        &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \exp \left( \ln \Omega_2 (E_T) - \eval{\pdv{\ln \Omega_2 (E)}{E}}_{E=E_T} E_{1n} + \cdots \right),
    \end{aligned}
\]
仅保留到一阶项，并重新定义常数，就得到
\begin{equation}
    \hat{\rho} = \frac{1}{Z} \sum_n \dyad{n} \ee^{-\beta E_n} = \frac{1}{Z} \sum_{n, i} \ee^{-\beta E^{(n)}} \Omega(E^{(n)}) \dyad{E^{(n)}, i}.
    \label{eq:canonical-ensemble-density-operator}
\end{equation}
这里我们已经为了书写简便将$E_{1n}$简写为了$E_n$，因为一旦得到了\eqref{eq:canonical-ensemble-density-operator}，我们就完全只使用系统以及一些常数得到了系统的状态，而不再有必要考虑热库的结构了。
但热库并非对系统的状态毫无影响。可以看到
\[
    \beta = \eval{\pdv{\ln \Omega_2 (E)}{E}}_{E=E_T},
\]
由于热库远大于系统，$E_T$近似就是热库的能量$E_2$，于是
\begin{equation}
    \beta = \eval{\pdv{\ln \Omega_2 (E)}{E}}_{E=E_2} = \frac{1}{T}.
\end{equation}
这里$T$指的是热库的温度，由于系统和热库共同达到了平衡，这就是系统的温度。%
\footnote{顺带提一句，这也意味着热库的状态数可以写成
\[
    \Omega_2(E) = \gamma \ee^{\beta E},
\]
其中$\gamma$是一个和$E$无关的常数。
\label{note:res-state-number}
}%
容易看出归一化因子$Z$就是\autoref{sec:relative-density-operator}中提到的配分函数，于是
\begin{equation}
    Z = \trace \ee^{-\beta \hat{H}} = \sum_n \ee^{-\beta E_n} = \sum_{E^{(n)}} \Omega(E^{(n)}) \ee^{-\beta E^{(n)}}.
    \label{eq:partition-function-canonical-ensemble}
\end{equation}
这里将$\Omega_1(E)$简写为$\Omega(E)$，因为有了\eqref{eq:canonical-ensemble-density-operator}之后就不再需要考虑热库了。
注意到$\Omega(E)$的“分辨率”，或者说能量相差多小的量子态被看作是在同一能级上，完全不影响\eqref{eq:canonical-ensemble-density-operator}。

因为各$\ket{n}$彼此正交，\eqref{eq:canonical-ensemble-density-operator}意味着，能量$E^{(n)}$出现的概率为
\begin{equation}
    P(E^{(n)}) = \frac{\Omega(E^{(n)})}{Z} \ee^{-\beta E^{(n)}}.
    \label{eq:boltzmann-distribution}
\end{equation}
这种较高的能量出现的概率指数下降的分布为\textbf{玻尔兹曼分布}。
与微正则系综不同，正则系综中由于热库的存在，系统可以出现在不同能量的能级上。
这也就是微正则系综在名称上似乎比正则系综“小”的原因：微正则系综中系统可能出现的状态少于正则系综。
玻尔兹曼分布的表达式中，随着能量上升，$\exp (-\beta E)$快速下降，而另一方面$\Omega(E)$却在上升——这是组合学的必然结论，因为
\[
    \hat{H} = \sum_{\text{single particle}} \hat{H}_i + \text{interaction},
\]
系统在较低的能级上时，所有粒子都应该具有较低的能量（否则，如果一些粒子的能量很高，另一些粒子的能量就变成了负数，矛盾），而系统在较高的能级上时，可以所有粒子都具有较高的能量，也可以有一些粒子能量很低而另一些粒子能量很高。
因此最后的$P(E)$与$E$的关系会是一个峰：$E$较低时指数因子$\exp (-\beta E)$不是特别小，随着$E$增长，$\Omega(E)$快速增长；而当$E$很大时，指数因子完全盖过了$\Omega(E)$带来的增长。

需要指出的是，\eqref{eq:canonical-ensemble-density-operator}和\eqref{eq:partition-function-canonical-ensemble}在任何绘景下都是成立的。
可以从两方面看出这一点：首先，我们导出这些公式时没有用到任何和时间演化相关的知识；其次，平衡态的密度算符和绘景选取无关。

为方便起见，常定义
\begin{equation}
    \rho_n = \mel{n}{\hat{\rho}}{n} = \frac{1}{Z} \ee^{-\beta E_n},
\end{equation}
并设函数$\rho(E)$为一个满足
\begin{equation}
    \rho(E_n) = \rho_n
\end{equation}
的且足够平滑的函数，称为\textbf{分布函数}。这样一来，
\begin{equation}
    P(\text{energy is $E$}) = \Omega(E) \rho(E).
\end{equation}
在能谱几乎是连续的情况下，这就是
\[
    \dd{P} = \dd{\Omega} \rho(E),
\]
从而
\begin{equation}
    \rho(E) = \dv{P}{\Omega}.
\end{equation}
相应的，概率相对能量的密度为
\begin{equation}
    W(E) = \dv{P}{E} = \dv{P}{\Omega} \dv{\Omega}{E} = \rho(E) \dv{\Omega}{E}.
    \label{eq:canonical-ensemble-probablity-density}
\end{equation}

\subsubsection{熵和温度}

首先指出一个事实：玻尔兹曼分布\eqref{eq:canonical-ensemble-density-operator}是让熵取极大值的分布。可以使用拉格朗日乘子法导出这一点。记$\hat{\rho}$为归一化的密度算符，则%
\footnote{这只是一个条件，但我们只需要说明“所有可能的熵极大值都对应吉布斯平衡态”即可，如果只使用这个条件就能够推出这个结论，那就没有问题。}
\[
    \trace \hat{\rho} = 1.
\]
平衡态时系统的能量的期望恒定，于是
\[
    \trace (\hat{\rho} \hat{H}) = E = \const.
\]
从而，只需要最大化
\[
    S = - \trace (\hat{\rho} \ln \hat{\rho}) \quad \text{s.t.} \; \begin{bigcase}
        \trace \hat{\rho} &= 1, \\
        \trace (\hat{\rho} \hat{H}) &= E
    \end{bigcase}
\]
即可。取目标函数为
\[
    u = - \trace (\hat{\rho} \ln \hat{\rho}) + \gamma (E - \trace (\hat{\rho} \hat{H})) + \gamma' (1 - \trace \hat{\rho}),
\]
对$\hat{\rho}$优化得到
\[
    \ln \hat{\rho} + 1 + \gamma \hat{H} + \gamma' = 0,
\]
从而得到
\[
    \hat{\rho} = \exp (-(1+\gamma')) \exp(- \gamma \hat{H}).
\]
重新定义常数，得到
\[
    \hat{\rho} = \frac{1}{Z} \ee^{-\beta \hat{H}}.
\]
由于$\hat{\rho}$的迹为1，自然的就有
\[
    Z = \sum_\text{eigenstate $\ket{n}$} \ee^{-\beta E_n}.
\]
这正是玻尔兹曼分布。这表明，任何系统到达平衡态时熵都取极大值。

熵在平衡态的表达式还可以使用分布函数写出。首先我们有
\[
    S = - \expval*{\ln \hat{\rho}} = - \expval*{\ln \rho_n},
\]
而$\rho_n$的对数和能量之间有线性关系：
\[
    \ln \rho_n = - \beta E_n - \ln Z,
\]
于是
\[
    \expval*{\ln \rho_n} = \ln \rho(\bar{E}),
\]
我们就得到
\begin{equation}
    S = - \ln \rho(\bar{E}).
\end{equation}
在体系能级离散（但又分布得足够密，以至于总是可以找到一个能级，其能量几乎就是$\bar{E}$）时，我们有
\[
    \rho(\bar{E}) \Omega(\bar{E}) = P(\bar{E}) \approx 1,
\]
于是
\begin{equation}
    S = \ln \Omega(\bar{E}).
\end{equation}
我们于是就一个和微正则系综非常类似的熵表达式。当然，能写出这种表达式的原因是系综等价性：大系统使用什么系综描述都是一样的。

在系统粒子数足够多以至于能谱基本上是连续的时不再有分立的$\Omega(\bar{E})$，或者说由于我们并不需要完全精确的能谱，$\Omega(\bar{E})$“弥散”到附近的能量上。
系统出现在能级$E$上的概率和$E$之间的关系是一个先上升后下降的曲线，因此通过
\begin{equation}
    W(\bar{E}) \Delta E = 1
\end{equation}
定义的$\Delta E$量度了峰的宽度。
回顾\eqref{eq:canonical-ensemble-probablity-density}，我们有
\[
    \rho(\bar{E}) \eval{\dv{\Omega}{E}}_{E=\bar{E}} \Delta E = 1.
\]
马上可以注意到，
\begin{equation}
    \Delta \Omega = \eval{\dv{\Omega}{E}}_{E=\bar{E}} \Delta E
\end{equation}
给出了峰附近的态的数目（只具有数量级的意义，因为准确的值需要通过积分算出来），于是
\[
    \rho(\bar{E}) = \frac{1}{\Delta \Omega},
\]
从而
\begin{equation}
    S = \ln \Delta \Omega.
    \label{eq:canonical-entropy-and-number-of-states}
\end{equation}
关于\eqref{eq:canonical-entropy-and-number-of-states}的导出有几个应当说明的地方。首先，它的导出一定依赖于能谱几乎连续这一事实，否则$\bar{E}$不一定会落在任何一个能级上，则类似于$W(\bar{E})$（既然能谱离散，它实际上是$\Omega(E)$乘上一个$\delta$函数）这样的表达式全部为零，因此不可能导出\eqref{eq:canonical-entropy-and-number-of-states}。
然而，一旦能谱连续，出现在\eqref{eq:canonical-entropy-and-number-of-states}中的对数函数中的$\Delta\Omega$就不可能是真正的“某个能级上的独立状态数”，因为既然$\Omega$关于$E$连续分布，一个完全确定的$E$对应的独立状态数实际上是零。
因此我们通过计算“峰附近的独立状态数”引入了一个$\Delta\Omega$，这才让\eqref{eq:canonical-entropy-and-number-of-states}成立。
$\Delta\Omega$可以不是任何一个实际的能级上的独立状态数。
最后，我们能够得到\eqref{eq:canonical-entropy-and-number-of-states}是可以预期的，因为在热力学极限下，正则系综实际上就是微正则系综，因此只有峰附近的状态才是重要的，于是做替换$\Omega\longrightarrow \Delta\Omega$就可以。

实际上，玻尔兹曼分布的形式\eqref{eq:boltzmann-distribution}也反映了能量和熵的竞争关系，能量增大，相应状态出现的概率会下降，而一种状态的熵增大，它出现的概率会上升。最终的极大概然分布就是两者达到某种“平缓”的位置。

\subsubsection{巨正则系综}\label{sec:grand-canonical-ensemble}

现在我们考虑系统不仅和外界交换能量，而且还交换除此以外的守恒荷的情况，这样得到的系综称为\textbf{巨正则系综}。

设系统内有$s$种不同的守恒荷，它们记作$\hat{N}_1, \hat{N}_2, $等等，则系统的哈密顿量和这些守恒荷算符对易。
然而，系统中的守恒荷却未必守恒，因为系统可以和外界交换这些守恒荷，例如整个宇宙中的电荷守恒，但是具体一个绝缘体上的静电却可以不守恒，因为我们可以给它电荷或者从它上面导出电荷。（在量子力学中怎么处理这种情况见\autoref{note:without-other-decoupling}）
我们将会和系统交换守恒荷的那部分环境称为\textbf{粒子库}，因为守恒荷通常都是粒子携带的。
系统中的守恒荷加上粒子库中的守恒荷的和是守恒的，因为总系统中的守恒荷算符和总系统的哈密顿量对易，而总系统中的一切都按照总系统的哈密顿量（系统的哈密顿量只是它的一部分）发生时间演化。

由于系统的哈密顿量和各个守恒荷算符彼此对易，系统的哈密顿量的本征态可以被标记为
\[
    \ket{E^{(i)}, N_1^{(j_1)}, N_2^{(j_2)}, \ldots, k},
\]
我们使用和\autoref{sec:contacting-systems}中一样的记号，使用右上角标标记各可观察量的不同本征值。$k$指的是可能出现的额外的自由度，因为仅仅使用守恒荷可能不足以完全区分$\hat{H}$的简并本征态。

仿照\eqref{eq:total-system-state-number}，我们有
\begin{equation}
    \begin{aligned}
        \Omega_T (E, N_1, \ldots, N_s) = \sum_{m, n_1, \ldots, n_s} &\Omega_1 (E_1^{(m)}, N_{1,1}^{(n_1)}, \ldots, N_{1,s}^{(n_s)}) \\
        &\times \Omega_2(E-E_1^{(m)}, N_1 - N_{1,1}^{(n_1)}, \ldots, N_s - N_{1,s}^{(n_s)}).
    \end{aligned}
\end{equation}
同样，$E-E^{(m)}_1$虽然可能并不是热库的哈密顿量的本征值，但由于热库很大，它总是几乎是热库的哈密顿量的本征值。
按照\autoref{sec:contacting-systems}中的方式也可以得到连续能谱情况下的表达式。由于连续能谱意味着守恒荷很大，我们也可以把诸$N_i$看成连续的，从而做替换
\[
    \sum \longrightarrow \int, \quad \Omega \longrightarrow d(E, N_1, \ldots, N_s) \dd{E} \dd{N_1} \cdots \dd{N_s},
\]
最终得到
\begin{equation}
    \begin{aligned}
        d_T(E, N_1, \ldots, N_s) = \int \dd{E_1} \dd{N_{1,1}} \cdots \dd{N_{1,s}} &d_1(E_1, N_{1,1}, \ldots, N_{1,s}) \\
        &\times d_2(E-E_1, N_1-N_{1,1}, \ldots, N_s-N_{1,s}).
    \end{aligned}
    \label{eq:grand-canonical-ensemble-states}
\end{equation}

推导密度算符的方法和正则系综是完全一样的。将系统、热库和粒子库放在一起组成总系统，由于总系统适用微正则系综，我们有
\[
    P(E_{1,1}, N_{1,1}, \ldots, N_{1,s}) = \frac{\Omega_1(E_{1,1}, N_{1,1}, \ldots, N_{1,s})\Omega_2(E_T-E_{1,1}, N_{T,1}-N_{1,1}, \ldots, N_{T,s}-N_{1,s})}{\Omega(E_T, N_{T,1}, \ldots, N_{T,s})},
\]
在数学上$E,N_1,\ldots$的地位完全是相同的，因此我们可以照搬正则系综的推导，得到
\[
    \hat{\rho} = \const \cdot \sum_n \dyad{n} \exp\left(-\beta E_n - \sum_i \alpha_i N_{i,n}\right),
\]
或者通过重新定义常数，有
\begin{equation}
    \hat{\rho} = \frac{1}{\Xi} \sum_n \dyad{n} \exp \left(-\beta \left(E_n - \sum_i \mu_i N_{i,n}\right)\right) = \frac{1}{\Xi} \ee^{- \beta \left( \hat{H} - \sum_i \mu_i \hat{N}_i \right) }.
    \label{eq:grand-canonical-ensemble-density-operator}
\end{equation}
同样我们使用$E,N_1,\ldots$特指系统的能量、第一种守恒荷、第二种守恒荷，等等。
其中$\Xi$称为\textbf{巨配分函数}，为
\begin{equation}
    \Xi =  \sum_n \exp \left(-\beta \left(E_n - \sum_i \mu_i N_{i,n}\right)\right) = \trace \ee^{- \beta \left( \hat{H} - \sum_i \mu_i \hat{N}_i \right) },
\end{equation}
其中$\mu$称为\textbf{化学势}。很容易看出实际上这就是拉格朗日乘子（考虑高温极限，即能量最低，就能够看出这一点）。
会出现这种拉格朗日乘子是因为我们对场构型做了一个约束，即对所有场构型求和时实际上有一个形如$\delta(N_i - N_{i0})$的因子，把这个因子写到指数上%
\footnote{
    可以将$\delta$函数做傅里叶变换，就得到了$\ee^{\ii k (N_i - N_{i0})}$因子，并引入了一个新的自由度$k$。固定一个$k$，我们就得到了巨配分函数，而$k$其实就是化学势。
}%
就会导致一个拉格朗日乘子项。
这个构造实际上是非常常见的，例如，非相对论性粒子和电磁场耦合时，电势实际上就是一种化学势。

在守恒荷是由$U(1)$对称性提供的情况下，它实际上就是粒子数：$U(1)$对称性要求哈密顿量中的每一项含有同样数目的产生算符和湮灭算符，这样给产生算符乘上一个单位复数因子$\ee^{\ii \alpha}$时湮灭算符被乘上了$\ee^{ - \ii \alpha}$，于是哈密顿量整体不变；哈密顿量中的每一项含有同样数目的产生算符和湮灭算符又意味着，不会有粒子数的变化。
很多教科书会选择直接讨论以粒子数为守恒荷的巨正则系综，不过巨正则系综不仅仅适用于这种情况。

计算巨配分函数可以以用这样的方法：对每个守恒荷取值$N$，计算固定该守恒荷的值为$N$时对应的正则配分函数$Z(N)$，然后做叠加
\begin{equation}
    \Xi = \sum_{N} Z(N) \ee^{\beta \mu N}.
\end{equation}

\subsubsection{三种系综之间的等价性}

我们使用微正则系综导出了正则系综，然后又把正则系综推广到了巨正则系综。
而实际上，在粒子数很大时微正则系综、正则系综和巨正则系综实际上是彼此等价的。

先考虑正则系综和微正则系综之间的关系。
我们知道$P(E)$和$E$之间的关系\eqref{eq:boltzmann-distribution}是一条有一个峰的曲线，由于
\[
    \Omega \sim 2^N, \quad E \sim N,
\]
当粒子数很大时\eqref{eq:boltzmann-distribution}中的两个因子一个快速上升一个快速下降，因此当粒子数很大时\eqref{eq:boltzmann-distribution}实际上是一个非常尖锐的峰。
大粒子数意味着我们可以把能谱看成连续的，从而峰的位置$E_\text{peak}$可以通过求解
\[
    \eval{\pdv{E} (\Omega(E) \ee^{-\beta E})}_{E=E_\text{peak}} = 0
\]
或者等价的
\[
    \beta = \eval{\pdv{\ln \Omega}{E}}_{E=E_\text{peak}}
\]
得到，其中$\Omega$指的是系统的简并数。既然\eqref{eq:boltzmann-distribution}仅在$E_\text{peak}$附近非零，\eqref{eq:canonical-ensemble-density-operator}就成为
\[
    \hat{\rho} = \frac{1}{Z} \sum_i \Omega(E_\text{peak}) \ee^{-\beta E_\text{peak}} \dyad{E_\text{peak}, i},
\]
从而
\[
    Z = \Omega(E_\text{peak}) \ee^{-\beta E_\text{peak}},
\]
代入\eqref{eq:canonical-expectation-of-energy}，得到
\[
    \bar{E} = E_\text{peak},
\]
结合以上各式，在粒子数很大时（称为\textbf{热力学极限}），我们有
\begin{equation}
    \hat{\rho} = \frac{1}{\Omega(\bar{E})} \sum_{E_n=\bar{E}} \dyad{n}. 
\end{equation}
因此在热力学极限下，正则系综实际上就是一个以$\bar{E}$为能量的微正则系综。
从以上推导过程也可以看出，微正则系综实际上只是追踪了$P(E)-E$曲线峰值附近的那一部分系统，而正则系综考虑了整条曲线，但在热力学极限下，两者并无区别，因为远离峰的状态几乎不可能出现。

以上推导从正则系综出发，得到了微正则系综；实际上从微正则系综出发也可以得到正则系综。
想象总能量恒定的一个系统，我们给它做$M$份复制品，让它们组成一个微正则系综。由于系统很大，在这些复制品之间引入小的相互作用不会显著改变每个系统的行为。
这样，每个复制品周围与之接触的系统就可以成为它的热库，从而微正则系综在系统很大时就是正则系综。

表面上看，巨正则系综似乎应该也是一种正则系综，因为在已知$d(E, N_1, \ldots, N_s)$时，仅仅考虑量子态在能量上的分布，就得到
\[
    d(E) = \int \dd{N_1} \dd{N_2} \cdots \dd{N_s} d(E, N_1, \ldots, N_s),
\]
在\eqref{eq:grand-canonical-ensemble-states}中应用此式，积掉所有守恒荷变量就得到
\[
    d_T(E) = \int \dd{E_1} d_1(E_1) d_2(E-E_1),
\]
这正是正则系综的状态数公式\eqref{eq:canonical-state-continue}。从这个公式结合等概率原理就能够推导出正则系综。
但如果真的这样计算，得到的密度算符中将不会出现$\mu \hat{N}$项，从而产生矛盾。差错出现在什么地方？
其原因在于，由于系统和粒子库可以发生守恒荷的交换，系统具有不同守恒荷的态出现的概率并不相等。

这又产生了一个新的问题。如果系统和外界虽然能够交换某种守恒荷，但是交换速度很慢，那又会怎么样？显然，系统从一个任意的态出发，会很快收敛到一个正则系综；但随后，由于系统和外界终究还是会交换守恒荷，系统将会经历一个时间尺度更长的过程，从（近似的）正则系综过渡到巨正则系综。
这种情况下，是将系统看成正则系综还是巨正则系综完全取决于要讨论的问题的时间尺度是不是足够看到系统和外界交换较多的守恒荷。

% TODO：所以实际上完全可以这样导出各种系综：把微正则系综的密度算符迹掉热库，得到正则系综；迹掉一个热库和粒子库，得到巨正则系综，等等。

虽然如此，巨正则系综和正则系综并非没有联系。有两种方法可以将一个巨正则系综的问题转化为一个正则系综的问题。\eqref{eq:grand-canonical-ensemble-density-operator}由于$\hat{H}$和诸守恒荷算符对易，可以写成
\[
    \hat{\rho} = \frac{1}{\Xi} \ee^{-\beta \hat{H}} \ee^{\beta \sum_i \mu_i \hat{N}_i},
\]
于是可以把守恒荷算符部分迹掉%
\footnote{回顾\autoref{sec:combining-systems}节中关于约化密度算符的论述，我们把系统哈密顿量以及额外的自由度$k$提供的信息看成一个系统，把系统守恒荷算符提供的信息看成另一个系统，将密度算符中守恒荷部分求迹，就能够得到一个约化密度算符。}，得到
\begin{equation}
    \trace_{\hat{N}} \hat{\rho} = \frac{1}{\Xi} \trace \left( \ee^{\beta \sum_i \mu_i \hat{N}_i} \right) \ee^{-\beta \hat{H}}.
    \label{eq:trace-out-particle-number}
\end{equation}
因此凡是只通过$\hat{H}$和$\Xi$就能够得到的信息也可以通过密度算符$\trace_{\hat{N}} \hat{\rho}$连同一个按照\eqref{eq:partition-function-with-disturbance}做过扰动的配分函数$Z(\beta, \lambda)$计算得到，因为巨配分函数$\Xi$正好具有\eqref{eq:partition-function-with-disturbance}的形式，因此它正是正则系综受到守恒荷算符扰动之后得到的配分函数。从而，从今以后没有必要特别明确地区分巨配分函数和正则系综的配分函数——两者实际上是一回事。
但解析求解时，守恒荷算符的出现实际上可以简化计算，因此巨正则系综仍然是非常有用的。

第二种将巨正则系综和正则系综联系起来的方式是，注意到我们可以通过一些宏观的论证来比较容易地计算出化学势（见\autoref{sec:from-statistical-to-thermo}），那么诸化学势实际上是已知的，所以我们可以重新定义哈密顿量为
\[
    \hat{H}_\text{eff} = \hat{H} - \sum_i \mu_i \hat{N}_i,
\]
则以$\hat{H}_\text{eff}$为哈密顿量的正则系综正是以$\hat{H}$为哈密顿量的巨正则系综。%
\footnote{需注意要使用以$\hat{H}_\text{eff}$为哈密顿量的正则配分函数，而不是巨正则配分函数，也就是需要对所有可能的守恒荷求和而把化学势这个自由度求和掉。}%
还可以从另一个方面看$\hat{H}_\text{eff}$的意义。光有系统的哈密顿量是不足以确定系统的动力学的，因为系统和环境有相互作用。而我们看到，用从系统的哈密顿量中减去化学势乘以守恒荷这一项之后得到的$\hat{H}_\text{eff}$做正则系综，得到的结果和完整考虑热库作用的巨正则系综完全一致，这表明$- \sum_i \mu_i \hat{N}_i$项实际上正是环境作用对系统哈密顿量引入的修正。
将这一项加入哈密顿量中，环境作用就被完整地考虑了。

最后，我们总是可以让所有化学势都取零，此时巨正则系综就变成了正则系综，相应的守恒荷可以不再守恒。%
\footnote{需要注意的是能这么做的前提是计算巨正则系综和计算正则系综时使用的是同一个哈密顿量。
然而，很多时候在计算正则系综时我们会使用一个守恒荷的量已经被硬编码的哈密顿量，而计算巨正则系综时我们会使用一个更加一般的哈密顿量（例如，计算正则系综时使用一次量子化、粒子数固定的哈密顿量，计算巨正则系综时使用二次量子化哈密顿量），如果是这样，那么令化学势为零也不能让巨正则系综直接退化到正则系综。
这也是可以理解的，因为令化学势为零得到的是原本的守恒荷实际上可以随意变化而并不真的守恒的系综，而不是守恒荷确实守恒但和外界不能交换的系综。
}%
因此，形式上我们可以将巨正则系综当成平衡态系统的密度算符的一般形式。

在热力学极限下，微正则系综等价于正则系综，而巨正则系综通过哈密顿量的代换可以转化为一个正则系综，也即，三种系综在热力学极限下是等价的，因此在推导热力学极限下的一般性结论时通常在数学性质较良好而又相对简单的正则系综下工作。
在无需考虑系统和外界相互作用的时候，可以使用微正则系综；在需要理论上分析系统和外界相互作用时，可以使用正则系综；在做具体计算时，巨正则系综有时候能够提供更多的便利，因为此时可以将“守恒荷总量等于某个定值”这个约束去掉。
需要注意的是正则系综和巨正则系综之间的等价性并不意味着化学势不是独立的坐标——即使用正则系综描述系统，不同的$\mu$值也会导致不同的等效哈密顿量$\hat{H}-\sum_i \mu_i \hat{N}_i$。

\subsection{基于配分函数的计算}

\subsubsection{从正则配分函数计算各物理量}\label{sec:calculation-from-canonical-partition}

既然对充分大的系统正则系综、巨正则系综、微正则系综彼此等价，只需要讨论清楚正则系综中各种物理量的计算就可以了。
实际上，要做到这一点只需要正则系综的配分函数即可。

下面计算各可观察量的期望值。能量的期望可以直接从配分函数中读出来。注意到
\[
    \bar{E} = \expval*{\hat{H}} = \sum_i E^{(i)} P(E^{(i)}) = \frac{1}{Z} \sum_i E^{(i)} \Omega(E^{(i)}) \ee^{- \beta E^{(i)}} = \frac{1}{Z} \sum_\text{eigenstate $\ket{n}$} E_n \ee^{-\beta E_n} ,
\]
可以得到
\begin{equation}
    \bar{E} = \expval*{\hat{H}} = - \frac{1}{Z} \pdv{Z}{\beta} = - \pdv{\ln Z}{\beta}.
    \label{eq:canonical-expectation-of-energy}
\end{equation}
其余物理量的计算略微麻烦一些。为方便起见，先考虑一个受到外部扰动的哈密顿量
\begin{equation}
    \hat{H}' = \hat{H} + \lambda \hat{A},
\end{equation}
记它的配分函数为
\begin{equation}
    Z(\beta, \lambda) = \trace \ee^{-\beta (\hat{H} + \lambda \hat{A})}
    \label{eq:partition-function-with-disturbance}
\end{equation}
显然，取$\lambda = 0$我们就回退到了没有扰动的系统的配分函数。
我们尝试写出\eqref{eq:partition-function-with-disturbance}在$\lambda$很小时的表达式。
在$\lambda$很小时，$\hat{H} + \lambda \hat{A}$的各个本征态仍然满足正交归一化条件（实际上不管$\lambda$多大都是如此），且相对诸$\ket{n}$只有微小的偏移，由微扰论我们知道，略微偏离态$\ket{n}$的$\hat{H} + \lambda \hat{A}$的本征值约为
\[
    E'_n = E_n + \lambda \mel{n}{\hat{A}}{n},
\]
从而我们有
\[
    \begin{aligned}
        Z(\beta, \lambda) &= \sum_{\text{eigenstate $\ket{n'}$}} \ee^{- \beta E'_n} \\
        &= \sum_{\text{eigenstate $\ket{n}$}} \ee^{- \beta (E_n + \lambda \mel{n}{\hat{A}}{n})}.
    \end{aligned}
\]
第二个等号要求$\lambda$充分小。
因此在$\lambda$很小时，
\[
    \begin{aligned}
        \pdv{Z(\beta, \lambda)}{\lambda} &= \sum_{\text{eigenstate $\ket{n}$}} (-\beta \mel{n}{\hat{A}}{n}) \ee^{-\beta (E_n + \lambda \mel{n}{\hat{A}}{n})} \\
        &= - \beta \sum_{\text{eigenstate $\ket{n}$}} \mel{n}{\hat{A}}{n} \ee^{- \beta E_n} \quad \text{as $\lambda \to 0$},
    \end{aligned}
\]
而
\[
    \expval*{\hat{A}} = \frac{1}{Z} \sum_\text{eigenstate $\ket{n}$} \mel{n}{\hat{A}}{n} \ee^{- \beta E_n},
\]
因此
\begin{equation}
    \expval*{\hat{A}} = - \frac{1}{\beta Z} \eval{\pdv{Z(\beta, \lambda)}{\lambda}}_{\lambda = 0} = - \frac{1}{\beta} \eval{\pdv{\ln Z(\beta, \lambda)}{\lambda}}_{\lambda=0}.
    \label{eq:lambda-disturbance}
\end{equation}
于是我们从配分函数得到了所有可观察量的期望。

为了避免反复书写$\beta$这个数，我们做代换
\[
    - \beta \lambda = J,
\]
此时就有
\begin{equation}
    Z(\beta, J) = \trace \ee^{-\beta \hat{H} + J \hat{A}},
\end{equation}
在我们有一系列$\{\hat{A}_i\}_i$时，可以定义
\begin{equation}
    Z(\beta, J) = \trace \ee^{-\beta \hat{H} + \sum_i J_i \hat{A}_i },
\end{equation}
使用这个形式的配分函数（此时称为\textbf{生成函数}），就有
\begin{equation}
    \expval*{\hat{A}_{k_1} \hat{A}_{k_2} \cdots \hat{A}_{k_n}} = \frac{1}{Z(\beta,0)} \eval{\frac{\partial^n Z}{\partial J_{k_1} \partial J_{k_2} \cdots \partial J_{k_n}}}_{J=0}.
    \label{eq:correlation-function-from-partition-function}
\end{equation}
而能量的期望还是\eqref{eq:canonical-expectation-of-energy}。注意在使用$Z(\beta, \lambda)$形式的生成函数时这个式子不成立，因为指数上有$\lambda$和$\beta$的乘积。
任何在统计物理上有意义的物理量——无论是宏观统计量还是微观量——都可以写成一些可观察量的某个函数的期望，因此\eqref{eq:correlation-function-from-partition-function}意味着，只需要计算出配分函数实际上就得到了一个系统的所有统计物理性质。

配分函数也可以用于计算可观察量的涨落，即它偏离平均值的大小。定义涨落为其标准差，即
\begin{equation}
    (\Delta A)^2 = \expval*{(\hat{A} - \expval*{A})}^2 = \expval*{\hat{A}^2} - \expval*{A}^2,
\end{equation}
即可使用\eqref{eq:correlation-function-from-partition-function}计算出涨落。对非能量的物理量，用上式可以得到
\begin{equation}
    (\Delta A)^2 = \pdv[2]{\ln Z}{J}.
\end{equation}
对能量，涨落的表达式特别简单，就是
\begin{equation}
    (\Delta E)^2 = \pdv[2]{\ln Z}{\beta}.
\end{equation}
当系统非常大且$A$涉及很大一部分系统时（此时称$A$为\textbf{热力学量}），记$N$是表征系统大小的某个参量（例如如果系统粒子数守恒，那么$N$就可以是粒子数），则
\[
    Z \sim 2^N,
\]
于是
\[
    A \sim N, \quad (\Delta A)^2 \sim N,
\]
则
\[
    \frac{\Delta A}{A} \sim \frac{1}{\sqrt{N}}.
\]
因此任何一个物理量——不单单是能量——的测量值的概率分布实际上是一个非常窄的峰，峰的位置就是期望值，也即，一个物理量的平均值就是其极大概然值。%
\footnote{表面上看可以很快举出反例：理想气体的麦克斯韦速度分布律中，速度平均值就不是极大概然值。但实际上，单个分子的速度并不涉及很大的系统——它仅仅涉及单个分子——因此的确不适用这里的结论。
}%
于是我们可以把热力学量的值看成是完全确定的，例如
\[
    f(\expval*{A}) = \expval*{f(A)},
\]
等等。相应的，如果$\hat{A}$与哈密顿量对易，则可以在密度算符的表达式中使用其值标记各参与态，即
\[
    \hat{\rho} = \sum_n \rho_n \dyad{E_n, A_n, \text{something else}},
\]
而由于$\rho_n$在$A_n = \expval*{A}$时压倒性得大，上式可以写成
\[
    \hat{\rho} = \sum_n \rho_n \dyad{E_n, A, \text{something else}}.
\]
这在计算一些量的期望值时可以带来很大方便。

在连续极限下，$\hat{A}_i$变成了量子场$\hat{A}(\vb*{x})$，我们这就得到了所谓的\textbf{平衡态统计场论}，这只需要将偏导数换成偏泛函导数$\fdv{\phi}$即可。此时的配分函数为
\begin{equation}
    Z[J] = \int \fd{\phi} \ee^{-\beta \int \dd[D]{\vb*{r}} (\mathcal{H}[\phi(\vb*{r})] + J(\vb*{r}) \phi(\vb*{r}))}.
    \label{eq:path-integral-equilibrium}
\end{equation}

与量子场论中的路径积分相比较，$\hbar$的地位和$T=1/\beta$的地位类似。不同的$T$对应着不同的行为，正如不同的$\hbar$（实际上$\hbar$固定不变，场值在变，但也可以等效地认为场值不变而$\hbar$在变）对应不同的行为。
不过，实际计算时很多时候并不会把$\beta$替换为$1$（因为大部分系统的温度都会发生变化），而是把它当成对一个时间维的积分。

也可以通过配分函数计算熵。直接使用冯诺依曼熵的定义，可以计算得到
\begin{equation}
    S = \ln Z - \beta \pdv{\ln Z}{\beta}.
    \label{eq:entropy-from-partition-function}
\end{equation}
无论使用的是不带外部扰动的配分函数$Z(\beta)$还是带外部扰动的$Z(\beta, J)$，上式均成立。使用$Z(\beta, \lambda)$时上式不成立，因为这个表达式中有$\beta$和$\lambda$相乘的部分。

使用配分函数计算物理量期望值时，可以在$Z$上乘上一个常数因子，对最后得到的结果毫无影响；使用配分函数计算熵时，在$Z$上乘上一个因子会导致熵变化一个常数。
现在设想有两个彼此无关的系统，则容易证明它们组成的总系统的配分函数是
\begin{equation}
    Z = Z_1 Z_2,
\end{equation}
其中$Z_1$和$Z_2$分别是两个系统的配分函数。使用\eqref{eq:entropy-from-partition-function}，可以发现熵是可加的，正如我们使用密度算符证明的那样。
% TODO:但是如果两个系统中都有同一种全同粒子，那么两个系统的态就不可能是
如果配分函数前面被乘上了不恰当的因子，熵的可加性就可能被破坏。（这是理所当然的，因为不恰当的因子意味着熵被加上了一个常数，即它的零点选取得不好）在从量子到经典的过渡中会出现这种情况。
% TODO：和热力学第三定律的联系

\subsubsection{从巨配分函数计算物理量}

实际上，从巨配分函数计算一些量有时还方便一些。因此我们也讨论怎样从巨配分函数计算各种物理量。为了书写方便，我们定义
\begin{equation}
    \alpha_i = - \beta \mu_i,
\end{equation}
这样就有
\begin{equation}
    \Xi(\beta, \alpha) = \sum_n \ee^{-\beta E_n - \sum_i \alpha_i N_{i,n}},
\end{equation}
守恒荷前面的系数在使用$\beta$和$\alpha$（而不是化学势）表示时就和$\beta$无关了；这个$\alpha$当然和以守恒荷算符为扰动的\eqref{eq:partition-function-with-disturbance}中的$\beta\lambda$具有一样的作用。
通过和正则系综类似的方法，可以计算出
\begin{equation}
    \expval*{\hat{N}_k} = - \pdv{\ln \Xi}{\alpha_k} = \frac{1}{\beta} \pdv{\ln \Xi}{\mu_i}.
    \label{eq:expectation-of-charge-grand}
\end{equation}
若使用$\beta$和$\mu$为变量，有
\begin{equation}
    \expval*{\hat{H}} = - \pdv{\ln \Xi}{\beta} + \sum_i \frac{\mu_i}{\beta} \pdv{\ln \Xi}{\mu_i},
\end{equation}
若使用$\beta$和$\alpha$为变量，则有
\begin{equation}
    \expval*{\hat{H}} = - \pdv{\ln \Xi}{\beta}.
    \label{eq:expactation-of-energy-grand}
\end{equation}
熵的表达式使用$\beta$和$\mu$为变量，是
\begin{equation}
    S = \ln \Xi - \beta \pdv{\ln \Xi}{\beta} - \sum_j \mu_j \pdv{\ln \Xi}{\mu_j},
    \label{eq:entropy-mu-beta}
\end{equation}
使用$\beta$和$\alpha$为变量则是
\begin{equation}
    S = \ln \Xi - \beta \pdv{\ln \Xi}{\beta} - \sum_j \alpha_j \pdv{\ln \Xi}{\alpha_j}
\end{equation}

\subsubsection{鞍点近似}

配分函数的计算通常是比较复杂的，因此有很多近似方法。首先考虑\textbf{鞍点近似}。配分函数可以写成
\[
    Z = \int \dd{E} \Omega(E) \ee^{- \beta E} = \int \dd{E} \ee^{\ln \Omega(E) - \beta E}, 
\]
我们设$f(E) = \ln \Omega(E) - \beta E$的极值点为$E_0$，即
\[
    \eval{\pdv{\ln \Omega}{E}}_{E=E_0} - \beta = 0,
\]
在$E_0$附近做展开，就有
\[
    f(E) = f(E_0) + \frac{1}{2} \eval{\pdv[2]{\ln \Omega}{E}}_{E=E_0} + \cdots,
\]
而
\[
    \pdv[2]{\ln \Omega}{E} = \pdv{\beta}{E} = - \frac{1}{T^2 C},
\]
其中$C$是无外界做功时的热容，于是
\[
    \begin{aligned}
        Z &= \int \dd{E} \ee^{\ln \Omega(E_0) - \beta E_0 - \frac{1}{2 T^2 C} (E - E_0)^2} \\
        &= \ee^{\ln \Omega(E_0) - \beta E_0} \sqrt{2\pi T^2 C}.
    \end{aligned}
\]
从上式也可以看到为什么我们通常要求无外界做功时的热容大于零，否则会造成鞍点近似失效。
然后我们会发现，
\[
    \ln Z = \ln \Omega(E_0) - \beta E_0  + O(\ln N),
\]
最后一项来自$\sqrt{2\pi T^2 C}$，在热力学极限下$\ln N$项增长得不够快，可以略去，此时上式实际上就是$F = U - TS$，不同的是上式中熵和内能都是假定$E=E_0$的情况下计算出来的。从这里我们也可以看到，热力学极限下关于整个系统的物理量——熵、内能等——几乎没有涨落，可以直接在$E=E_0$的条件下计算它们。

鞍点近似本身几乎总是适用的，但是它实际上只是把困难转移到了精确确定$E_0$上面。由于求解$E_0$要求解析计算$\Omega(E)$，这和计算配分函数并无本质差别。
更常见的方法是，将$E$分成一个比较容易处理的部分（所谓\textbf{自由部分}）和一个\textbf{相互作用部分}，通过微扰论做计算。

\subsubsection{粗粒化}\label{sec:coarse-graining}

% TODO：这里给出的路径积分似乎已经是经典统计了，是不是量子统计的路径积分精确解一定是虚时间路径积分？？
% 此外，量子的粗粒化要怎么做？？

回顾配分函数的表达式
\[
    Z = \sum_n \ee^{- \beta E_n},
\]
对比较复杂的系统，通常难以写出所有能量本征态。为简化问题，引入相对较粗糙的某个量$\hat{m}$来标记具有类似性质的一系列$\ket{n}$之和，我们有
\[
    Z = \sum_m \sum_{n|m} \ee^{- \beta E_n},
\]
定义\textbf{有效自由能}$F(m)$%
\footnote{回顾\eqref{eq:free-energy-and-partition-function}，$F(m)$就是$\hat{m}$的取值固定为$m$，其余不变的系统的自由能。它并不是整个系统的自由能，后者正比于$\ln Z$。
不过，当$m$是热力学量时，由最速下降法，有效自由能的极小值通常就对应着系统的自由能。

这里有一个看似矛盾的地方：在配分函数最开始的定义中，出现在$\ee$指数上的是哈密顿量，但是我们知道内能正比于哈密顿量，而自由能还需要减去$TS$，为什么积掉一部分自由度之后出现在$\ee$指数上的就是自由能了？
原因在于，积掉$n$中无用的自由度之后，它们保存的态的简并因子就不能通过$n$的可能取值而给出了，而必须体现在求和中，即设$m$扫过所有可能的$m$的取值，则应有
\[
    Z' = \sum_m \Omega(m) \ee^{-\beta H'(m)},
\]
我们知道状态数和熵的关系，于是就可以写出
\[
    Z' = \sum_m \ee^{-\beta F(m)}.
\]
从这个角度也可以看到，积掉无用自由度之后$F(m)$通常会有显式的温度依赖，因为状态数本身和温度无关，于是$T S$一定有温度依赖。
在我们已经有一个有效理论但是对它的物理意义不甚清楚的时候，我们可以反道而行之，将$F$拆分成$H-TS$的形式，其中$S$可以诠释为某个系统的熵，从而证明，后者在参数适当调节的情况下，可以给出和已有的有效理论一样的预言。
}%
使得近似有
\[
    \ee^{- \beta F(m)} = \sum_{n|m} \ee^{- \beta E_n},
\]
我们就得到了粗粒化之后的配分函数
\[
    Z' = \sum_m \ee^{- \beta F(m)}.
\]
换而言之，我们“积掉”了$\ket{n}$提供的那部分不需要的自由度（或者说把它们对$n|m$平均掉了，与此同时把简并因子也归入了有效自由能）%
\footnote{类似的术语还包括“积掉不需要的过程”或者“忽略不需要的过程”，所谓“过程”在这里无非指的是哈密顿量或者有效自由能中的一项，因为这样的一项在微扰展开中对应着一个费曼图，所以在准经典理论中可以被赋予“过程”的含义。}%
，而只留下泛泛而谈的$m$。这就是\textbf{粗粒化}。请注意$F$可以依赖温度。
有效自由能是那部分我们显式地考虑其涨落的自由度的函数；为了将它和热力学中定义的自由能区分开来，我们称后者为\textbf{热力学自由能}。
从有效自由能可以计算出热力学自由能，但是反过来不行：热力学抹去了系统的微观细节。

原则上，无论$m$是什么，粗粒化都是可以进行下去的，但请注意精确地积掉一个自由度在数学上非常困难。通常采用微扰展开的方法，即认为要积掉的自由度和$m$之间只有较弱的耦合，然后逐阶计算微扰，但在要积掉的自由度和$m$之间的耦合实际上比较强时，这么做通常会导致一个渐进级数，处理起来非常困难。
因此，实际上选取$m$时肯定要根据系统的性质合理选择。

具体积掉什么自由度要按照不同的需求考虑。如果只需要讨论一小片区域内的问题，就应该使用坐标表象，积掉区域以外的自由度；如果只需要讨论较低能量的问题，就应该使用动量表象，积掉快场或者说“紫外场”（见下节）。

有几种办法可以计算出有效的$F(m)$。一种是真的动手去算那个平均值，还有一种是通过对称性分析和类似的论证。
例如如果$\hat{H}$是局域的，那么$F(m)$一定也是局域的，又比如$F(m)$一定具有$\hat{H}$具有的对称性，而且可能还会多出来一些对称性（例如，$\hat{H}$可能会导致空间上局部的起伏，但是在大尺度上这些起伏可以被略去，于是我们得到空间平移不变性）。
通过这样的分析可以写出$F(m)$关于$m$的形式，这个表达式通常会带有一些常数，这些常数是$\hat{H}$中的常数在大尺度上涌现出来的结果，可以通过数值分析计算但不太方便解析求解。

在所分析的体系需要使用连续的场$\hat{m}(\vb*{x})$（例如，它可以是一小块区域内粒子的某个性质的平均）标记时，$F$将是场$m(\vb*{x})$的泛函，此时我们记之为$F[m(\vb*{x})]$，有
\[
    F[m(\vb*{x})] = \int \dd[D]{\vb*{r}} \mathcal{F}(m(\vb*{r}), \grad{m}, \ldots), 
\]
相应的配分函数就是
\[
    Z = \int \fd{m} \ee^{- \beta F[m]}.
\]
实际上这是平衡态统计理论的一般形式，因为如果系统并不需要用场来描述，只需要把$m$用离散的量代替就可以了，即做变换$m(\vb*{r}) \longrightarrow m_n$就可以。
从上式我们也可以看到系综等价性：热力学极限下$F$通常都很大，因此只有那些接近
\[
    m_* = \arg\min_m F[m]
\]
的场构型$m$才对配分函数有贡献，从而我们有
\[
    \expval*{m} = \arg\min_m F[m],
\]
而注意到场构型$m$出现的概率
\[
    P(m) \propto \ee^{-\beta F[m]},
\]
有
\[
    \expval*{m} = \arg\max_m P(m).
\]
换而言之，和大系统有关的$m$的期望值就是它的极大概然值。

需要注意的是，下文提到的重整化实际上也是一种粗粒化手段，但它与本节的粗粒化有着一些不同之处：本节提到的粗粒化并不要求$m$和原本体系的CSCO是同样的对象，例如，考虑一个格点系统，它的每个格点都有或者向上或者向下的自旋，我们可以取$m$为平均磁化率，显然它和自旋不是同样类型的对象。
然而，重整化仅仅改变理论中的常数，它本身并不会导致“离散的量被连续的场代替”等情况。
我们可以认为本节提到的粗粒化是做了一个变量代换——如，将格点上的物理量使用一个仅在格点上有非零值的场来代替——然后再做重整化，即将高动量的部分积掉，从而让场变得平缓。

\subsubsection{量纲、尺度变换和重整化群}

% TODO：重整化之后什么时候哈密顿量会多出来项？多出来的项的阶数是不是会大于原有哈密顿量中各项的阶数？
% TODO：粗粒化是有可能出现原本不存在的高阶项的？
% 做对称性分析时是不是哈密顿量的每一项都需要满足有关的对称性？？不需要，但有一些对称性如$U(1)$确实需要
% 费曼图可以用于重整化。重整化之后的哈密顿量中多出来的项导致的费曼图外腿一定是重整化前的费曼图的外腿；换而言之，重整化只是把费曼图中的复杂图形用一个顶点代替了，外腿的结构（“用户界面”）是不变的

考虑理论
\[
    Z = \int \fd{\phi} \ee^{- F[\phi]},
\]
这个理论形式是最一般的路径积分。这个路径积分通常来自几种可能的理论推导：
\begin{enumerate}
    \item 对经典平衡态统计物理，取$\phi$为所有坐标和动量就可以，因为在经典理论中这两者可以同时确定，此时$F$就是哈密顿量，我们可以将对温度的依赖整合进了有效自由能当中，因为可以巧妙地重新定义场和各常数来把温度这个因子吸收掉；
    \item 如果\autoref{sec:coarse-graining}中提到的粗粒化可以进行，那么$\phi$就是粗粒化过后系统的状态，粗粒化之后得到的理论是一个经典平衡态统计物理理论；
    \item 我们总是可以使用\autoref{sec:imaginary-path-integral}中的方法完成一个量子平衡态统计物理中的配分函数的计算，它与经典的平衡态统计物理理论的区别在于$\beta$不再简单地被乘在哈密顿量或是有效自由能前面，而是被当作虚时间积分的上限，且热力学作用量$S$代替了有效自由能$F$，前者相比后者多出来了一个场变量对时间的导数项，如果理论是有限温的且有$d$个空间维度，那么这样会得到一个准$d+1$维的路径积分理论（虚时间维是受限制的），而如果是零温的，这样会得到一个$d+1$维的路径积分理论。（一个例外是，如果哈密顿量是可以严格对角化的，那么量子的$d$维理论还是对应一个经典的$d$维理论）
\end{enumerate}
这三种理论中的场变量的物理意义未必是一样的，例如考虑一个量子场论理论，其中有场算符，场算符产生粒子，粒子在空间中展现出集体行为。
场算符可能被第三种理论拿来做场变量，粒子的坐标和动量可能被第一种理论拿来做场变量（而如果第一种理论拿场算符来做场变量，就不会有单粒子图像了，因为经典场产生不了粒子），当然也可以把粒子的坐标和动量放到第三种理论中做场变量，而粒子的集体行为，比如密度波，可能被第二种理论拿来做场变量。
但无论如何，理论的配分函数都一定可以写成对某个场变量（不管它的物理意义是什么）的路径积分，并且温度是$F$中的一个参数，这里$F[\phi]$放在$\ee$指数上就给出了不同的系统状况出现的概率，称为\textbf{朗道函数}。

下面的论述将使用坐标或动量来标记不同位置的场值，不过这并没有失去一般性，因为我们没有用到任何关于空间或者动量的特殊性质，因此原则上可以使用任何连续或者离散的量来代替坐标或动量。
我们将通过截断动量积分上界的方式做重整化群，这称为\textbf{Wilson重整化群}，还有其它一些做重整化群的方法，如\textbf{Kosterlitz重整化群}通过调整晶格常数（坐标积分的下界）来做重整化群计算。

在理论必须满足的对称性条件确定时，$F[\phi]$的形式也就确定了，不确定的仅仅是其中各项的系数，也即理论中的参数。这些参数标记了不同的理论，它们组成一个\textbf{理论空间}。

在动量空间中写出我们的理论：
\begin{equation}
    Z = \int \prod_{\abs{\vb*{k}} < \Lambda} \dd{\phi(\vb*{k})} \ee^{ - F[\phi(\vb*{k})]},
    \label{eq:theory-in-momentum-space}
\end{equation}
其中$\Lambda$是一个截断。%
\footnote{注意：截断本身并不是理论空间中的参数。实际上它的作用是某一重整化群流（见后）的“曲线坐标”。}%
会有这个截断是因为我们考虑的系统涉及的过程不会具有任意高的动量，并且当动量高到一定程度时我们的理论可能失效。例如，高动量对应着较低的特征长度，而$F[\phi]$可能是经过粗粒化的，那么当动量对应的特征尺度接近粗粒化的特征尺度时，理论就失效了。

如果我们关注的过程涉及的动量甚至远小于$\Lambda$，就需要考虑另一个截断
\[
    \Lambda' = \frac{\Lambda}{\zeta}, \quad \zeta > 1,
\]
由于低动量过程和高动量过程可能有耦合，不能够直接以
\[
    Z = \int \prod_{\abs{\vb*{k}} < \Lambda' } \dd{\phi(\vb*{k})} \ee^{ - F[\phi(\vb*{k})]},
\]
作为新的配分函数。
我们定义
\[
    \phi(\vb*{k}) = \phi^-(\vb*{k}) + \phi^+(\vb*{k}),
\]
$\phi^-(\vb*{k})$在$\abs{\vb*{k}} > \Lambda'$时为零，$\phi^+(\vb*{k})$在$\abs{\vb*{k}} < \Lambda'$时为零，两者在$\vb*{k} > \Lambda$时都为零。
我们写出低动量过程和高动量过程（分别称为\textbf{红外端}和\textbf{紫外端}，对应的场称为红外场和紫外场，或者说慢场和快场）的耦合：
\[
    F[\phi(\vb*{k})] = F_0 [\phi^-(\vb*{k})] + F_0 [\phi^+(\vb*{k})] + F_I [\phi^-(\vb*{k}) , \phi^+ (\vb*{k})],
\]
则
\[
    \begin{aligned}
        Z &= \int \prod_{\abs{\vb*{k}} < \Lambda'} \dd{\phi^{-}(\vb*{k})} \prod_{\Lambda' < \abs{\vb*{k}} < \Lambda} \dd{\phi^+ (\vb*{k})} \ee^{- (F_0 [\phi^-(\vb*{k})] + F_0 [\phi^+(\vb*{k})] + F_I [\phi^-(\vb*{k}) , \phi^+ (\vb*{k})])} \\
        &= \int \prod_{\abs{\vb*{k}} < \Lambda'} \ee^{- F_0 [\phi^-(\vb*{k})]} \prod_{\Lambda' < \abs{\vb*{k}} < \Lambda} \ee^{- (F_0 [\phi^+(\vb*{k})] + F_I [\phi^-(\vb*{k}) , \phi^+ (\vb*{k})])},
    \end{aligned}
\]
定义
\begin{equation}
    \begin{aligned}
        \ee^{-F'[\phi^-(\vb*{k})]} &= \ee^{- F_0 [\phi^-(\vb*{k})]} \int \prod_{\Lambda' < \abs{\vb*{k}} < \Lambda} \ee^{- (F_0 [\phi^+(\vb*{k})] + F_I [\phi^-(\vb*{k}) , \phi^+ (\vb*{k})])} \\
        &= \ee^{- F_0 [\phi^-(\vb*{k})]} \int \fd{\phi^+} \ee^{-F_0[\phi^+]} \ee^{-F_I} \\
        &\sim \ee^{- F_0 [\phi^-(\vb*{k})]} \expval{\ee^{-F_I[\phi^-, \phi^+]}}_+,
    \end{aligned}
\end{equation}
这里我们用下标$\expval*{\cdot}_+$表示仅对动量超过$\Lambda'$的那部分场计算期望，而把动量较低的场当成给定的常数，并且略去了一个无关紧要的归一化常数；上式也可以等价地写成
\begin{equation}
    \begin{aligned}
        F'[\phi^-] &= F_0[\phi^-] - \ln \expval{\ee^{-F_I[\phi^+, \phi^-]}}_+ \\
        &= F_0[\phi^-] + \expval{F_I}_+ - \frac{1}{2} ( \expval{F_I^2}_+ - \expval{F_I}^2_+ ) + \cdots.
    \end{aligned}
\end{equation}
这样就有
\begin{equation}
    Z = \int \fd{\phi^-} \ee^{-F'[\phi^-]}.
    \label{eq:low-energy-effective-theory}
\end{equation}
现在我们的理论中没有紫外场$\phi^+$了，我们\textbf{积掉}了这些自由度，留下一个有效自由能$F'[\phi^-]$。我们知道对配分函数中的场求导可以获得系统的各种信息，\eqref{eq:theory-in-momentum-space}中的场跑遍所有小于$\Lambda$的动量，而\eqref{eq:low-energy-effective-theory}中的场，在原来的动量尺度（也就是$\vb*{k}$而不是$\vb*{k}'$）下只跑遍小于$\Lambda'$的动量，因此\eqref{eq:low-energy-effective-theory}只能够提供关于在原来的动量尺度下只跑遍小于$\Lambda'$的动量的那部分场的信息，紫外端的信息全部丢失了，仅仅保留了红外部分的物理。

注意到在做积分\eqref{eq:theory-in-momentum-space}时，动量的值实际上是不重要的，因为我们总是可以通过调整自由能表达式中的参数，并重新定义场的方法，把对动量的尺度变换吸收掉。
因此对理论$F'[\phi^-]$，我们做一个动量的尺度变换以及与之相关的坐标的尺度变换，
\[
    \vb*{k}' = \zeta \vb*{k}, \quad \vb*{r}' = \frac{1}{\zeta} \vb*{r},
\]
这样它的动量截断和$F[\phi]$的动量截断一样，同时调整各参数、重新定义场，以保持配分函数不变，在完成了这一系列手续之后我们的理论就变成了
\[
    Z = \int \prod_{\vb*{k'} < \Lambda} \dd{\phi'(\vb*{k}')} \ee^{-F_\zeta [\phi'(\vb*{k}')]},
\]
显然$F_\zeta[\phi']$仍然在原理论空间中，但是它的参数发生了变化，且这些变化可以通过$\zeta$确定。这种积掉紫外自由度之后参数发生的变化称为\textbf{参数跑动}。
对一个能标固定的过程，我们可以积掉比它高的大部分自由度，得到的相互作用强度基本上就（至少是定性地）反映了这个过程的强度。

这种选取紫外场，积掉紫外场，然后重新定义场、参数以获得一个低能有效理论的操作称为\textbf{重整化群}。重整化群只是一个半群，因为它不可逆——紫外端的信息在重整化之后全部丢失了。

如前所述的对$\vb*{k}$和$\vb*{r}$的尺度变换实际上自然地导出了量纲的概念。
我们要求尺度变换前后的理论是等价的，这就意味着尺度变换前后的配分函数只应该差一个常数因子。
换而言之，应该有
\[
    \int \fd{\phi'} \ee^{- F'[\phi']} = \const \cdot \int \fd{\phi} \ee^{ - F[\phi]},
\]
由于$\phi$在变换前后的确只相差一个因子，上式等价于
\[
    F[\phi] = F'[\phi'],
\]
即
\[
    \int \dd[D]{\vb*{r}} \mathcal{F}[\phi(\vb*{r})] = \int \frac{\dd[D]{\vb*{r}}}{\zeta^D} \mathcal{F}' [\phi'(\vb*{r}')],
\]
也即
\[
    \mathcal{F}[\phi(\vb*{r})] = \frac{1}{\zeta^D} \mathcal{F}' [\phi'(\vb*{r}')].
\]
$\mathcal{F}$是$\phi$本身和它的各阶导数的多项式，即
\[
    \mathcal{F}[\phi] \sim \sum g \phi^{n_0} (\grad{\phi})^{n_1} \cdots,
\]
$g$是理论中含有的参数之一。因此，理论的尺度变换不变性等价于可以找到参数$\lambda_\phi$和$\lambda_g$，使得对每一项都有
\[
    g \phi^{n_0} (\grad{\phi})^{n_1} \cdots = \frac{1}{\zeta^D} \zeta^{\lambda_g} g (\zeta^{\lambda_\phi} \phi)^{n_0} (\zeta \grad{\zeta^{\lambda_\phi} \phi})^{n_1} \cdots, 
\]
从而
\[
    1 = \frac{1}{\zeta^D} \zeta^{\lambda_g} (\zeta^\lambda_\phi)^{n_0} (\zeta \zeta^{\lambda_\phi})^{n_1} \cdots,
\]
可以看出，$\lambda_\phi$和$\lambda_g$实际上正是取长度量纲为$-1$时对应量的量纲。自由能的量纲，据此计算，就是零，这是合理的因为自由能直接出现在$\ee$指数中，所以应该是无量纲量。

重整化群可以有不动点，通常是鞍点。在一次重整化之后，理论中的任何一个特征长度都会发生
\[
    \xi' = \frac{\xi}{\zeta}
\]
的变化。也即，在不动点处或是特征长度为零，或是特征长度为无穷大。
这意味着重整化群的不动点处没有有限而非零的特征长度，因此重整化群的不动点处的理论在单纯的尺度变换之下不应该有任何变化。
特别的，在不动点处系统的关联长度（即两点关联函数衰减的特征长度）或是为零或是无穷大，而其它地方，有物理意义的系统的关联长度应该是非零有限值。
（请注意一个任意的理论在重整化群作用下未必会收敛到一个不动点上，例如，它完全可以不收敛，而只是没完没了地向无穷远运动；实际上，不处于相变状态的系统大多就是这个情况。
对这样的系统，重整化群不动点的性质也许未必适用，使用工程量纲分析哪些项是相关的哪些项是无关的也可能会失败，因为可能没有可靠的标度律，因为相互作用很强）

在不动点的不同方向做扰动（在某个方向上做扰动，就是让自由能表达式中这个方向对应的项前面的系数发生小的变化，如在$(\grad{\phi})^2$方向上做扰动，就是让自由能加上$\epsilon (\grad{\phi})^2$），可能是稳定的，也可能是不稳定的，也可能是临界的
\footnote{即此时一系列不动点排成一条连续的线，则沿着这个线的方向做扰动只会从一个不动点变动到另一个不动点。这种情况通常是因为做扰动时微扰阶数取得不够多，以至于稳定性表现得不明显。但的确存在这样的理论，有些方向的扰动精确地就是临界的。}%
。
如果一个方向上的扰动是不稳定的，这个方向对应的自由能表达式中的项就是\textbf{相关的（relevant）}，因为这意味着这一项会显著改变一个理论在重整化群作用下会趋于的不动点；反之，如果一个方向上的扰动是稳定的，这个方向对应的自由能表达式中的项就是\textbf{无关的（irrelevant）}，因为它对不动点并无显著影响。
显然，理论在不动点处的行为主要由相关的项确定。我们称在一个不动点附近的相关的扰动方向为这个不动点的相关扰动方向。

在实际计算时，通常采取这样的方式：令重整化群的群参数变动一小段（例如如果以截断$\Lambda$为群参数，那么积掉$\Lambda$到$\Lambda-\dd{\Lambda}$之间的自由度），形式地写出耦合常数$g$的变化，然后得到下面的方程：
\begin{equation}
    \pdv{g}{\ln \Lambda} = \beta(g),
\end{equation}
从而重整化群的不动点由$\beta(g)=0$的解给出，根据$\beta(g)$的形式可以分析不动点是稳定的还是不稳定的，从而分析$g$对应的项是相关的还是无关的。
$\beta(g)$称为\textbf{$\beta$函数}，它完全给出了重整化群的行为。
通常其具体形式并不重要，重要的是一些性质。例如如果$\beta(g) < 0$则随着能标降低相互作用越来越大，$\beta(g) > 0$则正好相反。
$\beta(g) = 0$给出了不动点的位置，此时如果$\beta'(g) > 0$则不动点不稳定，$\beta'(g) < 0$则不动点稳定，$\beta'(g) = 0$意味着是临界不动点。

可以使用形象的方法描述重整化群在理论空间中的作用。
我们现在有三类参数：
\begin{enumerate}
    \item 理论中各项前的系数，它们是理论空间的坐标；
    \item 标记了重整化的进程的参数，或者说是重整化群的群参数。；
    \item 外部给定的、不参与重整化的常数（比如统计物理中的温度），它们可以成为理论空间的坐标之一，当它们固定时所有可能的理论就是理论空间中的一个低维子集。
\end{enumerate}
这三类参数当然不是绝对区分开的。例如，我们可以将温度看成一个自然的能量尺度，从而它可以看成重整化群的一个群参数（显然不是唯一的）%
\footnote{
    一种常用的方法是，设有一个特征温度$T_0$，在其上配分函数可以写成
    \[
        Z_0(g) = \int \fd{\phi} \ee^{- \frac{F[\phi, g]}{T_0}},
    \]
    其中$g$是耦合常数。现在设我们要计算温度$T$下的配分函数
    \[
        Z(g) = \int \fd{\phi} \ee^{- \frac{F[\phi, g]}{T}},
    \]
    很容易可以看到，可以积掉一部分自由度并且做尺度变换，使得
    \[
        Z(g) = \int \fd{\phi'} \ee^{- \frac{F'[\phi', g]}{T}} \propto \int \fd{\phi'} \ee^{- \frac{F[\phi', g']}{T_0}} = Z_0(g'),
    \]
    于是可以看出$T$就标记了重整化的进程，而由于它和自由能量纲相同，它实际上就是能标；温度降低意味着重整化的进行。

    这样做的好处在于，我们可以将温度降低时体系发生的一系列变化和重整化群作用下耦合常数的变化建立直接的关系。
    例如，我们可以将一个物理量表示成耦合常数和温度的函数，则固定耦合常数不变，让温度下降计算出来的物理量就等于固定温度不变，让耦合常数在重整化群作用下发生跑动而计算出来的物理量。
}
；而由于温度直接乘在自由能上，我们可以将温度吸收进自由能前面各个项的系数中，从而温度也可以成为理论空间的一个坐标；最后，在量子统计理论中温度会导致一个虚时间，因此温度还可以是坐标空间的一个截断。
又比如，我们可以这么做重整化：每一个步骤都是积掉$\Lambda$到$\Lambda-\dd{\Lambda}$之间的能量的自由度，那么此时$\Lambda$就是重整化群的群参数；但是我们也可以这样做完之后重新调整坐标的尺度，让$\Lambda-\dd{\Lambda}$的数值在调整之后恢复$\Lambda$，此时$\Lambda$就是外部给定的常数。

重整化操作在理论空间中绘制出一系列运动曲线，称为\textbf{重整化群流}，不动点就是重整化群流的交汇处。
任取一条重整化群流，截断是其曲线坐标。
外部给定的、不参与重整化的常数标记了不同的曲线。这些常数完全由重整化起始时的理论在理论空间中的位置确定（或者反过来，也可以用这些常数确定重整化起始时的理论在理论空间中的位置）。

在高能标自由度的贡献不是很大，低能和高能过程几乎解耦时（例如在不动点附近），重整化群的作用主要来自尺度变换。
此时可以通过简单的量纲分析来判断一个项是相关的还是无关的，又或者是临界的。重整化群的作用总是伴随着大于1的$\zeta$，因此如果某一项的系数的量纲大于$0$，那在重整化过程中它一定会增大，因此它是相关的；如果某一项的系数的量纲小于$0$，则在重整化过程中它会衰减，因此是无关的。如果量纲正好是$0$，那就是临界的。
将每一项除了系数以外的部分（有时称为“算符”）记作$\mathcal{O}$，即
\[
    \mathcal{F} \sim \sum g \mathcal{O},
\]
则
\[
    [g] + [\mathcal{O}] - D = 0,
\]
于是
\begin{itemize}
    \item $g \mathcal{O}$是相关的，当且仅当$D > [\mathcal{O}]$，
    \item $g \mathcal{O}$是无关的，当且仅当$D < [\mathcal{O}]$，
    \item $g \mathcal{O}$是临界的，当且仅当$D = [\mathcal{O}]$。
\end{itemize}

显然，在理论空间中诸多可能的项中，只有一小部分项是相关的，也即，形式各异的一族理论可以在重整化群作用下流向同一个不动点。
因此不动点自然地将理论做了分类，称为\textbf{普适类}，不动点的性质称为\textbf{普适性}。
如果我们只关心某个能标下会出现的现象，那就只需要考虑这个能标下的不动点就可以，因为无论理论一开始位于理论空间的什么位置，重整化群都会把理论带到某一个普适类中。
一旦对称性和场给定之后，普适类就确定了，换而言之，如果不同的模型在某个不动点附近的对称性和主要自由度的类型都是相同的（例如，都具有平移、旋转对称性，主要的自由度都是一个标量场），那么它们就由相同的普适类描述，具有相同的临界指数（见下文），等等。
如果对称性确定，那么哪些场是重要的就决定了不同的普适类。比如如果发现临界点附近除了我们关心的序参量以外还有一些自由度没办法较好地积掉，就说明出现了新的普适类。

需要注意的是，将不同的参数看成给定的、不参与重整化运算的参数，得到的理论空间、重整化群流以及量纲分析都可能会发生变化。
例如，如果理论空间中有两个量纲相同的参数，那么固定其中一个参数，对另一个参数做尺度变换之后，其它各种物理量的尺度变换情况和两个参数一起做一样的尺度变换显然是不同的。
通常我们将前者称为\textbf{反常量纲}，将后者称为\textbf{工程量纲}或者\textbf{正常量纲}，因为后者是比较初等的计算中常用的尺度变换方式。
大部分情况下，反常量纲中的固定死的参数是截断长度。
工程量纲对应的重整化群操作是平凡的，只不过是普通的标度变换而已，而反常量纲对应的重整化群操作可以涉及非平凡的重整化群操作，例如，如果固定死的参数是截断长度，反常量纲对应的就是积掉了高能相互作用的重整化群操作。
一个一般的不动点附近的标度律给出的通常是反常量纲，因为很多不动点处相互作用都仍然存在，从而标度律不会给出正常量纲。
虽然如此，在不动点附近使用正常量纲来判断一个项是不是相关大部分时候仍然是可靠的，因为如果不动点附近允许我们使用微扰论，那么只要正常量纲不非常接近$0$（即所谓“dangerous relevant”或者“dangerous irrelevant”），正常量纲会占据主导地位，相互作用给出的修正是可以忽略的。
如果不动点附近不允许我们使用微扰论，通常也没法解析分析这样的不动点。
实际计算物理量时则基本上总是需要使用反常量纲，因为实际的物理量当然和相互作用有关，且至少会有一个固定死的参数出现在物理量中：截断长度。
截断长度出现在物理量中暗示我们简单的量纲分析不能够得到物理量的完整形式，而具体的重整化操作则可以计算出有关的反常量纲。

\subsubsection{不动点附近的行为}

我们对不动点附近的重整化群流做一些具体计算。记重整化群为$R_\zeta$，$s$为群参数，我们要求$s$代表“缩放的倍率”，从而$s=1$时重整化群无作用。记理论中参与重整化的全体参数为$\vb*{K}$，不动点记为$\vb*{K}^*$。
在不动点附近引入扰动，然后对扰动后的理论做一小步重整化，所得结果为
\[
    \vb*{K} = \vb*{K}^* + \var{\vb*{K}} , \quad \vb*{K}' = R_\zeta(\vb*{K}^* + \var{\vb*{K}}),
\]
由于$\vb*{K}^*$是不动点，它附近的重整化群运算近似是线性的，即
\[
    \vb*{K}' = \vb*{K}^* + \eval{\pdv{R_\zeta}{\vb*{K}}}_{\vb*{K}^*} \var{\vb*{K}} = \vb*{K}^* + \vb*{M}_\zeta \var{\vb*{K}},
\]
这样，理论由于扰动后又要做重整化而发生的变化就是
\[
    \var{\vb*{K}'} = \vb*{M}_\zeta \var{\vb*{K}}.
\]
用指标$\sigma$标记变换矩阵$\vb*{M}_\zeta$的各个本征值和本征矢，记它们为
\[
    \phi^{(\sigma)} \vb*{M}_\zeta = \Lambda^{(\sigma)}_\zeta \phi^{(\sigma)},
\]
使用这些本征值来将原有的各个参数偏离不动点的距离做一个线性组合，即
\[
    u_\sigma = \sum_i \phi^{(\sigma)}_i (K'_i - K^*_i), 
\]
所有$\{u_\sigma\}$等价地给出了重整化群作用下偏离不动点的理论会去向何方。在重整化群作用下就有
\[
    u_\sigma' = \Lambda^{(\sigma)}_\zeta u_\sigma.
\]
现在我们看到了本征值$\Lambda_\zeta^{(\sigma)}$的意义：如果某个$\Lambda_\zeta^{(\sigma)}$大于1，那么对应的$u_\sigma$在重整化群作用下会不断远离不动点，这样这个方向就是相关的；如果某个$\Lambda_\zeta^{(\sigma)}$小于1，那么那么对应的$u_\sigma$在重整化群作用下会不断靠近不动点，这样这个方向就是无关的。
由上一节提到的不动点附近重整化和量纲之间的关系，$\Lambda_\zeta^{(\sigma)}$可以写成$u_\sigma$的量纲的$\zeta$次方。

请注意在不动点附近做重整化几乎不涉及积掉高能自由度，因此无论是$K$还是$K'$都是合理的低能有效理论，它们各自对应着一种可能出现的参数安排。
现在设有物理量$f = f(\vb*{K})$，我们当然也可以把它写成$f=f(\{u_\sigma\})$，如果我们固定其它参数不动只变动某个$u_\sigma$，显然可以做展开（泰勒展开或者洛朗展开）
\[
    f(u_\sigma) - f(u_\sigma^*) = \sum_n a_n (u_\sigma - u_\sigma^*)^n = \sum_n a_n u_\sigma^n,
\]
在临界点附近这个展开式中最低阶的项（如果可以有$n<0$那么就是$\abs{n}$最大的项）是最显著的，记这个最低的阶数为$m$，则有
\[
    f(u_\sigma) - f(u_\sigma^*) \sim u_\sigma^m,
\]
设有两个$u_\sigma$和$u_\sigma'$，它们对应的参数安排可以认为只差了一个重整化群作用$R_\zeta$，其中$\zeta$由
\[
    \frac{u_\sigma'}{u_\sigma} = [u_\sigma]^\zeta
\]
给出，这样我们就得出结论：
\[
    f(u_\sigma) - f(u_\sigma^*) \sim \text{something}^{m \zeta},
\]
因此，随着参数向临界点靠近，物理量的变化将展现出幂律，幂律指数由物理量的定义（用于确定$m$）和重整化群在不动点附近的本征值（用于确定$\zeta$）给出。
这些幂律的指数就是\textbf{临界指数}。

\subsection{相变}

\textbf{相变}指的是随着某些给定常数——在统计理论中通常就是温度——的变动，某些量出现不光滑的变化的现象，所有量均光滑变动的参数空间称为一个\textbf{相}，相变点位于不同相的交界面上，也称为\textbf{临界点}。
相变的特征包括临界性——相变点相较于整个参数空间永远是一个低维子集；相变应该是系统的集体行为，因此正在发生相变的系统的关联长度应该是无限大；此外，相变点附近的物理规律总是服从幂律。

相变对应着系统非解析的特征。显然，由于配分函数及有关的量都是足够光滑的，非解析性不可能出现在配分函数中，而只能够出现在自由能中。
具体来说，由于
\[
    F \propto \ln Z,
\]
如果配分函数含有一些因子，在特定参数选取下趋于零，那么$F$就有奇点，于是就引入了不解析性。
对任何一个系统配分函数当然不可能取零，但数学上可以证明，配分函数可以有带有虚部的零点，且对规模趋于无穷大的系统这个零点趋于实轴。

\subsubsection{相变与不连续性}

设随着参数$X$的改变，出现了相变。由定义，在$X$的变化过程中一定会有一些别的参数发生不连续的变化。
如果一个相变点附近，随着$X$的改变自由能$F$发生了不连续的变化，那么这就是一个\textbf{一级相变}。
如果$F$始终连续但是$F$对$X$的导数不连续，那么就是\textbf{二级相变}。如此还有三级相变、四级相变……
内能$U$、吉布斯自由能$G$等物理量和$F$只相差一个勒让德变换，因此它们的光滑性和$F$是一样的，也可以用来区分相变的类型。
自由能的大小（或者内能的大小，吉布斯自由能的大小，等等）在任何一个热力学过程中总是可以连续调节的，因为总是可以缓慢地向系统加入或者从系统放出少量能量，
换而言之，如果随着$X$的改变自由能$F$发生了不连续的变化，这就说明在相变点向系统加入或者放出少量能量，$X$根本就没有变化。
这就是一级相变独有而更高阶相变没有的现象：\textbf{潜热}，即在相变时，向系统输入能量后看起来似乎什么也没发生，似乎一些能量被隐藏起来了。
换而言之，一级相变要完整地发生，必须吸收或者放出一些能量。

\subsubsection{相变与重整化群}

直接通过分析自由能的奇点来分析相变在数学上是非常困难的，配分函数通常只能微扰计算，未必能够找到奇点。所幸可以通过重整化群的方式来理解相变。

既然相变对应着系统趋于无限大，我们可以在理论中引入这样一个截断，使得低于一定特征尺度$L$的尺度上的过程不被考虑，然后让$L$变得越来越大，观察这样的重整化过程。
$L$趋于无穷大的极限就是无限大的系统的宏观行为。%
\footnote{当然在一些比较复杂的理论中，如果$L$太大那么又会有新物理出现，比如说出现相对论效应，等等。这里说的$L$趋于无穷大实际上指的是让$L$大到我们想要了解的尺度，如毫米级甚至厘米级。}%
$L$趋于无穷大时出现了不止一个普适类，这就表明在不同的外加参数下（例如不同温度下%
\footnote{虽然温度实际上是大系统的集体行为涌现出来的物理量，但如果局限在基于配分函数的计算中，它就和别的参数没有什么区别。}%
）系统可能出现截然不同的行为，从而每个普适类就是一个相，它们之间的转换就是相变。
不同普适类的交界面一定是重整化群不动点（因为$L$很大时出现了固定的普适类，交界面也是固定的），但一定是不稳定的不动点（因为只要略微偏离交界面，我们的理论就进入了某个普适类，于是重整化群流就会把我们带到这个普适类对应的不动点上）。
因此一个系统的所有相变点都可以通过其不稳定、关联长度为无穷大的重整化群不动点找到，它的所有相都可以通过稳定的吸引子（未必是一个点，因为一个相中的很多参数都是可以连续取值的）找到。
相变点具有尺度不变性还意味着在相变点附近，物理量的变化应遵循幂律，因为只有幂律才能够确保尺度变换后的结果和尺度变换前只差一个因子。% 这个说法存疑？？
如果能够求解$\beta$函数，那么其不稳定零点就是相变点。

在有多个相时，事情还会复杂一些。每两个相之间有一个界面，界面和界面之间又有交界线，交界线还会汇聚在交界点上。
例如，水的相图中，固液气三相之间有三条交界线，它们交汇在水的三相点。
实际上，扣除了交界线的交界面、扣除了交界点的交界线分别代表一个重整化群不动点。
要看出是为什么，设相图（即在重整化群的宏观极限下仍然是相关的所有项张成的空间，即宏观下的所有有效理论组成的空间）有$D$维，则交界面有$D-1$维，即只需要细调理论空间中的一个参数就可以让理论的宏观行为（即重整化的结果）这个交界面上；
交界线有$D-2$维，则只需要细调两个参数。
很容易看出，如果一个重整化群不稳定不动点附近有$d$个方向是相关的，那么如果要让理论流到这个不动点必须细调对应的$d$个参数（如果这$d$个参数偏差了一点，随着重整化系统就会越来越远离这个不动点）。
换而言之，相图中两相交界面对应着一个有1个相关扰动方向的重整化群不动点，它在相图上是一个$D-1$维集合；两相交界面的交界对应着一个有着2个相关扰动方向的不动点，它在相图上是一个$D-2$维集合……代表着相或是多相共存状态的重整化群不动点的相关扰动方向约束了能够流到这个不动点的参数选取中可以自由调节的参数的个数，这就是所谓的\textbf{相律}。

在这样的观点下，零温下的相变和有限温下的相变有很大不同。
如果一个理论在零温下有相变，那么它一定完整地考虑了量子效应（经典理论的零温下$\beta \to \infty$，这样$e$指数上的$\beta F[\phi]$会快速增大，理论退化为无涨落的自由能最小化），而零温下积分
\[
    \int_0^\beta \dd{\tau} \longleftarrow \int_0^\infty \dd{\tau},
\]
设理论有$d$个空间维度，则零温下的配分函数实际上是定义在$d+1$维空间中的，而不是$d$维空间中的。反之，有限温下的配分函数的虚时间积分有一个上限，因此只是准$d+1$维空间，可以划归到$d$维空间（考虑其经典极限，虚时间积分退化成了因子$\beta$，这时的配分函数就是$d$维空间的）。
换而言之，零温下的相变点对应一个$d+1$维的普适类，而有限温下的相变点对应一个$d$维的普适类。

以上所有的分析都是针对平衡态的——我们使用一些具有能量量纲的物理量（如自由能、哈密顿量）计算配分函数，然后指出可以对这样的理论应用重整化群，相变由重整化群的不动点描述。
这套理论在非统计性的经典问题中难以应用，因为经典物理可以概括为如下的最小作用量原理：
\[
    \phi = \arg\min_{\phi} \int \dd{t} L[\phi],
\]
此时不能“积掉”一些自由度。另一方面，本节讨论的统计理论则形如
\[
   Z = \int \fd{\phi} \ee^{- F[\phi]},
\]
它和非统计性的经典问题的不同之处在于$\phi$跑遍所有可能的构型同时最有可能出现在极小值点上，而不仅仅取极小值点。
直观地说，统计理论具有涨落而非统计性的经典问题没有涨落，没有涨落，系统就不能自发地演化到极小值点，也就不会出现分叉现象，因此相变的概念适用于前者而难以不做改动地用于后者。
当温度为零时不存在热涨落，经典统计物理就退化成了非统计性的经典问题，换而言之，经典统计物理中在零温下没有相变的概念。
然而，量子统计物理中虽然零温下系统可以是纯态，但同样可以使用配分函数描述纯态问题（即使用路径积分），因此量子统计物理中即使在零温下也可以有相变。
因此我们说，相变需要涨落（从而需要引入配分函数描述系统而不只是简单地最小化能量或者作用量），这个涨落可以是热涨落也可以是量子涨落。零温下没有热涨落但有量子涨落，因此还是可以有相变。
另一方面，以上讨论并不描述系统怎么从一个可能是非平衡的初态演化到平衡的末态，因此本节的理论不能处理亚稳态问题，即参数已经达到了相变的条件而没有发生相变的情况，如过冷水等。（在亚稳态维持的时间尺度足够长时可以使用热力学理论描述它，但此时的自由能等物理量未必是稳态对应的物理量的解析延拓）
完整地处理这些问题必须要有一个动力学理论。
不过，通过计算$F[\phi]$的局部极小值点和全局最小值点之间的能垒，以及涨落的大小，可以粗略地估计从局部极小值点转移到全局极小值点需要的时间。
能发生相变的系统通常可以很快地演化到一个局部极小值点附近，即几乎总是处于亚平衡态，% TODO：为什么
然后只要系统因为涨落被带到了隔绝局部极小值点和全局最小值点的能垒上，它就可以很快地演化到全局最小值点附近，达到真正的平衡态。

\subsubsection{自发对称破缺}

如果系统服从的理论具有某个对称性——也即，$F[\phi]$在某个变换下不变——这并不能够保证系统的状态一定是对称的。
这就导致了一个重要的结果：虽然系统服从的物理规律满足某个对称群$G$，如果这个物理规律允许出现的态本身并不对称%
\footnote{当然，物理规律允许出现的某个态经过$G$的变换之后得到的态肯定也是物理规律允许出现的。}%
，那么在系统的某个状态附近的有效理论也可以不具有$G$对称性。
这就是\textbf{对称性自发破缺}。
最常见的对称性自发破缺体现为系统基态的对称性破缺，不过对称性自发破缺的概念不局限在基态，例如，一把椅子具有确定的形状和空间方向，但是它遵循的物理规律却是旋转不变的。
破缺对称性会导致系统出现一些特别的激发模式。
例如，如果一个在基态被破缺的对称性是连续对称性，且哈密顿量中只有短程相互作用，那么它一定对应着一个无质量粒子，这就是著名的\textbf{Goldstone定理}。%
\footnote{基态具有简并，从而引入一个额外的参数来标记基态，这种现象可以出现在本文讨论的有限温度理论中，也可以出现在零温情况下，如氢原子的波函数的角向部分就可以不满足旋转不变性。两者的区别在于，前者中，“额外的参数”——序参量，或者别的序——总是可以涨落的，涨落会产生能量变化（如三维空间平移不变性破缺产生的晶格是一个序，这个序的涨落会产生声子；又比如铁磁序的涨落产生磁子，等等），从而产生新的激发模式，而后者只会引入新量子数，是否能够诠释为新的激发模式则见仁见智——新量子数的涨落并不会引起任何能量变化。}%

经典理论的对称性自发破缺非常好理解。
考虑经典的墨西哥草帽的例子：基态不是唯一的，因此在某个基态附近的低能有效理论也不具有旋转对称性，虽然对一个基态以及它附近的低能有效理论做旋转能够得到另一个基态和对应的低能有效理论，并且原则上只要等待足够长的时间，热涨落可以让其中一个态变成另一个，因此系统服从的物理规律实际上仍然是对称的。
换而言之，对称的系统可以产生不对称的态，以及这个态附近的不对称的低能有效理论。

这样的说法对量子系统其实并无意义：设基态$\ket{\phi_1}$和$\ket{\phi_2}$破坏了对称性，那么可以在基态场构型$\phi_1$附近做一个低能有效理论，或者在另一个基态场构型$\phi_2$附近做一个低能有效理论，
但是$\frac{1}{\sqrt{2}} (\ket{\phi_1} + \ket{\phi_2})$同样是基态（本征值最低的能量本征态），却不是场算符的本征态，那又怎么能在它附近做展开而得到低能有效理论呢？
换而言之，在经典图景下出现的对称性自发破缺在量子理论下被恢复了。
如果我们认为系统倾向于选择一组特定的基态（这个说法本身已经非常荒唐了），那么为什么不选择$\ket{\phi}_1$和$\ket{\phi_2}$的某个合理的线性组合，让这个线性组合具有对称性？
我们实际上也可以对椅子发出同样的疑问：为什么椅子不处在所有可能的空间指向的椅子的线性叠加态？

因此，量子理论的自发对称性破缺必然是统计性质的。换而言之，只有考虑一个暴露在开放的环境中的量子系统，“自发对称性破缺”才有意义。
要让自发对称性破缺，首先必须要有破缺了对称性的态，其次破缺了对称性的特定的那一组态必须成为偏好基。
偏好基是那些在小的外界扰动下能够保持稳定的态矢量。如果对称群$G$对应的算符表示的谱在系统规模变得很大时近似是连续的，且这个算符表示和外界有耦合，那么在小的扰动下系统很容易从它的一个本征态切换到另外一个，这时的偏好基就是破缺了$G$对称性的态。
此时可以证明在偏好基表象下，哈密顿量非对角的元素会被压低，小到和外界扰动同一数量级甚至更小，因此偏好基之间的跃迁可以忽略。
这样对称性自发破缺就出现了。因此我们通常只对热力学系统讨论对称性自发破缺。

从相变的特征可以看出，对称性自发破缺是一种重要的导致相变的因素。
随着某些参数的变化，$F[\phi]$的基态可能出现简并，从而每个基态附近的低能有效理论失去原有的对称性。
在一些参数下出现了对称性自发破缺，另一些参数下没有出现，即随着参数的变化，原本的一个稳定不动点分裂成两个稳定不动点和一个不稳定不动点，从而分裂出两个相，相变就出现了。
对称性自发破缺会让系统变得更加有序（因为此时对系统做对应的操作之后系统会发生改变，即系统的构型能够传递更多信息），称更无序的相中恒为零、在更有序的相中有非零取值的量为\textbf{序参量}。%
\footnote{这里有一个微妙的地方：原则上，有序的相服从的物理规律和无序的相是完全一样的。记序参量为$\phi$，既然计算期望值时所有可能的状态都会被计入，原则上运算$\expval*{\cdot}$保留有物理规律的对称性，那么，显然应该始终有
\[
    \expval*{\phi} = 0,
\]
但这似乎并不正确，既然我们希望序参量在有序的相中非零。
这里的关键点在于，在有序相中，系统发生对称性自发破缺，出现多个自由能一样大的自由能局域极小值点；当系统规模趋于无穷大时，从一个极小值点跃迁到另一个的概率会大大下降，从而让这些局域极小值点附近的状态成为亚稳态。
于是，对真正的热力学系统，从一个极小值点跃迁到另一个的概率降至零，也即，对一个已经发生了对称性自发破缺的系统，它的状态做一个对称性操作之后得到的态是不可及的；
于是原本的物理规律也随之“分裂”成若干个对称性发生了破缺的理论，这些理论中的每一个的$\expval*{\cdot}$都不再具有原来的对称性。
（我们需要手动将“系统破缺到了哪一个极小值点附近”手动放进去才能够得到具体的有效理论）
这就是之前提到相变必须在热力学系统中发生的原因。
}%
序参量一定是存在的，因为更有序的相既然发生了对称性破缺，应当需要更多的参数来标记。（还是以墨西哥草帽为例，需要一个额外的参量来表示系统位于帽子下陷位置的哪一点）%
\footnote{这里其实有一些术语上的混乱，因为依照定义序参量应该就是一个数，而“更有序的相既然发生了对称性破缺，应当需要更多的参数来标记”，在正则量子化的框架中这“更多的参数”应该是某个可以将简并的态区分开来的元激发算符，比如说对晶格来说就是声子场。
序参量可以是这些算符的期望，但不应该“就是”这些算符。
或者，如果将这些算符称为序参量，就应该记住序参量是有涨落的，比如说，对晶体而言，序参量可以是某个标记了晶格周期性的量，但是晶格可以发生畸变，出现声子场等。}%

容易证明，在临界点附近，具有同样的对称性（即在特定变换下变化方式一样）的序参量之间有正比关系。
这也就意味着实际上序参量的选择具有很大的任意性。
例如，为了一些原因，我们可以引入一个辅助场$\psi$，把系统中某种场$\phi$的自相互作用转变为$\phi$和$\psi$的相互作用（对两体相互作用而言，这就是Hubbard–Stratonovich变换），而如果能够适当选择辅助场，我们可以让$\psi$成为序参量，并积掉所有其它的场，从而得到一个临界点附近的、仅仅关于序参量的有效理论。
有时可能会碰到其它场无法积掉的情况，此时就会得到临界点附近的、同时含有序参量和其它场的有效理论。
视具体情况而定，我们可以获得临界点附近的主要模式（序参量，以及可能的其它场）以及对称性，从而写出关于序参量（或者还有别的变量的）的低能有效理论，这就是\textbf{金斯堡-朗道理论}。

虽然本节我们用“序参量”表示相变导致的多余参数，但并非所有相变都有一个局域的序参量，例如，相变导致的多余参数可以是一个拓扑激发，那么它就不能写成一个局域的量。

相互作用让系统倾向于产生特殊的激发，而涨落（包括热涨落和量子涨落，这两者在路径积分的框架中可以看得更加清楚：零温下没有热涨落，但是最速降近似也未必成立，同样需要计算配分函数）则倾向于抹去这些激发，因此系统中总是存在相互作用和涨落的竞争。
有时，使用平均场理论可以计算得到一个相变，但是引入大$N$展开的更多项之后也许会发现序参量在超越平均场的涨落下消失了。

% TODO：平均场理论就是只考虑最可几位形；如果做平均场之后破坏了某个对称性，那么可以加一个拉格朗日乘子来手动放回去这个对称性；这是因为如果原来的哈密顿量能够保持某个对称性，那么在场构型中加入保持这种对称性的$\delta$函数因子总是可以的；那么，我们可以做完平均场之后把$\delta$函数因子放回指数中，从而得到一个类似于化学势的东西

也有一些相变并不涉及对称性的变化，此时就不能够使用序参量来表征相变。例如水的气液相变和有外磁场的伊辛模型的铁磁区自旋顺着磁场和逆着磁场的相变就是一个典型例子。
一级相变的机制通常是，系统有多个低能有效理论，随着某些参数的变化最稳定（自由能更低）的低能有效理论会发生变化（从液态变为气态，顺磁变为铁磁，等等），而当两个低能有效理论同样稳定时就出现两相共存，此时就达到一级相变的相变点。
这些低能有效理论可以具有同样的对称性，一级相变并不总是涉及对称性自发破缺（但是也可以涉及）。
在有多个参数时，一级相变的两相共存曲线可以是断开的，断点称为\textbf{临界点}。沿着两相共存曲线到达临界点时，两个低能有效理论可能会融合成一个，这意味着出现了一个二级或以上的相变：原本有两个低能有效理论，说明系统会有对称性自发破缺，现在只有一个，说明此对称性自发破缺消失了。
从一个相绕过临界点到达另一个相则不涉及二级相变。
当然，如果一个一级相变出现了对称性自发破缺，那么其两相共存曲线就不存在临界点，因为对称性不同的两个相绝对不会融合。

\subsection{热力学的统计物理基础}\label{sec:from-statistical-to-thermo}

原则上有了平衡态统计物理就足以确定系统状态了。很自然的问题是，热力学和平衡态统计物理描述的系统有什么关系。
本节将考虑\autoref{sec:equilibrium-system}中提到的系统。为了保持一般性，我们将讨论可以和外界交换守恒荷的系统，也即，平衡时需要使用巨正则系综描述的系统。
我们总是这样选择系统的范围，让系统和外界的相互作用哈密顿量相对于系统自己的哈密顿量来说并不大。

本节需要解决两个问题。首先需要确定热力学是不是对本节所述的平衡态系统成立，其次，如果成立，需要找到一组合适的热力学坐标来描述它。换而言之，我们需要从统计物理推导出可以做具体计算的热力学。
实际上由于统计物理更善于计算具体的物理量，我们可以把这个过程倒转过来：先找到一组看起来像是热力学坐标的量，然后再表明它们确实是一个热力学理论中的热力学坐标。

\subsubsection{温度}

% TODO:表明统计力学中定义的温度是合适的热力学温度
% TODO：将外力做功产生的那部分能量计算进能量中，得到的实际上是焓而不是熵

\subsubsection{内能、功、热量的微观解释}\label{sec:head-work-energy-explained}

现在考虑热力学第一定律。在热力学中我们没有给出区分热量和功的方法，而只是笼统地讨论了“热量需要满足如何如何的性质，功要满足如何如何的性质”。实际上我们也没有定义内能。
因此我们需要指出，热力学量——也即，功、热量、内能的概念——在统计物理中确实有明确的意义。

首先认定：内能$U$就是系统的平均能量$\bar{E}$或者说$\expval*{H}$。它是不是好的内能定义取决于是不是可以写出一个关于它的热力学第一定律表达式。
\eqref{eq:thermodynamics-first-law}中提到，功可以看成某个广义力乘上某个热力学坐标的变化量。所谓热力学坐标必须不多不少正好能够确定一个平衡态系统的密度算符。要确定系统的密度算符需要的量无非属于下面三类：
\begin{itemize}
    \item $\hat{H}$。其形式通常是给定的，但是它可以带有一些参数，例如，盒中气体的哈密顿量就带有一个参数，即盒子的体积；
    \item 所有的$\mu_i$；
    \item 温度$T$，或者其倒数$\beta$。
\end{itemize}
给定了这些，通过\eqref{eq:grand-canonical-ensemble-density-operator}就能够计算出密度算符——哈密顿量携带的外参数决定了哈密顿量，哈密顿量、化学势、温度决定了平衡态密度算符。
记$\hat{H}$中的参数为$\{q_i\}$，则$(\{q_i\}, \{\mu_i\}, T)$就是系统的一组热力学坐标，它们标记了系统的宏观态。

实际上，化学势通常是难以直接测定的，所以我们尝试寻找另一些量取代它们。
对\eqref{eq:entropy-mu-beta}取微分，并保证诸$\{q_i\}$不变，这样就没有不是守恒荷变化导致的做功，于是有
\[
    \begin{aligned}
        \dd{S} &= \dd{\left(\ln \Xi - \beta \pdv{\ln \Xi}{\beta} - \sum_j \mu_j \pdv{\ln \Xi}{\mu_j}\right)} \\
        &= - \beta \dd{\pdv{\ln \Xi}{\beta}} - \sum_i \mu_i \dd{\pdv{\ln \Xi}{\mu_i}},
    \end{aligned}
\]
从而
\[
    \begin{aligned}
        T \dd{S} &= - \dd{\pdv{\ln \Xi}{\beta}} - \sum_i \frac{\mu_i}{\beta} \dd{\pdv{\ln \Xi}{\mu_i}} \\
        &= \dd{U} - \sum_i \mu \expval*{\hat{N}_i}.
    \end{aligned}
\]
最后考虑$q_i$的变化，就写出
\begin{equation}
    \dd{U} = T \dd{S} + \sum_i F_i \dd{q_i} + \sum_i \mu_i \dd{N_i}.
    \label{eq:equilibrium-first-law}
\end{equation}
其中已经使用符号$N_i$代替了平均值$\expval*{\hat{N}_i}$，这是为了表明守恒荷平均值是一个热力学坐标。
在推导巨正则系综时我们把化学势当成了一个外加的参数，但\eqref{eq:equilibrium-first-law}说明化学势可以从一组不含化学势的热力学坐标计算出来。

\eqref{eq:equilibrium-first-law}说明了两件事：首先，它表明诸$\mu_i$和诸$N_i$是共轭的变量，并且可以使用$U$而不是$S$为独立变量，因此知道了元组$(U, \{q_i\}, \{N_i\})$同样可以把一个平衡态系统的密度算符确定下来，换而言之，平衡态系统的宏观状态就是元组$(U, \{q_i\}, \{N_i\})$，它们是非常自然的热力学坐标。（非平衡状态需要使用比这更多的参数才能够确定，涉及非平衡状态的过程也不是$(U, \{q_i\}, \{N_i\})$空间中的曲线能够完整描述的）
其次，\eqref{eq:equilibrium-first-law}的推导假定了系统始终处于平衡态，而它的右边出现了$T\dd{S}$项，我们目前还没有证明通过密度算符定义的熵$S$是热力学熵，但是无论如何\eqref{eq:equilibrium-first-law}看起来这很像可逆过程的热力学第一定律，因此$\bar{E}$可能确实是良好的内能的定义。

现在考虑一个一般的过程——也即，可以涉及非平衡态系统的过程。
% TODO：非平衡态下无法定义化学势
% 从而将$\{\mu_i\}$——或者等价的$\{N_i\}$——看成哈密顿量的参数。这样就有
\[
    \dd{U} = \trace (\dd{\hat{\rho}} \hat{H}) + \sum_i \trace \left( \hat{\rho} \pdv{\hat{H}}{q_i} \right) \dd{q_i},
\]
我们使用$\{q_i\}$写出了$\hat{H}$的变化量是因为$\hat{H}$只和这些量有关，描述非平衡态系统需要的热力学坐标以外的参数是用来描述$\hat{\rho}$的。
请注意上式的形式和热力学第一定律非常一致，更明确地说，就是
\begin{equation}
    \dd{U} = \underbrace{\trace (\dd{\hat{\rho}} \hat{H})}_{\var{Q}} + \sum_i \underbrace{\trace \left( \hat{\rho} \pdv{\hat{H}}{q_i} \right)}_{F_i} \dd{q_i},
    \label{eq:first-law-in-statistics}
\end{equation}
因此我们这就定义了内能、功和热量。接着需要检验这样定义出来的内能、功和热量是不是具有可加性。
设有两系统，记为1和2，它们组成的总系统的哈密顿量为
\[
    \hat{H} = \hat{H}_1 + \hat{H}_2 + \hat{H}_I,
\]
其中$\hat{H}_I$为相互作用哈密顿量。假定相互作用很弱，则近似可以认为两个系统无纠缠，且略去$\hat{H}_I$项，从而对热量，有
\[
    \begin{aligned}
        \var{Q} &= \trace (\dd{\hat{\rho}} \hat{H}) \\
        &= \trace ((\dd{\hat{\rho}_1} \otimes \hat{\rho}_2 + \hat{\rho}_1 \otimes \dd{\hat{\rho}_2}) (\hat{H}_1 + \hat{H}_2)),
    \end{aligned}
\]
展开计算，并注意到
\[
    \trace (\dd{\hat{\rho}_1} \otimes \hat{\rho}_2 \hat{H}_1) = \trace(\dd{\hat{\rho}_1} \hat{H}_1) \trace \hat{\rho}_2 = \trace(\dd{\hat{\rho}_1} \hat{H}_1),
\]
以及
\[
    \trace (\dd{\hat{\rho}_1} \otimes \hat{\rho}_2 \hat{H}_2) = \dd{(\trace \hat{\rho}_1)} \trace(\hat{\rho}_2 \hat{H}_2) = 0,
\]
我们得到
\[
    \var{Q} = \trace(\dd{\hat{\rho}_1} \hat{H}_1) + \trace(\dd{\hat{\rho}_2} \hat{H}_2) = \var{Q_1} + \var{Q_2},
\]
这就证明了热量的可加性。类似地也可以证明功的可加性。既然已经证明了热量和功的可加性，内能的可加性也就自动获得了。
总之，按照\eqref{eq:first-law-in-statistics}定义的内能、功、热量完全符合热力学第一定律的要求。

在刚才的推导中，我们使用系统的哈密顿量$\hat{H}$来定义系统内能，但实际上这可能并不是最理想的定义。
例如，考虑一个和外界有相互作用的磁体，它的哈密顿量可能是
\[
    \hat{H} = \text{something about $\mu_i$} + \sum_i \mu_i B,
\]
其中磁场$B$为外参数。第一项显然应该计算到磁体的内能中；第二项实际上代表了磁体和外界的相互作用，但是它并不是前面提到的相互作用哈密顿量$\hat{H}_\text{int}$，因为这一项和系统规模同阶。
第二项是否应该计入磁体内能中？它显然展示了系统和外界发生相互作用的主要方式，所以计算配分函数时肯定要出现在$\ee$指数上。
但是我们通常不会觉得这一项纯粹是磁体的内能，而更倾向于将它解释成磁体的“势能”。
类似的，理想气体的哈密顿量除了气体分子的动能项以外还必须引入一个势阱，但是我们通常不会认为这个势阱导致的能量是“内能”。
概括地说，很多时候我们有
\[
    \hat{H} = \hat{H}_\text{0} + \hat{V}(\{q_i\}),
\]
$\hat{H}_0$不显含外参数。等号右边的两项同阶，并且我们希望取
\[
    U = \expval*{\hat{H}_0},
\]
而不是
\[
    U = \expval*{\hat{H}}.
\]
由于$\hat{H}_0$不显含外参数%
\footnote{需注意这不代表$U$就一定不显含外参数。例如，如果是平衡态统计力学，那么外参数会影响$\hat{\rho}$，而$\hat{\rho}$又会影响$U$，于是$U$的表达式也会带上外参数。
但$\hat{H}_0$的定义可以不显含外参数。}%
，朴素地对$\hat{H}_0$应用\eqref{eq:first-law-in-statistics}不能够区分做功和热量。
如果还是要求
\[
    \var{Q} = \trace (\dd{\hat{\rho}} \hat{H}) = \trace (\dd{\hat{\rho}} (\hat{H}_0 + \hat{V})), 
\]
那么对$\hat{H}$应用\eqref{eq:first-law-in-statistics}之后可以写出热力学第一定律为
\begin{equation}
    \dd{U} = \underbrace{\trace (\dd{\hat{\rho}} \hat{H})}_{\var{Q}} + \underbrace{\sum_i \trace \left( \hat{\rho} \pdv{\hat{H}}{q_i} \right) \dd{q}_i - \dd{\expval*{\hat{V}}}}_{\var{W}}.
\end{equation}
在上式中也可以验证功的可加性。此时，原本的外参数$q_i$不再能够让功写成
\[
    \var{W} = \sum_i F_i \dd{q_i}
\]
的形式，需要更改外参数来得到这样的形式。
$\expval*{\hat{H}}$不对应特殊的热力学量。如果$\hat{V}$和$\{q_i\}$是正比的，那么$\expval*{\hat{H}}$对应\textbf{焓}，即$U - \sum_i F_i q_i$，这种情况称为\textbf{吉布斯正则系综}，一般的正则系综、巨正则系综（可以将守恒荷看成$q$，化学势看成$V$对$q$的导数）、上面举的外加磁场的磁体、分析气体时常用的等温等压系综等均属此类。
吉布斯正则系综可以看成巨正则系综的某种推广，例如等温等压系综中的体积可以看成一种守恒荷（系统的体积加上环境的体积总是恒定的），压强是与体积相对的化学势。
如果$\hat{V}$取其它形式，$\expval*{\hat{H}}$可能具有别的意义。

将内能看成$\hat{H}$的期望值得到的热力学和将内能看成$\hat{H}_0$的期望值得到的热力学之间只相差一个不改变熵的勒让德变换，因此可以首先将内能看成$\hat{H}$的期望值，使用统计力学算出其准确值之后再做勒让德变换。
因此以下均以$\hat{H}$的期望值为内能。

\subsubsection{热力学第二定律的微观解释}

现在的问题是，按照以上方法定义的热量是否也符合热力学第二定律的要求？
热力学第二定律等价于两个条件：首先平衡态时应有$\var{Q}=T\dd{S}$，其次孤立系统的熵总是应该增大。
下面验证这两个条件。

为了验证第一个条件，我们首先使用一个简化的记号。考虑一个平衡态开放系统，用正则系综描述它，用角标$i$标记同一个宏观态下的各个微观态，$p_i$表示微观态$i$出现的概率，这样内能、宏观态变化时的做功和热量就可以写成
\[
    U = \sum_i p_i E_i, \quad \var{W} = \sum_i p_i \dd{E_i}, \quad \var{Q} = \sum_i E_i \dd{p_i},
\]
其中
\[
    p_i = \frac{1}{Z} \ee^{- \beta E_i}.
\]
请注意用记号体系下只有无穷小过程的热量和做功能够被分开，否则如果宏观态发生较大变化，微观态可能合并、分裂。
由于平衡态系统的密度算符是对角化的，熵就是
\[
    S = - \sum_i p_i \ln p_i,
\]
其变化为
\[
    \begin{aligned}
        \dd{S} &= - \sum_i \ln p_i \dd{p_i} - \sum_i p_i \dd{\ln p_i} \\
        &= - \sum_i \ln p_i \dd{p_i} - \dd{\sum_i p_i} \\
        &= - \sum_i \ln p_i \dd{p_i}.
    \end{aligned}
\]
由正则系综的性质，有
\[
    \ln p_i = - \frac{1}{T} E_i + \ln Z ,
\]
从而
\[
    \dd{S} = \frac{1}{T} \sum_i E_i \dd{p_i} + \sum_i \ln Z \dd{p_i} = \frac{1}{T} \sum_i E_i \dd{p_i}.
\]
这样就得到了
\[
    \var{Q} = T \dd{S},
\]
第一个条件得到验证。

关于第二个条件，通过随机过程的理论可以证明涨落定理：孤立系统熵增加$S$的概率和熵减少同样值的概率之比正比于$\ee^{At}$。
这就意味着孤立系统熵增的概率远远大于熵减，于是热力学第二定律的微观解释就完全得到说明。

然而从统计物理给出的热力学第二定律的解释必然需要解决几个疑难：
\begin{enumerate}
    \item 首先，遵循一个哈密顿量做时间演化时，由刘维尔定理熵似乎根本不会增加；
    \item 其次是时间箭头：为什么遵循时间反演不变性的系统在宏观上展现出了一个时间方向（即熵增的方向）？
    毕竟，既然写出了从密度算符到熵的表达式，那么对一个熵增的过程，把它倒转过来就得到了一个熵减的过程。
    那么，看起来熵增和熵减应该具有一样的概率才对。
    \item 另一个疑难是，闭合系统有庞加莱复现性：只要经过足够长的时间，系统总可以演化到和初态任意接近的状态。如果熵是密度算符的函数，那么只要经过足够长时间，熵总是可以减少的。
\end{enumerate}

第一个疑难的一种解释是，热力学系统的时间演化遵循的实际上不是\eqref{eq:quantum-liouville}，而是带有环境扰动的主方程。
的确，按照\eqref{eq:quantum-liouville}熵确实没有变化，但是随着时间演化，只需要小的扰动就可以让系统的状态更加偏离纯态。
一个经典的图像是，代表点分布随着时间演化，在相空间中变成了一个越来越支离破碎的形状（与此同时保持其体积不变，从而使得熵不变），如果此时加入一个小的扰动，就立刻让代表点分布的体积变大了，于是熵也就变大了。
换而言之，低熵态的数量实际上远远小于高熵态，看起来低熵态无处不在是因为它们非常分散，大部分低熵态附近就是熵较高的态，
因此一方面，看起来低熵态并不难以找到，而另一方面，在有环境扰动的情况下熵增长是一点不奇怪的，而且对一个低熵态，它有很大概率随着时间演化变成高熵态，而只有很小的概率变为熵更加低的态。
这个解释在讨论“宇宙是不是严格遵循热力学第二定律”的时候不适用，因为宇宙外没有东西能对宇宙产生扰动（也可以相信宇宙是无限的，即使天文学似乎说明宇宙有限，也可以认为本宇宙外仍有其他东西和本宇宙有微弱而非零的相互作用）。
对常规的、和环境有相互作用的体系，这个解释似乎很合理，但是我们仍然需要论证这个相互作用何以看起来像随机“扰动”。

关于时间箭头的疑难，我们应当指出，断言“熵在任何时候都会增长”当然破坏了时间反演不变性，但是一个低熵的系统熵增的概率很大并不一定违反时间反演不变性。
低熵态有很大概率演化为高熵态，高熵态演化为低熵态的概率则很小，但低熵态的数目相比高熵态很少，这样，经过一段时间的演化之后：
\begin{enumerate}
    \item 占所有可能的态中的少数的低熵态大多演化为了高熵态；
    \item 大部分高熵态还是高熵；
    \item 一小部分低熵态保持低熵；
    \item 一小部分高熵态演化为了低熵态；
\end{enumerate}
过程2和过程3的时间反演是它们自身；过程1的时间反演是过程4。可见，只要低熵态的数目相比高熵态很少，就算低熵的系统熵增的概率很大，时间反演对称性也还是能够保持的：每个过程对应的逆过程都可以发生，而所有可能的态中低熵态和高熵态的占比也并无变化。
但当我们把注意力集中在一个特定的初态时，无论这个初态自己的熵有多大，它熵减的可能性都很小；
而如果我们把注意力集中在一个特定的末态并把它的时间演化倒转，会发现这个末态经过逆转的时间演化而熵减的可能性也很小——由低熵态演化而来的高熵态只占少数，因此对一个态反过来做时间反演，它还是不太可能熵减！
因此热力学第二定律意味着一个系统熵增的概率很大，而时间反演对称性意味着这个系统可以熵减，两者可以并存。

然而需要注意的是，以这种方式解决时间箭头的疑难会导致一个新的疑难，虽然这个疑难对统计物理的理论框架并没有构成挑战，却挑战了其自然性。
既然我们可以明显地注意到熵增，这就意味着我们处于一个低熵的宇宙中，这样才能有明显的熵增，否则熵几乎总是在极大值附近波动。
但如前所述低熵的状态是很少的，那么问题是，为什么我们的世界竟然处于一个低熵态？
既然“我们的世界处于低熵态”这么一个小概率事件发生了，“我们的世界恰好处于一个能够自发熵减的高熵态”这么一个小概率事件为什么就没有发生？
既然压倒性多数的态都是高熵的，难道我们的世界正好是一个高熵态发生了一次不太可能的涨落而转变成的低熵态吗？

庞加莱复现导致的疑难的解答也是类似的：它只是表明系统可以经过演化回到初态附近，即熵可以增大再减小，但是这样的过程非常不可能出现，因为复现需要的时间非常长。我们可以把庞加莱复现看成一个巨型涨落，而需要等很长时间才能够观察到这个涨落，因此可以忽略这种现象。
但当然，我们还是需要回答为什么宇宙目前处于低熵态这个问题。

总而言之，目前虽然有各种方法可以（甚至是定量地）说明熵是如何增加的，但这些方法本身均需要人为地对体系和环境做些假设：具体而言，我们要求体系一开始和环境没什么关系，然后随着体系和环境的相互作用，信息不可逆地流入了环境，这个信息的损失意味着我们如果把注意力只放在体系上，则似乎出现了熵增。
这些假设的用处是以某种方式破坏动力学的时间反演不变性。
人类的物理学理论中所有涉及耗散、熵增等的部分都是这样的：例如玻尔兹曼方程能给出熵增，但那是因为我们做了分子混沌性假设；多体系统中的自能的虚部给出了耗散，但那是因为我们假定衰变产物“跑到了远处”不再回来。%
\footnote{
    在有些情况下这个假设是错的：例如激光器内的振荡模式“溢出”激光器的过程也是这样一个“小的体系和大的环境耦合，信息不可逆地流向环境”的过程，但这里我们关心“环境”（即激光器以外的世界），而环境中又没有别的耗散机制，那么就会发现激光器的输出是一个纯态，不是什么热光子。
}
总而言之，目前没有办法从可逆的动力学中完全第一性地推导热力学第二定律。我们只知道我们实际上会接触的体系都服从热力学第二定律，甚至还能以此为基础做定量的计算（如玻尔兹曼方程），但仅此而已。

明白了这一点后，我们再次审视热量和功的区别。这两者都涉及系统和环境的相互作用，它们的区别在于，功总是可以写成$X\dd{Y}$的形式，因此即使我们对环境的动力学不甚了解，也是可以追踪功的去向的。
反之，热量的去向是完全无从追踪的，因为它意味着什么涉及环境的具体结构。
我们再一次看到，两者的区别本质上在于“信息”：做功不涉及我们看得到的信息的丢失，而传热则涉及我们能够知道的信息的丢失。
换句话说，热量是我们不能追踪的那部分能量流动量的总和。
于是，能量耗散（即：能量流到了我们不知道的地方）和信息丢失是紧密相关的，而它们都是系统和环境发生相互作用的结果。
热量和功有明确区分这件事当然也是依赖于前述的用来“推导”热力学第二定律的各种假设的。

\subsubsection{热力学第三定律}

$T\to 0$——即$\beta \to \infty$——时，密度算符趋于系统的全部基态等几率混合而成的混合态。
设共有$g$个基态，零温下有
\[
    S = \ln \Omega = \ln g.
\]
如果系统基态没有简并，那么零温下熵就是零，而由于随着温度升高$g$不会有特别大的增长，$\ln g$在零温附近几乎不会有变化，这就得到了热力学第三定律。
如果系统基态有简并，由于$g$随着系统规模的增长速度最快也就是指数级，零温下的$S$顶多是一个常数，这个常数只和系统基态数目有关，于是同样可以得到热力学第三定律。只需要把熵的零点做一个平移，就可以让零温下的熵对任何系统都为零。
实际上，很多系统中$g \sim N$，则
\[
    \frac{S}{N} \sim \frac{\ln N}{N} \to 0 \quad \text{as } T \to 0,
\]
因此零温下熵为零。

热力学第三定律实际上是一种宏观量子效应。如果经典统计在温度趋于零时仍然适用，将会导致明显的矛盾。
例如热力学第三定律预言，$T\to 0$时，任何一种热容都满足
\[
    C = \frac{\var{Q}}{\dd{T}} = T \frac{\dd{S}}{\dd{T}} = 0,
\]
但是很容易可以构造出违反这个条件的经典系统。

\subsubsection{热力学量的统计物理表达式}

回顾\eqref{eq:increasing-entropy}，对任何一个过程，都有
\[
    \var{Q} \leq T \dd{S},
\]
于是我们得到
\begin{equation}
    \dd{U} - \sum_i F_i \dd{q_i} - \sum_i \mu_i \dd{N_i} - T \dd{S} \leq 0.
\end{equation}
给定一组热力学变量$\{X_i\}$，可以做坐标变换，如果某些$X_i$显含某些$F_j$或者$\mu_j$还需要做勒让德变换，可以写出不等式
\[
    \dd{\Phi} - \sum_i Y_i \dd{X_i} \leq 0.
\]
微分号内的部分称为这种条件下的\textbf{热力学势}。等号只对准静态过程取到。相应的，$\{X_i\}$称为$\Phi$的\textbf{自然变量}。只要得到了使用$\{X_i\}$表示的$\Phi$就可以计算出各个$Y_i$，而由于$\{Y_i\}$和$\{X_i\}$之间有确定的关系，这样就得到了我们需要的所有热力学方程。
特别的，对自然变量固定不变的系统（通常是由于一些约束条件），热力学势一定取极小值——这就是它们被称为“势”的原因。

定义
\begin{equation}
    F = U - TS, 
\end{equation}
则对准静态过程有
\begin{equation}
    \dd{F} = \var{W} - S \dd{T},
    \label{eq:free-energy-first-law}
\end{equation}
因此$F$是将变量$S$用变量$T$替换，其余不动而得到的热力学势。在等温条件下就有
\[
    \dd{F} = \var{W}.
\]
可见$\Delta F$给出了一个等温过程如果是准静态过程会做的功。既然准静态过程做功最多，$F$的变化量给出了系统在等温条件（在过程非平衡时这里的温度应为系统和外界接触点的温度）下能够做的最大功。
% TODO：以下是正则系综
考虑到\eqref{eq:entropy-from-partition-function}和\eqref{eq:canonical-expectation-of-energy}，我们有
\begin{equation}
    F = - \frac{1}{\beta} \ln Z = - T \ln Z.
    \label{eq:free-energy-and-partition-function}
\end{equation}

\eqref{eq:free-energy-first-law}和\eqref{eq:free-energy-and-partition-function}放在一起，给出了从平衡态统计物理迁移到平衡态热力学最自然的变换方式。
这一方面是因为从配分函数到热力学自由能的过程非常简单，一方面是因为，用这种方式计算出的热力学自由能是温度的函数，从而通过
\[
    S = - \eval{\pdv{F}{T}}_{\var{W} = 0}
\]
就可以计算出熵，进而计算出内能和其它物理量。反之，从配分函数出发计算内能更加复杂，而且内能需要使用熵表示出来才能够用于计算其它一切物理量（因为$\dd{U} \sim T \dd{S}$，从而需要用$U$对$S$的偏导计算其它物理量），配分函数并不直接给出熵，从而让计算变得困难。

设热力学坐标$X$和$Y$构成一对共轭变量，且这对共轭变量对应某种做功，它们做的功为$X \dd{Y}$，由于在等温条件下$F$的变动就是功的微元，有
\begin{equation}
    X = \pdv{F}{Y} = -\frac{1}{\beta} \pdv{\ln Z}{Y}.
\end{equation}
上式当然是热力学的结论，但注意到它也可以通过统计物理的方式推导出来。我们总是可以用$Y$当作哈密顿量的某个参数，令其它条件不动，$Y$发生小的变动，则有
\[
    \hat{H}' = \hat{H} + \hat{A} \dd{Y},
\]
其中$\hat{A}$是哈密顿量相对$Y$的导数，回顾\eqref{eq:lambda-disturbance}，有
\[
    \expval*{\hat{A}} = - \frac{1}{\beta} \eval{\pdv{\ln Z}{Y}}_{T},
\]
而
\[
    \dd{U} = \expval*{\hat{A} \dd{Y}} = \expval*{\hat{A}} \dd{Y},
\]
于是$\expval*{\hat{A}}$就是$X$，这样就得到了需要的结果。
内能和熵不能使用这样的方式计算。熵的表达式是
\begin{equation}
    S = - \left( \pdv{F}{T} \right)_{\var{W}=0},
\end{equation}
可以使用自由能的定义来计算内能，也可以直接使用公式
\begin{equation}
    U = - \pdv{\ln Z}{\beta}.
\end{equation}
无做功时的热容为
\[
    C = \eval{\frac{\var{Q}}{\dd{T}}}_{\var{W}=0} = \eval{\pdv{U}{T}}_{\var{W}=0} = T \eval{\pdv{S}{T}}_{\var{W}=0},
\]
最后一个等号是因为由热力学第一定律，
\[
    T = \eval{\pdv{U}{S}}_{\var{W}=0}.
\]
那么，我们就有
\begin{equation}
    C = T \eval{\pdv{S}{T}}_{\var{W}=0} = - T \eval{\pdv[2]{F}{T}}_{\var{W}=0}.
\end{equation}
$C$正比于$\ln Z$，而彼此独立的系统的$\ln Z$具有可加性，因此热容$C$对彼此独立的系统也具有可加性。

使用自由能计算\eqref{eq:correlation-function-from-partition-function}中的这种关联函数要稍微困难一些，因为自由能正比于$\ln Z$，换而言之在只知道自由能时只能够对$\ln Z$求导而不能够对$Z$求导之后再除以$Z$，而
\[
    \pdv[2]{\ln Z}{J_1}{J_2} \neq \frac{1}{Z} \pdv[2]{Z}{J_1}{J_2}.
\]
我们定义
\begin{equation}
    \cexpval{A_1 A_2 \cdots A_n} = \frac{\partial^n F}{\partial J_1 \partial J_2 \cdots J_n},
\end{equation}
称它们为\textbf{联通（connected）关联函数}或\textbf{累积量（cumulant）}（这是统计学上的术语）。
% TODO：它们实际上似乎就是每个算符减去其自身的期望值之后乘起来的期望，也就是方差的推广
联通关联函数可以直接使用自由能求导并乘上某个系数计算出来。
可以证明一个$n$点关联函数可以写成$n$点、$n-1$点、……联通关联函数的函数。
在自由场论的情况下，由于自由能不含有任何一次项，设 $\phi$是场，我们有
\begin{equation}
    \expval*{\phi_1 \phi_2} = \cexpval{\phi_1 \phi_2}.
\end{equation}
通过展开$\ln Z$的导数，我们得到
\begin{equation}
    \begin{bigcase}
        \cexpval{\phi} &= \expval*{\phi}, \\
        \cexpval{\phi_1 \phi_2} &= \expval*{\phi_1 \phi_2} - \expval*{\phi_1} \expval*{\phi_2}, \\
        \cexpval{\phi_1 \phi_2 \phi_3} &= \expval*{\phi_1 \phi_2 \phi_3} - \expval*{\phi_1 \phi_2} \expval*{\phi_3} - \expval*{\phi_1 \phi_3} \expval*{\phi_2} - \expval*{\phi_2 \phi_3} \expval*{\phi_1} + 2\expval*{\phi_1} \expval*{\phi_2} \expval*{\phi_3}, \\
        \ldots
    \end{bigcase}
\end{equation}
反过来，我们有
\begin{equation}
    \begin{bigcase}
        \expval*{\phi} &= \cexpval{\phi}, \\
        \expval*{\phi_1 \phi_2} &= \cexpval{\phi_1 \phi_2} + \cexpval{\phi_1} \cexpval{\phi_2}, \\
        \expval*{\phi_1 \phi_2 \phi_3} &= \cexpval{\phi_1 \phi_2 \phi_3} + \cexpval{\phi_1 \phi_2} \cexpval{\phi_3} + \cexpval{\phi_1 \phi_3} \cexpval{\phi_2} + \cexpval{\phi_2 \phi_3} \cexpval{\phi_1} + \cexpval{\phi_1} \cexpval{\phi_2} \cexpval{\phi_3}, \\
        \ldots
    \end{bigcase}
\end{equation}
通过数学归纳法可以证明更加一般的形式：
\begin{equation}
    \begin{aligned}
        \expval*{\phi_1 \phi_2 \cdots \phi_n} &= \cexpval{\phi_1 \phi_2 \cdots \phi_n} + \sum_{i} \cexpval{\phi_1 \cdots \widehat{\phi_i} \cdots \phi_n} \cexpval{\phi_i} \\
        &+ \sum_{i < j} \cexpval{\phi_1 \cdots \widehat{\phi_i} \cdots \widehat{\phi_j} \cdots \phi_n} \cexpval{\phi_i \phi_j} + \cdots + \expval*{\phi_1} \expval*{\phi_2} \cdots \expval*{\phi_n}.
    \end{aligned}
\end{equation}
其中，一连串算符的乘积中将一个算符戴上尖帽子$\widehat{\ }$表示这个算符不参与乘法运算，如$\phi_1 \widehat{\phi_2} \phi_3$表示$\phi_1 \phi_3$，$\phi_2$不出现。

以上结果建立在认定内能就是$\expval*{\hat{H}}$的基础上；如果内能的定义有变，则需要使用$\expval*{\hat{H}} - TS$代替所有$F$。
采用和\autoref{sec:head-work-energy-explained}一样的记号，设
\[
    \hat{H} = \hat{H}_0 + \hat{V},
\]
并将$\expval*{\hat{H}_0}$看成内能，并适当地做这个划分，使得$\hat{H}_0$和$\hat{V}$在热力学极限下几乎是对易的。
此时依照定义可以证明，我们有
\[
    - T \ln Z_H = - T \ln Z_{H_0} - T \ln Z_{V},
\]
而
\[
    - T \ln Z_{H_0} = F,
\]
于是$-T \ln Z_H$就是另一个热力学势，而不是$F$。
例如对吉布斯正则系综，$-T \ln Z_H$给出的是吉布斯自由能$F + \pdv{V}{q}q$，而不是$F$。此时有关的热力学公式都要做修改，但这些修改是非常机械的，很容易得到。

实际上，当系统的哈密顿量比较简单，可以解析地写出状态数时，则可以使用微正则系综，即认为熵就是\eqref{eq:entropy-and-state-number}，并配合热力学方程。
回顾最大熵原理，孤立系统（或者任何一个热力学系统，由于系综等价性）的熵在其可及的范围内达到最大。
所谓可及的范围指的是哈密顿量中的参数完全确定，各个守恒荷的值给定的所有状态。
很多时候哈密顿量中的参数和各个守恒荷的值不能完全确定，而是由一系列约束方程确定它们之间的关系，此时可及的范围指的是热力学坐标满足约束条件的所有状态。
那么，最大化系统可及范围内的熵，就可以得到平衡态时系统的状态。%
\footnote{在最大化过程中可调的这些参数，对平衡态系统而言未必都是独立的热力学变量。例如，我们把一个系统内各部分压强当成独立的参数，然后最大化熵，则最大化条件可能是“各部分压强相等”，因此各部分压强对平衡态系统而言不都是独立的热力学变量，虽然对非平衡态系统它们可以独立变化。}%
这种方法相当于最大化$\Omega$，因此又称为\textbf{极大概然法}，因为相当于是将可观察量的极大概然值当成了其期望值。这样做是合理的，因为涉及大系统的可观察量的涨落相对较小，即其概率分布非常尖锐，从而配分函数几乎完全由鞍点决定。
这样，原则上可以只使用\eqref{eq:entropy-and-state-number}以及内能（或者别的热力学势）关于系统状态的公式这两个统计力学的公式，加上热力学第一定律就能够完全计算出体系的全部性质。
如果需要考虑系统和热库的相互作用，由\autoref{note:res-state-number}，设热库的状态数为
\begin{equation}
    \Omega_R (U_R) = \gamma \ee^{\beta U_R}
\end{equation}
即可，其中$\gamma$是一个和$U_R$无关的常数。
但实际上，在相互作用比较明显时，难以写出能量本征态，自然也很难数出$\Omega$；此外，$\Omega$通常很大，其结果是$\ln \Omega$难以精确计算，通常只能够使用斯特林公式获得近似结果。因此，基于配分函数的计算仍然是最好用的方案。

\subsection{从量子统计退化到经典统计}\label{sec:from-quantum-to-classical}

\subsubsection{代表点密度和经典配分函数}

在经典统计力学中我们使用代表点密度而不是密度算符来处理问题。这两者之间有一个线性关系，从而
\[
    \rho(x, p) \propto \mel{n}{\hat{\rho}}{n} \propto \ee^{- \beta H_n},
\]
由于经典情况下坐标和动量几乎是对易的，$x, p$是$\ket{n}$的诸广义坐标和广义动量，因此上式可以写成
\[
    \rho \propto \ee^{-\beta H(x, p)},
\]
于是对正则系综，有
\begin{equation}
    \rho = \frac{1}{Z} \ee^{- \beta H(x, p)},
\end{equation}
其中
\begin{equation}
    Z = \int \dd{\Gamma} \ee^{- \beta H(x, p)},
    \label{eq:classical-partition-function}
\end{equation}
巨正则系综可以有类似的处理。经典统计物理中计算可观察量期望值的方法为
\begin{equation}
    \expval*{A} = \frac{\int \dd{\Gamma} A(x, p) \ee^{-\beta H(x, p)}}{\int \dd{\Gamma} \ee^{-\beta H(x, p)}},
\end{equation}
容易验证，量子统计中从配分函数及其导数计算可观察量期望值的公式仍然成立。

以上我们只是说明了从经典统计力学出发也可以得到配分函数，并且可以使用配分函数计算各种我们需要的物理量，但并没有说明什么时候可以使用经典统计力学。
显然，系统所有的尺度都远大于对应的量子效应开始呈现的尺度时经典统计力学肯定是适用的。
空间尺度非常微观的系统当然不满足这个条件，但实际上，很多宏观的系统也不完全满足这个条件。
例如可以考虑一个近独立粒子组成的系统，此时每个粒子的位置、动量等和其它粒子都是独立的，而每个粒子的能量相对于$\hbar$来说未必特别大，因此量子力学不能过渡到经典力学。
这就导致了两个重要的结果：其一，不能真的将在量子力学中不对易的量看成是对易的，也即积分测度不能是相空间中的体积元$\dd{\Gamma}$；
其二，能量的分立性不能忽略，这是很显然的，因为经典理论的配分函数为
\[
    Z_\text{classical} \sim \int \dd{\Gamma} \ee^{-\beta H},
\]
量子理论的配分函数为
\[
    Z_\text{quantum} \sim \sum_n \ee^{- \beta H_n},
\]
在$\beta$较大（也即温度较低）时，前者和后者相差非常明显，因为$\ee^{-\beta H}$此时下凸得非常厉害，诸$\{H_n\}$的排列紧密程度不足以让求和变成积分。
在$T$真的非常低时，量子效应非常明显，此时经典理论完全失效；但$T$相对较高时通过一些修正还是可以使用经典理论得到相当精确的效果。
第一个问题，即物理量不对易的问题，可以通过引入相格的概念加以解决。量子力学中可以证明，可以近似将相空间看成一系列大小为$(2\pi \hbar)^s$的不相交的格子组成的，其中$s$是坐标-动量对的总数，每个格子表示一个本征态，这样可以做近似
\[
    \sum_n \longrightarrow \frac{1}{(2\pi \hbar)^s} \int \dd{\Gamma}.
\]
第二个问题可以通过对求和$\sum_n \exp (- \beta H_n)$做一个截断加以解决。
既然对比较大的$H_n$，$\exp(-\beta H_n)$几乎为零，考虑一个量级和$\beta$相同的截断因子$\Lambda$，则
\[
    \sum_n \ee^{-\beta H_n} \approx \sum_{H_n < \Lambda} \ee^{-\beta H_n},
\]
记
\[
    \hat{H}' = \sum_{H_m < \Lambda} \dyad{m} H_m,
\]
则
\[
    \sum_n \ee^{- \beta H_n} = \sum_n \ee^{- \beta H'_n},
\]
$\hat{H}'$不包括特别大的能级，因此近似有
\[
    \sum_n \ee^{-\beta H'_n} = \frac{1}{(2\pi \hbar)^s} \int \dd{\Gamma} \ee^{- \beta H'(x, p)},
\]
换而言之计算经典配分函数时应该使用$H'$而不是$H$作为哈密顿量。$H'$是将$H$中能量远大于$\beta$的部分去掉之后得到的哈密顿量，换而言之，我们发现使用$\hat{H}$做经典计算所得结果并不好，使用将$\hat{H}$中的高能自由度去掉之后得到的哈密顿量做经典计算得到的结果反而好，这种现象称为\textbf{自由度冻结}。

\subsubsection{经典统计力学的特殊性质}

经典统计力学可以使用微积分处理位置和动量，性质更加良好，因此可以证明一些量子统计力学中并不一般成立的结果。例如我们有\textbf{能量均分定理}。以正则系综为例，我们有
\[
    \begin{aligned}
        Z &= \int \dd{\Gamma} \pdv{x_k}{x_k} \ee^{- \beta H(x, p)} \\
        &= \int \dd{\Gamma} \pdv{x_k} \left(x_k \ee^{- \beta H(x, p)}\right) - \int \dd{\Gamma} x_k \pdv{\ee^{- \beta H(x, p)}}{x_k} \\
        &= \int \dd{\Gamma_k} \eval{x_k \ee^{- \beta H(x, p)}}_\text{boundary} - \int \dd{\Gamma} x_k ( - \beta) \pdv{H}{x_k} \ee^{- \beta H(x, p)},
    \end{aligned}
\]
其中$\dd{\Gamma_k}=\dd{\Gamma}/\dd{x_k}$，即不对$x_k$积分。
有物理意义的系统，相空间边缘处的能量应该是无穷大（否则这就不是真正的边界：怎样保证系统不会越过相空间的边缘呢？），从而第一项为零，于是
\[
    Z = \beta \int \dd{\Gamma} x_k \pdv{H}{x_k} \ee^{-\beta H(x, p)},
\] 
将$Z$移动到右边，我们会发现方程右边正是一个系综平均，于是
\begin{equation}
    \expval{x_k \pdv{H}{x_k}} = \frac{1}{\beta}.
\end{equation}
这就是能量均分定理。由系综等价性，上式对平衡态系统普遍成立。
这个定理叫做能量均分定理是因为，如果$H$是二次型，且不同自由度%
\footnote{“自由度”一词有时表示描述系统需要的CSCO的总数，那么，设一个系统有3个坐标，3个动量，它就有3个自由度。但在这里我们使用“自由度”来表示正则变量的总数，在这种定义下上述系统就有6个自由度。
\label{note:degree-of-freedom-counting}
}%
之间无耦合，那么就有
\[
    x_k \pdv{H}{x_k} = 2 E_k,
\]
其中$E_k$是哈密顿量中分配在自由度$x_k$上的能量（这是良定义的，既然不同自由度无耦合，所以没有相互作用能），从而
\begin{equation}
    \expval{E_k} = \frac{1}{2\beta}.
\end{equation}
关于“无耦合”要说一句：如果不同自由度真的一点耦合也没有，那么系统根本不能够达到热平衡，因为没有能量交换。但实际上，微正则系综会受到小的外界扰动，正则系综和巨正则系综中的不同自由度和热库都有耦合，因此即使系统自己的哈密顿量中不同自由度之间没有耦合，系统和外界的接触也会让系统能够达到热平衡，从而让能量均分定理适用。

\subsubsection{熵}

由于代表点密度和密度算符之间的线性关系并不明确，经典配分函数和量子统计的配分函数之间会差一个常数因子。这个因子肯定不是1，因为两者的量纲都不一致。
如\autoref{sec:calculation-from-canonical-partition}所述，配分函数前的因子不适当将会导致熵的表达式不适当，从而让熵失去可加性。
实际上，在经典统计中问题还要严重。由于经典统计力学中不可能良定义一个状态数（在本文展示的量子统计力学首先考虑分散的能级，然后推广到连续谱，而经典统计力学中任何东西都是连续的），朴素地写下
\[
    S = \ln \Omega
\]
将会得到一个无穷大的结果，因为$\Omega$是无穷大的。因此我们只能对相空间做一个粗粒化，来获得有限的结果。
不同的粗粒化方案之间相差一个常数，因此相当奇怪的，通过经典统计力学竟然不能得到确定的熵的表达式！
可以确定的是，如果朴素地将经典配分函数当成量子配分函数做计算，对粒子数守恒的全同粒子系统%
\footnote{全同粒子指的是使用同一套产生湮灭建立的粒子。例如，一群电子，无论其动量如何分布，都是全同的，因为它们都是QED中的同一个旋量场创生的；电子和光子就不是全同的，即使它们的动量一样，因为它们是不同的场创生的。}%
，得到的熵是不正确的。这称为\textbf{吉布斯佯谬}，即理应满足熵可加性的系统并无预期的熵可加性。
从物理图像上看，这是因为计算经典配分函数时积分测度是
\[
    \int \dd{\Gamma} = \int \prod_i \dd{x_i} \dd{p_i} = \int \prod_n \prod_{s|n} \dd{x_{n,s}} \dd{p_{n,s}},
\]
其中$i$跑遍所有的自由度，$n$跑遍所有的粒子，$s$跑遍单个粒子的所有自由度，这个积分测度暗含着将基本粒子用从$1$跑到$N$（总粒子数）的编号$n$标记了，但实际上对全同粒子不可能良定义这样的一个粒子标签来区分全同粒子；此外，该积分测度还假定了粒子的坐标和动量%
\footnote{未必就是实际的坐标和动量，任何在哈密顿动力学中构成共轭对的变量都可以。}%
是可以完全确定下来的，在量子力学中这当然是不正确的，因此我们需要把相空间做粗粒化，把同一个相格中的不同$x$和$p$当成相同的。

下面我们分析，对粒子数守恒的系统如何计算经典配分函数以获得正确的熵。（粒子数不守恒的系统通常没有必要使用经典统计物理分析）
设系统中共有$k$种全同粒子%
\footnote{关于怎么样算“一种”粒子需要特殊说明。使用$q$表示在求和中会发生变化的全部变量，如果交换两个$q$分别为$q_1$和$q_2$的粒子之后会得到新的态，那么它们就是两种粒子，即使它们可能是同一个场产生的粒子。
例如，假定有这样一个体系，其中一半的电子具有向上的自旋，一半的电子具有向下的自旋，且自旋固定不动，而动量可以随意改变，那么系统中就有两种粒子，因为显然
\[
    \hat{a}^\dagger_{\vb*{p}_1, \uparrow} \hat{a}^\dagger_{\vb*{p}_2, \downarrow} \ket{0} \neq \pm \hat{a}^\dagger_{\vb*{p}_2, \uparrow} \hat{a}^\dagger_{\vb*{p}_1, \downarrow} \ket{0},
\]
虽然所有电子都是从同一个场（QED中的一个旋量场）产生的。
\label{note:one-kind-of-particle}
}%
，它们的数量分别恒定为$N_1, N_2, \ldots, N_k$，总粒子数为$N$，每个粒子具有$D$个连续自由度%
\footnote{这里的“自由度”指的是经典的概念，即一个自由度对应一个坐标和一个动量。
我们确信连续自由度一定需要一对坐标-动量来描述，这是哈密顿动力学的自然推论：如果运动方程是二阶的，那么必定有一对坐标-动量，动量与坐标的一阶时间导数正相关；如果运动方程是一阶的，总是可以假定坐标是复的，这样其实部和虚部（可能差一些常数）就构成一对坐标-动量。
\label{note:degree-of-freedom}
}%
，有$M$个离散自由度
%
\footnote{牛顿力学处理不了离散自由度的时间演化，实际上离散自由度的起源必定是量子的，如自旋。
离散自由度的哈密顿量形如
\[
    \epsilon_1 \dyad{1} + \epsilon_2 \dyad{2} + \cdots + \epsilon_M \dyad{M},
\]
是一个离散求和。
}%
，则系统总共有$ND$个连续自由度，$MN$个离散自由度，相空间由连续和离散两部分的直积构成。
\autoref{sec:back-to-classical}告诉我们，相空间的连续部分应被看成一系列大小为$(2\pi \hbar)^{ND}$的相格，由于经典尺度下$\dd{x}$和$\dd{p}$都是宏观小微观大的微元，在大小为$\dd{\Gamma}$的连续相空间中包含了
\[
    \frac{\dd{\Gamma}}{(2\pi \hbar)^{ND}}
\]
个相格，也即，包含了这么多的可以分辨的坐标-动量对。如果两个坐标-动量对彼此是两个全同粒子互换的结果，那么它们对应了同一个量子态，考虑到这一点，$\dd{\Gamma}$体积的相空间对应了
\[
    \frac{1}{N_1! N_2! \cdots N_k!} \frac{\dd{\Gamma}}{(2\pi \hbar)^{ND}}
\]
个独立的态矢量。
量子配分函数是
\[
    Z = \sum_n \ee^{-\beta H_n},
\]
它对密度算符中所有的参与态求和，这个求和在经典近似下正是
\[
    \sum_\text{all arrangement of discrete variables} \int \frac{1}{N_1! N_2! \cdots N_k!} \frac{\dd{\Gamma}}{(2\pi \hbar)^{ND}},
\]
即对所有可能的离散自由度取值求和，并对所有可能的连续自由度积分，然后除以相格体积和全同粒子修正系数。
因子
\[
    \frac{1}{N_1! N_2! \cdots N_k!} \frac{1}{(2\pi \hbar)^{ND}}
\]
实际上是一个\textbf{态密度}——它给出了宏观的相空间体积元和微观的状态数的对应关系。引入态密度时我们自然而言地做了从量子到经典的过渡，因为我们已经将离散的量子态当成连续分布了。
在经典极限下可以认为能量本征值就是
\[
    H_n = H(x, p, s),
\]
其中$x, p, s$分别表示坐标、动量和离散自由度，于是
\begin{equation}
    Z = \frac{1}{N_1! N_2! \cdots N_k!} \frac{1}{(2\pi \hbar)^{ND}} \sum_{s} \int \dd{\Gamma} \ee^{-\beta H(x, p, s)}.
\end{equation}
类似的论证表明玻尔兹曼熵在经典情况下的表达式为
\begin{equation}
    S = \ln \frac{\Gamma}{N_1! N_2! \cdots N_k! (2\pi\hbar)^{ND}}.
\end{equation}
由于经典理论不能区分一群粒子是不是全同粒子（经典理论没有产生湮灭算符的概念，因此无从讨论全同性），常常以
\begin{equation}
    \Omega_\text{BM} = \frac{\Gamma}{(2\pi\hbar)^{ND}}
\end{equation}
为状态数，但这样得到的熵没有可加性，正确的公式是
\[
    S = \ln \Omega_\text{BM} - \ln N_1! - \ln N_2! - \cdots - \ln N_k!.
\]

% TODO：真的吗？
但要注意，通过加入修正因子$N!$得到的配分函数一般并不具有可乘性。考虑两个含有同种全同粒子的系统，它们的配分函数前面的因子分别是$1/N_1!$和$1/N_2!$，但是它们组成的总系统前面的因子就是$1/(N_1+N_2)!$。

乘上修正因子$1/N!$的操作对仅仅使用单粒子量子力学，把实际上属于全同粒子的各个粒子的量子数当成独立的变量计算出来的配分函数也是必要的。
（这样也可以看到，除了计算熵或者计算其它涉及总状态数的量以外，有没有全同粒子修正因子是无关紧要的）
乘上修正因子$1/N!$得到的结果和通过场算符计算出来的结果在热力学极限下应该是一样的。
% TODO:把这里的讨论分成两部分，一部分是全同粒子修正，一部分是相格
我们可以看到，修正因子$1/N!$实际上是纯粹的量子效应，因为经典体系下态不能线性叠加，因此不可能构造出交换两个粒子之后保持不变或者只差一个负号的态，这就是经典情况下粒子永远可以编号的原因。
实际上，即使是在量子情况下，同样有
\[
    \ket{\psi} \otimes \ket{\phi} \neq \ket{\phi} \otimes \ket{\psi},
\]
即直积的顺序很重要，但可以通过线性组合构造交换对称/反对称态来把这个自由度消除掉，此时对粒子编号没有意义。
交换对称/反对称态会导致一些特殊的物理效应（如交换能）。但即使这些效应很弱以至于可以不使用交换对称/反对称态而允许粒子被编号也能够计算出正确的结果，为了避免吉布斯佯谬，修正因子$1/N!$也是必要的。

需要注意的是，以上讨论中，跑遍所有粒子的脚标$n$只是临时的、没有任何物理实质的编号。如果$n$是实际的粒子的标签（比如格点坐标），那么并不需要修正因子$1/N!$。
换而言之，如果我们如下标记可能的系统构型：“第1个粒子的某个量为$q_1$，第2个粒子的某个量为$q_2$……”，那么必须乘以修正因子$1/N!$，
而如果如下标记可能的系统构型：“格点坐标1上的粒子的某个量为$q_1$，格点坐标2上的粒子的某个量为$q_2$……”，就不需要乘以这个因子。
这样，对一个量子多粒子系统，如果每个粒子的某个标签的值都不相同，那么这个量子多粒子系统就严格等价于一个没有该标签的经典多粒子系统。
例如，如果每个粒子都定域在彼此分开的点上，就可以使用位置这个标签把各个粒子区分开。
此时的系统虽然本质上是量子的，却可以使用经典的手段计算其配分函数。有时也称这样的系统为\textbf{定域系统}。%
\footnote{由于每个粒子都有一个独一无二的标签，也可以把这些粒子全部看成不同种类的粒子，这样修正因子就是
\[
    \frac{1}{N_1! N_2! \cdots N_k!} = \frac{1}{1! 1！ \cdots 1!} = 1,
\]
等于没有修正。关于怎么样算是“一种”粒子，见\autoref{note:one-kind-of-particle}。
}

\subsection{近独立系统}

最后我们分析一个具体的例子。考虑一个系统，其二次量子化哈密顿量保证粒子数守恒，这就意味着哈密顿量是二次型，从而总是可以找到适当的表象，使得哈密顿量为
\begin{equation}
    \hat{H} = \sum_i \epsilon_i \hat{a}_i^\dagger \hat{a}_i,
\end{equation}
即在这个表象之下粒子之间没有相互作用，没有相互作用能，系统的总能量就是各个粒子能量之和。这样的系统称为\textbf{近独立系统}，说“近”独立是因为为了确保达到热平衡，粒子之间不可能真的毫无相互作用。
此时，哈密顿量和诸能量的粒子的粒子数算符是全部守恒荷，它们的共同本征态就是“能量为$\epsilon_i$的粒子正好有$n_i$个”这种状态，即
\[
    \ket{n_1, n_2, \ldots},
\]

近独立系统的重要性在于很多看似复杂的系统实际上可以通过一些方式转化为近独立系统，就算不行，也可以通过微扰展开的方式，以近独立系统为零阶近似，定义费曼图，做各种计算。
我们知道微扰展开通常以一个自由理论为起点，而一个自由理论的算符运动方程应该是线性的，从而其哈密顿量是二次型的，那么对哈密顿量中涉及的算符做一个傅里叶变换，可以把哈密顿量中的导数项全部消除掉。
由于做了傅里叶变换之后的哈密顿量还是厄米的，它总是可以被对角化为近独立系统哈密顿量的形式（可能差一个常数，但这可以通过重新定义能量零点消除掉），其中诸$\epsilon_i$为实数——通常是正实数，因为哈密顿量应保持正定。
换而言之，任何一个自由系统实际上都是近独立系统。
加上微扰的相互作用之后，理论的格林函数出现自能修正。（不同的近似自能修正实际上就标记了不同的场论近似计算方法，比如说自洽平均场理论就是做一阶自能修正，修正本身用到了带相互作用的格林函数，从而需要自洽求解；RPA近似就是环形图近似，或者说大$N$展开中的一阶项。这些近似本质上都是对费曼图的部分求和）
本质上这种修正是因为高动量自由度被积掉，从而修正了相互作用顶角。

\subsubsection{粒子的能级分布}

为了方便接下来的计算，我们做一些记号上的修改，记$i$仅仅标记能量这个量子数，$n_i$为能级$\epsilon_i$上的粒子数。
这样，在能级$\epsilon_1$上粒子数为$n_1$，在能级$\epsilon_2$上粒子数为$n_2$，等等的状态就不止一个。
每个粒子可以使用一系列好量子数标记，记确定具有能量$\epsilon_i$的粒子的其它量子数的可能组合方式的数目为$g_i$。（例如，如果粒子可以使用能量和自旋标记，而能级$\epsilon_i$上同时存在两种自旋的粒子，那么$g_i=2$）

在巨正则系综下讨论问题。巨配分函数为
\[
    \Xi = \sum_{\{n_i\}} \Omega(\{n_i\}) \ee^{- \sum_i (\alpha + \beta \epsilon_i) n_i},
\]
即我们对所有可能的组合$\{n_i\}$（称为\textbf{布居数}，即不同能级上出现的粒子的数目）求和。
记$W_i$为能级$\epsilon_i$上放上$n_i$个粒子的独立排列方式数目（说“独立”是因为态满足叠加原理，所以总有无数种态可以让能级$\epsilon_i$上放上$n_i$个粒子），由于系统的态矢量就是不同能级的态的直积，有
\[
    \Omega(\{n_i\}) = \prod_i W_i(n_i),
\]
于是
\[
    \Xi = \sum_{\{n_i\}} \prod_i W_i(n_i) \ee^{- \sum_i (\alpha + \beta \epsilon_i) n_i} = \prod_i \sum_{\{n_i\}} W_i(n_i) \ee^{-  (\alpha + \beta \epsilon_i) n_i},
\]
设
\[
    \Xi_i = \sum_{\{n_i\}} W_i(n_i) \ee^{-  (\alpha + \beta \epsilon_i) n_i},
\]
则
\[
    \Xi = \prod_i \Xi_i.
\]
具体$W_i$是多少取决于我们分析的系统由费米子组成还是由玻色子组成。
对费米子体系，由于不可能有两个粒子具有一模一样的好量子数，显然有$n_i \leq g_i$，且$W_i$是将$n_i$个物品放进$g_i$个位置且不能重复的排列数目，即
\[
    W_i = \begin{cases}
        \frac{g_i !}{n_i ! (g_i - n_i) !}, &\quad n_i \leq g_i, \\
        0, &\quad \text{otherwise}.
    \end{cases}
\]
对玻色子体系没有这个限制，$W_i$是将$n_i$个不可分辨的物品可以重复、可以空置地放进$g_i$个可以分辨的位置的数目，则
\[
    W_i = \frac{(g_i + n_i - 1) !}{n_i ! (g_i - 1)!}.
\]
这样，对费米子体系，使用二项式定理有
\[
    \Xi_i = \sum_{n_i=0}^{g_i} \frac{g_i !}{n_i ! (g_i - n_i) !} \ee^{- (\alpha + \beta \epsilon_i) n_i} = \left( 1 + \ee^{- (\alpha + \beta \epsilon_i) } \right)^{g_i}.
\]
对玻色子体系，利用$(1-x)^{-m}$的级数展开，可以得到
\[
    \Xi_i = \sum_{n_i=0}^\infty \frac{(g_i + n_i - 1) !}{n_i ! (g_i - 1)!} \ee^{- (\alpha + \beta \epsilon_i) n_i} = (1 - \ee^{- (\alpha + \beta \epsilon_i)})^{-g_i}.
\]
因此近独立体系的巨配分函数就是
\begin{equation}
    \Xi = \prod_i (1 - \eta \ee^{- (\alpha + \beta \epsilon_i)})^{-\eta g_i},
    \label{eq:grand-partition-independent}
\end{equation}
对费米子$\eta=-1$，对玻色子$\eta=1$。
% TODO:将$\alpha$改成$\alpha_i$
很容易计算出
\begin{equation}
    \expval*{\hat{n}_k} = \frac{g_k}{\ee^{\alpha + \beta \epsilon_k} - \eta} = \frac{g_k}{\ee^{\beta (\epsilon_k - \mu)} - \eta}.
\end{equation}
$\eta=1$的情况称为\textbf{玻色-爱因斯坦分布}，$\eta=-1$的情况称为\textbf{费米-狄拉克分布}。

上式给出的是所有能量为$\epsilon_k$的粒子总数的期望值。这些期望值是从巨正则系综推导出来的，但它们也可以通过最可几分布等方法推导出来，这是系综等价性保证的。
实际上，通过引入微小的扰动，我们总是可以让能级$\epsilon_i$分裂成$g_i$个能量略有差别的能级，从而让能量简并消失，这表明，设$i$为标记产生湮灭算符的量子数（而不仅仅是标记能级的量子数），则
\begin{equation}
    \expval*{\hat{n}_i} = \frac{1}{\ee^{ \alpha + \beta \epsilon_i} - \eta } = \frac{1}{\ee^{\beta (\epsilon_i - \mu)} - \eta }.
\end{equation}

粒子数算符显然是一个热力学量，因此可以预期，其期望值就是极大概然值。
通过拉格朗日乘子法可以证明的确如此。

从粒子数算符的表达式还可以看出，近独立玻色子体系的化学势一定小于最小的能级，否则不能保证粒子数期望大于零。
另一方面，近独立费米子体系的化学势必须大于最小的能级，否则无简并的能级的粒子数期望也会大于1，这是不可能的，因为这违背了泡利不相容原理。
通常，化学势来自粒子间相互作用，而我们可以看到，即使没有相互作用，泡利不相容原理也会导致费米子间存在一个表面上的排斥力，而玻色子之间则由于粒子数期望要大于零，会有一个表面上的吸引力。

在零温极限下，即$\beta \to + \infty$时，费米子和玻色子在不同能级上的排布具有不同规律。
对费米子很容易可以看出
\begin{equation}
    \expval*{\hat{n}_i} = \begin{cases}
        1, \quad \epsilon_i < \mu, \\
        0, \quad \epsilon_i > \mu.
    \end{cases}
\end{equation}
对玻色子，如果有某个能级$\epsilon_i < \mu$，则该能级上
\[
    \expval*{\hat{n}_i} = \frac{1}{\ee^{  \beta (\epsilon_i - \mu)} - 1} \to -1,
\]
显然这是不可能的，因此化学势$\mu$一定小于等于最低的能级。
而如果$\epsilon_i > \mu$，则$\expval*{\hat{n}_i}$趋于零。
因此
\[
    \expval*{\hat{n}_i} = \begin{cases}
        \infty, \quad \epsilon_i = \mu, \\
        0, \quad \epsilon_i \neq \mu.
    \end{cases}
\]
显然这意味着$\mu$的值一定是某个能级。零温下体系总能量最低，因此$\mu$取$\epsilon_i$应当为$\{\epsilon_i\}$中的最小值。
不失一般性地通常我们取之为零。也即，零温下的玻色子的粒子数期望在最低能级上非零，其余能级上均为零，因此此时系统的密度算符非常纯，几乎就是一个宏观相干粒子态，这就是\textbf{玻色-爱因斯坦凝聚}。
需要注意的是以上推导实际上是非常“危险”的，非常依赖于求极限的函数的微妙性质，因此不同的系统中玻色-爱因斯坦凝聚是不是真的是一个物理解是不清楚的；而且它也不是一个行为良好的相变。
例如，如果相互作用导致了某些情况下极限不能交换，那么有可能玻色-爱因斯坦凝聚在小的扰动下就消失了。
反之，近独立费米子系统在$T\to 0$时，有
\[
    \expval*{\hat{n}_i} = \begin{cases}
        0, \quad \epsilon_i > \mu, \\
        1, \quad \epsilon_i < \mu, 
    \end{cases}
\]
因此粒子填充了所有化学势以下的能级而化学势以上的能级全空。此时的化学势称为\textbf{费米能}，它是$N$个粒子从低到高占据能级后能占据的最高能级的能量。
%需注意以上仅仅给出了粒子数的期望，即使在零温下也不能够保证系统的态一定就是$\ket{1, 1, 1, \ldots, 0, 0, \ldots}$或者$\ket{M, 0, 0, \ldots}$。

\subsubsection{热力学量计算}

现在计算其它宏观量。由近独立系统的哈密顿量显然有
\begin{equation}
    U = \bar{E} = \sum_i \epsilon_i \expval*{\hat{n}_i},
\end{equation}
热力学第一定律就是
\[
    \dd{U} = \var{Q} + \var{W} = \sum_i \dd{\epsilon_i} \expval*{\hat{n}_i} + \sum_i \epsilon_i \dd{\expval*{\hat{n}_i}},
\]
显然，设$q_i$是一个外参数，则它对应的广义力为（粒子数期望是热力学变量，我们不改变它，虽然其表达式中也有$\epsilon_i$）
\[
    \expval{\pdv{\hat{H}}{q_i}} = \sum_j \pdv{\epsilon_j}{q_i} \expval*{\hat{n}_i},
\]
则
\[
    \expval{\pdv{\hat{H}}{q_i}} \dd{q_i} = \sum_j \pdv{\epsilon_j}{q_i} \expval*{\hat{n}_i} \dd{q_i} = \sum_j \expval*{\hat{n}_j} \dd{\epsilon_j},
\]
于是
\begin{equation}
    \var{Q} = \sum_i \epsilon_i \dd{\expval*{\hat{n}_i}}, \quad \var{W} = \sum_i \expval*{\hat{n}_i} \dd{\epsilon_i}.
    \label{eq:independent-q-and-w}
\end{equation}
换而言之，粒子分布不变、能级具体的大小可变的过程是绝热的。

我们会注意到粒子数的期望值在这里和$\hat{\rho}$似乎有某种对应关系（比较\eqref{eq:first-law-in-statistics}和\eqref{eq:independent-q-and-w}），这当然是合理的，因为计算全同粒子系统的能量时需要对每个粒子求和，正如计算系综能量平均值时需要对每个参与态求和一样——粒子数和$\hat{\rho}$都提供了一个概率测度。
但全同粒子系统和单粒子系统的系综并不等价，很容易可以看出这一点：全同粒子系统中有
\[
    n \propto \frac{1}{\ee^{\beta (\epsilon - \mu)} - \eta},
\]
而巨正则系综中有
\[
    P \propto \frac{1}{\ee^{\beta (\epsilon - \mu)}},
\]
两者的分母差了一项。这种原因是量子统计理论特有的结果。巨正则系综中，各个参与态之间没有纠缠，即
\[
    \hat{\rho} \propto \sum_n \dyad{n} \ee^{- \beta (E_n - \mu)},
\]
而全同粒子系统的密度算符在单粒子态表象下不是对角化的，这可以从二次量子化中乘积态的定义看出。
例如，纯态
\[
    \ket{\psi} = \frac{1}{\sqrt{2}} (\ket{1} \ket{2} - \ket{2} \ket{1})
\]
对应的密度算符在单粒子态表象下不仅有$\dyad{1}$和$\dyad{2}$分量，也有$\ket{2}\bra{1}$分量和$\ket{1}\bra{2}$分量。
因此全同粒子系统不是单粒子系统的直积，不能看成单粒子系统的系综。
例如，在\eqref{eq:grand-partition-independent}中我们会发现量子全同粒子系统的配分函数并不是单个粒子的配分函数简单地乘起来。%
\footnote{再次提醒：如果存在某个量子数，使得每个粒子的这个量子数都不同，那么在计算配分函数时确实是可以把系统看成经典系统的。}%
我们也因此常常称这里所说的基于费米子或玻色子的全同粒子系统为\textbf{非定域系统}。

前面提到过化学势可以使用其它参量计算出来，对近独立系统而言这特别简单，只需要求解自洽方程
\begin{equation}
    \sum_k \frac{1}{\ee^{\beta (\epsilon_k - \mu)} - \eta} = N,
\end{equation}
其中$k$跑遍粒子所有的自由度的全部可能取值，$N$是总粒子数。如果用$k$表示能级编号则上式需要改写成
\[
    \sum_k \frac{g_k}{\ee^{\beta (\epsilon_k - \mu)} - \eta} = N.
\]
求解得到的$\mu$是$N,T$的表达式。这个方程通常过于复杂而不能解析求解，不过我们注意到
\[
    \pdv{N}{\mu} = \sum_k \eta \beta \frac{\ee^{\beta (\epsilon_k - \mu)}}{(\ee^{ \beta (\epsilon_k - \mu)} - \eta)^2},
\]
右边求和号中的每一项都是正的，因此
\[
    \pdv{N}{\mu} \sim \text{the total number of possible values of all degree of freedoms}.
\]
因此对非常大的系统，
\[
    \pdv{N}{\mu} \to \infty,
\]
反过来，可以认为$\mu$对$N$的变化很不敏感。因此热力学极限下，系统中的粒子数的小的变化几乎不改变化学势，因此化学势在很多问题中可以看成一个常数。

\subsubsection{无粒子数守恒的情况}

如果系统中不存在粒子数守恒，可以采用二次量子化的观点，即将不同的$i$看成不同的模式，而改变每个模式上的粒子数。
不同的模式彼此独立，于是我们有
\begin{equation}
    Z = \prod_i Z_i.
\end{equation}
对玻色子，模式$i$的配分函数为
\begin{equation}
    Z_i = \sum_n \ee^{-\beta n \epsilon_i} = \frac{1}{1 - \ee^{-\beta \epsilon_i}},
\end{equation}
而对费米子，每个模式上面只能有一个粒子，于是
\begin{equation}
    Z_i = 1 + \ee^{- \beta \epsilon_i}.
\end{equation}
以上两个方程正是令\eqref{eq:grand-partition-independent}中的化学势为零所得到的结果。

\subsubsection{平均场近似}

对有相互作用的体系，可以使用\textbf{平均场近似}，即找到一个单体算符（安排这种单体算符的方式称为\textbf{通道}，同一个相互作用体系可以有好多不同的通道），使它的期望和相互作用项的期望一致，当体系中的每个粒子附近总是可以找到较多粒子（从而其它粒子的作用可近似使用一个场代替），但粒子间相互作用又不太剧烈（从而涨落不是很大），就可以使用该单体算符代替相互作用项，在物理上，等于是近似认为粒子和一个平均场发生相互作用。

自洽平均场实际上就是一个仅有 % TODO：费曼图中的修正

平均场近似成立的条件实际上是非常苛刻的，通常在高维，平均场近似是比较好的近似。然而，由于操作简便，平均场近似往往是分析一个模型的起点。
平均场理论成立与否主要取决于每个空间点和多少其它空间点发生相互作用，越多，看起来相互作用就越平均。
因此对于通常的几何构型上的模型——如格点或者连续的空间——维数越高，平均场理论越适用。
低于某个维数（\textbf{临界维数下界，lower critical dimension}）时平均场理论完全就是错的，高于某个维数（\textbf{临界维数上界，upper critical dimension}）时平均场理论基本正确。

平均场近似实际上是大$N$展开的第一项。所谓大$N$展开是将系统按照其自由度数目$N$的倒数做展开，当$N$很大时只需要取第一项，这一项的物理意义是不同自由度的涨落相互抵消了。
加入大$N$展开中的更多项可能会对系统性质产生不连续的影响，比如平均场预言有相变，而涨落让相变消失了。
即使没有这种效应，通过平均场理论计算出来的参数都不能认为是精确的，因为大$N$展开中的后续项会改变这些参数。
然而，在没有出现“加入大$N$展开中的更多项可能会对系统性质产生不连续的影响”时，以平均场基态为基态引入涨落的方法可以用于得到一个普适类，只要引入的涨落在重整化群下都是相关项即可。
因此，这样的处理仍然是有用的，只是其中的参数不能确定。

粒子间的相互作用可以看成是粒子和一个场在产生相互作用，从配分函数中积掉这个场就得到粒子间相互作用。
平均场近似，或者说自洽Hartree-Fock近似，可以用两种等价的方式理解：一种是费曼图部分求和（对粒子线做完整的修正但是不做任何顶角修正或者别的修正），一种是假定基态上的期望和自由场期望相差不大，从而可以通过变分法证明下面这样的分解是最优的：
\begin{equation}
    U \hat{n}_{\text{d} \uparrow} \hat{n}_{\text{d} \downarrow} \approx U \hat{n}_{\text{d} \uparrow} \expval*{\hat{n}_{\text{d} \downarrow}} + U \expval*{\hat{n}_{\text{d} \uparrow}} \hat{n}_{\text{d} \downarrow} - U \expval*{\hat{n}_{\text{d} \uparrow}} \expval*{\hat{n}_{\text{d} \downarrow}}.
\end{equation}

\subsubsection{经典极限}

当$\beta \epsilon_i$很大——也即，$\epsilon_i$相对温度来说很大——时，无论是费米子还是玻色子的分布的期望都退化为
\begin{equation}
    \expval*{\hat{n}_i} = \frac{1}{\ee^{\beta (\epsilon_i - \mu)}},
    \label{eq:boltzman-distribution}
\end{equation}
称为\textbf{玻尔兹曼分布}。可以从经典平衡态统计物理中推导出这个分布。
实际上，考虑到经典平衡态统计物理中不同粒子的正则变量被视为不同的量，即每个粒子可以有一个始终固定的编号%
\footnote{实际上，也可以从这个角度看为什么经典平衡态统计是量子平衡态统计的高能近似——在能量很高时，粒子能够取的状态非常多，以至于几乎总是可以找到一个量子数将所有粒子都区分开来。}%
，由于我们不再考虑“纠缠”等纯粹的量子概念，现在经典全同粒子系统实际上就是单粒子系统的系综了。
于是有巨正则系综立刻得到\eqref{eq:boltzman-distribution}。
与量子情况下的非定域系统相对应，经典的全同粒子系统可以称为定域系统。

玻尔兹曼分布下的状态数由下式给出：
\[
    \Omega(\{n_i\}) = \frac{N!}{\prod_i n_i!} \prod_i g_i^{n_i},
\]
这个结果是将$N$个粒子分成若干组，各组的数目为$\{n_i\}$，然后第$i$组中的每个粒子可以有$g_i$种状态的排列方式总数。
可以使用这个公式计算玻尔兹曼分布的熵。

% 经典极限下的配分函数分成两种情况。设系统中共有$M$个模式，如果假定粒子可分辨（即前面所说的，粒子的量子数包括两个标签，一个标签指定它处在哪个模式中，还有一个标签同样是物理的，但能够保证每个粒子的取值都不同），那么就有
%\begin{equation}
    %Z = Z_1^N, \quad \Xi = \sum_N \frac{M!}{N!(M-N)!} Z(N) \ee^{-\alpha N} = \left(1 + \ee^{-\alpha}Z_1 \right)^M,
%\end{equation}
%如果粒子不可分辨，则需要加上$1/N!$因子，即
%\begin{equation}
    %Z = \frac{Z_1^N}{N!}, \quad \Xi = 
%\end{equation}

\subsection{对单位制的说明}

在以上讨论中我们为了方便，要求
\[
    \beta = \frac{1}{T},
\]
但实际上通过这种方式定义的温标和我们平时熟悉的摄氏温标的刻度间隔相差很大，所以为了让热力学温标的变化量和摄氏温标一致（两者的零点肯定不一致），实际计算时通常取
\begin{equation}
    \beta = \frac{1}{k_B T},
\end{equation}
常数$k_B$称为\textbf{玻尔兹曼常数}。

对熵和热量，我们有关系式
\[
    \var{Q} \leq T \dd{S},
\]
为了避免波尔兹曼常数出现在这个关系式中，我们要在玻尔兹曼熵和冯诺依曼熵的定义前面都加上$k_B$。也即，从$k_B=1$的自然单位制到国际单位制的变换为
\begin{equation}
    \begin{aligned}
        T_\text{int} = \frac{1}{k_B} T_\text{nat}, \\
        S_\text{int} = k_B S_\text{nat},
    \end{aligned}
\end{equation}
int和nat分别表示国际单位制和自然单位制。

这样，在国际单位制下，从配分函数计算各物理量的公式是：
\begin{equation}
    F = - k_\text{B} T \ln Z,
\end{equation}
\begin{equation}
    U = k_\text{B} T^2 \pdv{\ln Z}{T},
\end{equation}
以及
\begin{equation}
    S = k_\text{B} \ln Z - k_\text{B} \beta \pdv{\ln Z}{\beta}.
\end{equation}

\section{近平衡态理论}

% TODO：推迟格林函数、超前格林函数，以及它们的叠加编时格林函数，前向关联函数，后向关联函数

本节基本上只在正则系综下工作，因为我们真正计算的只是各种物理量的平均值，而在这种意义下巨正则系综等效为一个哈密顿量为$\hat{H}-\mu\hat{N}$的正则系综。

所谓近平衡态指的是这样一种状态：虽然系统可以受到扰动，并且这个扰动足以产生可观察的物理效应，但是系统始终不偏离平衡态太多。
这意味着系统的时间演化可以认为是由一个基本上不显含时间的哈密顿量指导的，也即，除去外加扰动的部分，系统具有时间平移不变性；
这也意味着系统的任何一个可观察量偏离平衡态的大小近似正比于扰动（即所谓的\textbf{线性响应}假设）。%
\footnote{需要注意的是如果系统本身接近相变了，本身并不大的扰动可能导致相变，从而破坏准静态条件。此时需要另外的理论。}%

\subsection{涨落的准热力学理论}

在一个纯粹的热力学理论中实际上并不能够良定义涨落，因为热力学中并无期望值，也就没有对期望的偏离。涨落的大小一定涉及到具体的统计物理理论。
本节将从热力学量出发计算这些量的涨落，而不显式地使用配分函数，从而有关的计算只需要使用热力学关系而无需分析系统的微观结构。

热力学量的涨落总是非常小的，也即，涨落不会太过偏离平衡态。设$\Phi, \{Y_i\}$是一组热力学坐标，其中$\Phi$是一个热力学势，在平衡态时它满足
\[
    \dd{\Phi} = T \dd{S} + \sum_i X_i \dd{Y_i}, 
\]
也就是说，它是对内能做适当的勒让德变换之后得到的。上式在偏离平衡态时并不成立，但由于涨落很小，可以假定上式对各个量的涨落均适用。
由于等概率原理仍然近似成立，我们有
\[
    P(U, \{Y_i\}) \propto \Omega(\Phi, \{Y_i\}) = \ee^{-S}(\Phi, \{Y_i\}).
\]
设平衡态的熵为$S_\star$，则
\begin{equation}
    \Omega = \Omega_\text{max} \ee^{\Delta S}, \quad \Delta S = S - S_\star < 0.
\end{equation}
通过
\[
    \Delta{\Phi} = T \Delta{S} + \sum_i X_i \Delta{Y_i},
\]
将$\Delta S$写成要计算的物理量的涨落以及平衡态物理量的函数，就得到了要计算的物理量的涨落的联合概率分布。
如果系统和外界有接触，把热库当成永远处于热力学平衡的系统即可。

从内能开始。
% 我其实这里是有一点糊涂的，这里的$E$有没有算上和外界相互作用的部分？
\begin{equation}
    \Delta E^2 = T^2 \pdv{\expval*{E}}{T},
\end{equation}
涨落量级为$1/\sqrt{N}$

一对共轭变量，固定了其中一个另一个就会有涨落。这可以看成量子不确定性在经典概率中的一种类比。这个类比实际上是严格的，因为在Wick转动下可以将一个纯态量子系统转化为一个经典概率系统。

在涨落不很大的时候，共轭变量$X_i$和$Y_i$之间可以认为有线性关系，此时通过构造热力学循环可以证明，$X_i$和$Y_j$之间的线性关系就是$X_j$和$Y_i$之间的线性关系。

最后我们来总结一下这一节我们做了什么：为了避免完整地从配分函数出发计算涨落，我们将热力学自由能算出（很多时候并不是算出来的而是通过对称性分析等方法形式地写出来的），并且假定系统的热力学坐标的变动的全过程系统都处于准静态。
由于重整化无非是反复积掉自由度，上面的说法意味着，计算出热力学自由能实际上就是反复积掉高能自由度，以这样的方式重整化到了一个不动点，在那里，系统的状态完全由热力学坐标描述。
从这个意义上，涨落的准静态理论实际上是分析了系统的最低运动模式带来的涨落。

这个思路实际上不仅仅适用于涨落的准静态理论——一切将系统的热力学和某些外部的动力学过程耦合起来的理论实际上都是将系统的最低能激发和外部的动力学过程耦合了起来。
例如，使用固体材料的自由能计算出其应力，并与外部动力学过程耦合，实际上就是在将固体材料的声子场的最低能激发和外部动力学过程耦合。
从这里我们也可以看出为什么我们可以认为热力学变量有确定的值：记热力学变量的集合为$\{X_i\}$，原则上，热力学自由能可以写成$\{X_i\}$的函数，这样我们似乎应该计算配分函数
\[
    Z = \int \prod_i \fd{X_i} \ee^{-\beta F(X)},
\]
但是在热力学极限下$F(X)$非常大，所以鞍点近似是很好的近似。
当然，如果我们处理的系统明显是多尺度的，在一个尺度下看起来是热力学坐标的变量是另一个尺度下的场构型，那么计算以上配分函数就是完全理所当然的。%
\footnote{不过，这样的系统实际上很难出现：一方面，外界扰动要足够大，让鞍点近似失效，另一方面它们又要足够小，不能产生新的物理。例如，对一块固体，外界扰动应该达到其自由能的量级，但是又不能大到把固体打碎。这样的系统是很难制备的。}%
完整地处理“系统和外界耦合”需要用到本文后面会阐述的近平衡态理论，而本节的处理——以及其它一切将系统的热力学和某些外部的动力学过程耦合起来的理论——实际上都是略去了系统的虚时间路径积分配分函数中的$\pi \dot{\phi}$项——即认为系统的运动非常缓慢，也即能量较低——之后所做的近似。

然而，真的寻找鞍点同样是非常不容易的，大部分近似方法都会将一个实际上未必是鞍点的点当成鞍点，从而引入显著的误差。

\subsection{使用格林函数描述系统}

一个近平衡态系统的全部特征都可以使用特定的格林函数写出来。这并不令人意外，因为我们能够观察到的体系的行为无非是在一个时间点通过某些手段在系统中产生一些激发，然后在另一个时间点观察会出现什么样的激发；既然多粒子态构成体系态矢量的一组完备基，只需要计算出所有的$n$点格林函数就足以完整描述系统的一切行为。
因此我们首先看一个典型的例子——线性响应。

\subsubsection{线性响应}\label{sec:linear-response}

设我们在体系中加入一个微扰$\hat{A}$（为了满足哈密顿量的厄米性它一定是可观察量）：
\begin{equation}
    \hat{H}' = \hat{H} + h(t) \hat{A},
\end{equation}
其中$h(t)$是一个含时的系数。
我们要求$h(t)$被缓慢地施加，而又缓慢地被撤去，从而系统初态（也即，$t=-\infty$时的状态）可以看成平衡态。
记密度算符$\hat{\rho}$在$t=-\infty$时的状态为$\hat{\rho}_0$。
显然微扰会改变系统的行为。计算受到微扰的系统中某不含时的可观察量$\hat{B}$的期望偏离平衡态的程度（下标0表示这是对没有加过微扰的系统取平均，也就是按照$\hat{\rho}_0$取平均）：
\[
    y(t) = \expval*{\hat{B}}(t) - \expval*{\hat{B}}_0 = \trace\left((\hat{\rho} - \hat{\rho}_0)\hat{B}\right).
\]
前面提到这是微扰，因此$y(t)$和$h(t)$的关系近似是线性的（这就是我们正在讨论的理论称为\textbf{线性响应}理论的原因），从而我们可以使用一个响应函数联系两者，即
\[
    y(t) = \int \dd{t'} G(t, t') h(t').
\]
我们要求系统具有因果律，这意味着，在$t<t'$时应有$G(t,t')=0$，否则某一时刻的$h(t')$将会影响过去时间的$y(t)$。因此我们有
\[
    G(t,t') \propto \Theta(t-t'),
\]
且积分可以写成
\[
    y(t) = \int_{-\infty}^t \dd{t'} G(t, t') h(t').
\]

切换到相互作用绘景下。取$\hat{H}$为自由哈密顿量%
\footnote{
    值得注记一下的是，在统计理论中量子系统的性质实际上好于经典系统。在量子系统中为了保证概率归一化，密度算符的时间演化一定被一个幺正算符联系起来，那么通过简单的指数映射就一定可以定义一个哈密顿量。
    经典系统中做近平衡理论计算则需要大量使用主方程。
}%
，$-h(t)\hat{A}$为相互作用哈密顿量，那么演化方程就是
\[
    \dv{\hat{\rho}^I}{t} = \frac{\ii}{\hbar} \comm*{\hat{\rho}^I}{h(t)\hat{A}^I(t)} = - \frac{\ii}{\hbar} h(t) \comm*{\hat{A}^I(t)}{\hat{\rho}^I}.
\]
上式等价于积分方程
\[
    \hat{\rho}^I(t) = \hat{\rho}_0^I - \frac{\ii}{\hbar}  \int_{-\infty}^t \dd{t'} h(t') \comm*{\hat{A}^I(t')}{\hat{\rho}^I(t')}.
\]
事实上，$\hat{\rho}_0^I$就是$\hat{\rho}_0$，因为$\hat{\rho}_0$为
\[
    \hat{\rho}_0 = \frac{1}{Z} \ee^{-\beta \hat{H}},
\]
从而
\[
    \hat{\rho}_0^I = \ee^{-\frac{\ii}{\hbar}t \hat{H}} \hat{\rho}_0 \ee^{\frac{\ii}{\hbar}t \hat{H}} = \hat{\rho}_0.
\]
由于$h(t)$非常小，$\hat{\rho}^I$的变化不是特别大，于是取以上方程的一阶近似，得到
\[
    \hat{\rho}^I(t) = \hat{\rho}_0 - \frac{\ii}{\hbar}  \int_{-\infty}^t \dd{t'} h(t') \comm*{\hat{A}^I(t')}{\hat{\rho}_0}.
\]
于是可以计算出$y(t)$：%
\footnote{请注意迹运算无论是在相互作用绘景还是在薛定谔绘景下都是一样的。}
\[
    \begin{aligned}
        y(t) &= \trace \left\{ (\hat{\rho}^I(t) - \hat{\rho}^I_0) \hat{B}^I(t) \right\} \\
        &= - \frac{\ii}{\hbar} \int_{-\infty}^t \dd{t'} h(t') \trace \left\{ \comm*{\hat{A}^I(t')}{\hat{\rho}_0} \hat{B}^I(t) \right\},
    \end{aligned}
\]
利用迹运算的轮换性，得到
\[
    \trace \left\{ \comm*{\hat{A}^I(t')}{\hat{\rho}_0} \hat{B}^I(t) \right\} = \trace \left\{ \hat{\rho}_0 \comm*{\hat{B}^I(t)}{\hat{A}^I(t')} \right\},
\]
于是最终得到
\[
    \begin{aligned}
        y(t) &= - \frac{\ii}{\hbar} \int_{-\infty}^t \dd{t'} h(t') \trace \left\{ \hat{\rho}_0 \comm*{\hat{B}^I(t)}{\hat{A}^I(t')} \right\} \\
        &= - \frac{\ii}{\hbar} \int_{-\infty}^t \dd{t'} h(t') \expval*{\comm*{\hat{B}^I(t)}{\hat{A}^I(t')} }_0.
    \end{aligned}
\]
最后，注意到以$\hat{H}$为自由哈密顿量的相互作用绘景中的算符实际上就是以$\hat{H}$为哈密顿量的海森堡绘景中的算符，于是我们写出$y(t)$和$h(t')$之间的响应函数：
\[
    G(t,t') = - \frac{\ii}{\hbar} \Theta(t-t') \expval*{\comm*{\hat{B}^H(t)}{\hat{A}^H(t')}}_0.
\]
为了更加明确，通常使用下面的记号：
\begin{equation}
    G(t,t')^\text{ret}_{BA} = - \frac{\ii}{\hbar} \Theta(t-t') \expval*{\comm*{\hat{B}(t)}{\hat{A}(t')}}.
    \label{eq:retarded-green-function}
\end{equation}
上标ret表示这是\textbf{推迟格林函数}（retarded），下标表示扰动和响应。所谓“推迟”不代表该格林函数在时间上是非局域的，而是表示向后的因果性。
默认体系不受到微扰，且算符$\hat{A}$和$\hat{B}$默认处于无微扰的海森堡绘景中，于是略去期望值的下标0和算符的上标。

实际我们做实验分析一个系统的性质时，都是对系统施加某个输入（敲它以下、加上一个磁场、通电，等等），然后测量对应的响应，因此只需要计算出我们关心的过程（例如，外加电场会导致通电，即外加$\vb*{E}$导致$\vb*{j}$）的推迟格林函数，就确定了这个过程的性质。
而由于我们总是假定输入很小，不同的扰动带来的响应是彼此独立的。
总之，只需要推迟格林函数就能够完全确定线性响应。于是接下来来分析推迟格林函数的性质。

\subsubsection{几种格林函数的定义}

由\autoref{sec:linear-response}，系统可观察的各种特征全部可以由推迟格林函数推导出来。
换而言之，近平衡态理论就是要计算各种不同的可观察量的格林函数。
现在的问题是，怎么计算关于两个可观察量的推迟格林函数？任何一个系统都可以通过一个场论产生，例如非相对论多电子体系由一个薛定谔场产生，电子对撞由QED产生，等等，系统的各个状态可以使用一组产生湮灭算符（或所谓的场算符%
\footnote{
    需要注意的是，在一般的场论中，场算符本身未必是某个表象下的产生算符或者湮灭算符，例如，实的克莱因高登场算符就不是坐标表象下的产生算符或湮灭算符。
    但对任何一个场算符，总是可以对它做一个线性变换以得到产生湮灭算符，例如克莱因高登场做傅里叶变换之后就能够得到一组动量空间下的产生湮灭算符。
    因此以下不再区分这两个概念。
}%
）产生，相应的，任何一个可观察量都是一系列二次量子化算符或它们的线性组合。
我们现在处理的问题都是一个自由哈密顿量加上一个外界扰动，这意味着可以使用Wick定理，从而将任何一个物理量的期望值拆分成一系列两点关联函数——即形如$\expval*{\hat{\psi}(x_1)\hat{\psi}^\dagger(x_2)}$函数——的乘积的线性组合。%
\footnote{自由哈密顿量是场算符的二次型，因此可以找到一组乘积态作为它的完备本征函数集。我们有
\[
    \expval{\hat{O}} = \frac{1}{Z} \sum_n \ee^{-\beta E_n} \mel{n}{\hat{O}}{n},
\]
如果$\hat{O}$中的产生算符数目和湮灭算符数目不一致，那么$\mel{n}{\hat{O}}{n}$就一定是零，因此单个场算符的期望值是零，并且奇数个算符的乘积的期望值也是零，再加上自由哈密顿量是二次型这个事实，我们确定Wick定理适用，并且凡是产生算符数目和湮灭算符数目不一致的$n$点关联都为零。

实际上，这里的关键在于“自由哈密顿量确实是二次型”，否则计算期望时不能够将多点关联函数拆分成一系列算符缩并的乘积。这一点在路径积分表述中特别清楚：哈密顿量是二次型意味着生成泛函也是二次型，则其四阶导数为零，然后就可以通过求导计算出Wick定理。
}%

可以使用不同的量来标记场算符，但是如果使用一个符号表示用位置和自旋标记的场算符，用另一个符号表示用动量和自旋标记的场算符，又用别的符号表示用别的量标记的场算符，符号就不够用了，因此以下$\hat{\psi}_\sigma(\vb*{r})$表示用位置和自旋标记的场算符，$\hat{\psi}_\sigma(\vb*{p})$表示用动量和自旋标记的场算符，等等，只要不使用$\vb*{p}$表示位置就不会引起歧义。

此外，由于以下推导不涉及任何经典-量子对照，我们使用自然单位制，即取$\hbar=1$。
这样可以把动量和傅里叶变换中的波矢看成同一个东西，将能量和频率看成同一个东西。

接下来给出推迟格林函数以及其它几种与之相关的格林函数的定义。它们虽然并不都像推迟格林函数那样有着明确的物理意义，但在理论计算上很重要。
例如，原则上任何算符的推迟格林函数都可以表示成场算符的大于/小于格林函数。
这些函数被称为格林函数是因为它们在可以使用线性方程描述系统时确实是这个线性方程的格林函数，具体的证明见\autoref{sec:field-green-function}。

对任意两个算符$\hat{A}$和$\hat{B}$——可以是可观察量，也可以是场算符——定义时域上的\textbf{编时格林函数}为
\begin{equation}
    G(t, t')_{AB} = - \ii T_t \expval*{\hat{A}(t) \hat{B}(t')},
\end{equation}
其中$\hat{A}(t)$和$\hat{B}(t')$是海森堡绘景中的算符，它，下同。
$T$是编时算符，它总是重排一个场算符的序列，让时间最早的算符出现在最后；如果场算符是费米算符，设重排了$s$次，则需要乘上一个因子$(-1)^s$。（而如果$\hat{A}$和$\hat{B}$是可观察量，那么可以把它们展开成一系列场算符的乘积的线性组合之后作用编时算符）

定义\textbf{推迟格林函数}为
\begin{equation}
    G^\text{ret}_{AB} (t, t') = - \ii \Theta (t-t') \expval*{\comm*{\hat{A}(t)}{\hat{B}(t')}_\eta},
\end{equation}
其中带$\eta$脚标的方括号定义为
\begin{equation}
    \comm*{\hat{A}}{\hat{B}}_\eta = \hat{A} \hat{B} - \eta \hat{B} \hat{A},
\end{equation}
在$\hat{A}$和$\hat{B}$构成一组玻色型算符时它取$+1$，在$\hat{A}$和$\hat{B}$构成一组费米型算符时它取$-1$。
“费米型算符”和“玻色型算符”的概念是比较奇怪的，我们马上解释它们。
简单地说，$\eta$可以由下式确定：
\begin{equation}
    T_t \expval*{\hat{A} \hat{B}} = \eta T_t \expval*{\hat{B} \hat{A}}.
\end{equation}
当然，如果$\hat{A}$和$\hat{B}$是同一种粒子在不同位置（或动量）、不同自旋的场算符，若这种粒子是费米子，它们就构成一对费米型算符，如果粒子是玻色子，它们就构成一对玻色型算符。
如果它们是不同粒子的场算符，那么显然它们对易，于是它们构成一对玻色型算符（即使其中一种粒子是费米子）。

实际上，很大一类可观察量的期望值被编时算符作用之后也会产生一个这样的系数。
如果$\hat{A}$和$\hat{B}$关于不同的场，那么它们对易，于是$\eta=1$。
如果$\hat{A}$和$\hat{B}$关于同一个玻色场，那么虽然它们未必对易（可能处在不同的时间），但由玻色子算符的性质，我们仍然有
\[
    T_t \expval*{\hat{A}(t_1)\hat{B}(t_2)} = T_t \expval*{\hat{B}(t_2)\hat{A}(t_1)},
\]
也即，应取$\eta=1$。
如果$\hat{A}$和$\hat{B}$关于同一个费米场，事情会略微复杂一些。如果$\hat{A}$关于场算符的多项式表示的每一项中含有奇数个场算符%
\footnote{例如
\[
    \hat{A} = \hat{a}+\hat{a}^\dagger,
\]
请注意$\hat{A}$和$\hat{B}$是可观察量。}，并且$\hat{B}$关于场算符的多项式表示的每一项中含有偶数个场算符，或者正好相反，那么应取$\eta=-1$，否则应取$\eta=1$。%
\footnote{举例：设$\hat{a}$是费米型湮灭算符，且$\hat{A}=\hat{a}_1^\dagger \hat{a}_1$，$\hat{B}=\hat{a}_2^\dagger \hat{a}_3^\dagger \hat{a}_3 \hat{a}_2$，则容易验证
\[
    T_t \expval{\hat{A}(t)\hat{B}(0)} = T_t (\hat{B}(0) \hat{A}(t)).
\]
}%
我们称$\eta=1$的情况为\textbf{玻色型推迟格林函数}，$\eta=-1$的情况为\textbf{费米型推迟格林函数}。
以上规则覆盖不到的情况（例如一个可观察量和几个场都有关系）均可通过期望值的线性性展开为以上情况中的一种或几种而得到计算。
实际计算中，基本上可观察量的每一项都含有相同数目的产生湮灭算符，因此两个可观察量的松原格林函数就都是玻色型的，即使产生这些可观察量的场算符实际上是费米场。

在$\hat{A}$和$\hat{B}$都是可观察量时，推迟格林函数有明确的物理意义（就是对外界扰动的响应函数）；在它们是场算符时，看起来推迟格林函数只是对响应函数的模仿。它们的作用要在\autoref{sec:matsubara-theory}中才能更好地看出。

与推迟格林函数类似地还可以定义\textbf{超前格林函数}：
\begin{equation}
    G^\text{adv}_{AB} (t, t') = \ii \Theta(t' - t) \expval*{\comm*{\hat{A}(t)}{\hat{B}(t')}_\eta}.
\end{equation}
推迟格林函数只在$t>t'$时才有非零值，超前格林函数只在$t<t'$时才有非零值。

最后，定义\textbf{大于格林函数}和\textbf{小于格林函数}，它们基本上就是前一节中提到的关联函数（差一个常数）。
大于格林函数是
\begin{equation}
    G^> (t, t')_{AB} = - \ii \expval*{\hat{A}(t) \hat{B}(t')},
\end{equation}
小于格林函数是
\begin{equation}
    G^< (t, t')_{AB} = - \eta \ii \expval*{\hat{B}(t') \hat{A}(t)}.
\end{equation}

\subsubsection{费米场和玻色场的格林函数}\label{sec:field-green-function}

% TODO：量子涨落、基态、热力学极限下才会出现对称性破缺
% 量子涨落指的实际上是，如果哈密顿量中同时含有一系列彼此不对易的项，那么基态就不是这些项的本征态，从而即使在零温、基态下，物理量还是不会有确定的值，即出现涨落。显然并非所有系统都有量子涨落

下面讨论场算符的格林函数，我们选取$\hat{A} = \hat{\psi}$，$\hat{B} = \hat{\psi}^\dagger$。
位置（或动量）以及自旋足以标记其场算符，于是使用$G_{\sigma \sigma'}(\vb*{r}, t, \var{r}', t')$来标记任何一个场算符格林函数。（可以是编时格林函数，也可以是大于、小于、超前、推迟格林函数）
在两个场算符的自旋一致时，我们使用简单的记号$G_{\sigma}(\vb*{r}, t; \vb*{r}', t')$来标记它们的格林函数。（不局限于编时格林函数）
如果系统具有自选旋转不变性，也即，没有自旋-轨道耦合，那么单个粒子的自旋就不会发生改变，于是对$\sigma \neq \sigma'$，我们有%
\footnote{如同下面讨论编时格林函数、大于格林函数和小于格林函数时会提到的那样，$\expval*{\hat{\psi}_{\sigma}(\vb*{r}, t) \hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t')}$是在一个时空点放入一个粒子而在另一个时空点发现这个粒子的概率振幅，既然系统没有自旋-轨道耦合，一个粒子的自旋当然不可能发生改变，于是$\sigma\neq \sigma'$时振幅为零。类似的，具有空间平移不变性的系统，有
\[
    \expval*{\hat{\psi}_{\sigma}(\vb*{p}, t) \hat{\psi}^\dagger_{\sigma'} (\vb*{p}', t')} \propto \delta(\vb*{p} - \vb*{p}').
\]
}%
\[
    \expval*{\hat{\psi}_{\sigma}(\vb*{r}, t) \hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t')} = 0,
\]
也即非平凡的格林函数都可以使用$G_{\sigma}(\vb*{r}, t; \vb*{r}', t')$来标记。

费米子的推迟格林函数就是
\begin{equation}
    G^\text{ret}_{\sigma \sigma'}(\vb*{r}, t; \vb*{r}', t') = - \ii \Theta(t-t') \expval*{\acomm*{\hat{\psi}_\sigma (\vb*{r}, t)}{\hat{\psi}_{\sigma'}^\dagger(\vb*{r}', t')}},
\end{equation}
类似地，玻色子的推迟格林函数为
\begin{equation}
    G^\text{ret}_{\sigma \sigma'}(\vb*{r}, t; \vb*{r}', t') = - \ii \Theta(t-t') \expval*{\comm*{\hat{\psi}_\sigma (\vb*{r}, t)}{\hat{\psi}_{\sigma'}^\dagger(\vb*{r}', t')}}.
\end{equation}
以上两式当然来自以下统一的形式：
\begin{equation}
    G^\text{ret}_{\sigma \sigma'}(\vb*{r}, t; \vb*{r}', t') = - \ii \Theta(t-t') \expval*{\comm*{\hat{\psi}_\sigma (\vb*{r}, t)}{\hat{\psi}_{\sigma'}^\dagger(\vb*{r}', t')}_\eta}.
\end{equation}

在系统是自由的时——也即，场的运动方程是线性方程时——场算符的编时格林函数确确实实是微分方程意义上的格林函数，具体来说，它是系统的薛定谔表象运动方程的格林函数。
对费米场，我们有
\[
    G_{\sigma \sigma'}^\text{ret} (\vb*{r}, t; \vb*{r}', t') = - \ii \Theta (t-t') \expval*{\hat{\psi}_\sigma (\vb*{r}, t) \hat{\psi}_{\sigma'}^\dagger (\vb*{r}', t')} + \ii \Theta(t'-t) \expval*{\hat{\psi}_{\sigma'}^\dagger(\vb*{r}', t') \hat{\psi}_\sigma (\vb*{r}, t)},
\]
求导之后可以得到
\[
    \begin{aligned}
        &\quad \; \ii \hbar \partial_t G_{\sigma \sigma'}^\text{ret} (\vb*{r}, t; \vb*{r}', t') \\
        &= \delta(t-t') \expval*{\acomm*{\hat{\psi}_\sigma (\vb*{r}, t)}{\hat{\psi}_{\sigma'}^\dagger (\vb*{r}', t')}} + \Theta(t-t') \expval*{\dot{\hat{\psi}}_\sigma (\vb*{r}, t) \hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t')} - \Theta(t'-t) \expval*{\hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t') \dot{\hat{\psi}}_\sigma (\vb*{r}, t)} \\
        &= \delta(t-t') \expval*{\acomm*{\hat{\psi}_\sigma (\vb*{r}, t)}{\hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t)}} + \Theta(t-t') \expval*{\dot{\hat{\psi}}_\sigma (\vb*{r}, t) \hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t')} - \Theta(t'-t) \expval*{\hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t') \dot{\hat{\psi}}_\sigma (\vb*{r}, t)} \\
        &= \delta(t-t') \delta(\vb*{r} - \vb*{r}') \delta_{\sigma \sigma'} + \Theta(t-t') \expval*{\dot{\hat{\psi}}_\sigma (\vb*{r}, t) \hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t')} - \Theta(t'-t) \expval*{\hat{\psi}^\dagger_{\sigma'} (\vb*{r}', t') \dot{\hat{\psi}}_\sigma (\vb*{r}, t)}.
    \end{aligned}
\]
场方程关于时间或者是一阶微分方程，或者是二阶微分方程。如果是前者，则哈密顿量可以只使用场算符来写出（而不涉及场对应的共轭动量），设其为
\[
    \hat{H} = \int \dd[D]{\vb*{r}''} \hat{\psi}^\dagger (\vb*{r}'', t) A(\vb*{r}'', t) \hat{\psi}(\vb*{r}'', t),
\]
其中$A$可以是算符，代入前式得到
\[
    (\ii \partial_t - A(\vb*{r}, t)) G_{\sigma \sigma'}^\text{ret} (\vb*{r}, t; \vb*{r}', t') = \delta(\vb*{r} - \vb*{r}') \delta(t-t').
\]
% TODO:二阶方程，比如克莱因-高登

以上推导对玻色场同样适用，只需要把反对易子换成对易子就可以。
此外注意到以上推导没有用到任何坐标的特殊性质，因此把它换成动量或者别的足以标记单个粒子的可观察量都是可以的。

注意到，对自由场可以有粒子数目固定的稳定多粒子态，其中一个只含单个粒子的态必定形如
\[
    \ket{\vb*{r} (t)} = \hat{\psi}(\vb*{r}, t) \ket{0}
\]
或其线性组合，则单粒子波函数的演化方程和场算符的演化方程完全一致。这也就是场算符有时被认为是“多粒子波函数”的原因，虽然它并不携带任何关于特定系统的信息。

场算符的大于格林函数和小于格林函数是
\begin{equation}
    G^>_{\sigma \sigma'} (\vb*{r}, t; \vb*{r}', t') = - \ii \expval*{\hat{\psi}_\sigma (\vb*{r}, t) \hat{\psi}_{\sigma'}^\dagger (\vb*{r}', t')},
\end{equation}
以及
\begin{equation}
    G^<_{\sigma \sigma'} (\vb*{r}, t; \vb*{r}', t') = - \eta \ii \expval*{\hat{\psi}_{\sigma'}^\dagger (\vb*{r}', t') \hat{\psi}_\sigma (\vb*{r}, t)}.
\end{equation}
在时间顺序正确时，这两者可以看成是向系统加入一个粒子，过一段时间之后发现这个粒子演化成了另一个粒子而其它一切照旧的概率振幅。
即使对混合态，这个说法也是成立的，容易根据混合态的定义，证明格林函数的模长平方正是向系统加入一个粒子，过一段时间之后发现这个粒子演化成了另一个粒子而其它一切照旧的概率。（定义前的$-\ii$因子是无关紧要的）

\subsection{频域上的格林函数}

由于系统具有时间平移不变性，格林函数（无论是哪一种）的值仅仅和$t-t'$有关，于是使用$G_{AB}(t-t')$标记它们，对场算符格林函数，就是$G_{\sigma \sigma'}(\vb*{r}, \vb*{r}', t-t')$。
这就意味着我们可以对$t-t'$做傅里叶变换，从而得到频域上的格林函数，记作$G_{AB}(\omega)$（对场算符格林函数这就是$G_{\sigma \sigma'}(\vb*{r}, \vb*{r}', \omega)$）。
在自由场的情况下，这就是外加一个周期性载荷（而不是冲击载荷），场给出的响应。
需要注意的是，至少在本节的正则量子化框架内，$\omega$不一定代表粒子的能量，因为和$\omega$一起出现在格林函数宗量中的量子数（如$\vb*{r}$）未必就是好
量子数，此时粒子甚至没有确定的能量。
在和$\omega$一起出现在格林函数宗量中的量子数是好量子数时（例如如果系统平移不变，那么$\vb*{k}$就是好量子数），格林函数的极点给出了相应的集体激发的能谱。
% TOOD

在写下$G_{AB}(t-t')$时我们实际上已经固定了$t$和$t'$的地位，用前者表示$\hat{A}$所在的时刻，用后者表示$\hat{B}$所在的时刻，因为在$G_{BA}$中$t$表示$\hat{B}$的时刻而$t'$表示$\hat{A}$的时刻，所以需要把时间颠倒一下，于是有
\begin{equation}
    G^\text{ret}_{AB}(t-t') = \eta G^\text{adv}_{BA}(t'-t), \quad G^\text{ret}_{AB}(\omega) = \eta G^\text{adv}_{BA}(-\omega).
\end{equation}

\begin{equation}
    G^\text{ret}_{\alpha \beta} (\vb*{k}, \omega) = (G^\text{adv}_{\beta \alpha}(\vb*{k}, \omega))^*.
\end{equation}

可以看到，$\omega$和$\vb*{k}$在某种意义上具有等价的地位。在路径积分表述中这会体现得更加明显——它们无非是底流形的坐标的傅里叶变换的参数。
有时，仿照相对论力学中惯用的记号，我们记$p=(\omega, \vb*{p})$，但$p$的变换规则未必是洛伦兹变换。

\subsubsection{涨落耗散定理}

本节展示推迟格林函数的一个非常重要的性质。采取海森堡绘景，定义两个算符的\textbf{关联函数}为它们的涨落的乘积的期望，即
\begin{equation}
    S_{BA}(t,t') = \expval*{(\hat{B}(t) - \expval*{\hat{B}(t)}) (\hat{A}(t') - \expval*{\hat{A}(t')})} = \expval*{\hat{B}(t)\hat{A}(t')} - \expval*{\hat{B}(t)}\expval*{\hat{A}(t')}.
\end{equation}
我们可以不失一般性地对各个算符做一个平移，从而让它们的期望值为零，即做变换
\[
    \hat{A} \longrightarrow \var{\hat{A}} = \hat{A} - \expval*{\hat{A}},
\]
于是不失一般性地认为所有算符的期望值都为零，从而
\begin{equation}
    S_{BA}(t,t') = \expval*{\hat{B}(t)\hat{A}(t')}.
\end{equation}

由于哈密顿量不含时，我们有时间平移对称性，于是
\begin{equation}
    G_{BA}^\text{ret}(t,t') = G_{BA}^\text{ret}(t-t'), \quad S_{BA}(t,t') = S_{BA}(t-t').
\end{equation}
于是可以定义一个单变量傅里叶变换：%
\footnote{
    需要这么定义是因为，当$t$充分大时，不再有相互作用，于是$B$按照自由理论的情况演化，此时就有
    \[
        G(\omega) \propto \int \dd{t} \ee^{\ii \omega t} \ee^{-\ii E t} \propto \delta(E - \omega),
    \]
    因此如同我们预期的那样，$\omega$起到了标记能量的作用。在做费曼图计算时由于傅里叶变换的卷积性，每个粒子线都会增加一个标签$\omega$，由上式，输入线和输出线的$\omega$就是能量，但是中间态的$\omega$可以和它们的量子数没有关系，这就是中间态有时称为虚粒子的原因。
}%
\begin{equation}
    S_{BA}(\omega) = \int_{-\infty}^\infty \dd{t} S_{BA}(t) \ee^{\ii \omega t}, \quad G_{BA}^\text{ret}(\omega) = \int_{-\infty}^\infty \dd{t} G_{BA}^\text{ret}(t) \ee^{\ii \omega t}.
\end{equation}
实际上由\eqref{eq:retarded-green-function}，$t<0$处推迟格林函数为零，从而
\[
    G_{BA}^\text{ret}(\omega) = \int_0^\infty \dd{t} G_{BA}^\text{ret}(t) \ee^{\ii \omega t}.
\]
那么，我们有\textbf{涨落耗散定理}：%
\footnote{依照定义可以看出频域上的响应函数的虚部代表了耗散，因为这会导致随着时间的演化，响应越来越弱；关联函数则代表了两个物理量共同涨落的强弱。}
\begin{equation}
    \Im G_{BA}^\text{ret}(\omega) = \frac{\eta \ee^{-\beta \omega} - 1}{2} S_{BA}(\omega).
\end{equation}

下面我们来证明这一点。首先注意到，$h(t)$和$y(t)$都是实数，从而联系它们的推迟格林函数也一定是实数，这样就有
\[
    \begin{aligned}
        \Im G_{BA}^\text{ret}(\omega) &= \frac{1}{2\ii} \left( G_{BA}^\text{ret}(\omega) -( G_{BA}^\text{ret}(\omega))^* \right) \\
        &= \frac{1}{2\ii} \left( \int_0^\infty \dd{t} \ee^{\ii \omega t} G_{BA}^\text{ret}(t) -\int_0^\infty \dd{t} \ee^{- \ii \omega t} G_{BA}^\text{ret}(t) \right) \\
        &= \frac{1}{2\ii} \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} G_{BA}^\text{ret}(t) \\
        &= - \frac{1}{2} \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \expval*{\comm*{\hat{B}(t)}{\hat{A}(0)}_\eta} \\
        &= - \frac{1}{2} \left( \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \hat{B}(t) \hat{A}(0) - \eta \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \hat{A}(0) \hat{B}(t) \right).
    \end{aligned}
\]
第一项正是关联函数。对第二项，
\[
    \begin{aligned}
        \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \hat{A}(0) \hat{B}(t) &= \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \frac{1}{Z} \trace \left( \ee^{-\beta \hat{H}} \hat{A}(0) \ee^{\ii \hat{H} t} \hat{B}(0) \ee^{ - \ii \hat{H} t} \right) \\
        &= \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \frac{1}{Z} \trace \left( \ee^{-\beta\hat{H}} \hat{A}(0) \ee^{-\beta \hat{H}} \ee^{\beta \hat{H}} \ee^{\ii \hat{H} t} \hat{B}(0) \ee^{ - \ii \hat{H} t} \right) \\
        &= \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \frac{1}{Z} \trace \left( \ee^{-\beta \hat{H}} \ee^{\beta \hat{H}} \ee^{\ii \hat{H} t} \hat{B}(0) \ee^{ - \ii \hat{H} t} \ee^{-\beta\hat{H}} \hat{A}(0) \right) \\
        &= \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \frac{1}{Z} \trace \left( \ee^{-\beta \hat{H}} \ee^{\ii \hat{H} (t - \ii \beta)} \hat{B}(0) \ee^{ - \ii \hat{H} (t - \ii \beta)} \hat{A}(0) \right) \\
        &= \int_{-\infty + \ii\beta}^{\infty+\ii \beta} \dd{t} \ee^{\ii \omega (t + \ii \beta)} \frac{1}{Z} \trace \left( \ee^{-\beta \hat{H}} \ee^{\ii \hat{H} t} \hat{B}(0) \ee^{ - \ii \hat{H} t} \hat{A}(0) \right).
    \end{aligned}
\]
被积函数在区域$0 < \Im t < \beta$内是解析的，从而就有
\[
    \begin{aligned}
        \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \hat{A}(0) \hat{B}(t)  &= \ee^{-\omega \beta} \int_{-\infty+\ii \beta}^{\infty+\ii \beta} \dd{t} \ee^{-\ii \omega t} \frac{1}{Z} \trace \left( \ee^{-\beta \hat{H}} \ee^{\ii \hat{H} t} \hat{B}(0) \ee^{ - \ii \hat{H} t} \hat{A}(0) \right) \\
        &= \ee^{-\omega \beta} \int_{-\infty}^{\infty} \dd{t} \ee^{-\ii \omega t} \frac{1}{Z} \trace \left( \ee^{-\beta \hat{H}} \ee^{\ii \hat{H} t} \hat{B}(0) \ee^{ - \ii \hat{H} t} \hat{A}(0) \right),
    \end{aligned}
\]
于是就证明了涨落耗散定理。

涨落耗散定理本身的物理含义非常直观：如果系统中有大量的涨落，那么显然能量从一点可以很快地传递到另外一点，因此如果外界冲击导致某一点出现了一个很大的起伏，它很快就会耗散殆尽。
涨落耗散定理可以用于计算系统中各种类型的耗散强度，例如，设系统受到一个冲击
\[
    h(t) = \delta(t-t_0),
\]
则冲击之后我们有
\[
    y(t) = G(t-t_0), \quad t > t_0.
\]
又比如，简单的求导告诉我们
\begin{equation}
    \dv{y}{t} = G(t+0^+, t) h(t) + \int_{-\infty}^t \dd{t'} \pdv{G(t, t')}{t} h(t'),
\end{equation}
这个可以告诉我们$h(t)$导致的变化是如何被阻尼的。

\subsubsection{Kramers-Kronig关系}

实际上，推迟格林函数的实部和虚部也有关系。要看出这个关系只需要利用推迟格林函数的两个性质：
\begin{itemize}
    \item 因果性，即$G_{BA}^\text{ret}(t)$在$t<0$时为零；
    \item 频谱至少衰减得和$1/\omega$一样快，这个条件实际上需要额外的确认，但通常是成立的，因为当
\end{itemize}

第一个条件，也就是，因果律，意味着$G_{BA}^\text{ret}(\omega)$在上半平面上是解析的。这是因为
\[
    G_{BA}^\text{ret}(t) = \frac{1}{2\pi} \int_{-\infty}^\infty \dd{t} G_{BA}^\text{ret}(\omega) \ee^{-\ii\omega t},
\]
在$t<0$时能够保证在上半平面上，$\omega\to\inf$时$\ee^{-\ii \omega t}$快速衰减，于是
\[
    G_{BA}^\text{ret}(t) = \frac{1}{2\pi} \cdot 2 \pi \sum_\text{upper plane}  \Res G_{BA}^\text{ret}(\omega) \ee^{-\ii\omega t},
\]
在$t<0$时上式一定是零，从而上半平面上必定没有奇点，从而$G_{BA}^\text{ret}(\omega)$在上半平面上是解析的。
相应的，如果系统不是平凡的，那么下半平面一定有奇点，因为$t<0$时应当在下半平面取留数。

现在考虑积分
\[
    \int_{-\infty}^\infty \dd{\omega'} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+},
\]
被积函数仅有的奇点位于下半平面，因此它在上半平面和实轴上处处解析，从而
\[
    \oint \dd{\omega'} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+} = 0.
\]
另一方面，设$C$是上半平面上的辐角从$0$到$\pi$的大圆弧，由于$G_{BA}^\text{ret}(\omega)$衰减得很快，由大圆弧引理，
\[
    \int_C \dd{\omega} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+} = 0.
\]
那么，取实轴和大圆弧组成一个闭合回路，在这个闭合回路上的积分是零，在大圆弧上的积分还是零，于是实轴上的积分也是零，
\[
    \int_{-\infty}^\infty \dd{\omega'} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+} = 0.
\]
而这个积分可以通过经典的“将奇点移动到实轴而改变积分路径”的方法计算出来，或者等价地，使用公式
\[
    \frac{1}{\omega'-\omega+\ii 0^+} = \primevalue \frac{1}{\omega'-\omega} - \pi \ii \delta(\omega'-\omega),
\]
其中$\primevalue$表示柯西积分主值，就得到
\[
    0 = \int_{-\infty}^\infty \dd{\omega'} \left( \Re G_{BA}^\text{ret}(\omega') + \ii \Im G_{BA}^\text{ret}(\omega') \right) \left( \primevalue \frac{1}{\omega'-\omega} - \pi \ii \delta(\omega'-\omega) \right),
\]
分别取实部和虚部，就得到
\begin{equation}
    \begin{bigcase}
        \Re G_{BA}^\text{ret}(\omega) &= \frac{1}{\pi} \primevalue \int_{-\infty}^\infty \dd{\omega'} \frac{\Im G_{BA}^\text{ret}(\omega')}{\omega' - \omega}, \\
        \Im G_{BA}^\text{ret}(\omega) &= - \frac{1}{\pi} \primevalue \int_{-\infty}^\infty \dd{\omega'} \frac{\Re G_{BA}^\text{ret}(\omega')}{\omega' - \omega}.
    \end{bigcase}
\end{equation}
因此，推迟格林函数的实部和虚部之间可以相互换算。

总之，在频域上，推迟格林函数的实部、虚部和关联函数这三者是一一对应的，因此实际的自由度只有一个。

\subsubsection{谱函数}\label{sec:spectral-function}

% TODO:似乎以下定义的谱函数只对$\hat{A}$和$\hat{B}$相同的情况才适用

定义% TODO:什么时候加上$\eta$？？
\begin{equation}
    A_{BA}(\omega) = \frac{1}{\pi} \Im G_{BA}^\text{ret}(\omega) = \frac{1}{2 \pi} \int_{-\infty}^\infty \dd{t} \expval*{\comm*{\hat{B}(t)}{\hat{A}(0)}_\eta} \ee^{\ii \omega t}
\end{equation}
为\textbf{谱函数}。当然，推迟格林函数可以很容易地使用谱函数表示出来：% 但是小量$\ii 0^+$的正负号好像错了
\begin{equation}
    \begin{bigcase}
        \Re G_{BA}^\text{ret}(\omega) &= \primevalue \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega)}{\omega'-\omega} , \\
        \Im G_{BA}^\text{ret}(\omega) &= \pi A_{BA}(\omega).
    \end{bigcase}
\end{equation}
或者，考虑到
\[
    \frac{1}{\omega'-\omega-\ii 0^+} = \primevalue \frac{1}{\omega'-\omega} + \ii \pi \delta(\omega'-\omega),
\]
就是
\begin{equation}
    G_{BA}^\text{ret}(\omega) = \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega')}{\omega' - \omega - \ii 0^+}.
\end{equation}
这表明谱函数给出了推迟格林函数在不同频率上的分布情况。当$\omega\to 0$时，我们有
\[
    G_{BA}^\text{ret}(\omega) \sim \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega')}{\omega' - \ii 0^+},
\]
而当$\omega\to \infty$时，我们有
\[
    G_{BA}^\text{ret}(\omega) \sim - \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega')}{\omega},
\]
这表明外加驱动频率很低时和外加驱动频率很高时产生的响应的正负号是反的。这是谐振子对外加驱动的响应的一种推广：当驱动频率很小时，体系能够很好地跟上外加驱动，当驱动频率特别大时，体系几乎总是落在外加驱动后面。

到现在为止谱函数仅仅是纯形式的记号。现在我们要说明怎样通过哈密顿量得到谱函数，这个过程称为\textbf{谱表示}。由于通常并不能解出哈密顿量，谱表示的理论意义大于实际计算意义。
设哈密顿量被对角化为
\[
    \hat{H} \ket{n} = E_n \ket{n},
\]
则
\[
    \begin{aligned}
        A_{BA} (\omega) &= \frac{1}{\pi} \Im G_{BA}(\omega) \\
        &= \frac{1}{2 \pi \hbar} \int_{-\infty}^\infty \dd{t} \expval*{\comm*{\hat{B}(t)}{\hat{A}(0)}_\eta} \ee^{\ii \omega t} \\
        &= \frac{1}{2 \pi \hbar} \int_{-\infty}^\infty \dd{t} \ee^{\ii \omega t} \frac{1}{Z} \\
        & \quad \quad \times \sum_m \left( \mel{m}{\ee^{-\beta E_m} \ee^{\frac{\ii}{\hbar} E_m t} \hat{B}(0) \ee^{- \frac{\ii}{\hbar} \hat{H} t} \hat{A}(0) }{m} - \eta \mel{m}{\ee^{-\beta E_m} \hat{A}(0) \ee^{\frac{\ii}{\hbar} \hat{H} t} \hat{B}(0) \ee^{- \frac{\ii}{\hbar} E_m t} }{m} \right).
    \end{aligned}
\]
上式中我们已经将紧邻左矢或右矢的哈密顿算符写成了本征值的形式。通过在每一个期望值中间再插入一组完备正交基，我们得到
\[
    \begin{aligned}
        &\quad \mel{m}{\ee^{-\beta E_m} \ee^{\frac{\ii}{\hbar} E_m t} \hat{B}(0) \ee^{- \frac{\ii}{\hbar} \hat{H} t} \hat{A}(0) }{m} \\
        &= \sum_n \mel{m}{\ee^{-\beta E_m} \ee^{\frac{\ii}{\hbar} E_m t} \hat{B}(0)}{n} \mel{n}{\ee^{- \frac{\ii}{\hbar} E_n t \hat{A}(0) }}{m} \\
        &= \ee^{- \beta E_m} \ee^{\frac{\ii}{\hbar} (E_m - E_n)} \sum_n \mel{m}{\hat{B}(0)}{n} \mel{n}{\hat{A}(0)}{m},
    \end{aligned}
\]
同理
\[
    \begin{aligned}
        &\quad \mel{m}{\ee^{-\beta E_m} \hat{A}(0) \ee^{\frac{\ii}{\hbar} \hat{H} t} \hat{B}(0) \ee^{- \frac{\ii}{\hbar} E_m t} }{m} \\
        &= \sum_n \mel{m}{\ee^{-\beta E_m} \hat{A}(0) \ee^{\frac{\ii}{\hbar} E_n t}}{n} \mel{n}{\hat{B}(0) \ee^{- \frac{\ii}{\hbar} E_m t}}{m} \\
        &= \ee^{-\beta E_m} \ee^{\frac{\ii}{\hbar} (E_n - E_m) t} \sum_n \mel{m}{\hat{A}(0)}{n} \mel{n}{\hat{B}(0)}{m}.
    \end{aligned}
\]
通过交换第二项中的$m$和$n$，并计算有关积分，就得到
\begin{equation}
    A_{BA}(\omega) = \frac{1}{\hbar Z} \sum_{m,n} \left( \ee^{-\beta E_m} - \eta \ee^{-\beta E_n} \right) \mel{m}{\hat{B}}{n} \mel{n}{\hat{A}}{m} \delta\left( \omega + \frac{E_m - E_n}{\hbar} \right).
\end{equation}
这就是谱表示的具体表达式。考虑到狄拉克函数的性质，可以写出一个不那么对称的表达式：
\begin{equation}
    A_{BA}(\omega) = \frac{1}{\hbar Z} \sum_{m,n} \ee^{-\beta E_m} (1 - \eta \ee^{- \beta \hbar \omega}) \mel{m}{\hat{B}}{n} \mel{n}{\hat{A}}{m} \delta\left( \omega + \frac{E_m - E_n}{\hbar} \right). 
\end{equation}

从谱表示出发可以获得涨落耗散定理的另一个证明，因为我们可以证明关联函数的形式实际上和谱表示只差了一个常数因子。

当然，也可以取另一个定义
\begin{equation}
    A_{\sigma \sigma'}(\vb*{k}, \omega) = - \frac{1}{\pi} \Im G^\text{ret}_{\sigma \sigma'}(\vb*{k}, \omega),
\end{equation}
这样可以将格林函数写成下面的形式：
\begin{equation}
    G^\text{ret}_{\sigma \sigma'}(\vb*{k}, \omega) = \int \dd{\omega'} \frac{A(\vb*{k}, \omega')}{\omega - \omega' + \ii 0^+},
\end{equation}
这样分子中$\omega$是正的，和很多其它情况中的惯例一致。

% TODO：费米子谱函数
% TODO：谱函数代表了态密度？？
\[
    \rho(\omega) \propto \int \dd[D]{\vb*{k}} A(\vb*{k}, \omega)
\]

由谱函数的定义可知
\[
    A(\vb*{k}, \omega) \propto \expval*{\hat{a}_\sigma^\dagger(\vb*{k}) \hat{a}_\sigma(\vb*{k})}
\]
在这种定义下，无相互作用时粒子-粒子谱函数为
\begin{equation}
    A = \delta(\omega - \epsilon_n)
\end{equation}
当加入相互作用时，谱函数不再是一个个尖峰，而具有一定的展宽。无论如何，谱函数大致描述了态密度。
这就意味着
\begin{equation}
    \int \dd{\omega} A_{\sigma}(\vb*{k}, \omega) = 1.
\end{equation}

以上讨论讨论的场算符的格林函数均涉及两个时空位置，因此可以统称为\textbf{两点格林函数}。
% TODO：多点格林函数有没有推迟、超前一说？

\subsubsection{零温格林函数的特殊性质}

本节讨论零温格林函数的特殊性质，也即，纯态的格林函数的特殊性质。

对处于真空态的自由体系——此时体系的状态就是$\ket{0}$，无需使用密度算符描述，即退化为零温场论——粒子数不变，于是总是可以找到一组好量子数，记作$n$（通常它就是动量和自旋），并用$\ket{n}$表示$\hat{a}_n^\dagger\ket{0}$。可以写出对角化的自由哈密顿量
\[
    \hat{H} = \sum_n \epsilon_n \hat{a}_n^\dagger \hat{a}_n.
\]
此时推迟格林函数为
\[
    \begin{aligned}
        G^\text{ret}_{\sigma \sigma'} (\vb*{r}, t; \vb*{r}', t') &= - \ii \Theta(t-t') \mel{0}{\hat{\psi}_\sigma(\vb*{r}, t) \hat{\psi}^\dagger_{\sigma'}(\vb*{r}', t')}{0} - \underbrace{\ii \eta \Theta(t'-t) \mel{0}{\hat{\psi}^\dagger_{\sigma'}(\vb*{r}', t') \hat{\psi}_\sigma(\vb*{r}, t)}{0}}_{=0} \\
        &= - \ii \Theta(t-t') \braket{(\vb*{r}, \sigma) (t)}{(\vb*{r}', \sigma')(t')} \\
        &= - \ii \Theta(t-t') \mel{\vb*{r}, \sigma}{\ee^{-\ii \hat{H} (t-t')}}{\vb*{r}', \sigma'}.
    \end{aligned}
\]
其中第二行的态矢量是有演化的（产生算符在海森堡绘景中），第三行的态矢量在海森堡绘景中。
切换到$n$表象，我们有
\[
    \begin{aligned}
        G^\text{ret}_{\sigma \sigma'} (\vb*{r}, t; \vb*{r}', t') &= - \ii \Theta(t-t') \sum_n \braket{\vb*{r}, \sigma}{n} \mel{n}{\ee^{-\ii \hat{H} (t-t')}}{n} \braket{n}{\vb*{r}', \sigma'} \\
        &= - \ii \Theta(t-t') \sum_n \braket{\vb*{r}, \sigma}{n} \ee^{-\ii \epsilon_n (t-t')} \braket{n}{\vb*{r}', \sigma'},
    \end{aligned}
\]
注意到
\[
    \Theta (t-t') = - \frac{1}{2\pi \ii} \int_{-\infty}^\infty \dd{\epsilon} \frac{ \ee^{ - \ii \epsilon (t-t')}}{\epsilon + \ii 0^+},
\]
就得到
\[
    \begin{aligned}
        G^\text{ret}_{\sigma \sigma'} (\vb*{r}, t; \vb*{r}', t') &= \frac{1}{2\pi} \int \dd{\epsilon} \sum_n \braket{\vb*{r}, \sigma}{n} \frac{\ee^{-\ii (\epsilon_n + \epsilon) (t-t')}}{\epsilon + \ii 0^+} \braket{n}{\vb*{r}', \sigma'} \\
        &= \frac{1}{2\pi} \int \dd{\epsilon} \sum_n \braket{\vb*{r}, \sigma}{n} \frac{\ee^{-\ii \epsilon (t-t')}}{\epsilon - \epsilon_n + \ii 0^+} \braket{n}{\vb*{r}', \sigma'}.
    \end{aligned}
\]
这样，其频域形式就是
\[
    G^\text{ret}_{\sigma \sigma'}(\vb*{r}, \vb*{r}', \omega) = \sum_n \braket{\vb*{r}, \sigma}{n} \frac{1}{\omega - \epsilon_n + \ii 0^+} \braket{n}{\vb*{r}', \sigma'}.
\]
请注意由于是自由场，可以认为每个粒子的运动遵循单粒子哈密顿量%
\footnote{自由场情况下各个粒子可以认为是彼此无关的，从而做替换$\ket{n} \longrightarrow \hat{\psi}_n$就从单粒子哈密顿量得到了场论哈密顿量，这个操作就是“二次量子化”这个说法的来源。\label{note:second-quantization}
}%
\[
    \hat{h} = \sum_n \epsilon_n \dyad{n},
\]
于是我们有
\begin{equation}
    G^\text{ret}_{\sigma \sigma'}(\vb*{r}, \vb*{r}', \omega) = \mel{\vb*{r}, \sigma}{\hat{G}}{\vb*{r}', \sigma'},
\end{equation}
其中
\begin{equation}
    \hat{G}(\omega) = \sum_n \frac{\dyad{n}}{\omega - \epsilon_n + \ii 0^+} = \frac{1}{\omega - \hat{h} + \ii 0^+}.
    \label{eq:one-particle-green-operator}
\end{equation}
也即，所有格林函数都是某个算符的矩阵元。$\hat{G}$不是别的，正是单粒子哈密顿量$\hat{h}$所导致的薛定谔绘景运动方程的频域格林函数：
给方程
\[
    \ii \hbar \dv{t} \ket{\psi} = \hat{h} \ket{\psi}
\]
外加脉冲，并切换到频域，则$\hat{G}$就是所得方程的一个解。我们再一次看到推迟格林函数作为格林函数的一面。

\eqref{eq:one-particle-green-operator}实际上并不仅仅出现在单粒子量子力学中（也即，没有粒子生灭、没有粒子间相互作用，可以使用一个单粒子哈密顿量描述的平凡的场论）。对一般的量子场论，也可以定义类似的算符，即
\[
    \hat{G}(\omega) = \frac{1}{\omega - \hat{H} + \ii 0^+},
\]
其中$\hat{H}$是场论的哈密顿量或者说二次量子化哈密顿量，在$\hat{H}$是自由场论时它就退化成了
\[
    \hat{G}(\omega) = \sum_n \frac{\hat{a}_n^\dagger \hat{a}_n}{\omega - \epsilon_n + \ii 0^+},
\]
然后由于自由场论时$\hat{a}^\dagger_n$和单粒子态$\ket{n}$可以相互替换（见\autoref{note:second-quantization}），上式和单粒子格林算符是等价的，只需要做通常的二次量子化手续，即将$\ket{n}$和$\hat{a}^\dagger_n$相互替换。
使用和之前类似的论证，我们发现
\[
    \text{Fourier transformation of }(- \ii \Theta(t-t') \braket{\text{state1 at $t$}}{\text{state2 at $t'$}}) = \mel{\text{state1}}{\hat{G}(\omega)}{\text{state2}}.
\]
因此推迟格林函数实际上是推迟格林算符的矩阵元。
实际上，考虑到任何一种格林函数对于$\hat{A}$和$\hat{B}$的双线性特征，任何一种格林函数都是某个格林算符的矩阵元。
从这里我们也可以很容易看到一个性质：若哈密顿量在某表象下是对角化的，则该表象下推迟格林算符也是对角化的，相应的非对角的推迟格林函数在该表象下恒为零。
当然，通过守恒性的论证可以发现这个性质在有限温理论中也是成立的。
由于一般的场论的能谱基本上不可能解析求解，对它定义推迟格林算符在实际计算上没有意义，因此通常并不讨论场的推迟格林算符，而只是讨论它在乘积态下的矩阵元，也就是各种推迟格林函数。

应当注意：虽然格林算符的求和形式中的极点都在实数上，由于
\[
    \frac{1}{\omega - \omega_n + \ii 0^+} = \mathrm{P} \frac{1}{\omega - \omega_n} - \pi \ii \delta(\omega - \omega_n),
\]
如果对$n$的求和形式适当——例如，如果是连续谱而对$n$的求和实际上是一个积分——那么最终的计算结果将会有一个有限大小的虚部。
格林函数的某个矩阵元存在虚部意味着存在衰变；虽然原则上自能总是可以在一些情况下有虚部，在一些情况下衰变被禁戒——如能量不够高从而无法衰变——在这些情况下虚部为零。

零温的情况还意味着我们可以去数自由体系中单个粒子本征态的数目。实际上，态密度和谱函数有着非常直接的关系。
注意到
\[
    \delta(\omega' - \omega) = - \frac{1}{\pi} \Im \frac{1}{\omega' - \omega + \ii 0^+},
\]
而动量表象下的态密度为
\[
    \rho(\omega) = \int \dd[3]{\vb*{k}} \delta(\omega(\vb*{k}) - \omega),
\]
于是就发现
\begin{equation}
    \rho(\omega) = \int \dd[3]{\vb*{k}} A(\vb*{k}, \omega).
\end{equation}
换而言之，对角化的谱函数实际上是态密度。
% TODO:进一步说明，特别是
依照定义，
\[
    \begin{aligned}
        \expval*{\hat{n}_{\text{d} \sigma}} &= \sum_{n, m} \expval*{\hat{c}^\dagger_{n \sigma} \hat{c}_{m \sigma}} \braket{\text{d} \sigma}{n \sigma} \braket{m \sigma}{\text{d} \sigma} \\
        &= \sum_{n} \expval*{\hat{c}^\dagger_{n \sigma} \hat{c}_{n \sigma}} \abs*{\braket{\text{d} \sigma}{n \sigma} }^2 \\
        &= \sum_{n} f(\epsilon_{n \sigma}) \abs*{\braket{\text{d} \sigma}{n \sigma} }^2, 
    \end{aligned}
\]
而谱函数满足（同样由定义可以证明）
\[
    A_{\text{d} \sigma}(\omega) = \sum_n \abs*{\braket{\text{d} \sigma}{n \sigma} }^2 A_{n \sigma} = \sum_n \abs*{\braket{\text{d} \sigma}{n \sigma} }^2 \delta(\omega - \epsilon_{n \sigma}),
\]
则
\[
    \begin{aligned}
        \expval*{\hat{n}_{\text{d} \sigma}} &= \sum_{n} f(\epsilon_{n \sigma}) \abs*{\braket{\text{d} \sigma}{n \sigma} }^2 \\
        &= \int \sum_{n} \dd{\omega} \delta(\omega - \epsilon_{n \sigma}) \abs*{\braket{\text{d} \sigma}{n \sigma} }^2 f(\omega) \\
        &= \int \dd{\omega} A_{\text{d} \sigma} f(\omega).
    \end{aligned}
\]

\subsection{松原理论}\label{sec:matsubara-theory}

\subsubsection{松原格林函数及其作用}

推迟格林函数并不是简单的一连串算符的期望值的形式，因此将Wick定理作用在推迟格林函数上计算较繁琐。这让我们设想，是不是可以把推迟格林函数写成某种编时函数，从而可以轻松地应用Wick定理。
\textbf{松原理论}通过引入一个虚时间，解决了这个问题。

算符的运动方程是（我们特意把$\hbar$放了回来，以展示虚时间的意义）
\[
    \hat{A}(t) = \ee^{\frac{\ii}{\hbar} t \hat{H}} \hat{A}(t=0) \ee^{-\frac{\ii}{\hbar} t \hat{H}},
\]
做变换
\begin{equation}
    \frac{\ii}{\hbar} t \longrightarrow \tau,
\end{equation}
得到
\begin{equation}
    \hat{A}(\tau) = \ee^{\tau \hat{H}} \hat{A}(\tau=0) \ee^{-\tau \hat{H}}.
\end{equation}
我们称$\tau$为\textbf{虚时间}。我们相当于对时间变量做了解析延拓，从而让时间成了一个复变量，然后取虚轴上的函数值。

现在定义\textbf{松原格林函数}为
\begin{equation}
    G_{AB}(\tau_1, \tau_2) = - \frac{1}{\hbar} T_\tau \expval*{\hat{A}(\tau_1)\hat{B}(\tau_2)},
\end{equation}
其中$\hat{A}$和$\hat{B}$为海森堡绘景中的算符，同样，它们可以是场算符（而不是可观察量），可以是费米算符也可以是玻色算符，$T_\tau$是虚时间的编时算符。%
\footnote{实际上，为了让编时算符有良定义，我们是把虚时间当成实数来计算，然后把计算结果解析延拓到虚轴上。}%
时间平移不变性意味着松原格林函数可以写成$G_{AB}(\tau_1-\tau_2)$的形式，从而可以定义单变量傅里叶变换。
在切换到频域前，注意到一个非常有用的性质，那就是松原格林函数是虚时间下的编时格林函数，所以依照$\hat{A}$和$\hat{B}$的性质，可以把松原格林函数分成玻色型和费米型。
玻色型松原格林函数是周期性的，而费米型松原格林函数是反周期性的，写成方程就是
\begin{equation}
    G_{AB}(\tau) = \eta G_{AB}(\tau+\beta).
    \label{eq:period-matsubara}
\end{equation}
这是因为我们有%
\footnote{下面有些“交换算符顺序”实际上是迹运算的轮换性质，因此即使交换的是费米子算符也不需要加上负号。}%
\[
    \begin{aligned}
        \hbar G_{AB}(\tau) &= - T_\tau \expval*{\hat{A}(\tau)\hat{B}(0)} \\
        &= - \frac{1}{Z} T_\tau \trace \left( \ee^{-\beta \hat{H}} \ee^{\tau \hat{H}} \hat{A}(0) \ee^{ - \tau \hat{H}} \hat{B}(0) \right) \\
        &= - \frac{1}{Z} T_\tau \trace \left(  \ee^{ - \tau \hat{H}} \hat{B}(0) \ee^{-\beta \hat{H}} \ee^{\tau \hat{H}} \hat{A}(0) \right) \\
        &= - \frac{1}{Z} T_\tau \trace \left( \ee^{-\beta \hat{H}} \ee^{(\beta-\tau) \hat{H}} \hat{B}(0) \ee^{-(\beta-\tau)\hat{H}} \hat{A}(0) \right) \\
        &= \hbar G_{BA} (\beta - \tau),
    \end{aligned}
\]
于是
\begin{equation}
    G_{AB}(\tau) = G_{BA} (\beta - \tau), \quad G_{AB}(\beta+\tau) = G_{BA}(-\tau),
\end{equation}
另一方面我们有%
\footnote{倒数第二个等号是由于编时算符的性质。对费米子算符而言，有
\[
    T_\tau (\hat{A} \hat{B}) = - T_\tau (\hat{B} \hat{A}),
\]
对玻色子算符而言则是
\[
    T_\tau (\hat{A} \hat{B}) = T_\tau (\hat{B} \hat{A}).
\]
导出这个等号用到的不是迹运算的轮换性。
}
\[
    \begin{aligned}
        \hbar G_{BA}(-\tau) &= - T_\tau  \expval*{\hat{B}(-\tau)\hat{A}(0)} \\
        &= - T_\tau \expval*{\hat{B}(0)\hat{A}(\tau)} \\
        &= - \eta T_\tau \expval*{\hat{A}(\tau)\hat{B}(0)} = \eta \hbar G_{AB}(\tau),
    \end{aligned}
\]
于是就得到我们想要的\eqref{eq:period-matsubara}。

周期性条件\eqref{eq:period-matsubara}意味着，松原格林函数的傅里叶变换实际上就是傅里叶级数。那就是说，频域上的松原格林函数可以记作$G_{AB}(\omega_n)$（由于定义在实际的时间上的格林函数——称为\textbf{实时格林函数}以和松原理论的虚时间区分——的频域形式是关于连续的频率的，并不会把它和松原格林函数混淆），它关于分立的频率$\omega_n$（称为\textbf{松原频率}），且可以通过下式计算：
\begin{equation}
    G_{AB}(\omega_n) = \int_0^\beta \dd{\tau} \ee^{\ii \omega_n \tau} G_{AB}(\tau),
\end{equation}
反过来就有
\begin{equation}
    G_{AB}(\tau) = \frac{1}{\beta} \sum_{\omega_n} G_{AB}(\omega_n) \ee^{- \ii \omega_n \tau}.
\end{equation}
其中对玻色子而言有
\begin{equation}
    \omega_n = \frac{2\pi}{\beta} n, \quad n = \ldots, -2, -1, 0, 1, 2, \ldots,
\end{equation}
称为\textbf{玻色子的松原频率}，而\textbf{费米子的松原频率}则是
\begin{equation}
    \omega_n = \frac{\pi}{\beta} (2n+1), \quad n = \ldots, -2, -1, 0, 1, 2, \ldots.
\end{equation}

计算松原格林函数的主要目的在于可以通过简单的解析延拓得到实时间的格林函数。
实时间的编时格林函数通常定义为
\[
    G = - \ii T_t \expval*{\hat{A} \hat{B}},
\]
从而在纯态情况下可以直接使用泛函求导计算得到。设$G(t)$和$g(\tau)$分别是实时间编时格林函数和虚时间松原格林函数，则
\begin{equation}
    G(\tau)|_{\tau=\ii t + \mathrm{sgn}(t) 0^+} = - \ii G(t),
\end{equation}
因为
\[
    T_t \expval*{\hat{A}(t_1) \hat{B}(t_2)} = T_\tau \expval*{\hat{A}(\tau_1) \hat{B}(\tau_2)} |_{\tau = \ii t + \mathrm{sgn}(t) 0^+},
\]
这就是简单的解析延拓，$\mathrm{sgn}(t) 0^+$是为了让编时算符能够给出确定的值。我们对实时间推迟格林函数可能更加感兴趣，而对松原格林函数做以下替换：
\begin{equation}
    G_{AB}(\omega_n) \xrightarrow{\ii \omega_n \longrightarrow \omega+\ii 0^+} G_{AB}^\text{ret} (\omega),
    \label{eq:from-matsubara-to-retarded}
\end{equation}
就得到了推迟格林函数。
证明的方式是使用松原格林函数的谱表示。我们有
\[
    \begin{aligned}
        G_{AB} (\omega_n) &= - \int_0^\beta \dd{\tau} T_\tau \expval*{\hat{A}(\tau) \hat{B}(0)} \ee^{\ii \omega_n \tau} \\
        &= - \int_0^\beta \dd{\tau} \sum_{l, m} \frac{1}{Z} \ee^{-\beta E_l} \mel{l}{\ee^{\tau \hat{H}} \hat{A}(0) \ee^{- \tau \hat{H}}}{m} \mel{m}{\hat{B}(0)}{l} \ee^{\ii \omega_n \tau} \\
        &= - \int_0^\beta \dd{\tau} \sum_{l, m} \frac{1}{Z} \ee^{-\beta E_l} \mel{l}{\ee^{\tau E_l} \hat{A}(0) \ee^{- \tau E_m}}{m} \mel{m}{\hat{B}(0)}{l} \ee^{\ii \omega_n \tau} \\
        &= - \sum_{l, m} \frac{1}{Z} \ee^{-\beta E_l} \mel{l}{\hat{A}(0)}{m} \mel{m}{\hat{B}(0)}{l} \int_0^\beta \dd{\tau} \ee^{(\ii \omega_n - E_m + E_l) \tau} \\
        &= - \sum_{l, m} \frac{1}{Z} \ee^{-\beta E_l} \mel{l}{\hat{A}(0)}{m} \mel{m}{\hat{B}(0)}{l} \eval{\frac{\ee^{(\ii \omega_n - E_m + E_l) \tau}}{\ii \omega_n - E_m + E_l}}_{\tau=0}^\beta,
    \end{aligned}
\]
根据松原频率的表达式得到$\ee^{\ii \beta \omega_n} = \eta$，于是
\[
    \begin{aligned}
        G_{AB} (\omega_n) &= - \sum_{l, m} \frac{1}{Z} \ee^{-\beta E_l} \mel{l}{\hat{A}(0)}{m} \mel{m}{\hat{B}(0)}{l} \frac{\eta \ee^{\beta (E_l - E_m)} - 1}{\ii \omega_n - E_m + E_l} \\
        &= \frac{1}{Z} \sum_{l, m} \frac{\ee^{-\beta E_l - \eta \ee^{- \beta E_m}}}{\ii \omega_n + E_l - E_m} \mel{l}{\hat{A}(0)}{m} \mel{m}{\hat{B}(0)}{l}.
    \end{aligned}
\]
考虑到谱函数，
\begin{equation}
    G_{AB} (\omega_n) = \int \dd{\omega'} \frac{A_{AB}(\omega)}{\ii \omega_n - \omega}.
\end{equation}
现在，\eqref{eq:from-matsubara-to-retarded}就是显然的。
总之，任何一个推迟格林函数都可以转化为松原格林函数来计算。

比较有趣的是，将$\tau$替换为$\ii t$和将$\ii \omega_n$替换为$\omega$显然是等价的，因此以上论述实际上表明了傅里叶变换和虚时间解析延拓是不交换的：已经有了一个虚时间时域松原格林函数之后，如果先做解析延拓再做傅里叶变换，会得到频域实时间编时格林函数，而如果先做傅里叶变换再做解析延拓会得到频域推迟格林函数。
在零温时虚时间积分上限无穷大，于是虚时间路径积分应该和实时间路径积分等价，于是非常合理地，频域松原格林函数和实时间格林函数有一个对应关系：
\begin{equation}
    - \ii G(\omega) = G(\omega_n)|_{\ii \omega_n = \omega + \ii \mathrm{sgn}(\omega) 0^+}.
\end{equation}
这里的无穷小虚部可以保证$\ii \omega_n \tau$和$\ii \omega t$之间没有一阶小量的差别。
直观地说，和编时格林函数有关的无穷小虚部基本上是在绕开$t=0$的点，因为在这里$\hat{A}$和$\hat{B}$的排列顺序是不确定的。
和推迟格林函数有关的无穷小虚部基本上是在保证因果律，即比避免在$\omega$的上半平面出现奇点。

在实际计算中通常先计算得到松原格林函数，然后计算实时间编时格林函数和推迟格林函数，因为后两者之间没有特别简单的关系。

\subsubsection{虚时间演化与松原格林函数的计算}

哈密顿量不显含虚时间，因此可以使用两个时间点之间的距离标记时间演化算符。在虚时间相互作用绘景中，某个虚时间往后演化$\tau$的时间演化算符为
\begin{equation}
    \hat{U}(\tau, 0) = T_\tau \exp \left( - \int_0^\tau \dd{\tau'} H_i^I(\tau') \right),
\end{equation}
其中$\hat{H}_i^I$为虚时间相互作用绘景下的相互作用哈密顿量。%
\footnote{注意区分相互作用哈密顿量和扰动哈密顿量：前者（在薛定谔绘景或者海森堡绘景中）仍然不显含时间，称它为相互作用哈密顿量只是因为它导致粒子生灭或者粒子转化；扰动哈密顿量则通常是含时的，来自外部施加的扰动。}%
由相互作用绘景的性质，有
\[
    \ee^{-\tau \hat{H}} = \ee^{- \tau \hat{H}_0} \hat{U}(\tau, 0),
\]
其中$\hat{H}_0$是薛定谔绘景中（也是海森堡绘景中）的自由哈密顿量。
配分函数为
\[
    Z = \trace (\ee^{- \tau \hat{H}_0} \hat{U}(\tau, 0)).
\]
这样，任意一个算符$\hat{A}$（未必是可观察量，比如说可以是场算符及其任意乘积）在虚时间海森堡绘景中的期望值为
\[
    \begin{aligned}
        \expval*{\hat{A}^H (\tau)} &= \frac{1}{Z} \trace (\ee^{-\beta \hat{H}} \hat{A}^H (\tau)) \\
        &= \frac{1}{Z} \trace ( \ee^{-\beta \hat{H}_0} \hat{U}(\beta, 0) \hat{U}(0, \tau) \hat{A}^I(\tau) \hat{U}(\tau, 0) ).
    \end{aligned}
\]
加入编时算符，就得到
\[
    T_\tau \expval*{\hat{A}^H (\tau)} = \frac{1}{Z} \trace (\ee^{- \beta \hat{H}_0} T_\tau (\hat{A}^I(\tau) \hat{U}(\beta, 0))) = \frac{\trace (\ee^{- \beta \hat{H}_0} T_\tau (\hat{A}^I(\tau) \hat{U}(\beta, 0)))}{\trace (\ee^{- \tau \hat{H}_0} \hat{U}(\tau, 0))}.
\]
设$\expval*{\cdot}_0$表示按自由哈密顿量计算期望，则
\begin{equation}
    T_\tau \expval*{\hat{A}^H (\tau)} = \frac{\expval*{T_\tau (\hat{A}^I (\tau) \hat{U}(\beta, 0))}_0}{\expval*{\hat{U}(\beta, 0)}_0} = \frac{\expval*{\hat{U}(\beta, \tau) \hat{A}^I (\tau) \hat{U}(\tau, 0)}_0}{\expval*{\hat{U}(\beta, 0)}_0}.
    \label{eq:relation-to-free-system}
\end{equation}
实际上，$\hat{A}^I$就是自由体系的海森堡绘景中的算符。只需要把$\hat{A}$换成$\hat{A}\hat{B}$，就可以使用\eqref{eq:relation-to-free-system}把任意的时域松原格林函数用自由体系的期望值表示出来。
特别的，如果我们只想计算平衡态期望值，那么
\begin{equation}
    \expval*{\hat{A}} = \frac{\expval*{\hat{A}^I(\beta) \hat{U}(\beta, 0)}_0}{\expval*{\hat{U}(\beta, 0)}_0}.
\end{equation}
也即，平衡态期望值是虚时间演化到$\beta$的虚时间算符期望值。
我们完全可以将$\hat{H}_0$设置为零，即取虚时间薛定谔绘景，那么上式就退化成了普通的系综平均值：
\begin{equation}
    \expval*{A} = \frac{\expval*{\hat{A} (\beta) \hat{U}(\beta, 0)}_0}{\expval*{\hat{U}(\beta, 0)}_0}, \quad \hat{U}(\beta, 0) = \ee^{-\beta \hat{H}}, \quad \expval*{\cdot}_0 = \trace (\cdot).
\end{equation}

自由系统适用Wick定理，而$\hat{U}(\beta, 0)$可以级数展开，于是\eqref{eq:relation-to-free-system}可以使用费曼图逐阶计算。
这样可以获得很多物理图像非常清晰的计算，如哈密顿量中每一项的阶数就是一个可能的过程中涉及到的粒子数，微扰展开的阶数则是粒子发生相互作用的次数，等等。
和零温场论中一样，可以将$\expval*{T_\tau (\hat{A}^I (\tau) \hat{U}(\beta, 0))}_0$对应的费曼图分成普通的图和真空气泡图，后者指的是存在不和任何外线连接的独立子图的图（只要$\hat{A}$不是普通的常数，这种图就是非连通的），而真空气泡图可以被提取出来形成一个因子，这个因子正好就是$\expval*{\hat{U}(\beta, 0)}_0$，即
\begin{equation}
    \begin{aligned}
        T_\tau \expval*{\hat{A}^H (\tau)} &= \sum \text{connected diagrams of $T_\tau (\hat{A}^I (\tau) \hat{U}(\beta, 0))$} \\
        &= \sum \text{connected diagrams of $\hat{U}(\beta, \tau) \hat{A}^I (\tau) \hat{U}(\tau, 0)$}.
    \end{aligned}
\end{equation}

\subsection{虚时间路径积分}\label{sec:imaginary-path-integral}

除了将$\hat{U}(\beta, 0)$做微扰展开以外，还可以从配分函数计算松原格林函数。实际上，由于配分函数可以导出所有我们需要的物理量，完全可以从配分函数的计算出发构建近平衡态量子统计理论。

\subsubsection{相干态}

回顾配分函数的定义：
\[
    Z = \trace \ee^{- \beta \hat{H}} = \sum_n \mel{n}{\ee^{ - \beta \hat{H}}}{n} = \sum_{\ket{n}} \ee^{ -\beta \mel{n}{\hat{H}}{n}},
\]
在场论的观点下，我们希望使用场算符来构造本征态$\ket{n}$。

先考虑玻色场。场算符可以分成使用同一CSCO的不同值（即同一类型的好量子数的不同取值）标记的产生-湮灭算符对$\{(\hat{a}_i, \hat{a}_i^\dagger)\}$。现在从其中取一对$\hat{a}, \hat{a}^\dagger$，并考虑以下态矢量：
\begin{equation}
    \ket{\alpha} = \ee^{\alpha \hat{a}^\dagger} \ket{0},
\end{equation}
其中$\alpha$是复变量，且定义
\[
    f(\alpha) = \comm*{\hat{a}}{\ee^{\alpha \hat{a}^\dagger}},
\]
对它求导，得到
\[
    \dv{f(\alpha)}{\alpha} = \hat{a}^\dagger f(\alpha) + \ee^{\alpha \hat{a}^\dagger},
\]
于是
\[
    f(\alpha) = \alpha \ee^{\alpha \hat{a}^\dagger}.
\]
通过这个对易关系，以及$\hat{a}\ket{0} = 0$的事实，就得到
\[
    \hat{a} \ket{\alpha} = \alpha \ket{\alpha}.
\]
这样我们就找到了湮灭算符的本征态，称为\textbf{相干态}。请注意以上推导对任意复数$\alpha$均成立，即$\alpha$扫过整个复数集合。

相干态实际上是完备的，我们来推导这一点。由指数函数的定义可以写出
\[
    \ket{\alpha} = \sum_{n=0}^\infty \frac{\alpha^n}{n!} (\hat{a}^\dagger)^n \ket{0} =  \sum_{n=0}^\infty \frac{\alpha^n}{\sqrt{n!}} \ket{n} ,
\]
这里用$\ket{n}$表示有$n$个$\hat{a}^\dagger$产生的粒子的状态。于是
\[
    \int \frac{\dd{\alpha^*} \wedge \dd{\alpha}}{2\pi \ii} \ee^{- \alpha \alpha^*} \ket{\alpha} \bra{\alpha^*} = \sum_{n, m} \frac{1}{\sqrt{n!}\sqrt{m!}} \ket{n} \bra{m} \int \frac{\dd{\alpha^*} \wedge \dd{\alpha}}{2\pi \ii} \ee^{- \alpha \alpha^*} \alpha^n (\alpha^*)^m,
\]
而
\[
    \dd{\alpha} = \dd{R} \ee^{\ii \theta} + \ii R \ee^{\ii \theta} \dd{\theta}, \quad \dd{\alpha^*} = \dd{R} \ee^{- \ii \theta} - \ii R \ee^{- \ii \theta} \dd{\theta},
\]
于是
\[
    \dd{\alpha^*} \wedge \dd{\alpha} = 2 \ii R \dd{R} \wedge \dd{\theta},
\]
积分就是
\[
    \begin{aligned}
        \int \frac{\dd{\alpha^*} \wedge \dd{\alpha}}{2\pi \ii} \ee^{- \alpha \alpha^*} \alpha^n (\alpha^*)^m &= \frac{1}{\pi} \int R \dd{R} \dd{\theta} \ee^{-R^2} R^{m+n} \ee^{\ii \theta (n-m)} \\
        &= \delta_{mn} n!,
    \end{aligned}
\]
从而就得到
\[
    \int \frac{\dd{\alpha^*} \wedge \dd{\alpha}}{2\pi \ii} \ee^{- \alpha^* \alpha} \ket{\alpha} \bra{\alpha^*} = \sum_n \dyad{n}.
\]
等式右边是由$\hat{a}^\dagger$产生的多粒子态空间中的恒等算符，也是完整的态空间（即由$\hat{a}^\dagger_1, \hat{a}^\dagger_2, \ldots$创建的态空间）中的一个投影算符。
记$\hat{a}^\dagger_i$产生的多粒子态空间中的恒等算符为$1_i$，则
\[
    \int \frac{\dd{\alpha^*_i} \wedge \dd{\alpha}_i}{2\pi \ii} \ee^{- \alpha_i^* \alpha_i} \ket{\alpha_i} \bra{\alpha^*_i} = 1_i.
\]
显然我们有
\[
    1 = \prod_i 1_i,
\]
于是（为了简便已经将外积符号略去了）
\[
    \int \prod_i \frac{\dd{\alpha_i^*} \dd{\alpha_i}}{2\pi \ii} \exp \left( - \sum_i \alpha_i^* \alpha_i \right) \ket{\alpha} \bra{\alpha^*} = 1,
\]
其中$\ket{\alpha}$指的是$\ket{\alpha_1, \alpha_2, \ldots}$，即不同的$\hat{a}_i$的相干态的直积。

有了完备性，再看相干态之间的内积。相干态的内积是
\[
    \braket{\alpha^*}{\beta} = \sum_{m,n = 0}^\infty \frac{(\alpha^*)^m \beta^n}{\sqrt{m!} \sqrt{n!}} \braket{m}{n}, 
\]
显然由多粒子态的正交归一化特征得到
\[
    \braket{\alpha^*}{\beta} = \ee^{\alpha^* \beta}.
\]

事实上，一般的场由连续变量（而不是离散的$i$）标记，故取极限得到
\begin{equation}
    \int \fd{[\alpha^*(\vb*{r}), \alpha(\vb*{r})]} \exp \left( - \int \dd[D]{\vb*{r}} \alpha^*(\vb*{r}) \alpha(\vb*{r}) \right) \ket{\alpha} \bra{\alpha^*} = 1,
    \label{eq:completeness-of-boson}
\end{equation}
其中
\begin{equation}
    \fd{[\alpha^*(\vb*{r}), \alpha(\vb*{r})]} = \lim_{N\to \infty} \prod_i \frac{\dd{\alpha_i^*} \dd{\alpha_i}}{2\pi \ii},
\end{equation}
$\alpha_i$和$\alpha^*_i$是将$\alpha(\vb*{r})$和$\alpha^*(\vb*{r})$做$N$点离散化的结果。
类似地，通过离散化再相乘的方法，可以得到内积公式
\begin{equation}
    \braket{\alpha^*}{\beta} = \exp \left( \int \dd[D]{\vb*{r}} \alpha^*(\vb*{r}) \beta(\vb*{r}) \right).
\end{equation}

对费米子也可以进行类似的操作。比较棘手的地方在于费米场算符一般来说不会有复数本征值（很容易在有限维复线性代数中处理这个问题），因此我们需要使用一些算符来充当形式上的本征值。
总是可以找到一些特殊的算符$\theta$，用这些算符来标记态矢量，使得
\[
    \hat{\phi} = \sum_n \theta_n \dyad{\theta_n},
\]
从而这里的$\theta_n$就起到了类似于复数本征值的作用。由于费米场是反对易的，$\{\theta_n\}_n$也张成一个反对易代数，称为\textbf{格拉斯曼数}。
它们仅仅用于计算的中间步骤，不会出现在任何具有直接物理意义的结果中。
使用$\{(\hat{c}_i, \hat{c}_i^\dagger)\}$表示使用同一类型的好量子数$i$标记的费米子产生湮灭算符，记$\hat{c}$和$\hat{c}^\dagger$是其中的一对，定义
\begin{equation}
    \ket{c} = \ee^{\hat{c}^\dagger c} \ket{0},
\end{equation}
称为\textbf{费米子的相干态}。由于格拉斯曼数的反对易性，它的任何函数做泰勒展开之后的高阶项因为自乘都变成零了，因此只需要取线性项，即
\[
    \ket{c} = (1 + \hat{c}^\dagger c) \ket{0}.
\]
我们来证明相干态的完备性。格拉斯曼数的积分的定义可以任取，但如果只是为了凑出完备性表达式，那么可以选取
\begin{equation}
    \int \dd{c} = 0, \quad \int \dd{c} c = 1,
\end{equation}
容易验证这满足积分通常应该满足的性质，即线性性和分部积分法则。
由$\hat{c}^\dagger$创建的多粒子态空间中只有两个线性独立的态矢量，就是$\ket{0}$和$\ket{1} = \hat{c}^\dagger \ket{0}$，而通过简单的计算可以发现
\[
    \int \dd{c^*} \int \dd{c} \ee^{-c^* c} \ket{c} \bra{c^*} = \dyad{0} + \dyad{1},
\]
这样在完整的态空间中就有
\[
    \int \prod_i \dd{c^*_i} \dd{c_i} \exp \left( - \sum_i c^*_i c_i \right) \ket{c} \bra{c^*} = 1,
\]
其中$\ket{c}$指的就是$\ket{c_1, c_2, \ldots}$，即不同的产生算符的相干态的直积。

下面计算费米子相干态的内积。我们有
\[
    \bra{c^*} = \bra{0} (1 + c^* \hat{c}), \quad \ket{d} = (1 + \hat{c}^\dagger d) \ket{0},
\]
于是容易计算出
\[
    \braket{c^*}{d} = \ee^{c^* d}.
\]
这个结果和玻色子一模一样，只不过这里不能轻易交换变量，因为$c$和$d$是格拉斯曼数。

和玻色场相同，对使用连续变量标记的场，有
\begin{equation}
    \int \fd{[c^*(\vb*{r}), c(\vb*{r})]} \exp \left( - \int \dd[D]{\vb*{r}} c^*(\vb*{r}) c(\vb*{r}) \right) \ket{c} \bra{c^*} = 1,
    \label{eq:completeness-of-fermion}
\end{equation}
其中
\begin{equation}
    \fd{[c^*(\vb*{r}), c(\vb*{r})]} = \lim_{N\to \infty} \prod_i \dd{c^*_i} \dd{c_i},
\end{equation}
$c_i$和$c_i^*$是$c(\vb*{r})$和$c^*(\vb*{r})$做$N$点离散化的结果。
相应的内积是
\begin{equation}
    \braket{c^*}{d} = \exp \left( \int \dd[D]{\vb*{r}} c^*(\vb*{r}) d(\vb*{r}) \right).
\end{equation}

\subsubsection{路径积分计算场的配分函数}

接下来应用\eqref{eq:completeness-of-boson}和\eqref{eq:completeness-of-fermion}写出配分函数。

首先考虑仅包含单个场的哈密顿量（包含多个场的情况可以很容易地化归到这种情况，下面会说）。
我们统一地用$\phi$表示前述相干态对应的湮灭算符的本征值，且为了和场论中的记号相一致，我们使用$\bar{\phi}$代替了$\phi^*$，这样就有
\[
    \begin{aligned}
        Z &= \sum_n \mel{n}{\ee^{-\beta \hat{H}}}{n} \\
        &= \sum_n \mel{n}{\ee^{- \beta \hat{H}} \int \fd{[\bar{\phi}(\vb*{r}), \phi(\vb*{r})]} }{\phi} \braket{\bar{\phi}}{n} \\
        &= \eta \int \fd{[\bar{\phi}(\vb*{r}), \phi(\vb*{r})]} \sum_n \braket{\bar{\phi}}{n} \mel{n}{\ee^{- \beta \hat{H}} }{\phi} \\
        &= \eta \int \fd{[\bar{\phi}(\vb*{r}), \phi(\vb*{r})]} \mel{\bar{\phi}}{\ee^{- \beta \hat{H}}}{\phi},
    \end{aligned}
\]
其中$\ket{n}$中的$n$单纯只是标记而已，并不代表粒子数。
$\eta$对玻色子取$1$，对费米子取$-1$，它的出现来自于我们交换了两个内积的顺序，而由于内积结果未必是复数而可能含有格拉斯曼数，需要引入这个因子。
不失一般性地我们假定$\hat{H}$是正规排序的，也即，其中的每一项中湮灭算符都在产生算符的右边，这就意味着，设
\[
    \hat{H} = F [\hat{\phi}, \hat{\phi}^\dagger],
\]
则
\[
    \mel{\bar{\phi}}{\hat{H}}{\phi} = F[\phi, \bar{\phi}].
\]
使用记号
\[
    \hat{H} = H[\hat{\phi}^\dagger, \hat{\phi}],
\]
就有
\[
    \mel{\bar{\phi}}{\hat{H}}{\phi} = H[\bar{\phi}, \phi].
\]
现在我们切换到虚时间海森堡绘景中，%
\footnote{由于哈密顿量不含时，海森堡绘景中的哈密顿量和薛定谔绘景中的哈密顿量是相等的，且两者关于各自的绘景中的场算符的表达式也是相等的。
更明确地说，设
\[
    \hat{H}^S[\hat{\phi}^S] = \int \dd[D]{\vb*{r}} f(\hat{\phi}^S, \grad{\hat{\phi}^S}),
\]
则
\[
    \hat{H}^H[\hat{\phi}^H] = \int \dd[D]{\vb*{r}} f(\hat{\phi}^H, \grad{\hat{\phi}^H}).
\]
这也就是为什么对不含时系统，我们从来不区分哈密顿量在哪个绘景中，也不区分不同绘景中哈密顿量的表达式。
同样，记$\phi$为能量本征态$\ket{\phi}$相对场算符的本征值，$H$为它相对哈密顿量的本征值，则有
\[
    H = \int \dd[D]{\vb*{r}} f(\phi(\vb*{r}), \grad{\phi(\vb*{r})}),
\]
而与绘景无关，因为绘景变换不改变$\phi$和$H$。
本文的剩余部分使用更加通常的记号，将$f$记作$\mathcal{H}$。
}%
让场算符和其本征值带上时间标记$\tau$。当然，有意义的虚时间取值范围只是$0 \leq \tau \leq \beta$，但是为了方便起见我们总是可以做周期延拓，让
\[
    \phi(\beta+0^+) = \pm \phi(0).
\]
正号对应玻色子，负号对应费米子。为什么这样选择正负号接下来可以看到。
注意到$\hat{H}$不显含时间，所以我们有
\[
    \beta \hat{H} = \int_0^\beta \dd{\tau} \hat{H},
\]
我们把从$0$到$\beta$的虚时间区间离散化为$N$个点，得到离散的时间值
\[
    \phi(\vb*{r}, \tau_n) = \phi(\vb*{r}, n \Delta \tau), \quad n = 0, 1, \ldots, N-1,
\]
这样周期延拓就是
\[
    \phi(\vb*{r}, \tau_0) = \pm \phi(\vb*{r}, \tau_N).
\]

如果是玻色子，利用周期延拓，
\[
    Z = \int \mathcal{D}_{\vb*{r}}{[\bar{\phi}(\vb*{r}, \tau_0), \phi(\vb*{r}, \tau_0)]} \mel{\bar{\phi}(\tau_N)}{\ee^{- \beta \hat{H}}}{\phi(\tau_0)},
\]
其中$\mathcal{D}_{\vb*{r}}$表示只对空间上的场构型求和。
在上式中的矩阵元里插入一系列完备性条件，得到
\[
    \begin{aligned}
        &\quad \; \mel{\bar{\phi}(\tau_N)}{\ee^{- \beta \hat{H}}}{\phi(\tau_0)} \\
        &= \mel{\bar{\phi}(\tau_N)}{\ee^{-\Delta \tau \hat{H}} \prod_{k=1}^{N-1} \int \mathcal{D}_{\vb*{r}}[\bar{\phi}(\vb*{r}, \tau_k), \phi(\vb*{r}, \tau_k)] \ee^{- \int \dd[D]{\vb*{r}} \bar{\phi}(\vb*{r}, \tau_k) \phi(\vb*{r}, \tau_k) } \dyad{\phi(\tau_k)} \ee^{ - \Delta \tau \hat{H}} }{\phi(\tau_0)} \\
        &= \prod_{k=0}^{N-1} \int \mathcal{D}_{\vb*{r}}[\bar{\phi}(\vb*{r}, \tau_k), \phi(\vb*{r}, \tau)] \ee^{- \int \dd[D]{\vb*{r}} \bar{\phi}(\vb*{r}, \tau_k) \phi(\vb*{r}, \tau_k) } \mel{\bar{\phi}(\tau_{k+1})}{\ee^{ - \Delta \tau \hat{H}}}{\phi(\tau_k)},
    \end{aligned}
\]
而由于$\Delta \tau$可以取得任意小，我们有
\[
    \begin{aligned}
        \mel{\bar{\phi}(\tau_{k+1})}{\ee^{-\Delta \tau \hat{H}}}{\phi(\tau_k)} &= \mel{\bar{\phi}(\tau_{k+1})}{1 - \Delta \tau \hat{H}}{\phi(\tau_k)} \\
        &= (1 - \Delta \tau H[\bar{\phi}(\tau_{k+1}), \phi(\tau_k)]) \braket{\bar{\phi}(\tau_{k+1})}{\phi(\tau_k)} \\
        &= \exp \left( - \Delta \tau H[\bar{\phi}(\tau_{k+1}), \phi(\tau_k)] \right) \exp \left( \int \dd[D]{\vb*{r}} \bar{\phi}(\vb*{r}, \tau_{k+1}) \phi(\vb*{r}, \tau_k) \right) \\
        &= \exp \left( \int \dd[D]{\vb*{r}} \bar{\phi}(\vb*{r}, \tau_{k+1}) \phi(\vb*{r}, \tau_k) - \Delta \tau H[\bar{\phi}(\tau_{k+1}), \phi(\tau_k)] \right).
    \end{aligned}
\]
结合以上各式，得到
\[
    \begin{aligned}
        Z &= \int \mathcal{D}_{\vb*{r}}[ \bar{\phi}(\vb*{r}, \tau_0), \phi(\vb*{r}, \tau_0) ]  \prod_{k=1}^{N-1} \int \mathcal{D}_{\vb*{r}}[ \bar{\phi}(\vb*{r}, \tau_k), \phi(\vb*{r}, \tau_k) ] \ee^{- \int \dd[D]{\vb*{r}} \bar{\phi}(\vb*{r}, \tau_k) \phi(\vb*{r}, \tau_k) } \\
        & \quad \times \ee^{\int \dd[D]{\vb*{r}} \bar{\phi}(\vb*{r}, \tau_{k+1}) \phi(\vb*{r}, \tau_k) - \Delta \tau H[\bar{\phi}(\tau_{k+1}), \phi(\tau_k)]} \\
        &= \prod_{k=0}^{N-1} \int \mathcal{D}_{\vb*{r}}[ \bar{\phi}(\vb*{r}, \tau_k), \phi(\vb*{r}, \tau_k) ] \ee^{\sum_j \Delta \tau \left( \int \dd[D]{\vb*{r}} \frac{\bar{\phi}(\vb*{r}, \tau_{j+1}) - \bar{\phi}(\vb*{r}, \tau_j) }{\Delta \tau} \phi(\vb*{r}, \tau_j) - H[\bar{\phi}(\tau_{k+1}), \phi(\tau_k)] \right) },
    \end{aligned}
\]
令$N \to \infty$，并定义
\begin{equation}
    \mathcal{D} [\bar{\phi}, \phi] = \mathcal{D} [\bar{\phi}(\vb*{r}, \tau), \phi(\vb*{r}, \tau)] = \lim_{N \to \infty} \prod_{k=0}^{N-1} \int \mathcal{D}_{\vb*{r}}[ \bar{\phi}(\vb*{r}, \tau_k), \phi(\vb*{r}, \tau_k) ],
\end{equation}
就得到
\begin{equation}
    Z = \int \fd{[\bar{\phi}, \phi]} \exp \left( \int_0^\beta \dd{\tau} \left( \int \dd[D]{\vb*{r}} \pdv{\bar{\phi}(\vb*{r}, \tau)}{\tau} \phi(\vb*{r}, \tau) - H[\bar{\phi}(\vb*{r}, \tau), \phi(\vb*{r}, \tau)] \right) \right).
    \label{eq:one-field-partition-function}
\end{equation}

如果是费米子，也可以使用基本上一样的方法得到同样的表达式。

对于包含多个场的系统，其态矢量可以写成每一个场的态矢量的直积，从而
\[
    Z = \sum_{\ket{\phi_1}} \mel{\phi_1}{  \sum_{\ket{\phi_2}} \mel{\phi_2}{\cdots \sum_{\ket{\phi_n}} \mel{\phi_n}{\ee^{-\beta \hat{H}}}{\phi_n} \cdots}{\phi_2} }{\phi_1},
\]
因此只需要把
\[
    \sum_{\ket{\phi_{i+1}}} \mel{\phi_{i+1}}{\cdots \sum_{\ket{\phi_n}} \mel{\phi_n}{\ee^{-\beta \hat{H}}}{\phi_n} \cdots}{\phi_{i+1}}
\]
当成哈密顿量而对场$\phi_i$做积分，重复$n$次，就得到
\[
    Z = \int \prod_i \fd{[\bar{\phi_i}, \phi_i]} \exp \left( \int_0^\beta \dd{\tau} \left( \sum_j \int \dd[D]{\vb*{r}} \pdv{\bar{\phi_j}(\vb*{r}, \tau)}{\tau} \phi_j(\vb*{r}, \tau) - H[\{\bar{\phi_i}(\vb*{r}, \tau), \phi_i(\vb*{r}, \tau)\}] \right) \right),
\]
为简化书写，定义列向量$\phi$包含所有的$\{\phi_i\}$，行向量$\bar{\phi}$包含所有的$\{\bar{\phi}_i\}$，%
\footnote{这就是我们使用$\bar{\phi}$而不是$\phi^*$表示单个场的复共轭的原因，因为有多个场时复共轭要被共轭转置代替，而又不能使用符号$\dagger$，因为诸$\phi_i$在这里并不是作用在态矢量上的算符。}%
并设
\begin{equation}
    \fd[\bar{\phi}, \phi] = \prod_i \fd{[\bar{\phi_i}, \phi_i]},
\end{equation}
就有
\begin{equation}
    Z = \int \fd[\bar{\phi}, \phi] \ee^{ - S[\phi]},
\end{equation}
其中作用量为
\begin{equation}
    \begin{aligned}
        S[\phi] &= - \int_0^\beta \dd{\tau} \left( \int \dd[D]{\vb*{r}} \dv{\bar{\phi}(\vb*{r}, \tau)}{\tau} \phi(\vb*{r}, \tau) - H[\bar{\phi}(\tau), \phi(\tau)] \right) \\
        &= - \int_0^\beta \dd{\tau} \int \dd[D]{\vb*{r}} \left( \dv{\bar{\phi}(\vb*{r}, \tau)}{\tau} \phi(\vb*{r}, \tau) - \mathcal{H}[\bar{\phi}(\tau), \phi(\tau)] \right).
    \end{aligned}
\end{equation}
可以看到$S$的表达式中除了$H$氦多出来了一项，这一项在基于算符的表达式$\trace \ee^{-\beta \hat{H}}$中并不存在。
当然，它的出现来自场变量和它的正则动量并不对易这一事实——如果我们希望使用实数（和格拉斯曼数）将配分函数写出来，就必须使用额外的这一项来反映这一事实。
这就是\textbf{量子涨落}的体现。

需注意上式和\eqref{eq:path-integral-equilibrium}的区别：上式的积分中，变量$\phi$跑遍时空中所有可能的场构型（也跑遍每个虚时间点，因此实际上我们是在对不同的\textbf{世界线}求和；选取不同的场算符的相干态作为表象会导致不同的世界线选择；由于$\phi(\tau)$可以随意变化，无需讨论算符演化遵循哪种绘景），而\eqref{eq:path-integral-equilibrium}的积分中变量$\phi$仅仅跑遍空间中所有可能的场构型。
正如下一节要看到的那样，使用上式可以求解出各场算符处于不同虚时间点的松原格林函数，而\eqref{eq:path-integral-equilibrium}仅能用于计算同一时刻的平衡态关联函数。

实际上，这里得到的路径积分表述和零温路径积分只差了一个Wick转动。首先，考虑到场变量在$\tau=0$和$\tau=\beta$处的边界条件，并使用分部积分法，我们有
\[
    \int_0^\beta \dd{\tau} \dv{\bar{\phi}(\vb*{r}, \tau)}{\tau} \phi(\vb*{r}, \tau) = - \int_0^\beta \dd{\tau} \bar{\phi}(\vb*{r}, \tau) \pdv{\phi(\vb*{r}, \tau)}{\tau},
\]
这样
\[
    S = \int_0^\beta \dd{\tau} \int \dd[D]{\vb*{r}} \left( \bar{\phi}(\vb*{r}, \tau) \pdv{\phi(\vb*{r}, \tau)}{\tau} + \mathcal{H}[\bar{\phi}(\tau), \phi(\tau)] \right).
\]
请注意，由产生湮灭算符的对易关系
\[
    \comm*{\hat{\phi}_i}{\hat{\phi}_j^\dagger}_\eta = \delta_{ij},
\]
可以得到
\[
    \comm*{\hat{\phi}_i}{\ii \hat{\phi}_j^\dagger}_\eta = \ii \delta_{ij},
\]
即$\ii \hat{\phi}^\dagger$是$\hat{\phi}$的共轭动量，记之为$\hat{\pi}$，并将哈密顿量表示成$\phi$和$\pi$的表达式，于是得到
\begin{equation}
    \begin{aligned}
        S &= \int_0^\beta \dd{\tau} \int \dd[D]{\vb*{r}} \left( \bar{\phi}(\vb*{r}, \tau) \pdv{\phi(\vb*{r}, \tau)}{\tau} + \mathcal{H}[\bar{\phi}(\tau), \phi(\tau)] \right) \\
        &= \int_0^\beta \dd{\tau} \int \dd[D]{\vb*{r}} \left( \frac{1}{\ii} \pi(\vb*{r}, \tau) \pdv{\phi(\vb*{r}, \tau)}{\tau} + \mathcal{H}[\phi(\tau), \pi(\tau)] \right).
    \end{aligned}
    \label{eq:action-with-phi-pi}
\end{equation}
以上得到的平衡态统计物理作用量\eqref{eq:action-with-phi-pi}中的$\phi$和$\pi$对应着一套产生湮灭算符$\hat{\phi}$和$\hat{\phi}^\dagger$，并非一般的场变量和它的共轭动量。
然而，\eqref{eq:action-with-phi-pi}实际上对任何的场变量和它的共轭动量都是成立的。
如果一个场是费米场，那么它的运动方程必定是一阶的，因此场变量的共轭动量和场变量之间有线性关系，容易看出为了维持反对易关系应当取$\hat{\pi} = \ii \hat{\phi}^\dagger$，于是可以直接使用\eqref{eq:action-with-phi-pi}。
如果是玻色场，若是实场，做变量代换
\[
    \hat{a} = \frac{1}{\sqrt{2}} (\hat{\phi} + \ii \hat{\pi}), \quad \hat{a}^\dagger = \frac{1}{\sqrt{2}} (\hat{\phi} - \ii \hat{\pi}),
\]
可以发现$\hat{a}^\dagger$和$\hat{a}$构成一对产生湮灭算符。据此计算，得到
\[
    \begin{aligned}
        \bar{a} \pdv{a}{\tau} &= \frac{1}{2} \left( \phi \pdv{\phi}{\tau} + \pi \pdv{\pi}{\tau} + \ii \phi \pdv{\pi}{\tau} - \ii \pi \pdv{\phi}{\tau} \right) \\
        &= \frac{1}{\ii} \pi \pdv{\phi}{\tau} - \frac{1}{2\ii} \pdv{(\phi \pi)}{\tau} + \pdv{\tau} (\phi^2 + \pi^2), 
    \end{aligned}
\]
由$\tau=0$和$\tau=\beta$处的边界条件，上式中的全微分对作用量中的积分没有贡献，从而导出\eqref{eq:action-with-phi-pi}。
在获得了\eqref{eq:action-with-phi-pi}之后我们会发现其形式和零温量子场论中的作用量更加接近了。
实际上，按照\eqref{eq:action-with-phi-pi}，配分函数为
\begin{equation}
    Z = \int \fd{[\bar{\phi}, \phi]} \exp \left( - \int_0^\beta \dd{\tau} \int \dd[D]{\vb*{r}} \left( \frac{1}{\ii} \pi(\vb*{r}, \tau) \pdv{\phi(\vb*{r}, \tau)}{\tau} + \mathcal{H} \right) \right),
    \label{eq:path-integral-partition-function}
\end{equation}
与零温场论中的配分函数
\[
    Z = \int \fd{[\bar{\phi}, \phi]} \exp \left( \ii \int \dd{t} \int \dd[D]{\vb*{r}} \left( \pi(\vb*{r}, t) \pdv{\phi(\vb*{r}, t)}{t} - \mathcal{H} \right) \right)
\]
相对比，我们发现只需要做Wick转动，并限制时间的积分区域在$0$到$\beta$，就可以从零温场论的配分函数过渡到有限温的虚时间配分函数。（注意：零温场论的配分函数并不等于有限温场论的虚时间配分函数，而哈密顿量的形式应该是不变的）
当温度趋于零，即$\beta$趋于无限大，虚时积分区间上限趋于无限大，于是零温场论的配分函数过渡到有限温的虚时间配分函数就只差了一个Wick转动。
换而言之，零温下的理论确实和纯态的理论是一样的，我们可以交替使用“零温”和“纯态”（或者说“非统计性的”）两个概念。
在实际计算时可以使用频域的路径积分，即
\begin{equation}
    S = \sum_{n} \int \dd[D]{\vb*{r}} \left( - \ii \omega_n \bar{\phi}(\vb*{r}, \omega_n) \phi(\vb*{r}, \omega_n) + \mathcal{H}[\bar{\phi}, \phi] \right),
\end{equation}
其中$\omega_n$指的是松原频率，按照$\phi$的类型（费米场还是玻色场）会有不同。

使用路径积分表述可以容易地计算出虚时间编时格林函数，从而可以计算出松原格林函数，从而计算出所有我们需要的物理量。
这里要注意松原格林函数和$T_\tau \expval*{\hat{\phi} \hat{\phi}^\dagger}$之间差了一个负号，从而对自由体系，如果使用松原格林函数写出其配分函数，则应该是
\[
    Z \sim \fd[\bar{\phi}, \phi] \exp(\bar{\phi} G^{-1} \phi),
\]
$\ee$指数内没有负号。在使用虚时间Wick定理时也需要注意
\[
    \expval*{\phi \bar{\phi}} = - \frac{1}{\ii \omega_n - \epsilon},
\]
和松原格林函数差一个负号。在微扰计算时应小心正负号。会出现正负号的地方包括：
\begin{itemize}
    \item 待计算的松原函数本身的定义会引入一个负号；
    \item 传播子和自由粒子关联函数之间差一个负号；
    \item 由于$\ee^{-S}$的形式，每个相互作用顶角会引入一个负号；
    \item 如果系统中有费米子，费米子算符的编时会引入负号，这些负号有时会抵消有时不会，一个简单的判别方式：费米子形成的可能产生负号的元件共计$F$个时要乘上因子$(-1)^F$，具体是哪些元件和顶角的形式有关；
    \item 有些中间量的定义（如自能等）本身带有负号。
\end{itemize}

使用路径积分表述有非常多的好处，首先是理论在形式上非常简洁，因此有利于一些数学上的分析；其次，路径积分中时间和空间并无明显差异，且场变量都是经典的（格拉斯曼变量不那么“经典”，但是单纯的反交换肯定比反对易关系简单多了），因此可以做一些正则量子化表述下物理意义不是很清晰的运算。
例如，可以把场从时域切换到频域，在正则量子化中时间是一个单独被拿出来的参量，因此对时间做傅里叶变换看起来相当奇怪，但在路径积分表述中这就毫无问题。
又比如，两个彼此之间有相互作用的场会导致所谓的“推迟相互作用”，即某个场某一点通过影响其它场来间接地影响它本身。如果我们只关心某一个场，使用正则量子化方法处理这种问题非常困难，因为需要手动把延时放进仅含我们关心的场的哈密顿量中（很多时候，不扩充哈密顿动力学甚至根本就不能够找到合适的哈密顿量描述这样的系统！），而并没有比较自然的方法可以把其它场消除掉。
在路径积分表述中，可以很自然地将不需要的场积掉，得到的有效作用量自然地会给出正确的延迟。
使用路径积分的另一个好处在于，可以在统一的框架下分析耗散、阻尼等现象，而在哈密顿量表述下就必须引入主方程。
在路径积分表述中，阻尼在积掉一些和保留下来的自由度高度耦合的自由度时自然地产生，它可能体现为推迟相互作用（实际上，推迟通常就意味着某种耗散，因为此时改变哈密顿量中的某些外参数之后并不能立即得到相应的响应，于是$X \dd{Y}$不能写成一个恰当微分形式）。
最后，对于含有（通常并不是一眼能够看出的）无用自由度（即这些自由度在哈密顿量中看起来是存在的，但有证据表明希尔伯特空间中没有这些自由度）的系统，直接正则量子化常常会产生一些非物理的结果（如直接对电磁场朴素地做正则量子化可能会出现负能量疑难）。
经典物理中可以很容易地引入一些约束条件，但是这样就需要做带约束的正则量子化，在数学上比较麻烦，也很不直观。
路径积分表述中可以轻易地使用一些罚函数（如“规范固定项”）来编码这些约束条件，大大简化了操作。

\subsubsection{经典统计与量子统计}

比较\eqref{eq:path-integral-partition-function}和经典统计中看起来也可以写成路径积分的配分函数
\[
    Z = \int \prod_i \dd{q_i} \dd{p_i} \exp(-\beta H) = \int \fd{[q, p]} \exp(-\int_0^\beta \int \dd[D]{\vb*{r}} \mathcal{H}),
\]
会发现两个不同：
\begin{itemize}
    \item 量子统计的配分函数中有$\pi \partial_\tau \phi$项，这一项也称为\textbf{Berry相位项}。这一项的出现意味着必须做虚时间积分，而不是简单地乘以$\beta$；这一项称为Berry相位是因为让虚时间从$0$演化到$\tau$，哈密顿量那一项由于只和场有关，不会造成相位变化，但是$\bar{\phi}\partial_\tau \phi$由于$\tau$导数，会造成一个相位。
    \item 量子统计的积分变量是场算符，而不是系统状态。在经典统计中“物理量”和“物理量取某些值形成的状态”基本上可以不做区分，但是量子物理中前者是算符，后者是态矢量。
\end{itemize}
因此，量子路径积分和经典“路径积分”的对应并不那么容易看出。

第一个问题：量子统计如何退化到经典统计？我们知道高能量（能标远大于$\hbar$，但是没有出现新物理，即哈密顿量的形式可以不变）下量子理论退化为经典理论，因为对易关系中的$\hbar$可以忽略。
正如我们所预期的那样，高温下（从而高能标下），$\beta$非常小，则Berry相位项可能可以略去。
这就得到了一个经典“路径积分”。需要注意的是此配分函数仍然是以场为表象的而不是以粒子为表象的，和\autoref{sec:from-quantum-to-classical}中的经典配分函数并不相同。
需要注意的是这么做是比较危险的，因为温度再高都存在场构型可以产生非平庸的Berry相位，虽然温度增高会将这些场构型的权重压低，但是压低的速率并无很好的估计。
Berry相位是否可以省略需要具体分析。一些时候，高温下——所谓“经典统计极限”下——的确没有$\bar{\phi} \partial_\tau \phi$形式的Berry相位项，但是会演生出其它形式的Berry相位项。
原则上，任何符合物理条件的Berry相位项都可以通过适当地让相互作用和$\bar{\phi} \partial_\tau \phi$配合而产生。

第二个问题：和经典“路径积分”相对应的量子理论到底是什么？
实际上它就是
\[
    Z = \trace \ee^{-\beta \hat{H}} = \sum_{n_1, n_2, \ldots, n_m} \mel{n_1}{\ee^{-\Delta \tau \hat{H}}}{n_2} \mel{n_2}{\ee^{-\Delta \tau \hat{H}}}{n_3} \cdots \mel{n_{m-1}}{\ee^{-\Delta \tau \hat{H}}}{n_m}, \quad m \Delta \tau = \beta.
\]
之前推导的“场算符的路径积分”实际上仅仅给出了一种可能的路径积分，其积分变量是场构型；但是实际上在做“将虚时间演化分割成很多小片，每个小片插入完备性条件”时，可以不使用相干态为表象；此时照样能够有路径积分，一条世界线就是$\tau=\Delta\tau$时系统状态$\ket{n_1}$，$\tau=2\Delta\tau$时系统状态$\ket{n_2}$这样。
这种类型的路径积分也许不便手工计算，但是数值计算有时可能会用到。
我们刚才得到的有Berry相位项、以场构型的世界线为积分变量的路径积分只是一种特例。
在时间演化的$\Delta \tau$非常小时，可以证明$\ee^{-\Delta \tau \hat{H}}$的哈密顿量中的各个项可以近似认为是对易的。

需要注意的是，和一个量子理论对应的经典理论的哈密顿量和原哈密顿量可以看起来毫无关系。
这完全是数学上的对应；反之，在$\hbar \to 0$极限下，一个量子的哈密顿量等价于一个具有相同哈密顿量的经典体系，但是这只是近似，而不是严格的等价。
此外，很多量子理论对应的“经典理论”实际上根本就不是物理上有意义的经典理论：“哈密顿量”中会出现虚数，“概率”不是正的甚至不是实数，等等。%
\footnote{
    当然，原则上我们总是可以将哈密顿量对角化然后得到一个经典理论，但是此时的基矢量和经典哈密顿量不具有任何经典意义，它甚至可以不是局域的。
    我们要说的其实是“很多量子统计系统不能在具有经典意义的基底下被赋予经典统计的意义”。
}%
通过线性代数可以证明（Frobenius定理），如果（量子）哈密顿量的非对角元全部小于等于零，那么不会出现这种情况。
总之，量子理论中实际上蕴含着比经典理论更加复杂的行为。

\subsubsection{关于路径积分的一般性的注记}

上面提到的方法只适用于动力学变量为具有共轭动量的场变量的情况，也就是场论问题。我们看到，$\phi \dot{\pi}$项的出现实际上是因为坐标和动量不对易，因此我们可以将它当成量子涨落的实现。
反之，如果哈密顿量中没有共轭动量，那么路径积分的积分测度就应该是$\fd{\phi}$，$\ee$指数上就是简单的$\ee^{-\beta H[\phi]}$。
还有一些时候动力学变量不是这样的变量，根本找不到典型的坐标-动量关系（例如只含有自旋的问题就属于此类），那么就不能使用上面提到的方法做路径积分，而哈密顿量表述还是适用的。
虽然如此，实际上可以将以上思路适当变通一下就能够将路径积分推广。
关键在于找到合适的完备性表达式，如对自旋的情况，设$\ket{\uparrow}$为$\hat{S}^z$的本征值最大的本征态，那么使用Haar测度实际上我们可以写出
\[
    \int \dd{g} \dyad{g} = \const.
\]
将这个完备性表达式插入对$\ee^{-\beta \hat{H}}$的分片乘积中，就可以得到路径积分。
容易验证这样得到的路径积分的经典极限和对应的哈密顿量的经典极限表述还是等价的。
同样，如果哈密顿量中含有不对易的算符，那么也会出现量子涨落项，需要注意的是此时的路径积分中的作用量可能不再是“动量乘以坐标的时间导数减去哈密顿量再对时间积分”，而可能会多出来一些项。这些项可以看成某种类型的量子反常。

实际上，也没有什么保证了$\tau$一定需要连续变化（归根到底，只有$\beta$才具有物理意义，虚时间），我们完全可以取离散的虚时间点，对虚时间点处的场构型求积分。
实际上这开拓了更加宽广的天地，因为这样场构型从一个虚时间点到另一个虚时间点不需要是连续的，那么对自旋之类的物理量甚至就可以使用离散的场值。

% TODO：似乎求解“几乎热平衡的系统发生时间演化”却不能够简单地使用路径积分解决；当然也并非完全解决不了，实际上我们需要把热力学坐标之间的关系当成动力学变量之间的关系，相当于我们要把热平衡的系统的高阶自由度在虚时间下积掉，而热力学坐标可以是实时间下的路径积分

实际工作中，大部分问题围绕着广义的坐标-动量系统，或是格点上的自旋系统，因此大部分时候，路径积分表述都是非常有用的。

\subsubsection{从配分函数导出松原格林函数}

现在配分函数被写成了一个泛函积分，而且其形式和从拉格朗日量写出的路径积分非常相似，唯一的区别在于它不在闵可夫斯基时空中，并且指数函数的宗量中没有因子$\ii$（但这一点差异在做变量代换之后就消失了）。
考虑到编时格林函数和路径积分的一般关系，我们有%
\footnote{对这个关系最直截了当的证明是做Wick转动，从虚时切换到实时，将我们的问题同一个闵可夫斯基时空中的零温场论建立等价关系，此时编时的松原格林函数就是普通的编时格林函数。
不过实际上并不需要严格的证明也能够猜测到这个关系。请注意编时格林函数是唯一能够保证参与运算的算符在交换顺序之后只差一个正负号的格林函数，而
\[
    \int \fd{[\bar{\phi}, \phi]} A(\bar{\phi}, \phi) \ee^{- S[\phi]}
\]
在交换$A$的表达式中各项中$\phi$的排序之后也只会发生正负号变化，因此两者一定只差一个常数因子。
}%
\begin{equation}
    T_\tau \expval*{\hat{A}^H} = \frac{\int \fd{[\bar{\phi}, \phi]} A(\bar{\phi}, \phi) \ee^{- S[\phi]}}{\int \fd{[\bar{\phi}, \phi]} \ee^{- S[\phi]}}.
    \label{eq:imaginary-time-order-path-integral}
\end{equation}
这样就得到了时域编时格林函数的路径积分表示。

\eqref{eq:imaginary-time-order-path-integral}的分子实际上和泛函求导有关。
如下在作用量中引入扰动$J$：
\begin{equation}
    Z[J] = \int \fd{\phi} \exp ( - S[\phi, J] ),
\end{equation}
其中
\begin{equation}
    S[\phi, J] = S[\phi] + \int_0^\beta \dd{\tau} \int \dd[D]{\vb*{r}} J(\vb*{r}, \tau) \phi(\vb*{r}, \tau),
\end{equation}
则由泛函求导可以得到
\begin{equation}
    T_\tau \expval*{\hat{\phi}(\vb*{r}_1, \tau_1) \hat{\phi}(\vb*{r}_2, \tau_2) \cdots \hat{\phi}(\vb*{r}_n, \tau_n)} = (-1)^n \frac{1}{Z(J=0)} \frac{\var^n J[\phi]}{\var{\phi(\vb*{r}_1, \tau_1)} \cdots \var{\phi(\vb*{r}_n \tau_n)}}.
\end{equation}
可以对$\bar{\phi}$引入同样的扰动做计算。

我们已经知道实时间的推迟格林函数的频域形式和松原格林函数之间可以建立一个映射，而松原格林函数实际上就是虚时间编时格林函数，这就解释了为什么看起来实时间推迟格林函数给出了系统中所有让人感兴趣的信息——因为它含有的信息和虚时间编时格林函数一样多，而后者又包含了统计场论中提供的全部信息。

\subsubsection{粒子和场的互换}

% TODO:线性响应下外加扰动在路径积分中体现为一个平方项，系数就是两点格林函数
实数场高斯积分
\begin{equation}
    \int \dd[n]{\vb{y}} \ee^{-\frac{1}{2} \vb{y}^\top \vb{G}^{-1} \vb{y} + \vb{B}^\top \vb{y}} = \sqrt{(2\pi)^n \det(\vb{G})} \ee^{\frac{1}{2} \vb{B}^\top \vb{G} \vb{B}}.
\end{equation}
费米子场高斯积分
\begin{equation}
    \int \dd[n]{\bar{\phi}} \dd[n]{\phi} \ee^{ - \bar{\phi}^\top \vb{A} \phi + q^\top \phi + \bar{\phi}^\top q} = \det(\vb{A}) \ee^{q^\top \vb{A}^{-1} q},
\end{equation}
注意到费米场和玻色场的行列式的位置是不同的，一个在分子上一个在分母上。
可以看到，$\vb{G}$实际上是自由场自由能$-\frac{1}{2} \vb{y}^\top \vb{G}^{-1} \vb{y}$的欧拉-拉格朗日方程（由于是自由场，此方程一定是线性的）外加一个脉冲而产生的响应。

直觉上看，粒子的集体行为就好像一个场，例如原子的集体振动形成了声子场。这个场的激发当然是某种新的粒子，事实上它就是前一种粒子的元激发。

Linked-Cluster定理：设$Z$是一系列费曼图的求和，则$\ln Z$是所有这些费曼图的连通子图的求和。

外腿一致，内部不一致的费曼图可以相加。由乘法分配律，如果某个图中一个内部结构未知的子图有两种可能，那么可以认为这个不确定的子图就等于这两个可能性的和。

TODO：

$Z$就是所有真空气泡图的求和，或者连通真空气泡图的求和的指数。

含相互作用的关联函数就是所有有外腿、未必连通的图之和除以归一化因子$Z$（也就是所有真空气泡图的和），也就是所有每个连通成分都和至少一个外腿连接的图之和，也就是至少和一个外腿连接的连通图的指数（但通常不会使用这个形式，因为这样要计算的每一张图外腿数目不是固定的）。
注意$\int \fd{\phi} \phi_1 \phi_2 \cdots \phi_n \ee^{-S}$是所有有外腿、未必连通的图的和，它们除以归一化因子才得到关联函数。

连通关联函数就是所有有外腿的连通图的和。

有时我们需要积掉一部分自由度，此时需要计算所有连通图之和。为了具体一些，我们假定被积掉的自由度是高动量自由度，虽然积掉别的自由度也遵循完全一样的流程。
回顾关于紫外场和红外场的讨论，我们有
\[
    F[\phi(\vb*{k})] = F_0 [\phi^-(\vb*{k})] + F_0 [\phi^+(\vb*{k})] + F_I [\phi^-(\vb*{k}) , \phi^+ (\vb*{k})],
\]
设积掉$\phi^+$之后的有效自由能为$F'[\phi^-]$（尚未做尺度调整），则我们容易验证
\[
    F'[\phi^-] = F_0[\phi^-_{\vb*{k}}] - \ln \expval{\ee^{-F_I[\phi_{\vb*{k}}^-, \phi_{\vb*{k}}^+]}}_+,
\]
其中下标$+$表示仅对$\phi^+$计算积分，而假定$\phi^-$为给定的常数。
$\ln \expval*{\exp(F)}$展开之后可以写成连通关联函数的级数，即
\begin{equation}
    \ln \expval{\ee^{-F_I}}_+ = - \cexpval{F_I}_+ + \frac{1}{2} \cexpval{F_I^2} + \cdots,
\end{equation}
现在我们看出来为什么只需要计算连通图了：要计算出高能自由度造成的修正，我们需要将所有内线全部是高能自由度的连通图加起来。
这些连通图中被保留的自由度是外腿，如果内线也都是被保留的自由度，求和得到的就是$F_0[\phi^-(\vb*{k})]$；反之，内线全部是高能自由度的连通图之和给出了$\phi^+$造成的修正——直观地看，虽然我们希望忽略高能自由度，但它们可以是一些入射、出射粒子都为低能态的过程的中间状态。（不存在内线部分是高能自由度，部分是低能自由度的情况，因为只对高能自由度求积分，因此所有传播子都是高能自由度的）
自由能的计算是通过计算所有连通真空气泡图之和完成的（可能要乘以一个$-1$的顶角个数次方的因子）。
实际上，自由能的计算是“积掉一部分自由度”的特殊情况：所有自由度都积掉，那么就没有外腿，自然就是求所有连通真空气泡图之和。
% TODO

关于费曼图的对称性因子：指数展开的因子$1/n!$被$n$个顶角互相可以代替而产生的$n!$因子抵消了。$n$体相互作用会产生一个$n!$的对称性因子，因为$n$个粒子可以相互代替，但是如果$n$体相互作用哈密顿量有一个$1/n!$的因子，那么这个对称性因子也会被抵消。
即使哈密顿量中有不只一种场，也有类似的结论。指数展开的$1/n_1! n_2! \cdots$因子不会出现在最终结果中。

同一个顶角引出的线应该看成是不同的，如果形成了圈则需要除以一些因子。有一些项，如$\phi^4$，对应的顶角中四条线会由于排列自由度引入一个对称性因子，如$\phi^4$顶角有4条一样的线，那么会引入一个$4!$因子（注：$\phi^4$是一个二体相互作用，但是需要乘以$4!$，因为这里还有一个额外的对称性因子：输入线和输出线没有做区分，因此实际上一个$\phi^4$顶角相当于一个二进二出的顶角，一个一进三出的顶角，一个三进一出的顶角；总之需要注意的是$n$体相互作用对应的对称性因子可以不是$n!$，而必须分析交换连接在顶角上的粒子线的排列自由度，在一个顶角涉及多种粒子时尤其需要注意这一点）。因此，为了方便起见我们实际上可以只考虑要在此基础上除以哪些因子。
从一个顶角引出的两条线如果实际上是一条（也就是形成了一个圈），那么要除以$2$，设连接在一个顶角上的
如果两个顶角被$M$条内线连接，那么要除以$M!$，因为这$M$个粒子彼此替换得到的是同样的量子态。
总之就是等价的缩并全部让对称性因子要除以某个数。

对称性因子仅仅取决于顶角的“形状”，和粒子的标签等无关。如果一个圈的两端具有不同的粒子标签——这在做坐标空间的计算时经常出现——这个圈还是会产生对称性因子。

一些顶角还带有约束，如动量守恒，约束可能还不止一个。我们可以把这些约束看成相互作用系数的一部分，此时无需特殊处理。我们也可以把它们直接反映在顶角的图形中（如将三条粒子线标上任意的动量，然后用动量守恒写出最后一条粒子线上的动量），此时应当注意这样的标注对顶角上的粒子线的对称性的破坏只是表面上的；如果有多个约束，这么做可能还会引入额外的对称性因子。

在计算响应函数时只连接在一个外腿上的圈图会造成难以消去的发散，但这是正常的，因为实际上把所有这些圈图加起来，实际上就是把无相互作用的基态变成了有相互作用的基态。
因此这种图可以直接忽略（这称为amputate）。这也说明了一点，就是费曼图展开经常不是良定义的泰勒展开，有时只算有限项永远得不到一些效应（非微扰效应），有时算的阶数高了反而不准确（因为涉及较高能的过程，但是我们使用的理论在这个能标下就未必正确了）。

% TODO:有限温下的散射理论：似乎只需要在算期望时把粒子数、态密度之类的东西替换成费米-狄拉克分布或玻色-爱因斯坦分布即可。例如虽然费米黄金法则是在零温下推导出来的，但有限温下只需要将态密度替换成有限温下态密度的期望值就可以了。而由于热力学系统涨落可以略去，可以使用经典的图像来计算粒子数、态密度等

1PI图：切断一根粒子线之后不连通的图（one particle irreducible）

相互作用通道：其实就是盖住中间过程，只保留入射出射外腿而获得的费曼图分类，或者说就是等效作用量中的一项。

\end{document}